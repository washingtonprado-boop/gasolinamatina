<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA MATINA/BA - GEST√ÉO TOTAL</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --success: #22c55e; --warning: #f59e0b; --danger: #ef4444; --bg: #f1f5f9; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; text-transform: uppercase; }
        body { background-color: var(--bg); margin: 0; padding: 10px; color: #1e293b; }
        .container { max-width: 1300px; margin: 0 auto; }
        .blurred { filter: blur(15px); pointer-events: none; }
        #login-screen { position: fixed; inset: 0; background: var(--primary); z-index: 999; display: flex; align-items: center; justify-content: center; flex-direction: column; color: white; }
        .login-box { width: 90%; max-width: 320px; text-align: center; }
        .login-box input { width: 100%; padding: 15px; border-radius: 10px; border: none; margin-bottom: 10px; text-align: center; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .nav-tabs { display: flex; gap: 10px; }
        .tab-btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; background: #cbd5e1; font-weight: bold; font-size: 11px; }
        .tab-btn.active { background: var(--accent); color: white; }
        .btn-logout { background: var(--danger); color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .mini-card { background: var(--primary); color: white; padding: 15px; border-radius: 10px; text-align: center; font-weight: bold; margin-bottom: 20px; }
        .charts-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; font-size: 10px; }
        th { background: #f8fafc; padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; }
        .alerta-media { background-color: #fee2e2 !important; color: #b91c1c !important; }
        .btn-save { background: var(--success); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        input, select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 5px; }
        label { font-size: 10px; font-weight: bold; color: #64748b; display: block; }
        .status-tag { padding: 3px 6px; border-radius: 4px; font-weight: bold; font-size: 9px; }
        .status-aguardando { background: var(--warning); color: #000; }
        .status-autorizado { background: var(--success); color: #fff; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

<div id="login-screen">
    <h2>MATINA/BA ‚õΩ</h2>
    <div class="login-box">
        <input type="text" id="user" placeholder="USU√ÅRIO">
        <input type="password" id="senha" placeholder="SENHA" onkeydown="if(event.key==='Enter') logar()">
        <button class="btn-save" onclick="logar()">ENTRAR</button>
    </div>
</div>

<div class="container blurred" id="app">
    <div class="top-bar no-print">
        <div class="nav-tabs">
            <button id="btn-tab-geral" class="tab-btn active" onclick="switchTab('geral')">PAINEL GERAL</button>
            <button id="btn-tab-users" class="tab-btn" style="display:none;" onclick="switchTab('usuarios')">CONFIGURA√á√ïES (MASTER)</button>
        </div>
        <button class="btn-logout" onclick="location.reload()">SAIR</button>
    </div>

    <div id="tab-geral">
        <div class="charts-row no-print">
            <div class="card"><h4>üí∞ GASTOS POR SECRETARIA</h4><div style="height:230px;"><canvas id="chartSec"></canvas></div></div>
            <div class="card"><h4>üöõ TOP 5 VE√çCULOS (R$)</h4><div style="height:230px;"><canvas id="chartVec"></canvas></div></div>
        </div>

        <div class="card no-print">
            <h3>‚õΩ NOVO LAN√áAMENTO</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                <div><label>PLACA</label><input type="text" id="f-placa" oninput="sugerir(this.value)"></div>
                <div><label>SECRETARIA</label><select id="f-sec">
                    <option>ADMINISTRA√á√ÉO E FINAN√áAS</option><option>AGRICULTURA E MEIO AMBIENTE</option>
                    <option>ASSIST√äNCIA SOCIAL</option><option>EDUCA√á√ÉO</option><option>SA√öDE</option>
                    <option>INFRAESTRUTURA E SERVI√áOS</option><option>AVULSOS / GERAL</option>
                </select></div>
                <div><label>MOTORISTA</label><input type="text" id="f-mot"></div>
                <div><label>COMBUST√çVEL</label><select id="f-tipo" onchange="calc()"><option value="GASOLINA">GASOLINA</option><option value="ALCOOL">ALCOOL</option><option value="DIESEL">DIESEL</option></select></div>
                <div><label>POSTO</label><select id="f-posto"><option>POSTO VITOR</option><option>POSTO MATINA</option></select></div>
                <div><label>DATA</label><input type="date" id="f-data"></div>
                <div><label>KM ATUAL</label><input type="number" id="f-km"></div>
                <div><label>LITROS</label><input type="number" id="f-lit" step="0.01" oninput="calc()"></div>
                <div><label>VALOR TOTAL</label><input type="text" id="f-val" readonly style="background:#f1f5f9; font-weight:bold;"></div>
            </div>
            <button class="btn-save" onclick="processar()">‚úîÔ∏è SALVAR REGISTRO</button>
        </div>
        <div id="relatorio-container"></div>
    </div>

    <div id="tab-usuarios" style="display:none;">
        <div class="card">
            <h3>üí≤ TABELA DE PRE√áOS</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <div><label>GASOLINA</label><input type="number" id="p-gas" value="6.00"></div>
                <div><label>ALCOOL</label><input type="number" id="p-alc" value="4.00"></div>
                <div><label>DIESEL</label><input type="number" id="p-die" value="6.00"></div>
            </div>
            <button class="btn-save" onclick="salvarPrecos()" style="background:var(--accent)">SALVAR PRE√áOS</button>
        </div>

        <div class="card">
            <h3 id="title-user">üë• GEST√ÉO DE USU√ÅRIOS</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                <input type="text" id="new-user" placeholder="USU√ÅRIO">
                <input type="text" id="new-pass" placeholder="SENHA">
                <select id="new-role" onchange="document.getElementById('div-limite').style.display = (this.value === 'secretarios') ? 'block' : 'none';">
                    <option value="admin">ADMIN (GILVAR/ENIO)</option>
                    <option value="secretarios">SECRETARIO (COM LIMITE)</option>
                    <option value="frentista">FRENTISTA</option>
                </select>
                <div id="div-limite" style="display:none;"><input type="number" id="new-limit" placeholder="LIMITE R$"></div>
            </div>
            <button class="btn-save" id="btn-user-action" onclick="addUsuario()" style="background:var(--accent)">CADASTRAR CONTA</button>
            <button class="btn-save" id="btn-cancel-edit" onclick="resetarFormUser()" style="background:var(--danger); display:none;">CANCELAR EDI√á√ÉO</button>
        </div>
        <div class="card"><table><thead><tr><th>USU√ÅRIO</th><th>CARGO</th><th>LIMITE</th><th>A√á√ïES</th></tr></thead><tbody id="user-body"></tbody></table></div>
    </div>
</div>

<script>
    // INICIALIZA√á√ÉO FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyDsEQ8L_hWgacZ8xweY3DR9OYt2t151kZE",
        authDomain: "tabela-gasolina.firebaseapp.com",
        databaseURL: "https://tabela-gasolina-default-rtdb.firebaseio.com", 
        projectId: "tabela-gasolina"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let cache = [], userLimit = 0, userRole = "", loginUser = "", precos = {GASOLINA:6, ALCOOL:4, DIESEL:6}, chartSec = null, chartVec = null;

    // CARREGAR CONFIGS
    db.ref('config/precos').on('value', snap => {
        if(snap.val()) {
            precos = snap.val();
            document.getElementById('p-gas').value = precos.GASOLINA;
            document.getElementById('p-alc').value = precos.ALCOOL;
            document.getElementById('p-die').value = precos.DIESEL;
        }
    });

    function logar() {
        const u = document.getElementById('user').value.toLowerCase().trim();
        const s = document.getElementById('senha').value.trim();
        if(u === "master" && s === "1234") return entrar("master", "master", 0);
        db.ref('usuarios/' + u).once('value', snap => {
            const user = snap.val();
            if(user && user.senha === s) entrar(u, user.role, user.limite || 0);
            else alert("ACESSO NEGADO!");
        });
    }

    function entrar(u, role, limit) {
        loginUser = u; userRole = role; userLimit = limit;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app').classList.remove('blurred');
        document.getElementById('btn-tab-users').style.display = (u === "master") ? 'block' : 'none';
        renderizar();
    }

    function salvarPrecos() {
        const p = { GASOLINA: parseFloat(document.getElementById('p-gas').value), ALCOOL: parseFloat(document.getElementById('p-alc').value), DIESEL: parseFloat(document.getElementById('p-die').value) };
        db.ref('config/precos').set(p).then(() => alert("PRE√áOS ATUALIZADOS!"));
    }

    function calc() {
        const tipo = document.getElementById('f-tipo').value;
        const litros = parseFloat(document.getElementById('f-lit').value) || 0;
        document.getElementById('f-val').value = "R$ " + (litros * (precos[tipo] || 0)).toFixed(2);
    }

    function processar() {
        const placa = document.getElementById('f-placa').value.toUpperCase();
        const litros = parseFloat(document.getElementById('f-lit').value) || 0;
        const tipo = document.getElementById('f-tipo').value;
        const valor = litros * precos[tipo];
        if(!placa || litros <= 0) return alert("DADOS INV√ÅLIDOS!");

        let st = (loginUser === "master" || userRole === "admin" || userRole === "secretarios") ? "AUTORIZADO" : "AGUARDANDO";

        if(userRole === 'secretarios') {
            const gasto = cache.filter(x => x.status === "AUTORIZADO" && x.autorizadoPor === loginUser.toUpperCase()).reduce((a,b)=>a+b.valor, 0);
            if((gasto + valor) > userLimit) return alert("LIMITE EXCEDIDO!");
        }

        db.ref('abastecimentos').push({
            placa, data: document.getElementById('f-data').value, motorista: document.getElementById('f-mot').value.toUpperCase(),
            tipo, secretaria: document.getElementById('f-sec').value, litro: litros, valor: valor,
            km: parseFloat(document.getElementById('f-km').value) || 0, status: st, 
            autorizadoPor: st === "AUTORIZADO" ? loginUser.toUpperCase() : "PENDENTE", timestamp: Date.now()
        }).then(() => {
            Toastify({text: "SALVO!", background: "green"}).showToast();
            ["f-placa","f-mot","f-km","f-lit","f-val"].forEach(id => document.getElementById(id).value = "");
        });
    }

    function renderizar() {
        if(!loginUser) return;
        const container = document.getElementById('relatorio-container');
        container.innerHTML = "";
        
        let headerTxt = `OPERADOR: ${loginUser.toUpperCase()}`;
        if(userRole === 'secretarios') {
            const gasto = cache.filter(x => x.status === "AUTORIZADO" && x.autorizadoPor === loginUser.toUpperCase()).reduce((a,b)=>a+b.valor, 0);
            headerTxt += ` | SALDO: R$ ${(userLimit - gasto).toFixed(2)}`;
        }
        container.innerHTML = `<div class="mini-card">${headerTxt}</div>`;

        const secretarias = [...new Set(cache.map(x => x.secretaria))].sort();
        secretarias.forEach(sec => {
            const dados = cache.filter(x => x.secretaria === sec).sort((a,b) => new Date(a.data) - new Date(b.data));
            let linhas = "";
            dados.forEach(d => {
                const hist = cache.filter(v => v.placa === d.placa && v.km < d.km).sort((a,b) => b.km - a.km);
                const media = (hist.length > 0 && d.litro > 0) ? ((d.km - hist[0].km) / d.litro) : 0;
                let corMedia = (media > 0 && ((d.tipo === "GASOLINA" && media < 7) || (d.tipo === "DIESEL" && media < 2.5))) ? "alerta-media" : "";

                linhas += `<tr class="${corMedia}">
                    <td>${d.data.split('-').reverse().join('/')}</td><td><b>${d.placa}</b></td><td>${d.tipo}</td><td>${d.motorista}</td>
                    <td><span class="status-tag status-${d.status.toLowerCase()}">${d.status}</span></td>
                    <td>${media > 0 ? media.toFixed(2) : '---'}</td><td>R$ ${d.valor.toFixed(2)}</td>
                    <td class="no-print">
                        ${(d.status === 'AGUARDANDO' && (loginUser === 'master' || userRole === 'admin')) ? `<button class="btn-auth" onclick="db.ref('abastecimentos/${d.id}').update({status:'AUTORIZADO', autorizadoPor:loginUser.toUpperCase()})">LIBERAR</button>` : ''}
                        ${(loginUser === 'master' || userRole === 'admin') ? `<button style="background:none;border:none;cursor:pointer" onclick="if(confirm('EXCLUIR?')) db.ref('abastecimentos/${d.id}').remove()">üóëÔ∏è</button>` : ''}
                    </td></tr>`;
            });
            container.innerHTML += `<div style="background:var(--primary);color:white;padding:8px;font-size:10px;margin-top:15px;border-radius:5px">${sec}</div>
            <table><thead><tr><th>DATA</th><th>PLACA</th><th>TIPO</th><th>MOT</th><th>STATUS</th><th>MEDIA</th><th>VALOR</th><th class="no-print">A√á√ïES</th></tr></thead><tbody>${linhas}</tbody></table>`;
        });
        atualizarGraficos();
    }

    function atualizarGraficos() {
        const aut = cache.filter(x => x.status === "AUTORIZADO");
        if(aut.length === 0 || !document.getElementById('chartSec')) return;
        const secMap = {}; aut.forEach(d => secMap[d.secretaria] = (secMap[d.secretaria] || 0) + d.valor);
        if(chartSec) chartSec.destroy();
        chartSec = new Chart(document.getElementById('chartSec'), { type: 'doughnut', data: { labels: Object.keys(secMap), datasets: [{ data: Object.values(secMap), backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6'] }] }, options: { responsive: true, maintainAspectRatio: false }});
        const vecMap = {}; aut.forEach(d => vecMap[d.placa] = (vecMap[d.placa] || 0) + d.valor);
        const sortedVec = Object.entries(vecMap).sort((a,b) => b[1] - a[1]).slice(0,5);
        if(chartVec) chartVec.destroy();
        chartVec = new Chart(document.getElementById('chartVec'), { type: 'bar', data: { labels: sortedVec.map(x => x[0]), datasets: [{ label: 'R$', data: sortedVec.map(x => x[1]), backgroundColor: '#0f172a' }] }, options: { responsive: true, maintainAspectRatio: false }});
    }

    // GEST√ÉO DE USU√ÅRIOS (COM EDI√á√ÉO)
    function addUsuario() {
        const u = document.getElementById('new-user').value.toLowerCase().trim();
        const s = document.getElementById('new-pass').value.trim();
        const r = document.getElementById('new-role').value;
        const l = parseFloat(document.getElementById('new-limit').value) || 0;
        if(u && s) db.ref('usuarios/'+u).set({senha:s, role:r, limite:l}).then(() => { alert("OK!"); resetarFormUser(); listUsuarios(); });
    }

    function prepararEdicao(u, s, r, l) {
        document.getElementById('new-user').value = u;
        document.getElementById('new-user').disabled = true;
        document.getElementById('new-pass').value = s;
        document.getElementById('new-role').value = r;
        document.getElementById('new-limit').value = l;
        document.getElementById('div-limite').style.display = (r === 'secretarios') ? 'block' : 'none';
        document.getElementById('btn-user-action').innerHTML = "SALVAR ALTERA√á√ïES";
        document.getElementById('btn-user-action').style.background = "var(--warning)";
        document.getElementById('btn-user-action').onclick = function() {
            db.ref('usuarios/'+u).update({senha: document.getElementById('new-pass').value, role: document.getElementById('new-role').value, limite: parseFloat(document.getElementById('new-limit').value)||0})
            .then(() => { alert("ATUALIZADO!"); resetarFormUser(); listUsuarios(); });
        };
        document.getElementById('btn-cancel-edit').style.display = "block";
    }

    function resetarFormUser() {
        document.getElementById('new-user').value = "";
        document.getElementById('new-user').disabled = false;
        document.getElementById('new-pass').value = "";
        document.getElementById('new-limit').value = "";
        document.getElementById('btn-user-action').innerHTML = "CADASTRAR CONTA";
        document.getElementById('btn-user-action').style.background = "var(--accent)";
        document.getElementById('btn-user-action').onclick = addUsuario;
        document.getElementById('btn-cancel-edit').style.display = "none";
    }

    function listUsuarios() {
        db.ref('usuarios').once('value', snap => {
            const tbody = document.getElementById('user-body'); tbody.innerHTML = "";
            snap.forEach(c => { 
                const u = c.val(); 
                tbody.innerHTML += `<tr><td>${c.key.toUpperCase()}</td><td>${u.role}</td><td>${u.limite||'--'}</td>
                <td>
                    <button onclick="prepararEdicao('${c.key}','${u.senha}','${u.role}',${u.limite||0})">‚úèÔ∏è</button>
                    <button onclick="if(confirm('EXCLUIR?')) {db.ref('usuarios/${c.key}').remove(); listUsuarios();}">üóëÔ∏è</button>
                </td></tr>`; 
            });
        });
    }

    db.ref('abastecimentos').on('value', snap => {
        cache = []; snap.forEach(i => { let v = i.val(); v.id = i.key; cache.push(v); });
        renderizar();
    });

    function switchTab(t) {
        document.getElementById('tab-geral').style.display = (t === 'geral') ? 'block' : 'none';
        document.getElementById('tab-usuarios').style.display = (t === 'usuarios') ? 'block' : 'none';
        if(t === 'usuarios') listUsuarios();
    }

    function sugerir(v) {
        const last = cache.filter(x => x.placa === v.toUpperCase()).sort((a,b) => b.timestamp - a.timestamp)[0];
        if(last) { document.getElementById('f-sec').value = last.secretaria; document.getElementById('f-mot').value = last.motorista; }
    }
    document.getElementById('f-data').valueAsDate = new Date();
</script>
</body>
</html>
