<!-- Firebase e Chart.js -->
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<style>
  :root { 
      --primary: #0f172a; 
      --accent: #3b82f6; 
      --success: #22c55e; 
      --warning: #f59e0b; 
      --danger: #ef4444; 
      --bg: #f1f5f9; 
  }
  * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; text-transform: uppercase; }
  body { background-color: var(--bg); margin: 0; padding: 10px; color: #1e293b; }
  .container { max-width: 1400px; margin: 0 auto; }
  .blurred { filter: blur(15px); pointer-events: none; }
  
  #login-screen { 
      position: fixed; 
      inset: 0; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      z-index: 999; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      color: white; 
  }
  .login-container {
      display: flex;
      max-width: 1100px;
      width: 90%;
      background: white;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }
  .login-left {
      flex: 1;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));
      padding: 40px 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      position: relative;
  }
  .login-left::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('https://i.imgur.com/qtUXYi3.png') center/cover;
      opacity: 0.05;
  }
  .login-logo {
      width: 100%;
      max-width: 300px;
      margin-bottom: 30px;
      position: relative;
      z-index: 1;
  }
  .login-left h1 {
      font-size: 32px;
      margin: 0 0 15px 0;
      position: relative;
      z-index: 1;
  }
  .login-left p {
      font-size: 16px;
      opacity: 0.9;
      position: relative;
      z-index: 1;
  }
  .login-box { 
      flex: 1;
      padding: 60px 50px;
      background: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
  }
  @media (max-width: 768px) {
      .login-container {
          flex-direction: column;
          width: 95%;
      }
      .login-left {
          padding: 40px 20px;
      }
      .login-box {
          padding: 40px 30px;
      }
  }
  .login-box h2 { 
      margin-bottom: 10px; 
      font-size: 32px; 
      color: var(--primary);
      text-shadow: none;
      text-align: center;
  }
  .login-box p { 
      color: #64748b; 
      font-size: 14px; 
      margin-bottom: 30px;
      text-align: center;
  }
  .login-box input { 
      width: 100%; 
      padding: 16px; 
      border-radius: 12px; 
      border: 2px solid #e2e8f0; 
      margin-bottom: 15px; 
      text-align: center; 
      font-size: 16px;
      transition: all 0.3s;
  }
  .login-box input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  .login-box .btn-login {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
  }
  .login-box .btn-login:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
  }
  
  .top-bar { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 20px; 
      flex-wrap: wrap; 
      gap: 10px;
      background: white;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .nav-tabs { display: flex; gap: 10px; flex-wrap: wrap; }
  .tab-btn { 
      padding: 12px 20px; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      background: #e2e8f0; 
      font-weight: bold; 
      font-size: 11px; 
      transition: all 0.3s;
  }
  .tab-btn.active { 
      background: var(--accent); 
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }
  .tab-btn:hover { opacity: 0.8; transform: translateY(-1px); }
  
  .btn-logout { 
      background: var(--danger); 
      color: white; 
      padding: 12px 24px; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: bold;
      transition: all 0.3s;
  }
  .btn-logout:hover {
      background: #dc2626;
      transform: translateY(-1px);
  }
  
  .card { 
      background: white; 
      border-radius: 12px; 
      padding: 24px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
      margin-bottom: 20px;
      transition: all 0.3s;
  }
  .card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  }
  .card h3 { 
      margin-top: 0; 
      color: var(--primary);
      font-size: 18px;
      border-bottom: 3px solid var(--accent);
      padding-bottom: 10px;
      margin-bottom: 20px;
  }
  
  .mini-card { 
      background: linear-gradient(135deg, var(--primary) 0%, #1e293b 100%);
      color: white; 
      padding: 20px; 
      border-radius: 12px; 
      text-align: center; 
      font-weight: bold; 
      margin-bottom: 20px; 
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  
  .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
  }
  .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
  }
  .stat-card h4 {
      font-size: 11px;
      color: #64748b;
      margin: 0 0 10px 0;
  }
  .stat-card .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary);
  }
  .stat-card .stat-icon {
      font-size: 32px;
      margin-bottom: 10px;
  }
  
  .charts-row { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
      gap: 20px; 
      margin-bottom: 20px; 
  }
  
  .table-wrapper { overflow-x: auto; }
  table { 
      width: 100%; 
      border-collapse: collapse; 
      min-width: 1000px; 
      font-size: 11px; 
  }
  th { 
      background: #f8fafc; 
      padding: 12px; 
      text-align: left; 
      border-bottom: 2px solid #e2e8f0; 
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
  }
  td { padding: 12px; border-bottom: 1px solid #f1f5f9; }
  tr:hover { background: #f8fafc; }
  
  .alerta-media { 
      background-color: #fee2e2 !important; 
      color: #b91c1c !important; 
      font-weight: bold;
      animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
  }
  
  .btn-save { 
      background: linear-gradient(135deg, var(--success) 0%, #16a34a 100%);
      color: white; 
      border: none; 
      padding: 16px; 
      border-radius: 10px; 
      cursor: pointer; 
      font-weight: bold; 
      width: 100%; 
      margin-top: 10px; 
      transition: all 0.3s;
      font-size: 13px;
  }
  .btn-save:hover { 
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(34, 197, 94, 0.3);
  }
  
  .status-tag { 
      padding: 6px 12px; 
      border-radius: 20px; 
      font-weight: bold; 
      font-size: 9px; 
      display: inline-block;
  }
  .status-aguardando { background: var(--warning); color: #000; }
  .status-autorizado { background: var(--success); color: #fff; }
  .status-rejeitado { background: var(--danger); color: #fff; }
  
  input, select { 
      width: 100%; 
      padding: 12px; 
      border: 2px solid #e2e8f0; 
      border-radius: 8px; 
      margin-bottom: 5px;
      transition: all 0.3s;
  }
  input:focus, select:focus { 
      outline: none; 
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  label { 
      font-size: 10px; 
      font-weight: bold; 
      color: #64748b; 
      display: block; 
      margin-bottom: 5px;
  }
  
  .btn-action { 
      padding: 8px 14px; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      margin: 0 3px; 
      font-size: 13px;
      transition: all 0.3s;
  }
  .btn-action:hover {
      transform: scale(1.05);
  }
  .btn-aprovar { background: var(--success); color: white; }
  .btn-rejeitar { background: var(--danger); color: white; }
  .btn-deletar { background: #64748b; color: white; }
  
  .grid-form { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
      gap: 15px; 
  }
  
  .section-header {
      background: linear-gradient(135deg, var(--primary) 0%, #1e293b 100%);
      color: white; 
      padding: 15px 20px; 
      margin-top: 20px; 
      border-radius: 10px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  
  .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: bold;
      margin-left: 8px;
  }
  .badge-success { background: var(--success); color: white; }
  .badge-danger { background: var(--danger); color: white; }
  .badge-warning { background: var(--warning); color: black; }
  
  @media print { 
      .no-print { display: none !important; } 
      .card { box-shadow: none; page-break-inside: avoid; }
      body { background: white; }
  }
  
  @media (max-width: 768px) {
      .grid-form { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: 1fr; }
      .charts-row { grid-template-columns: 1fr; }
      table { font-size: 9px; }
      th, td { padding: 8px; }
  }
  
  .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s;
  }
  @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
  }
  .modal-content {
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideUp 0.3s;
  }
  @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
  }
  .modal-content h3 {
      color: var(--primary);
      border-bottom: 3px solid var(--accent);
      padding-bottom: 10px;
      margin-bottom: 20px;
  }
  .modal-content label {
      text-transform: none;
      font-weight: normal;
  }
  .modal-close {
      float: right;
      cursor: pointer;
      font-weight: bold;
      font-size: 28px;
      color: #94a3b8;
      transition: all 0.3s;
  }
  .modal-close:hover {
      color: var(--danger);
      transform: rotate(90deg);
  }
  
  .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
  }
  @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
  }
</style>

<!-- Modal para Edi√ß√£o de Usu√°rios -->
<div id="modal-edit" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="fecharModal()">&times;</span>
    <h3>‚úèÔ∏è EDITAR USU√ÅRIO</h3>
    <div class="grid-form">
      <div>
        <label>USU√ÅRIO</label>
        <input type="text" id="edit-user" disabled>
      </div>
      <div>
        <label>NOVA SENHA</label>
        <input type="password" id="edit-pass">
      </div>
      <div>
        <label>COMBUST√çVEL PERMITIDO</label>
        <select id="edit-combustivel">
          <option value="GASOLINA">GASOLINA</option>
          <option value="ALCOOL">√ÅLCOOL</option>
          <option value="DIESEL">DIESEL</option>
          <option value="todos">TODOS</option>
        </select>
      </div>
      <div>
        <label>PERFIL</label>
        <select id="edit-role" onchange="toggleEditFields()">
          <option value="admin">ADMIN (TOTAL)</option>
          <option value="secretarios">SECRET√ÅRIO (RESTRITO)</option>
        </select>
      </div>
      <div id="edit-field-limit">
        <label>LIMITE MENSAL (R$)</label>
        <input type="number" id="edit-limit" placeholder="0.00" step="0.01">
      </div>
      <div id="edit-field-sec">
        <label>SECRETARIA VINCULADA</label>
        <select id="edit-sec-vinc">
          <option value="">SELECIONE...</option>
          <option>ADMINISTRA√á√ÉO E FINAN√áAS</option>
          <option>AGRICULTURA E MEIO AMBIENTE</option>
          <option>ASSIST√äNCIA SOCIAL</option>
          <option>EDUCA√á√ÉO</option>
          <option>SA√öDE</option>
          <option>INFRAESTRUTURA E SERVI√áOS</option>
          <option>AVULSOS / GERAL</option>
        </select>
      </div>
    </div>
    <button class="btn-save" style="background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);" onclick="salvarEdicao()">üíæ SALVAR ALTERA√á√ïES</button>
  </div>
</div>

<!-- Tela de Login -->
<div id="login-screen">
  <div class="login-container">
    <div class="login-left">
      <img src="https://i.imgur.com/AKM25W1.png" alt="Logo" class="login-logo">
      <h1>SISTEMA DE CONTROLE</h1>
      <p>Gest√£o Inteligente de Combust√≠vel</p>
    </div>
    <div class="login-box">
      <h2>üöó BEM-VINDO</h2>
      <p>Fa√ßa login para continuar</p>
      <input type="text" id="user" placeholder="USU√ÅRIO" autocomplete="username">
      <input type="password" id="senha" placeholder="SENHA" autocomplete="current-password" onkeypress="if(event.key==='Enter') logar()">
      <button class="btn-login" onclick="logar()">üîê ENTRAR</button>
    </div>
  </div>
</div>

<!-- √Årea Principal do App -->
<div class="container blurred" id="app">
  <div class="top-bar no-print">
    <div class="nav-tabs">
      <button id="btn-tab-geral" class="tab-btn active" onclick="switchTab('geral')">üìä DASHBOARD</button>
      <button id="btn-tab-pendentes" class="tab-btn" style="display:none;" onclick="switchTab('pendentes')">‚è≥ PENDENTES</button>
      <button id="btn-tab-users" class="tab-btn" style="display:none;" onclick="switchTab('usuarios')">‚öôÔ∏è CONFIGURA√á√ïES</button>
      <button class="tab-btn" onclick="abrirAlterarSenha()">üîë SENHA</button>
    </div>
    <button class="btn-logout" onclick="confirmarSair()">üö™ SAIR</button>
  </div>
  
  <div id="tab-geral">
    <div id="status-financeiro" class="mini-card">
      <div class="loading"></div> CARREGANDO...
    </div>
    
    <!-- Estat√≠sticas R√°pidas -->
    <div class="stats-grid no-print" id="stats-container"></div>
    
    <div class="charts-row no-print">
      <div class="card">
        <h3>üí∞ GASTOS POR SECRETARIA</h3>
        <div style="height:280px;"><canvas id="chartSec"></canvas></div>
      </div>
      <div class="card">
        <h3>üöõ TOP 5 VE√çCULOS</h3>
        <div style="height:280px;"><canvas id="chartVec"></canvas></div>
      </div>
    </div>
    
    <!-- Novo Abastecimento -->
    <div class="card no-print">
      <h3>‚õΩ NOVO ABASTECIMENTO</h3>
      <div class="grid-form">
        <div>
          <label>PLACA *</label>
          <input type="text" id="f-placa" placeholder="ABC-1234" maxlength="8" oninput="sugerir(this.value)">
        </div>
        <div>
          <label>POSTO *</label>
          <select id="f-posto">
            <option value="POSTO MATINA">POSTO MATINA</option>
            <option value="POSTO VICTOR">POSTO VICTOR</option>
          </select>
        </div>
        <div>
          <label>SECRETARIA *</label>
          <select id="f-sec">
            <option value="AVULSOS / GERAL">AVULSOS / GERAL</option>
            <option value="ADMINISTRA√á√ÉO E FINAN√áAS">ADMINISTRA√á√ÉO E FINAN√áAS</option>
            <option value="AGRICULTURA E MEIO AMBIENTE">AGRICULTURA E MEIO AMBIENTE</option>
            <option value="ASSIST√äNCIA SOCIAL">ASSIST√äNCIA SOCIAL</option>
            <option value="COMUNICA√á√ÉO">COMUNICA√á√ÉO</option>
            <option value="CULTURA, ESPORTE E LAZER">CULTURA, ESPORTE E LAZER</option>
            <option value="EDUCA√á√ÉO">EDUCA√á√ÉO</option>
            <option value="GOVERNOO">GOVERNOO</option>
            <option value="INFRAESTRUTURA E SERVI√áOS">INFRAESTRUTURA E SERVI√áOS</option>
            <option value="PLANEJAMENTO">PLANEJAMENTO</option>
            <option value="SA√öDE">SA√öDE</option>
          </select>
        </div>
        <div>
          <label>MOTORISTA *</label>
          <input type="text" id="f-mot" placeholder="NOME DO MOTORISTA">
        </div>
        <div>
          <label>COMBUST√çVEL *</label>
          <select id="f-tipo" onchange="calc()">
            <option value="GASOLINA">GASOLINA</option>
            <option value="ALCOOL">√ÅLCOOL</option>
            <option value="DIESEL">DIESEL</option>
          </select>
        </div>
        <div>
          <label>DATA *</label>
          <input type="date" id="f-data">
        </div>
        <div>
          <label>KM ATUAL *</label>
          <input type="number" id="f-km" placeholder="0" min="0">
        </div>
        <div>
          <label>LITROS *</label>
          <input type="number" id="f-lit" placeholder="0.00" step="0.01" min="0" oninput="calc()">
        </div>
        <div>
          <label>VALOR TOTAL (R$)</label>
          <input type="text" id="f-val" readonly style="background:#f1f5f9; font-weight:bold;">
        </div>
      </div>
      <button class="btn-save" onclick="processar()">‚úîÔ∏è REGISTRAR ABASTECIMENTO</button>
    </div>
    
    <!-- Filtro de Relat√≥rio -->
    <div class="card no-print">
      <h3>üîç FILTROS DE RELAT√ìRIO</h3>
      <div class="grid-form">
        <div>
          <label>DATA INICIAL</label>
          <input type="date" id="rel-data-inicial">
        </div>
        <div>
          <label>DATA FINAL</label>
          <input type="date" id="rel-data-final">
        </div>
        <div>
          <label>SECRETARIA</label>
          <select id="rel-secretaria">
            <option value="">TODAS</option>
            <option value="AVULSOS / GERAL">AVULSOS / GERAL</option>
            <option value="ADMINISTRA√á√ÉO E FINAN√áAS">ADMINISTRA√á√ÉO E FINAN√áAS</option>
            <option value="AGRICULTURA E MEIO AMBIENTE">AGRICULTURA E MEIO AMBIENTE</option>
            <option value="ASSIST√äNCIA SOCIAL">ASSIST√äNCIA SOCIAL</option>
            <option value="COMUNICA√á√ÉO">COMUNICA√á√ÉO</option>
            <option value="CULTURA, ESPORTE E LAZER">CULTURA, ESPORTE E LAZER</option>
            <option value="EDUCA√á√ÉO">EDUCA√á√ÉO</option>
            <option value="GOVERNOO">GOVERNOO</option>
            <option value="INFRAESTRUTURA E SERVI√áOS">INFRAESTRUTURA E SERVI√áOS</option>
            <option value="PLANEJAMENTO">PLANEJAMENTO</option>
            <option value="SA√öDE">SA√öDE</option>
          </select>
        </div>
        <div>
          <label>POSTO</label>
          <select id="rel-posto">
            <option value="">TODOS</option>
            <option value="POSTO MATINA">POSTO MATINA</option>
            <option value="POSTO VICTOR">POSTO VICTOR</option>
          </select>
        </div>
        <div>
          <label>COMBUST√çVEL</label>
          <select id="rel-combustivel">
            <option value="">TODOS</option>
            <option value="GASOLINA">GASOLINA</option>
            <option value="ALCOOL">√ÅLCOOL</option>
            <option value="DIESEL">DIESEL</option>
          </select>
        </div>
        <div>
          <label>PLACA</label>
          <input type="text" id="rel-placa" placeholder="ABC-1234">
        </div>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
        <button class="btn-save" onclick="gerarRelatorio()">üìä GERAR</button>
        <button class="btn-save" style="background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);" onclick="limparFiltros()">üîÑ LIMPAR</button>
      </div>
      <button class="btn-save" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%); margin-top:5px;" onclick="window.print()">üñ®Ô∏è IMPRIMIR</button>
    </div>
    
    <!-- Relat√≥rios -->
    <div id="relatorio-container"></div>
  </div>
  
  <div id="tab-pendentes" style="display:none;">
    <div class="card">
      <h3>‚è≥ SOLICITA√á√ïES PENDENTES DE APROVA√á√ÉO</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>DATA</th>
              <th>PLACA</th>
              <th>POSTO</th>
              <th>SECRETARIA</th>
              <th>MOTORISTA</th>
              <th>COMBUST√çVEL</th>
              <th>LITROS</th>
              <th>VALOR</th>
              <th>SOLICITANTE</th>
              <th class="no-print">A√á√ïES</th>
            </tr>
          </thead>
          <tbody id="pendentes-body"></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div id="tab-users" style="display:none;">
    <div class="card">
      <h3>üöó CADASTRO DE VE√çCULOS</h3>
      <div class="grid-form">
        <div>
          <label>PLACA *</label>
          <input type="text" id="vei-placa" placeholder="ABC-1234" maxlength="8">
        </div>
        <div>
          <label>MODELO</label>
          <input type="text" id="vei-modelo" placeholder="EX: GOL, SAVEIRO">
        </div>
        <div>
          <label>SECRETARIA</label>
          <select id="vei-sec">
            <option value="">SELECIONE...</option>
            <option>ADMINISTRA√á√ÉO E FINAN√áAS</option>
            <option>AGRICULTURA E MEIO AMBIENTE</option>
            <option>ASSIST√äNCIA SOCIAL</option>
            <option>EDUCA√á√ÉO</option>
            <option>SA√öDE</option>
            <option>INFRAESTRUTURA E SERVI√áOS</option>
            <option>AVULSOS / GERAL</option>
          </select>
        </div>
        <div>
          <label>MOTORISTA PADR√ÉO</label>
          <input type="text" id="vei-motorista" placeholder="NOME DO MOTORISTA">
        </div>
        <div>
          <label>TIPO DE COMBUST√çVEL</label>
          <select id="vei-combustivel">
            <option value="GASOLINA">GASOLINA</option>
            <option value="ALCOOL">√ÅLCOOL</option>
            <option value="DIESEL">DIESEL</option>
            <option value="FLEX">FLEX (GASOLINA/√ÅLCOOL)</option>
          </select>
        </div>
        <div>
          <label>ANO</label>
          <input type="number" id="vei-ano" placeholder="2020" min="1980" max="2030">
        </div>
      </div>
      <button class="btn-save" onclick="salvarVeiculo()" style="background: linear-gradient(135deg, var(--success) 0%, #16a34a 100%);">‚ûï SALVAR VE√çCULO</button>
    </div>
    
    <div class="card">
      <h3>üìã VE√çCULOS CADASTRADOS</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>PLACA</th>
              <th>MODELO</th>
              <th>SECRETARIA</th>
              <th>MOTORISTA PADR√ÉO</th>
              <th>COMBUST√çVEL</th>
              <th>ANO</th>
              <th class="no-print">A√á√ïES</th>
            </tr>
          </thead>
          <tbody id="veiculos-body"></tbody>
        </table>
      </div>
    </div>
    
    <div class="card">
      <h3>üí≤ TABELA DE PRE√áOS</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
        <div>
          <label>GASOLINA (R$/L)</label>
          <input type="number" id="p-gas" placeholder="0.00" step="0.01">
        </div>
        <div>
          <label>√ÅLCOOL (R$/L)</label>
          <input type="number" id="p-alc" placeholder="0.00" step="0.01">
        </div>
        <div>
          <label>DIESEL (R$/L)</label>
          <input type="number" id="p-die" placeholder="0.00" step="0.01">
        </div>
      </div>
      <button class="btn-save" onclick="salvarPrecos()" style="background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);">üíæ ATUALIZAR PRE√áOS</button>
    </div>
    
    <div class="card">
      <h3>üë• GEST√ÉO DE USU√ÅRIOS</h3>
      <div class="grid-form">
        <div>
          <label>USU√ÅRIO</label>
          <input type="text" id="new-user" placeholder="LOGIN">
        </div>
        <div>
          <label>SENHA</label>
          <input type="password" id="new-pass" placeholder="SENHA">
        </div>
        <div>
          <label>PERFIL</label>
          <select id="new-role" onchange="toggleUserFields()">
            <option value="admin">ADMIN (TOTAL)</option>
            <option value="secretarios">SECRET√ÅRIO (RESTRITO)</option>
          </select>
        </div>
        <div>
          <label>COMBUST√çVEL PERMITIDO</label>
          <select id="new-combustivel">
            <option value="GASOLINA">GASOLINA</option>
            <option value="ALCOOL">√ÅLCOOL</option>
            <option value="DIESEL">DIESEL</option>
            <option value="todos">TODOS</option>
          </select>
        </div>
        <div id="field-limit">
          <label>LIMITE MENSAL (R$)</label>
          <input type="number" id="new-limit" placeholder="0.00" step="0.01">
        </div>
        <div id="field-sec">
          <label>SECRETARIA VINCULADA</label>
          <select id="new-sec-vinc">
            <option value="">SELECIONE...</option>
            <option>ADMINISTRA√á√ÉO E FINAN√áAS</option>
            <option>AGRICULTURA E MEIO AMBIENTE</option>
            <option>ASSIST√äNCIA SOCIAL</option>
            <option>EDUCA√á√ÉO</option>
            <option>SA√öDE</option>
            <option>INFRAESTRUTURA E SERVI√áOS</option>
            <option>AVULSOS / GERAL</option>
          </select>
        </div>
      </div>
      <button class="btn-save" onclick="addUsuario()" style="background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);">‚ûï SALVAR USU√ÅRIO</button>
    </div>
    
    <div class="card">
      <h3>üìã USU√ÅRIOS CADASTRADOS</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>USU√ÅRIO</th>
              <th>PERFIL</th>
              <th>COMB. PERMITIDO</th>
              <th>V√çNCULO</th>
              <th>LIMITE</th>
              <th class="no-print">A√á√ïES</th>
            </tr>
          </thead>
          <tbody id="user-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDsEQ8L_hWgacZ8xweY3DR9OYt2t151kZE",
    authDomain: "tabela-gasolina.firebaseapp.com",
    databaseURL: "https://tabela-gasolina-default-rtdb.firebaseio.com", 
    projectId: "tabela-gasolina"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  
  const STATUS = {
    AGUARDANDO: 'AGUARDANDO',
    AUTORIZADO: 'AUTORIZADO',
    REJEITADO: 'REJEITADO'
  };
  
  const LIMITES_KM = {
    GASOLINA: 7,
    DIESEL: 2.5,
    ALCOOL: 5
  };
  
  let cache = [];
  let veiculos = [];
  let userLimit = 0;
  let userRole = "";
  let loginUser = "";
  let userSecretaria = "";
  let usuarioData = {};
  let precos = { GASOLINA: 6, ALCOOL: 4, DIESEL: 6 };
  let chartSec = null;
  let chartVec = null;
  
  db.ref('config/precos').on('value', snap => {
    if (snap.val()) {
      precos = snap.val();
      document.getElementById('p-gas').value = precos.GASOLINA;
      document.getElementById('p-alc').value = precos.ALCOOL;
      document.getElementById('p-die').value = precos.DIESEL;
    }
  });
  
  db.ref('veiculos').on('value', snap => {
    veiculos = [];
    snap.forEach(item => {
      let v = item.val();
      v.id = item.key;
      veiculos.push(v);
    });
  });
  
  function logar() {
    const u = document.getElementById('user').value.toLowerCase().trim();
    const s = document.getElementById('senha').value.trim();
    
    if (!u || !s) {
      mostrarNotificacao("PREENCHA USU√ÅRIO E SENHA!", "error");
      return;
    }
    
    if (u === "master" && s === "1234") {
      return entrar("master", "admin", 0, "", { 
        combustivelLiberado: "todos",
        senha: "1234",
        role: "admin"
      });
    }
    
    db.ref('usuarios/' + u).once('value', snap => {
      const user = snap.val();
      if (user && user.senha === s) {
        const dadosUsuario = {
          combustivelLiberado: user.combustivelLiberado || "todos",
          senha: user.senha,
          role: user.role,
          limite: user.limite || 0,
          secretariaVinculada: user.secretariaVinculada || ""
        };
        entrar(u, user.role, user.limite || 0, user.secretariaVinculada || "", dadosUsuario);
      } else {
        mostrarNotificacao("USU√ÅRIO OU SENHA INCORRETOS!", "error");
      }
    }).catch(error => {
      console.error("Erro ao buscar usu√°rio:", error);
      mostrarNotificacao("ERRO AO CONECTAR AO BANCO DE DADOS!", "error");
    });
  }
  
  function entrar(u, role, limit, sec, dadosExtras) {
    loginUser = u;
    userRole = role;
    userLimit = limit;
    userSecretaria = sec;
    usuarioData = dadosExtras || {};
    
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').classList.remove('blurred');
    
    const isMaster = (u === "master");
    const isAdmin = (role === "admin");
    
    document.getElementById('btn-tab-users').style.display = isMaster ? 'block' : 'none';
    document.getElementById('btn-tab-pendentes').style.display = (isMaster || isAdmin) ? 'block' : 'none';
    
    if (role === 'secretarios' && sec !== "") {
      document.getElementById('f-sec').value = sec;
      document.getElementById('f-sec').disabled = true;
    }
    
    mostrarNotificacao(`‚úÖ BEM-VINDO, ${u.toUpperCase()}!`, "success");
    
    setTimeout(() => {
      renderizar();
    }, 100);
  }
  
  function calc() {
    const tipo = document.getElementById('f-tipo').value;
    const litros = parseFloat(document.getElementById('f-lit').value) || 0;
    const valorTotal = litros * precos[tipo];
    document.getElementById('f-val').value = "R$ " + valorTotal.toFixed(2);
  }
  
  function calcularMedia(abastecimento) {
    const historico = cache
      .filter(v => 
        v.placa === abastecimento.placa && 
        v.timestamp < abastecimento.timestamp &&
        v.status === STATUS.AUTORIZADO
      )
      .sort((a, b) => b.timestamp - a.timestamp);
    
    if (historico.length === 0 || abastecimento.litro <= 0) {
      return 0;
    }
    
    const kmAnterior = historico[0].km;
    const kmAtual = abastecimento.km;
    const litros = abastecimento.litro;
    
    return (kmAtual - kmAnterior) / litros;
  }
  
  function validarAbastecimento(dados) {
    const erros = [];
    
    if (!dados.placa || dados.placa.length < 7) {
      erros.push("‚ùå PLACA INV√ÅLIDA");
    }
    if (!dados.motorista || dados.motorista.trim() === "") {
      erros.push("‚ùå MOTORISTA OBRIGAT√ìRIO");
    }
    if (!dados.data) {
      erros.push("‚ùå DATA OBRIGAT√ìRIA");
    }
    const hoje = new Date().toISOString().split('T')[0];
    if (dados.data > hoje) {
      erros.push("‚ùå DATA N√ÉO PODE SER FUTURA");
    }
    if (dados.litro <= 0) {
      erros.push("‚ùå LITROS DEVE SER MAIOR QUE ZERO");
    }
    if (dados.km <= 0) {
      erros.push("‚ùå KM DEVE SER MAIOR QUE ZERO");
    }
    
    const ultimoAbast = cache
      .filter(x => x.placa === dados.placa && x.status === STATUS.AUTORIZADO)
      .sort((a, b) => b.timestamp - a.timestamp)[0];
    if (ultimoAbast && dados.km < ultimoAbast.km) {
      erros.push(`‚ùå KM ATUAL (${dados.km}) N√ÉO PODE SER MENOR QUE O √öLTIMO REGISTRADO (${ultimoAbast.km})`);
    }
    return erros;
  }
  
  function processar() {
    const dados = {
      placa: document.getElementById('f-placa').value.toUpperCase().trim(),
      posto: document.getElementById('f-posto').value,
      motorista: document.getElementById('f-mot').value.toUpperCase().trim(),
      data: document.getElementById('f-data').value,
      tipo: document.getElementById('f-tipo').value,
      secretaria: document.getElementById('f-sec').value,
      litro: parseFloat(document.getElementById('f-lit').value) || 0,
      km: parseFloat(document.getElementById('f-km').value) || 0
    };
    
    const erros = validarAbastecimento(dados);
    if (erros.length > 0) {
      mostrarNotificacao(erros.join("\n"), "error");
      return;
    }
    
    if (userRole === 'admin') {
      if (usuarioData.combustivelLiberado !== 'todos' && usuarioData.combustivelLiberado !== dados.tipo) {
        mostrarNotificacao("‚õî VOC√ä N√ÉO TEM PERMISS√ÉO PARA LIBERAR ESTE TIPO DE COMBUST√çVEL!", "error");
        return;
      }
    }
    
    dados.valor = dados.litro * precos[dados.tipo];
    
    const abastecimentoHoje = cache.find(x => 
      x.placa === dados.placa && 
      x.data === dados.data && 
      x.status !== STATUS.REJEITADO
    );
    if (abastecimentoHoje) {
      if (!confirm("‚ö†Ô∏è O VE√çCULO J√Å ABASTECEU HOJE. DESEJA CONTINUAR?")) {
        return;
      }
    }
    
    if (userRole === 'secretarios') {
      const gastoComprometido = cache
        .filter(x => 
          (x.status === STATUS.AUTORIZADO || x.status === STATUS.AGUARDANDO) &&
          x.secretaria === userSecretaria
        )
        .reduce((acc, item) => acc + item.valor, 0);
      
      const saldoDisponivel = userLimit - gastoComprometido;
      if (dados.valor > saldoDisponivel) {
        mostrarNotificacao(
          `üö´ LIMITE EXCEDIDO!\nüí∞ SOLICITADO: R$ ${dados.valor.toFixed(2)}\n‚úÖ SALDO DISPON√çVEL: R$ ${saldoDisponivel.toFixed(2)}`,
          "error"
        );
        return;
      }
    }
    
    const status = (loginUser === 'master' || userRole === 'admin')
      ? STATUS.AUTORIZADO
      : STATUS.AGUARDANDO;
    
    db.ref('abastecimentos').push({
      ...dados,
      status: status,
      solicitadoPor: loginUser.toUpperCase(),
      timestamp: Date.now()
    }).then(() => {
      mostrarNotificacao(
        status === STATUS.AUTORIZADO
          ? "‚úÖ ABASTECIMENTO REGISTRADO COM SUCESSO!"
          : "üì§ SOLICITA√á√ÉO ENVIADA PARA APROVA√á√ÉO!",
        "success"
      );
      limparFormulario();
    }).catch(error => {
      mostrarNotificacao("‚ùå ERRO AO SALVAR: " + error.message, "error");
    });
  }
  
  function aprovar(id) {
    db.ref('abastecimentos/' + id).update({ 
      status: STATUS.AUTORIZADO,
      aprovadoPor: loginUser.toUpperCase(),
      aprovadoEm: Date.now()
    }).then(() => {
      mostrarNotificacao("‚úÖ ABASTECIMENTO APROVADO!", "success");
    });
  }
  
  function rejeitar(id) {
    if (!confirm("‚ö†Ô∏è TEM CERTEZA QUE DESEJA REJEITAR ESTA SOLICITA√á√ÉO?")) return;
    const motivo = prompt("üìù MOTIVO DA REJEI√á√ÉO (OPCIONAL):");
    db.ref('abastecimentos/' + id).update({
      status: STATUS.REJEITADO,
      rejeitadoPor: loginUser.toUpperCase(),
      rejeitadoEm: Date.now(),
      motivoRejeicao: motivo || "N√ÉO INFORMADO"
    }).then(() => {
      mostrarNotificacao("‚ùå SOLICITA√á√ÉO REJEITADA!", "success");
    });
  }
  
  function deletar(id) {
    if (!confirm("‚ö†Ô∏è TEM CERTEZA QUE DESEJA EXCLUIR ESTE REGISTRO?\n\n‚õî ESTA A√á√ÉO N√ÉO PODE SER DESFEITA!")) return;
    db.ref('abastecimentos/' + id).remove().then(() => {
      mostrarNotificacao("üóëÔ∏è REGISTRO EXCLU√çDO COM SUCESSO!", "success");
    });
  }
  
  function renderizar() {
    if (!loginUser) return;
    
    atualizarStatusFinanceiro();
    atualizarEstatisticas();
    atualizarRelatorio();
    atualizarGraficos();
    atualizarPendentes();
  }
  
  function atualizarEstatisticas() {
    const container = document.getElementById('stats-container');
    const dadosAutorizados = cache.filter(x => x.status === STATUS.AUTORIZADO);
    
    const totalGasto = dadosAutorizados.reduce((acc, item) => acc + item.valor, 0);
    const totalLitros = dadosAutorizados.reduce((acc, item) => acc + item.litro, 0);
    const totalAbastecimentos = dadosAutorizados.length;
    const veiculosUnicos = [...new Set(dadosAutorizados.map(x => x.placa))].length;
    
    container.innerHTML = `
      <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <h4>TOTAL GASTO</h4>
        <div class="stat-value">R$ ${totalGasto.toFixed(2)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚õΩ</div>
        <h4>TOTAL LITROS</h4>
        <div class="stat-value">${totalLitros.toFixed(1)} L</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <h4>ABASTECIMENTOS</h4>
        <div class="stat-value">${totalAbastecimentos}</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üöó</div>
        <h4>VE√çCULOS</h4>
        <div class="stat-value">${veiculosUnicos}</div>
      </div>
    `;
  }
  
  function atualizarStatusFinanceiro() {
    const statusDiv = document.getElementById('status-financeiro');
    if (userRole === 'secretarios') {
      const gasto = cache.filter(x => 
        (x.status === STATUS.AUTORIZADO || x.status === STATUS.AGUARDANDO) &&
        x.secretaria === userSecretaria
      ).reduce((acc, item) => acc + item.valor, 0);
      
      const saldo = userLimit - gasto;
      const percentual = (gasto / userLimit * 100).toFixed(1);
      statusDiv.innerHTML = `
        üìä ${userSecretaria}<br>
        üí∞ LIMITE: R$ ${userLimit.toFixed(2)} | 
        üìâ GASTO: R$ ${gasto.toFixed(2)} (${percentual}%) | 
        ‚úÖ SALDO: R$ ${saldo.toFixed(2)}
      `;
      if (saldo < userLimit * 0.2) {
        statusDiv.style.background = 'linear-gradient(135deg, var(--danger) 0%, #dc2626 100%)';
      } else if (saldo < userLimit * 0.5) {
        statusDiv.style.background = 'linear-gradient(135deg, var(--warning) 0%, #f97316 100%)';
      } else {
        statusDiv.style.background = 'linear-gradient(135deg, var(--primary) 0%, #1e293b 100%)';
      }
    } else {
      const totalGasto = cache.filter(x => x.status === STATUS.AUTORIZADO)
        .reduce((acc, item) => acc + item.valor, 0);
      const totalPendente = cache.filter(x => x.status === STATUS.AGUARDANDO)
        .reduce((acc, item) => acc + item.valor, 0);
      const pendentesQtd = cache.filter(x => x.status === STATUS.AGUARDANDO).length;
      statusDiv.innerHTML = `
        üë§ OPERADOR: ${loginUser.toUpperCase()} 
        <span class="badge badge-success">${userRole.toUpperCase()}</span><br>
        üí∞ TOTAL APROVADO: R$ ${totalGasto.toFixed(2)} | 
        ‚è≥ PENDENTE: R$ ${totalPendente.toFixed(2)} (${pendentesQtd})
      `;
    }
  }
  
  function atualizarRelatorio() {
    let listaSecs = [...new Set(cache.map(x => x.secretaria))].sort();
    if (userRole === 'secretarios') {
      listaSecs = [userSecretaria];
    }
    const container = document.getElementById('relatorio-container');
    container.innerHTML = "";
    listaSecs.forEach(sec => {
      const itens = cache.filter(x => x.secretaria === sec && x.status !== STATUS.REJEITADO)
        .sort((a, b) => b.timestamp - a.timestamp);
      if (itens.length === 0) return;
      let linhas = "";
      itens.forEach(d => {
        const media = calcularMedia(d);
        const limiteMinimo = LIMITES_KM[d.tipo] || 0;
        const alerta = (media > 0 && media < limiteMinimo) ? "alerta-media" : "";
        linhas += `<tr class="${alerta}">
          <td>${d.data.split('-').reverse().join('/')}</td>
          <td><b>${d.placa}</b></td>
          <td>${d.posto || '---'}</td>
          <td>${d.motorista}</td>
          <td>${d.tipo}</td>
          <td><span class="status-tag status-${d.status.toLowerCase()}">${d.status}</span></td>
          <td>${d.km.toLocaleString('pt-BR')}</td>
          <td>${d.litro.toFixed(2)} L</td>
          <td ${alerta ? 'style="color:#b91c1c;font-weight:bold;"' : ''}>
            ${media > 0 ? media.toFixed(2) + ' km/l' + (alerta ? ' ‚ö†Ô∏è' : '') : '---'}
          </td>
          <td>R$ ${d.valor.toFixed(2)}</td>
          <td class="no-print">
            ${(d.status === STATUS.AGUARDANDO && (loginUser === 'master' || userRole === 'admin'))
              ? `<button class="btn-action btn-aprovar" onclick="aprovar('${d.id}')">‚úÖ</button>
                 <button class="btn-action btn-rejeitar" onclick="rejeitar('${d.id}')">‚ùå</button>` 
              : ''}
            ${(loginUser === 'master' || userRole === 'admin')
              ? `<button class="btn-action btn-deletar" onclick="deletar('${d.id}')">üóëÔ∏è</button>` 
              : ''}
          </td>
        </tr>`;
      });
      const totalSec = itens.reduce((acc, item) => acc + item.valor, 0);
      const totalLitros = itens.reduce((acc, item) => acc + item.litro, 0);
      container.innerHTML += `
        <div class="section-header">
          ${sec} | üí∞ R$ ${totalSec.toFixed(2)} | ‚õΩ ${totalLitros.toFixed(2)} L | üìä ${itens.length} abastecimentos
        </div>
        <div class="card">
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>DATA</th>
                  <th>PLACA</th>
                  <th>POSTO</th>
                  <th>MOTORISTA</th>
                  <th>COMBUST√çVEL</th>
                  <th>STATUS</th>
                  <th>KM</th>
                  <th>LITROS</th>
                  <th>M√âDIA</th>
                  <th>VALOR</th>
                  <th class="no-print">A√á√ïES</th>
                </tr>
              </thead>
              <tbody>${linhas}</tbody>
            </table>
          </div>
        </div>
      `;
    });
  }
  
  function atualizarPendentes() {
    const pendentes = cache.filter(x => x.status === STATUS.AGUARDANDO);
    const tbody = document.getElementById('pendentes-body');
    if (pendentes.length === 0) {
      tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:40px;">‚úÖ NENHUMA SOLICITA√á√ÉO PENDENTE</td></tr>';
      return;
    }
    tbody.innerHTML = pendentes.map(d => `
      <tr>
        <td>${d.data.split('-').reverse().join('/')}</td>
        <td><b>${d.placa}</b></td>
        <td>${d.posto || '---'}</td>
        <td>${d.secretaria}</td>
        <td>${d.motorista}</td>
        <td>${d.tipo}</td>
        <td>${d.litro.toFixed(2)} L</td>
        <td>R$ ${d.valor.toFixed(2)}</td>
        <td>${d.solicitadoPor}</td>
        <td class="no-print">
          <button class="btn-action btn-aprovar" onclick="aprovar('${d.id}')">‚úÖ APROVAR</button>
          <button class="btn-action btn-rejeitar" onclick="rejeitar('${d.id}')">‚ùå REJEITAR</button>
        </td>
      </tr>
    `).join('');
  }
  
  function atualizarGraficos() {
    const dadosGrafico = cache.filter(x => {
      if (userRole === 'secretarios') {
        return x.status === STATUS.AUTORIZADO && x.secretaria === userSecretaria;
      }
      return x.status === STATUS.AUTORIZADO;
    });
    if (dadosGrafico.length === 0) return;
    
    const secMap = {};
    dadosGrafico.forEach(d => {
      secMap[d.secretaria] = (secMap[d.secretaria] || 0) + d.valor;
    });
    if (chartSec) chartSec.destroy();
    chartSec = new Chart(document.getElementById('chartSec'), {
      type: 'doughnut',
      data: {
        labels: Object.keys(secMap),
        datasets: [{
          data: Object.values(secMap),
          backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#64748b']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.label + ': R$ ' + context.parsed.toFixed(2);
              }
            }
          }
        }
      }
    });
    
    const vecMap = {};
    dadosGrafico.forEach(d => {
      vecMap[d.placa] = (vecMap[d.placa] || 0) + d.valor;
    });
    const sortedVec = Object.entries(vecMap)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);
    if (chartVec) chartVec.destroy();
    chartVec = new Chart(document.getElementById('chartVec'), {
      type: 'bar',
      data: {
        labels: sortedVec.map(x => x[0]),
        datasets: [{
          label: 'GASTO (R$)',
          data: sortedVec.map(x => x[1]),
          backgroundColor: '#3b82f6',
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                return 'R$ ' + context.parsed.y.toFixed(2);
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return 'R$ ' + value.toFixed(0);
              }
            }
          }
        }
      }
    });
  }
  
  function toggleUserFields() {
    const role = document.getElementById('new-role').value;
    document.getElementById('field-limit').style.display = (role === 'secretarios') ? 'block' : 'none';
    document.getElementById('field-sec').style.display = (role === 'secretarios') ? 'block' : 'none';
  }
  
  function toggleEditFields() {
    const role = document.getElementById('edit-role').value;
    document.getElementById('edit-field-limit').style.display = (role === 'secretarios') ? 'block' : 'none';
    document.getElementById('edit-field-sec').style.display = (role === 'secretarios') ? 'block' : 'none';
  }
  
  function addUsuario() {
    const usuario = document.getElementById('new-user').value.toLowerCase().trim();
    const senha = document.getElementById('new-pass').value.trim();
    const role = document.getElementById('new-role').value;
    const combustivel = document.getElementById('new-combustivel').value;
    const limite = parseFloat(document.getElementById('new-limit').value) || 0;
    const secretaria = document.getElementById('new-sec-vinc').value;
    
    if (!usuario || !senha) {
      mostrarNotificacao("‚ùå PREENCHA USU√ÅRIO E SENHA!", "error");
      return;
    }
    
    if (usuario.length < 3) {
      mostrarNotificacao("‚ùå USU√ÅRIO DEVE TER NO M√çNIMO 3 CARACTERES!", "error");
      return;
    }
    
    if (senha.length < 4) {
      mostrarNotificacao("‚ùå SENHA DEVE TER NO M√çNIMO 4 CARACTERES!", "error");
      return;
    }
    
    if (role === 'secretarios' && (!limite || !secretaria)) {
      mostrarNotificacao("‚ùå PREENCHA LIMITE E SECRETARIA PARA SECRET√ÅRIOS!", "error");
      return;
    }
    
    db.ref('usuarios/' + usuario).set({
      senha: senha,
      role: role,
      combustivelLiberado: combustivel,
      limite: limite,
      secretariaVinculada: secretaria
    }).then(() => {
      mostrarNotificacao("‚úÖ USU√ÅRIO SALVO COM SUCESSO!", "success");
      document.getElementById('new-user').value = '';
      document.getElementById('new-pass').value = '';
      document.getElementById('new-limit').value = '';
      document.getElementById('new-sec-vinc').value = '';
      listUsuarios();
    });
  }
  
  function listUsuarios() {
    db.ref('usuarios').once('value', snap => {
      const tbody = document.getElementById('user-body');
      tbody.innerHTML = "";
      snap.forEach(c => {
        const u = c.val();
        tbody.innerHTML += `
          <tr>
            <td><b>${c.key.toUpperCase()}</b></td>
            <td><span class="badge ${u.role === 'admin' ? 'badge-success' : 'badge-warning'}">${u.role === 'admin' ? 'ADMIN' : 'SECRET√ÅRIO'}</span></td>
            <td>${u.combustivelLiberado || 'TODOS'}</td>
            <td>${u.secretariaVinculada || 'TODAS'}</td>
            <td><b>R$ ${(u.limite || 0).toFixed(2)}</b></td>
            <td class="no-print">
              <button class="btn-action" style="background:var(--accent);color:white;" onclick="editarUsuario('${c.key}')">‚úèÔ∏è EDITAR</button>
              <button class="btn-action btn-deletar" onclick="if(confirm('‚ö†Ô∏è EXCLUIR USU√ÅRIO ${c.key.toUpperCase()}?\\n\\n‚õî ESTA A√á√ÉO N√ÉO PODE SER DESFEITA!')) { db.ref('usuarios/${c.key}').remove().then(() => { mostrarNotificacao('‚úÖ USU√ÅRIO EXCLU√çDO!', 'success'); listUsuarios(); }); }">
                üóëÔ∏è EXCLUIR
              </button>
            </td>
          </tr>
        `;
      });
    });
  }
  
  function editarUsuario(id) {
    db.ref('usuarios/' + id).once('value', snap => {
      const u = snap.val();
      document.getElementById('edit-user').value = id.toUpperCase();
      document.getElementById('edit-pass').value = u.senha;
      document.getElementById('edit-combustivel').value = u.combustivelLiberado || 'todos';
      document.getElementById('edit-role').value = u.role;
      document.getElementById('edit-limit').value = u.limite || "";
      document.getElementById('edit-sec-vinc').value = u.secretariaVinculada || "";
      toggleEditFields();
      document.getElementById('modal-edit').style.display = 'flex';
    });
  }
  
  function fecharModal() {
    document.getElementById('modal-edit').style.display = 'none';
  }
  
  function salvarEdicao() {
    const id = document.getElementById('edit-user').value.toLowerCase();
    const novaPass = document.getElementById('edit-pass').value;
    const combus = document.getElementById('edit-combustivel').value;
    const role = document.getElementById('edit-role').value;
    const limite = parseFloat(document.getElementById('edit-limit').value) || 0;
    const secretaria = document.getElementById('edit-sec-vinc').value;
    
    if (novaPass.length < 4) {
      mostrarNotificacao("‚ùå SENHA DEVE TER NO M√çNIMO 4 CARACTERES!", "error");
      return;
    }
    
    const dadosAtualizados = { senha: novaPass, combustivelLiberado: combus, role: role };
    if (role === 'secretarios') {
      if (!limite || !secretaria) {
        mostrarNotificacao("‚ùå PREENCHA LIMITE E SECRETARIA PARA SECRET√ÅRIOS!", "error");
        return;
      }
      dadosAtualizados.limite = limite;
      dadosAtualizados.secretariaVinculada = secretaria;
    } else {
      dadosAtualizados.limite = 0;
      dadosAtualizados.secretariaVinculada = "";
    }
    
    db.ref('usuarios/' + id).update(dadosAtualizados).then(() => {
      mostrarNotificacao("‚úÖ USU√ÅRIO ATUALIZADO COM SUCESSO!", "success");
      fecharModal();
      listUsuarios();
    });
  }
  
  function abrirAlterarSenha() {
    const nova = prompt("üîê Digite sua nova senha:");
    if (!nova) return;
    if (nova.length < 4) {
      mostrarNotificacao("‚ùå SENHA DEVE TER NO M√çNIMO 4 CARACTERES!", "error");
      return;
    }
    
    if (loginUser === 'master') {
      db.ref('config/masterPassword').set(nova).then(() => {
        mostrarNotificacao("‚úÖ SENHA DO MASTER ALTERADA COM SUCESSO!", "success");
      });
    } else {
      db.ref('usuarios/' + loginUser).update({ senha: nova }).then(() => {
        mostrarNotificacao("‚úÖ SENHA ALTERADA COM SUCESSO!", "success");
      }).catch(err => {
        mostrarNotificacao("‚ùå ERRO: " + err.message, "error");
      });
    }
  }
  
  function salvarPrecos() {
    const gas = parseFloat(document.getElementById('p-gas').value);
    const alc = parseFloat(document.getElementById('p-alc').value);
    const die = parseFloat(document.getElementById('p-die').value);
    if (!gas || !alc || !die) {
      mostrarNotificacao("‚ùå PREENCHA TODOS OS PRE√áOS!", "error");
      return;
    }
    if (gas <= 0 || alc <= 0 || die <= 0) {
      mostrarNotificacao("‚ùå PRE√áOS DEVEM SER MAIORES QUE ZERO!", "error");
      return;
    }
    db.ref('config/precos').set({
      GASOLINA: gas,
      ALCOOL: alc,
      DIESEL: die
    }).then(() => {
      mostrarNotificacao("üí≤ PRE√áOS ATUALIZADOS COM SUCESSO!", "success");
    });
  }
  
  function limparFormulario() {
    ['f-placa', 'f-mot', 'f-km', 'f-lit', 'f-val'].forEach(id => {
      document.getElementById(id).value = "";
    });
    document.getElementById('f-data').valueAsDate = new Date();
  }
  
  function limparFiltros() {
    document.getElementById('rel-data-inicial').value = '';
    document.getElementById('rel-data-final').value = '';
    document.getElementById('rel-secretaria').value = '';
    document.getElementById('rel-posto').value = '';
    document.getElementById('rel-combustivel').value = '';
    document.getElementById('rel-placa').value = '';
    atualizarRelatorio();
    mostrarNotificacao("üîÑ FILTROS LIMPOS!", "info");
  }
  
  function sugerir(valor) {
    const placa = valor.toUpperCase().trim();
    
    // Busca no cadastro de ve√≠culos
    const veiculo = veiculos.find(v => v.placa === placa);
    if (veiculo) {
      document.getElementById('f-mot').value = veiculo.motorista || '';
      document.getElementById('f-sec').value = veiculo.secretaria || '';
      document.getElementById('f-tipo').value = veiculo.combustivel === 'FLEX' ? 'GASOLINA' : veiculo.combustivel;
      calc();
      return;
    }
    
    // Busca no hist√≥rico de abastecimentos
    const ultimoAbast = cache.filter(x => x.placa === placa)
      .sort((a, b) => b.timestamp - a.timestamp)[0];
    if (ultimoAbast) {
      document.getElementById('f-mot').value = ultimoAbast.motorista;
      document.getElementById('f-sec').value = ultimoAbast.secretaria;
      document.getElementById('f-tipo').value = ultimoAbast.tipo;
      calc();
    }
  }
  
  function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('tab-geral').style.display = 'none';
    document.getElementById('tab-pendentes').style.display = 'none';
    document.getElementById('tab-users').style.display = 'none';
    if (tab === 'geral') {
      document.getElementById('tab-geral').style.display = 'block';
      document.getElementById('btn-tab-geral').classList.add('active');
    } else if (tab === 'pendentes') {
      document.getElementById('tab-pendentes').style.display = 'block';
      document.getElementById('btn-tab-pendentes').classList.add('active');
      atualizarPendentes();
    } else if (tab === 'usuarios') {
      document.getElementById('tab-users').style.display = 'block';
      document.getElementById('btn-tab-users').classList.add('active');
      listUsuarios();
      listVeiculos();
    }
  }
  
  function gerarRelatorio() {
    const dataInicial = document.getElementById('rel-data-inicial').value;
    const dataFinal = document.getElementById('rel-data-final').value;
    const secretaria = document.getElementById('rel-secretaria').value;
    const posto = document.getElementById('rel-posto').value;
    const combustivel = document.getElementById('rel-combustivel').value;
    const placa = document.getElementById('rel-placa').value.toUpperCase().trim();
    
    let registros = cache.filter(x => x.status === STATUS.AUTORIZADO);
    
    if (dataInicial) {
      registros = registros.filter(r => r.data >= dataInicial);
    }
    if (dataFinal) {
      registros = registros.filter(r => r.data <= dataFinal);
    }
    if (secretaria) {
      registros = registros.filter(r => r.secretaria === secretaria);
    }
    if (posto) {
      registros = registros.filter(r => r.posto === posto);
    }
    if (combustivel) {
      registros = registros.filter(r => r.tipo === combustivel);
    }
    if (placa) {
      registros = registros.filter(r => r.placa.includes(placa));
    }
    
    exibirRelatorioFiltrado(registros);
  }
  
  function exibirRelatorioFiltrado(registros) {
    const container = document.getElementById('relatorio-container');
    
    if (registros.length === 0) {
      container.innerHTML = `
        <div class="card" style="text-align:center; padding:60px 20px;">
          <div style="font-size:64px; margin-bottom:20px;">üì≠</div>
          <h3>NENHUM REGISTRO ENCONTRADO</h3>
          <p style="color:#64748b;">Ajuste os filtros e tente novamente</p>
        </div>
      `;
      return;
    }
    
    const totalGeral = registros.reduce((acc, r) => acc + r.valor, 0);
    const totalLitros = registros.reduce((acc, r) => acc + r.litro, 0);
    
    const gastosPorTipo = {};
    registros.forEach(r => {
      gastosPorTipo[r.tipo] = (gastosPorTipo[r.tipo] || 0) + r.valor;
    });
    
    let html = `
      <div class="card">
        <h3>üìä RESUMO DO RELAT√ìRIO FILTRADO</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">üìã</div>
            <h4>TOTAL DE REGISTROS</h4>
            <div class="stat-value">${registros.length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚õΩ</div>
            <h4>TOTAL EM LITROS</h4>
            <div class="stat-value">${totalLitros.toFixed(2)} L</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üí∞</div>
            <h4>TOTAL EM VALOR</h4>
            <div class="stat-value">R$ ${totalGeral.toFixed(2)}</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üöó</div>
            <h4>VE√çCULOS</h4>
            <div class="stat-value">${[...new Set(registros.map(r => r.placa))].length}</div>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>üìÑ DETALHAMENTO</h3>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>DATA</th>
                <th>PLACA</th>
                <th>POSTO</th>
                <th>SECRETARIA</th>
                <th>MOTORISTA</th>
                <th>COMBUST√çVEL</th>
                <th>KM</th>
                <th>LITROS</th>
                <th>VALOR</th>
              </tr>
            </thead>
            <tbody>`;
    
    registros.sort((a, b) => b.timestamp - a.timestamp).forEach(r => {
      html += `<tr>
        <td>${r.data.split('-').reverse().join('/')}</td>
        <td><b>${r.placa}</b></td>
        <td>${r.posto || '---'}</td>
        <td>${r.secretaria}</td>
        <td>${r.motorista}</td>
        <td><span class="badge ${r.tipo === 'GASOLINA' ? 'badge-danger' : r.tipo === 'DIESEL' ? 'badge-warning' : 'badge-success'}">${r.tipo}</span></td>
        <td>${r.km.toLocaleString('pt-BR')}</td>
        <td>${r.litro.toFixed(2)} L</td>
        <td><b>R$ ${r.valor.toFixed(2)}</b></td>
      </tr>`;
    });
    
    html += `</tbody></table></div></div>`;
    container.innerHTML = html;
  }
  
  function confirmarSair() {
    if (confirm("üö™ DESEJA REALMENTE SAIR DO SISTEMA?")) {
      location.reload();
    }
  }
  
  function mostrarNotificacao(texto, tipo) {
    const cores = {
      success: "#22c55e",
      error: "#ef4444",
      warning: "#f59e0b",
      info: "#3b82f6"
    };
    Toastify({
      text: texto,
      duration: 3000,
      gravity: "top",
      position: "right",
      backgroundColor: cores[tipo] || cores.info,
      stopOnFocus: true,
      style: {
        borderRadius: "10px",
        fontWeight: "bold"
      }
    }).showToast();
  }
  
  db.ref('abastecimentos').on('value', snap => {
    cache = [];
    snap.forEach(item => {
      let v = item.val();
      v.id = item.key;
      cache.push(v);
    });
    renderizar();
  });
  
  function salvarVeiculo() {
    const placa = document.getElementById('vei-placa').value.toUpperCase().trim();
    const modelo = document.getElementById('vei-modelo').value.toUpperCase().trim();
    const secretaria = document.getElementById('vei-sec').value;
    const motorista = document.getElementById('vei-motorista').value.toUpperCase().trim();
    const combustivel = document.getElementById('vei-combustivel').value;
    const ano = document.getElementById('vei-ano').value;
    
    if (!placa || placa.length < 7) {
      mostrarNotificacao("‚ùå PLACA INV√ÅLIDA!", "error");
      return;
    }
    
    db.ref('veiculos/' + placa.replace(/[^A-Z0-9]/g, '')).set({
      placa: placa,
      modelo: modelo,
      secretaria: secretaria,
      motorista: motorista,
      combustivel: combustivel,
      ano: ano,
      cadastradoEm: Date.now()
    }).then(() => {
      mostrarNotificacao("‚úÖ VE√çCULO SALVO COM SUCESSO!", "success");
      document.getElementById('vei-placa').value = '';
      document.getElementById('vei-modelo').value = '';
      document.getElementById('vei-sec').value = '';
      document.getElementById('vei-motorista').value = '';
      document.getElementById('vei-combustivel').value = 'GASOLINA';
      document.getElementById('vei-ano').value = '';
      listVeiculos();
    });
  }
  
  function listVeiculos() {
    db.ref('veiculos').once('value', snap => {
      const tbody = document.getElementById('veiculos-body');
      tbody.innerHTML = "";
      if (!snap.exists()) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px;">üì≠ NENHUM VE√çCULO CADASTRADO</td></tr>';
        return;
      }
      snap.forEach(c => {
        const v = c.val();
        tbody.innerHTML += `
          <tr>
            <td><b>${v.placa}</b></td>
            <td>${v.modelo || '---'}</td>
            <td>${v.secretaria || '---'}</td>
            <td>${v.motorista || '---'}</td>
            <td><span class="badge ${v.combustivel === 'GASOLINA' ? 'badge-danger' : v.combustivel === 'DIESEL' ? 'badge-warning' : 'badge-success'}">${v.combustivel || '---'}</span></td>
            <td>${v.ano || '---'}</td>
            <td class="no-print">
              <button class="btn-action btn-deletar" onclick="if(confirm('‚ö†Ô∏è EXCLUIR VE√çCULO ${v.placa}?')) { db.ref('veiculos/${c.key}').remove().then(() => { mostrarNotificacao('‚úÖ VE√çCULO EXCLU√çDO!', 'success'); listVeiculos(); }); }">
                üóëÔ∏è EXCLUIR
              </button>
            </td>
          </tr>
        `;
      });
    });
  }
  
  document.getElementById('f-data').valueAsDate = new Date();
  toggleUserFields();
</script>
