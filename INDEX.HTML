// Localize este trecho dentro da fun√ß√£o renderizar() no seu c√≥digo:

const itens = cache.filter(x => x.secretaria === sec).sort((a,b) => new Date(a.data) - new Date(b.data));
let sR$ = 0, sL = 0, linhas = "";

itens.forEach(d => {
    if(d.status === "AUTORIZADO") { sR$ += d.valor; sL += d.litro; }

    // --- CORRE√á√ÉO DA M√âDIA ---
    // Busca o abastecimento anterior (por data ou timestamp) para comparar o KM
    const historicoPlaca = cache
        .filter(v => v.placa === d.placa && v.km < d.km)
        .sort((a, b) => b.km - a.km); // Ordena do maior KM para o menor

    const kmAnt = historicoPlaca.length > 0 ? historicoPlaca[0].km : 0;
    const diferencaKm = d.km - kmAnt;
    
    // S√≥ calcula se houver KM anterior e se os litros forem maiores que zero
    const media = (kmAnt > 0 && d.litro > 0) ? (diferencaKm / d.litro) : 0;
    // -------------------------

    let btn = "";
    if(isAdmin) {
        if(d.status !== "AUTORIZADO") btn += `<button class="btn-auth" onclick="db.ref('abastecimentos/${d.id}').update({status:'AUTORIZADO'})">LIBERAR</button> `;
        btn += `<button onclick="if(confirm('EXCLUIR?')) db.ref('abastecimentos/${d.id}').remove()" style="border:none; background:none; cursor:pointer">üóëÔ∏è</button>`;
    }

    linhas += `<tr>
        <td>${d.data.split('-').reverse().join('/')}</td>
        <td><b>${d.placa}</b></td>
        <td>${d.motorista}</td>
        <td>${d.destino}</td>
        <td><span class="status-tag status-${d.status === 'AUTORIZADO' ? 'autorizado' : 'aguardando'}">${d.status}</span></td>
        <td>${d.km}</td>
        <td>${d.litro.toFixed(2)}</td>
        <td style="font-weight:bold; color:var(--accent)">${media > 0 ? media.toFixed(2) : '--'}</td>
        <td>R$ ${d.valor.toFixed(2)}</td>
        <td class="no-print">${btn}</td>
    </tr>`;
});
