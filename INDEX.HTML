<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de combust√≠vel Matina/BA</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --success: #22c55e; --warning: #f59e0b; --bg: #f8fafc; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; text-transform: uppercase; outline: none; }
        body { background-color: var(--bg); margin: 0; padding: 20px; color: #334155; }
        .container { max-width: 1400px; margin: 0 auto; transition: 0.3s; }
        .blurred { filter: blur(12px); pointer-events: none; visibility: hidden; }

        /* LOGIN */
        #login-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--primary); z-index:999; display: flex; align-items:center; justify-content:center; flex-direction:column; color:white; }
        .login-box input { padding: 15px; border-radius: 30px; border: 2px solid transparent; text-align: center; font-size: 18px; width: 300px; margin-bottom: 15px; text-transform: none; }
        .btn-login { padding: 15px 40px; border-radius: 30px; border:none; background: var(--accent); color:white; font-weight:bold; cursor:pointer; font-size: 16px; width: 100%; }

        /* CARDS */
        .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; position: relative; overflow: hidden; }
        .card-header { position: absolute; top:0; left:0; width:100%; height: 6px; background: linear-gradient(90deg, var(--accent), var(--primary)); }
        .title { font-size: 14px; font-weight: 800; color: var(--primary); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }

        /* QR SCANNER */
        #reader { width: 100%; border-radius: 8px; overflow: hidden; display: none; margin-bottom: 15px; border: 2px solid var(--accent); }
        .btn-qr { background: var(--primary); color: white; border: none; border-radius: 8px; padding: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 45px; }

        /* FORMUL√ÅRIO */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; }
        label { font-size: 10px; font-weight: bold; color: #64748b; margin-bottom: 5px; display: block; }
        input, select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-weight: 600; font-size: 13px; }
        
        /* GR√ÅFICOS */
        .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; height: 320px; margin-bottom: 20px; }
        @media (max-width: 800px) { .charts-row { grid-template-columns: 1fr; height: auto; } }

        /* BOT√ïES */
        .btn-action { width: 100%; padding: 18px; border: none; border-radius: 8px; font-size: 16px; font-weight: 900; color: white; cursor: pointer; margin-top: 20px; background: var(--success); box-shadow: 0 4px 0 #15803d; }
        .btn-editar-mode { background: var(--warning) !important; box-shadow: 0 4px 0 #b45309 !important; }
        .btn-cancel { background: #ef4444; color: white; padding: 10px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; display: none; margin-top: 10px; width: 100%; }

        /* TABELA */
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { text-align: left; padding: 12px; background: #f8fafc; border-bottom: 2px solid #e2e8f0; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; }
        .badge { padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 10px; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-blue { background: #dbeafe; color: #1e40af; }

        #area-impressao { display: none; background: white; padding: 40px; color: black; }
        @media print { 
            body { padding: 0; background: white; }
            .no-print { display: none !important; } 
            #area-impressao { display: block !important; position: absolute; top: 0; left: 0; width: 100%; } 
            .container { filter: none !important; visibility: visible !important; }
        }
    </style>
</head>
<body>

<div id="login-screen">
    <h1 style="margin-bottom: 5px; letter-spacing: 2px; text-align: center; padding: 0 20px;">Controle de combust√≠vel Matina/BA</h1>
    <div class="login-box">
        <input type="password" id="senha" placeholder="DIGITE A SENHA" onkeydown="if(event.key==='Enter') logar()">
        <br>
        <button class="btn-login" onclick="logar()">ENTRAR NO SISTEMA</button>
    </div>
</div>

<div class="container blurred" id="app">
    <div class="card no-print" style="background: #0f172a; color: white; display: flex; gap: 20px; align-items: center; padding: 15px;">
        <div style="font-size: 12px; font-weight: bold;">‚õΩ VALOR DO LITRO:</div>
        <div><label style="color:#94a3b8">POSTO VITOR</label><input type="number" id="price-v" value="5.89" step="0.01" oninput="calc()" style="width:90px; text-align:center; color:black"></div>
        <div><label style="color:#94a3b8">POSTO MATINA</label><input type="number" id="price-m" value="5.89" step="0.01" oninput="calc()" style="width:90px; text-align:center; color:black"></div>
    </div>

    <div class="charts-row no-print">
        <div class="card" style="margin:0"><div class="card-header"></div><div class="title">GASTOS POR SECRETARIA</div><canvas id="chartSec"></canvas></div>
        <div class="card" style="margin:0"><div class="card-header"></div><div class="title">TOP VE√çCULOS (Gasto R$)</div><canvas id="chartVec"></canvas></div>
    </div>

    <div class="card no-print">
        <div class="card-header"></div>
        <div class="title"><span>NOVO ABASTECIMENTO</span> <span id="mode-badge" class="badge bg-green">SISTEMA ATIVO</span></div>
        
        <div id="reader"></div>

        <div class="form-grid">
            <div>
                <label>PLACA</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="f-placa" placeholder="ABC1234" oninput="sugerir(this.value)">
                    <button class="btn-qr" onclick="alternarScanner()" title="Escanear QR Code">üì∑</button>
                </div>
            </div>
            <div style="grid-column: span 2">
                <label>SECRETARIA / SETOR</label>
                <select id="f-sec">
                    <option value="AVULSOS">AVULSOS / GERAL</option>
                    <option value="Secretaria Municipal de Administra√ß√£o e Finan√ßas">Secretaria Municipal de Administra√ß√£o e Finan√ßas</option>
                    <option value="Secretaria de Infraestrutura e Servi√ßos P√∫blicos">Secretaria de Infraestrutura e Servi√ßos P√∫blicos</option>
                    <option value="Controlador Interno">Controlador Interno</option>
                    <option value="Secretaria de Comunica√ß√£o">Secretaria de Comunica√ß√£o</option>
                    <option value="Secretaria Municipal de Educa√ß√£o">Secretaria Municipal de Educa√ß√£o</option>
                    <option value="Secretaria Municipal de Sa√∫de">Secretaria Municipal de Sa√∫de</option>
                    <option value="Secretaria de Agricultura, Abastecimento, Meio Ambiente e Desenvolvimento Econ√¥mico">Secretaria de Agricultura, Abastecimento, Meio Ambiente e Desenvolvimento Econ√¥mico</option>
                    <option value="Secretaria de Cultura, Esporte e Lazer">Secretaria de Cultura, Esporte e Lazer</option>
                    <option value="Secretaria de Governo">Secretaria de Governo</option>
                    <option value="Secretaria de Planejamento">Secretaria de Planejamento</option>
                    <option value="Secretaria de Assist√™ncia Social">Secretaria de Assist√™ncia Social</option>
                </select>
            </div>
            <div><label>MOTORISTA</label><input type="text" id="f-mot"></div>
            <div><label>POSTO</label><select id="f-posto" onchange="calc()"><option>POSTO VITOR</option><option>POSTO MATINA</option></select></div>
            <div><label>DATA</label><input type="date" id="f-data"></div>
            <div><label>KM ATUAL</label><input type="number" id="f-km"></div>
            <div><label>LITROS</label><input type="number" id="f-lit" step="0.01" oninput="calc('L')"></div>
            <div><label>TOTAL (R$)</label><input type="number" id="f-val" step="0.01" oninput="calc('V')" style="background:#f0fdf4"></div>
        </div>
        <button id="btn-save" class="btn-action" onclick="processar()">‚úîÔ∏è SALVAR REGISTRO</button>
        <button id="btn-cancel" class="btn-cancel" onclick="cancelarEdicao()">CANCELAR EDI√á√ÉO</button>
    </div>

    <div class="card no-print">
        <div class="card-header"></div>
        <div class="title">RELAT√ìRIOS E FILTROS üîç</div>
        <div class="form-grid" style="margin-bottom: 15px;">
            <div><label>DATA IN√çCIO</label><input type="date" id="rel-ini"></div>
            <div><label>DATA FIM</label><input type="date" id="rel-fim"></div>
            <div>
                <label>FILTRAR SECRETARIA</label>
                <select id="filtro-sec" onchange="aplicarFiltros()">
                    <option value="">TODAS</option>
                    <option value="AVULSOS">AVULSOS / GERAL</option>
                    <option value="Secretaria Municipal de Administra√ß√£o e Finan√ßas">Secretaria Municipal de Administra√ß√£o e Finan√ßas</option>
                    <option value="Secretaria de Infraestrutura e Servi√ßos P√∫blicos">Secretaria de Infraestrutura e Servi√ßos P√∫blicos</option>
                    <option value="Controlador Interno">Controlador Interno</option>
                    <option value="Secretaria de Comunica√ß√£o">Secretaria de Comunica√ß√£o</option>
                    <option value="Secretaria Municipal de Educa√ß√£o">Secretaria Municipal de Educa√ß√£o</option>
                    <option value="Secretaria Municipal de Sa√∫de">Secretaria Municipal de Sa√∫de</option>
                    <option value="Secretaria de Agricultura, Abastecimento, Meio Ambiente e Desenvolvimento Econ√¥mico">Secretaria de Agricultura</option>
                    <option value="Secretaria de Cultura, Esporte e Lazer">Secretaria de Cultura</option>
                    <option value="Secretaria de Governo">Secretaria de Governo</option>
                    <option value="Secretaria de Planejamento">Secretaria de Planejamento</option>
                    <option value="Secretaria de Assist√™ncia Social">Secretaria de Assist√™ncia Social</option>
                </select>
            </div>
            <div>
                <label>FILTRAR POSTO</label>
                <select id="filtro-posto" onchange="aplicarFiltros()">
                    <option value="">TODOS</option>
                    <option value="POSTO VITOR">POSTO VITOR</option>
                    <option value="POSTO MATINA">POSTO MATINA</option>
                </select>
            </div>
            <div><label>BUSCAR MOTORISTA/PLACA</label><input type="text" id="busca" placeholder="DIGITE AQUI..." oninput="aplicarFiltros()"></div>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button style="background:#10b981; color:white; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:bold" onclick="exportarExcel()">üíæ SALVAR EXCEL</button>
            <button style="background:#3b82f6; color:white; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:bold" onclick="printRel()">üñ®Ô∏è IMPRIMIR PDF</button>
            <button style="background:#64748b; color:white; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:bold" onclick="limparFiltros()">üîÑ LIMPAR FILTROS</button>
        </div>
    </div>

    <div class="card no-print">
        <div style="overflow-x: auto;">
            <table id="tabela">
                <thead><tr><th>DATA</th><th>PLACA</th><th>MOTORISTA</th><th>KM</th><th>RODADO</th><th>M√âDIA</th><th>CUSTO/KM</th><th>VALOR</th><th>A√á√ïES</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="area-impressao">
        <h1 style="text-align: center; margin: 0;">Controle de combust√≠vel Matina/BA - Relat√≥rio</h1>
        <p id="rel-sub" style="text-align: center; font-weight: bold;"></p>
        <hr>
        <table border="1" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
            <thead id="pdf-head"></thead>
            <tbody id="pdf-body"></tbody>
            <tfoot id="pdf-foot" style="background: #eee; font-weight: bold;"></tfoot>
        </table>
    </div>
</div>

<script>
    // CONFIGURA√á√ÉO FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyDsEQ8L_hWgacZ8xweY3DR9OYt2t151kZE",
        authDomain: "tabela-gasolina.firebaseapp.com",
        databaseURL: "https://tabela-gasolina-default-rtdb.firebaseio.com", 
        projectId: "tabela-gasolina",
        storageBucket: "tabela-gasolina.firebasestorage.app",
        messagingSenderId: "77121029722",
        appId: "1:77121029722:web:641b26a6cdf4c287f53a63"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let cache = [], editID = null, chartP = null, chartB = null, html5QrCode = null;

    document.getElementById('f-data').valueAsDate = new Date();
    
    function logar() {
        const pass = document.getElementById('senha').value.toLowerCase().trim();
        if(pass === "admin") {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app').classList.remove('blurred');
            document.getElementById('app').style.visibility = 'visible';
        } else { alert("SENHA INCORRETA!"); }
    }

    function calc(origem) {
        const posto = document.getElementById('f-posto').value;
        const preco = parseFloat(document.getElementById(posto === 'POSTO VITOR' ? 'price-v' : 'price-m').value);
        const l = document.getElementById('f-lit'), v = document.getElementById('f-val');
        if(origem === 'L') v.value = (l.value * preco).toFixed(2);
        if(origem === 'V') l.value = (v.value / preco).toFixed(2);
    }

    function sugerir(val) {
        let clean = val.toUpperCase().replace(/[^A-Z0-9]/g, '');
        const item = cache.find(x => x.placa === clean);
        if(item) { 
            document.getElementById('f-sec').value = item.secretaria; 
            document.getElementById('f-mot').value = item.motorista; 
        }
    }

    function processar() {
        const d = {
            placa: document.getElementById('f-placa').value.toUpperCase().replace(/[^A-Z0-9]/g, ''),
            secretaria: document.getElementById('f-sec').value,
            motorista: document.getElementById('f-mot').value.toUpperCase(),
            posto: document.getElementById('f-posto').value,
            data: document.getElementById('f-data').value,
            km: parseFloat(document.getElementById('f-km').value),
            litro: parseFloat(document.getElementById('f-lit').value),
            valor: parseFloat(document.getElementById('f-val').value)
        };
        if(!d.placa || !d.valor || !d.km) return notificar("PLACA, KM E VALOR S√ÉO OBRIGAT√ìRIOS!", "error");
        if(editID) db.ref('abastecimentos/' + editID).update(d).then(() => { notificar("ATUALIZADO!"); cancelarEdicao(); });
        else db.ref('abastecimentos').push(d).then(() => { notificar("SALVO!"); limparForm(); });
    }

    function aplicarFiltros() {
        const ini = document.getElementById('rel-ini').value;
        const fim = document.getElementById('rel-fim').value;
        const sec = document.getElementById('filtro-sec').value;
        const posto = document.getElementById('filtro-posto').value;
        const busca = document.getElementById('busca').value.toUpperCase();

        let filtrado = cache.filter(d => {
            const matchData = (!ini || d.data >= ini) && (!fim || d.data <= fim);
            const matchSec = !sec || d.secretaria === sec;
            const matchPosto = !posto || d.posto === posto;
            const matchBusca = !busca || d.placa.includes(busca) || d.motorista.includes(busca);
            return matchData && matchSec && matchPosto && matchBusca;
        });

        renderizar(filtrado);
    }

    function limparFiltros() {
        document.getElementById('rel-ini').value = "";
        document.getElementById('rel-fim').value = "";
        document.getElementById('filtro-sec').value = "";
        document.getElementById('filtro-posto').value = "";
        document.getElementById('busca').value = "";
        renderizar(cache);
    }

    db.ref('abastecimentos').on('value', snap => {
        cache = []; snap.forEach(i => { let v = i.val(); v.id = i.key; cache.push(v); });
        renderizar(cache);
        atualizarGraficos();
    });

    function renderizar(lista) {
        const tbody = document.querySelector("#tabela tbody");
        tbody.innerHTML = "";
        const ord = [...cache].sort((a,b) => a.km - b.km);
        [...lista].reverse().forEach(d => {
            const ant = ord.filter(x => x.placa === d.placa && x.km < d.km).pop();
            let kmR = "---", med = "---", ckm = "---";
            if(ant) {
                let diff = d.km - ant.km;
                kmR = diff + " KM";
                med = (diff / ant.litro).toFixed(2) + " KM/L";
                ckm = "R$ " + (d.valor / diff).toFixed(2);
            }
            tbody.innerHTML += `<tr><td>${d.data.split('-').reverse().join('/')}</td><td><b>${d.placa}</b></td><td>${d.motorista}</td><td>${d.km}</td><td>${kmR}</td><td><span class="badge bg-green">${med}</span></td><td><span class="badge bg-blue">${ckm}</span></td><td>R$ ${d.valor.toFixed(2)}</td><td><button onclick="editar('${d.id}')">‚úèÔ∏è</button><button onclick="remover('${d.id}')">üóëÔ∏è</button></td></tr>`;
        });
    }

    function editar(id) {
        const item = cache.find(i => i.id === id);
        document.getElementById('f-placa').value = item.placa;
        document.getElementById('f-sec').value = item.secretaria;
        document.getElementById('f-mot').value = item.motorista;
        document.getElementById('f-data').value = item.data;
        document.getElementById('f-km').value = item.km;
        document.getElementById('f-lit').value = item.litro;
        document.getElementById('f-val').value = item.valor;
        editID = id;
        document.getElementById('btn-save').innerHTML = "üíæ SALVAR ALTERA√á√ïES";
        document.getElementById('btn-save').classList.add('btn-editar-mode');
        document.getElementById('btn-cancel').style.display = 'block';
        window.scrollTo(0,0);
    }

    function cancelarEdicao() {
        editID = null; limparForm();
        document.getElementById('btn-save').innerHTML = "‚úîÔ∏è SALVAR REGISTRO";
        document.getElementById('btn-save').classList.remove('btn-editar-mode');
        document.getElementById('btn-cancel').style.display = 'none';
    }

    function limparForm() { ["f-placa","f-km","f-lit","f-val"].forEach(i => document.getElementById(i).value = ""); }
    function remover(id) { if(confirm("APAGAR?")) db.ref('abastecimentos').child(id).remove(); }

    function atualizarGraficos() {
        const secD = {}, vecD = {};
        cache.forEach(d => { secD[d.secretaria] = (secD[d.secretaria] || 0) + d.valor; vecD[d.placa] = (vecD[d.placa] || 0) + d.valor; });
        if(chartP) chartP.destroy();
        chartP = new Chart(document.getElementById('chartSec'), { type: 'pie', data: { labels: Object.keys(secD), datasets: [{ data: Object.values(secD), backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6'] }] }, options: { responsive:true, maintainAspectRatio:false } });
        const top = Object.entries(vecD).sort((a,b) => b[1]-a[1]).slice(0,5);
        if(chartB) chartB.destroy();
        chartB = new Chart(document.getElementById('chartVec'), { type: 'bar', data: { labels: top.map(x=>x[0]), datasets: [{ label:'R$', data: top.map(x=>x[1]), backgroundColor: '#0f172a' }] }, options: { responsive:true, maintainAspectRatio:false } });
    }

    function notificar(m, t) { Toastify({ text: m, duration: 2000, style: { background: t==="error"?"#ef4444":"#22c55e"} }).showToast(); }

    function exportarExcel() {
        let csv = "DATA;PLACA;SECRETARIA;MOTORISTA;KM;VALOR\n";
        cache.forEach(d => csv += `${d.data};${d.placa};${d.secretaria};${d.motorista};${d.km};${d.valor}\n`);
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
        a.download = "sgf_backup.csv"; a.click();
    }

    function printRel() {
        const ini = document.getElementById('rel-ini').value, fim = document.getElementById('rel-fim').value;
        const dados = cache.filter(d => (!ini || d.data >= ini) && (!fim || d.data <= fim));
        document.getElementById('rel-sub').innerText = `PER√çODO: ${ini || 'IN√çCIO'} AT√â ${fim || 'FIM'}`;
        const body = document.getElementById('pdf-body'); body.innerHTML = "";
        let tL=0, tV=0;
        dados.forEach(d => {
            body.innerHTML += `<tr><td>${d.data.split('-').reverse().join('/')}</td><td>${d.placa}</td><td>${d.secretaria}</td><td>${d.motorista}</td><td>${d.litro.toFixed(2)}</td><td>R$ ${d.valor.toFixed(2)}</td></tr>`;
            tL += d.litro; tV += d.valor;
        });
        document.getElementById('pdf-head').innerHTML = `<tr><th>DATA</th><th>PLACA</th><th>SECRETARIA</th><th>MOTORISTA</th><th>LITROS</th><th>TOTAL</th></tr>`;
        document.getElementById('pdf-foot').innerHTML = `<tr><td colspan="4">TOTAL</td><td>${tL.toFixed(2)} L</td><td>R$ ${tV.toFixed(2)}</td></tr>`;
        window.print();
    }
</script>
</body>
</html>
