<!-- Firebase e Chart.js -->
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- PWA Manifest -->
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU2lzdGVtYSBkZSBDb21idXN0w61lbCIsInNob3J0X25hbWUiOiJDb21idXN0w61lbCIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZjFmNWY5IiwidGhlbWVfY29sb3IiOiIjM2I4MmY2IiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vaS5pbWd1ci5jb20vQUtNMjVXMS5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">
<meta name="theme-color" content="#3b82f6">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Combust√≠vel">
<link rel="apple-touch-icon" href="https://i.imgur.com/AKM25W1.png">

<style>
  :root { 
      --primary: #0f172a; 
      --accent: #3b82f6; 
      --success: #22c55e; 
      --warning: #f59e0b; 
      --danger: #ef4444; 
      --bg: #f1f5f9; 
  }
  * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; text-transform: uppercase; }
  body { background-color: var(--bg); margin: 0; padding: 10px; color: #1e293b; }
  .container { max-width: 1400px; margin: 0 auto; }
  .blurred { filter: blur(15px); pointer-events: none; }
  
  #login-screen { 
      position: fixed; 
      inset: 0; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      z-index: 999; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      color: white; 
  }
  .login-container {
      display: flex;
      max-width: 1100px;
      width: 90%;
      background: white;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }
  .login-left {
      flex: 1;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));
      padding: 60px 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      position: relative;
  }
  .login-left::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('https://i.imgur.com/qtUXYi3.png') center/cover;
      opacity: 0.15;
  }
  .login-logo {
      width: 100%;
      max-width: 300px;
      margin-bottom: 30px;
      position: relative;
      z-index: 1;
  }
  .login-left h1 {
      font-size: 32px;
      margin: 0 0 15px 0;
      position: relative;
      z-index: 1;
  }
  .login-left p {
      font-size: 16px;
      opacity: 0.9;
      position: relative;
      z-index: 1;
  }
  .login-box { 
      flex: 1;
      padding: 60px 50px;
      background: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
  }
  @media (max-width: 768px) {
      .login-container {
          flex-direction: column;
          width: 95%;
      }
      .login-left {
          padding: 40px 20px;
      }
      .login-box {
          padding: 40px 30px;
      }
  }
  .login-box h2 { 
      margin-bottom: 10px; 
      font-size: 32px; 
      color: var(--primary);
      text-shadow: none;
      text-align: center;
  }
  .login-box p { 
      color: #64748b; 
      font-size: 14px; 
      margin-bottom: 30px;
      text-align: center;
  }
  .login-box input { 
      width: 100%; 
      padding: 16px; 
      border-radius: 12px; 
      border: 2px solid #e2e8f0; 
      margin-bottom: 15px; 
      text-align: center; 
      font-size: 16px;
      transition: all 0.3s;
  }
  .login-box input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  .login-box .btn-login {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
  }
  .login-box .btn-login:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
  }
  
  .top-bar { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 20px; 
      flex-wrap: wrap; 
      gap: 10px;
      background: white;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .nav-tabs { display: flex; gap: 10px; flex-wrap: wrap; }
  .tab-btn { 
      padding: 12px 20px; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      background: #e2e8f0; 
      font-weight: bold; 
      font-size: 11px; 
      transition: all 0.3s;
      position: relative;
  }
  .tab-btn.active { 
      background: var(--accent); 
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }
  .tab-btn:hover { opacity: 0.8; transform: translateY(-1px); }
  .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      animation: pulse-badge 2s infinite;
  }
  @keyframes pulse-badge {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
  }
  
  .btn-logout { 
      background: var(--danger); 
      color: white; 
      padding: 12px 24px; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: bold;
      transition: all 0.3s;
  }
  .btn-logout:hover {
      background: #dc2626;
      transform: translateY(-1px);
  }
  
  .card { 
      background: white; 
      border-radius: 12px; 
      padding: 24px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
      margin-bottom: 20px;
      transition: all 0.3s;
  }
  .card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  }
  .card h3 { 
      margin-top: 0; 
      color: var(--primary);
      font-size: 18px;
      border-bottom: 3px solid var(--accent);
      padding-bottom: 10px;
      margin-bottom: 20px;
  }
  
  .mini-card { 
      background: linear-gradient(135deg, var(--primary) 0%, #1e293b 100%);
      color: white; 
      padding: 20px; 
      border-radius: 12px; 
      text-align: center; 
      font-weight: bold; 
      margin-bottom: 20px; 
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  
  .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
  }
  .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
      transition: all 0.3s;
  }
  .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  }
  .stat-card h4 {
      font-size: 11px;
      color: #64748b;
      margin: 0 0 10px 0;
  }
  .stat-card .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary);
  }
  .stat-card .stat-icon {
      font-size: 32px;
      margin-bottom: 10px;
  }
  .stat-trend {
      font-size: 12px;
      margin-top: 5px;
  }
  .stat-trend.positive {
      color: var(--success);
  }
  .stat-trend.negative {
      color: var(--danger);
  }
  
  .charts-row { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
      gap: 20px; 
      margin-bottom: 20px; 
  }
  
  .table-wrapper { overflow-x: auto; }
  table { 
      width: 100%; 
      border-collapse: collapse; 
      min-width: 1000px; 
      font-size: 11px; 
  }
  th { 
      background: #f8fafc; 
      padding: 12px; 
      text-align: left; 
      border-bottom: 2px solid #e2e8f0; 
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
  }
  td { padding: 12px; border-bottom: 1px solid #f1f5f9; }
  tr:hover { background: #f8fafc; }
  
  .alerta-media { 
      background-color: #fee2e2 !important; 
      color: #b91c1c !important; 
      font-weight: bold;
      animation: pulse 2s infinite;
  }
  .alerta-km-alto {
      background-color: #fef3c7 !important;
      color: #92400e !important;
  }
  .eficiencia-excelente {
      background-color: #d1fae5 !important;
      color: #065f46 !important;
  }
  
  @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
  }
  
  .btn-save { 
      background: linear-gradient(135deg, var(--success) 0%, #16a34a 100%);
      color: white; 
      border: none; 
      padding: 16px; 
      border-radius: 10px; 
      cursor: pointer; 
      font-weight: bold; 
      width: 100%; 
      margin-top: 10px; 
      transition: all 0.3s;
      font-size: 13px;
  }
  .btn-save:hover { 
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(34, 197, 94, 0.3);
  }
  .btn-save:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
  }
  
  .status-tag { 
      padding: 6px 12px; 
      border-radius: 20px; 
      font-weight: bold; 
      font-size: 9px; 
      display: inline-block;
  }
  .status-aguardando { background: var(--warning); color: #000; }
  .status-autorizado { background: var(--success); color: #fff; }
  .status-rejeitado { background: var(--danger); color: #fff; }
  
  input, select { 
      width: 100%; 
      padding: 12px; 
      border: 2px solid #e2e8f0; 
      border-radius: 8px; 
      margin-bottom: 5px;
      transition: all 0.3s;
  }
  input:focus, select:focus { 
      outline: none; 
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  label { 
      font-size: 10px; 
      font-weight: bold; 
      color: #64748b; 
      display: block; 
      margin-bottom: 5px;
  }
  
  .btn-action { 
      padding: 8px 14px; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      margin: 0 3px; 
      font-size: 13px;
      transition: all 0.3s;
  }
  .btn-action:hover {
      transform: scale(1.05);
  }
  .btn-aprovar { background: var(--success); color: white; }
  .btn-rejeitar { background: var(--danger); color: white; }
  .btn-deletar { background: #64748b; color: white; }
  
  .grid-form { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
      gap: 15px; 
  }
  
  .section-header {
      background: linear-gradient(135deg, var(--primary) 0%, #1e293b 100%);
      color: white; 
      padding: 15px 20px; 
      margin-top: 20px; 
      border-radius: 10px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  
  .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: bold;
      margin-left: 8px;
  }
  .badge-success { background: var(--success); color: white; }
  .badge-danger { background: var(--danger); color: white; }
  .badge-warning { background: var(--warning); color: black; }
  
  .alert-box {
      background: #fef3c7;
      border-left: 4px solid var(--warning);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
  }
  .alert-box.danger {
      background: #fee2e2;
      border-left-color: var(--danger);
  }
  .alert-box.success {
      background: #d1fae5;
      border-left-color: var(--success);
  }
  
  .progress-bar {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
  }
  .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), var(--accent));
      transition: width 0.3s;
  }
  .progress-fill.warning {
      background: linear-gradient(90deg, var(--warning), #f97316);
  }
  .progress-fill.danger {
      background: linear-gradient(90deg, var(--danger), #dc2626);
  }
  
  @media print { 
      .no-print { display: none !important; } 
      .card { box-shadow: none; page-break-inside: avoid; }
      body { background: white; }
  }
  
  @media (max-width: 768px) {
      .grid-form { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: 1fr; }
      .charts-row { grid-template-columns: 1fr; }
      table { font-size: 9px; }
      th, td { padding: 8px; }
  }
  
  .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s;
  }
  @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
  }
  .modal-content {
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideUp 0.3s;
  }
  @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
  }
  .modal-content h3 {
      color: var(--primary);
      border-bottom: 3px solid var(--accent);
      padding-bottom: 10px;
      margin-bottom: 20px;
  }
  .modal-content label {
      text-transform: none;
      font-weight: normal;
  }
  .modal-close {
      float: right;
      cursor: pointer;
      font-weight: bold;
      font-size: 28px;
      color: #94a3b8;
      transition: all 0.3s;
  }
  .modal-close:hover {
      color: var(--danger);
      transform: rotate(90deg);
  }
  
  .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
  }
  @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
  }
  
  .qr-scanner-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
  }
  .qr-scanner-container video {
      width: 100%;
      max-width: 400px;
      border-radius: 8px;
      border: 3px solid var(--accent);
  }
  #qr-reader {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
  }
  .qr-code-display {
      margin-top: 20px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 8px;
  }
  .qr-code-display canvas {
      margin: 10px auto;
      display: block;
  }
  
  .comparison-card {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 15px;
  }
  .comparison-item {
      text-align: center;
      padding: 15px;
      background: #f8fafc;
      border-radius: 8px;
  }
  .comparison-item h5 {
      font-size: 11px;
      color: #64748b;
      margin: 0 0 10px 0;
  }
  .comparison-value {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary);
  }
  
  .efficiency-meter {
      width: 100%;
      height: 30px;
      background: linear-gradient(90deg, var(--danger) 0%, var(--warning) 50%, var(--success) 100%);
      border-radius: 15px;
      position: relative;
      margin: 10px 0;
  }
  .efficiency-pointer {
      position: absolute;
      top: -5px;
      width: 4px;
      height: 40px;
      background: #000;
      border-radius: 2px;
      transition: left 0.5s;
  }
  
  /* Sistema de Notifica√ß√µes */
  .notification-center {
      position: fixed;
      top: 80px;
      right: 20px;
      width: 350px;
      max-height: 500px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
      overflow: hidden;
  }
  .notification-center.active {
      display: block;
      animation: slideInRight 0.3s;
  }
  @keyframes slideInRight {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
  }
  .notification-header {
      padding: 15px 20px;
      background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);
      color: white;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
  }
  .notification-list {
      max-height: 400px;
      overflow-y: auto;
  }
  .notification-item {
      padding: 15px 20px;
      border-bottom: 1px solid #e2e8f0;
      cursor: pointer;
      transition: all 0.2s;
  }
  .notification-item:hover {
      background: #f8fafc;
  }
  .notification-item.unread {
      background: #eff6ff;
      border-left: 4px solid var(--accent);
  }
  .notification-item .notification-title {
      font-weight: bold;
      font-size: 12px;
      margin-bottom: 5px;
  }
  .notification-item .notification-text {
      font-size: 11px;
      color: #64748b;
      text-transform: none;
  }
  .notification-item .notification-time {
      font-size: 10px;
      color: #94a3b8;
      margin-top: 5px;
  }
  .notification-bell {
      position: relative;
      cursor: pointer;
      font-size: 20px;
      padding: 8px 12px;
      background: white;
      border-radius: 8px;
      transition: all 0.3s;
  }
  .notification-bell:hover {
      background: #f1f5f9;
  }
  .notification-bell .notification-count {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      animation: pulse-badge 2s infinite;
  }
  
  /* Dashboard Executivo */
  .executive-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
  }
  .executive-card h2 {
      margin: 0 0 20px 0;
      font-size: 24px;
  }
  .executive-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
  }
  .executive-metric {
      background: rgba(255,255,255,0.2);
      padding: 20px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
  }
  .executive-metric-label {
      font-size: 11px;
      opacity: 0.9;
      margin-bottom: 8px;
  }
  .executive-metric-value {
      font-size: 28px;
      font-weight: bold;
  }
  .executive-metric-trend {
      font-size: 12px;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 5px;
  }
  
  /* PWA Install Button */
  .install-pwa-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);
      color: white;
      padding: 15px 20px;
      display: none;
      align-items: center;
      justify-content: space-between;
      z-index: 999;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
  }
  .install-pwa-banner.show {
      display: flex;
      animation: slideUp 0.3s;
  }
  .install-pwa-banner button {
      background: white;
      color: var(--accent);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
  }
  .install-pwa-banner button:hover {
      transform: scale(1.05);
  }
  .install-pwa-banner .close-banner {
      background: transparent;
      color: white;
      font-size: 20px;
      padding: 5px 10px;
  }
</style>

<!-- Modal para Edi√ß√£o de Usu√°rios -->
<div id="modal-edit" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="fecharModal()">&times;</span>
    <h3>‚úèÔ∏è EDITAR USU√ÅRIO</h3>
    <div class="grid-form">
      <div>
        <label>USU√ÅRIO</label>
        <input type="text" id="edit-user" disabled>
      </div>
      <div>
        <label>NOVA SENHA</label>
        <input type="password" id="edit-pass">
      </div>
      <div>
        <label>COMBUST√çVEL PERMITIDO</label>
        <select id="edit-combustivel">
          <option value="GASOLINA">GASOLINA</option>
          <option value="ALCOOL">√ÅLCOOL</option>
          <option value="DIESEL">DIESEL</option>
          <option value="todos">TODOS</option>
        </select>
      </div>
      <div>
        <label>PERFIL</label>
        <select id="edit-role" onchange="toggleEditFields()">
          <option value="admin">ADMIN (TOTAL)</option>
          <option value="secretarios">SECRET√ÅRIO (RESTRITO)</option>
          <option value="frentista">FRENTISTA (SOMENTE LEITURA)</option>
        </select>
      </div>
      <div id="edit-field-limit">
        <label>LIMITE MENSAL (R$)</label>
        <input type="number" id="edit-limit" placeholder="0.00" step="0.01">
      </div>
      <div id="edit-field-sec">
        <label>SECRETARIA VINCULADA</label>
        <select id="edit-sec-vinc">
          <option value="">SELECIONE...</option>
          <option>ADMINISTRA√á√ÉO E FINAN√áAS</option>
          <option>AGRICULTURA E MEIO AMBIENTE</option>
          <option>ASSIST√äNCIA SOCIAL</option>
          <option>EDUCA√á√ÉO</option>
          <option>SA√öDE</option>
          <option>INFRAESTRUTURA E SERVI√áOS</option>
          <option>AVULSOS / GERAL</option>
        </select>
      </div>
    </div>
    <button class="btn-save" style="background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);" onclick="salvarEdicao()">üíæ SALVAR ALTERA√á√ïES</button>
  </div>
</div>

<!-- Modal de An√°lise de Efici√™ncia -->
<div id="modal-analise" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <span class="modal-close" onclick="fecharModalAnalise()">&times;</span>
    <h3>üìä AN√ÅLISE DE EFICI√äNCIA</h3>
    <div id="analise-content"></div>
  </div>
</div>

<!-- Modal de Hist√≥rico de Abastecimentos (Avulsos) -->
<div id="modal-historico-avulso" class="modal">
  <div class="modal-content" style="max-width: 600px;">
    <span class="modal-close" onclick="fecharModalHistoricoAvulso(false)">&times;</span>
    <h3 style="color:var(--warning);">‚ö†Ô∏è ATEN√á√ÉO: ABASTECIMENTO AVULSO</h3>
    <div id="historico-avulso-content"></div>
    <div style="margin-top:20px; padding:15px; background:#fff3cd; border-radius:8px; border-left:4px solid var(--warning);">
      <p style="margin:0; font-size:12px; color:#856404;">
        <strong>‚ö†Ô∏è IMPORTANTE:</strong> Este ve√≠culo possui hist√≥rico de abastecimentos em outras secretarias.<br>
        Deseja realmente registrar como <strong>AVULSO</strong>?
      </p>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px;">
      <button class="btn-save" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%);" onclick="fecharModalHistoricoAvulso(false)">
        ‚ùå CANCELAR
      </button>
      <button class="btn-save" onclick="fecharModalHistoricoAvulso(true)">
        ‚úÖ CONFIRMAR AVULSO
      </button>
    </div>
  </div>
</div>

<!-- Modal de Permiss√µes de Perfil -->
<div id="modal-permissoes" class="modal">
  <div class="modal-content" style="max-width: 700px;">
    <span class="modal-close" onclick="fecharModalPermissoes()">&times;</span>
    <h3>üîê CONFIGURAR PERMISS√ïES DO PERFIL</h3>
    <p style="font-size:12px; color:#64748b; margin-bottom:20px;">
      Selecione o que cada perfil pode visualizar e fazer no sistema
    </p>
    
    <div style="margin-bottom:20px;">
      <label>SELECIONE O PERFIL PARA CONFIGURAR</label>
      <select id="perfil-config" onchange="carregarPermissoesPerfil()" style="width:100%;">
        <option value="admin">ADMIN (TOTAL)</option>
        <option value="secretarios">SECRET√ÅRIO (RESTRITO)</option>
        <option value="frentista">FRENTISTA (SOMENTE LEITURA)</option>
        <option value="custom">PERSONALIZADO</option>
      </select>
    </div>
    
    <div id="permissoes-lista" style="max-height:400px; overflow-y:auto;">
      <!-- As permiss√µes ser√£o carregadas aqui -->
    </div>
    
    <button class="btn-save" style="background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);" onclick="salvarPermissoes()">
      üíæ SALVAR PERMISS√ïES
    </button>
  </div>
</div>

<!-- Tela de Login -->
<div id="login-screen">
  <div class="login-container">
    <div class="login-left">
      <img src="https://i.imgur.com/AKM25W1.png" alt="Logo" class="login-logo">
      <h1>SISTEMA DE CONTROLE</h1>
      <p>Gest√£o Inteligente de Combust√≠vel v2.0</p>
    </div>
    <div class="login-box">
      <h2>üöó BEM-VINDO</h2>
      <p>Fa√ßa login para continuar</p>
      <input type="text" id="user" placeholder="USU√ÅRIO" autocomplete="username">
      <input type="password" id="senha" placeholder="SENHA" autocomplete="current-password" onkeypress="if(event.key==='Enter') logar()">
      <button class="btn-login" onclick="logar()">üîê ENTRAR</button>
    </div>
  </div>
</div>

<!-- √Årea Principal do App -->
<div class="container blurred" id="app">
  <div class="top-bar no-print">
    <div class="nav-tabs">
      <button id="btn-tab-geral" class="tab-btn active" onclick="switchTab('geral')">üìä DASHBOARD</button>
      <button id="btn-tab-executivo" class="tab-btn" style="display:none;" onclick="switchTab('executivo')">üëî EXECUTIVO</button>
      <button id="btn-tab-pendentes" class="tab-btn" style="display:none;" onclick="switchTab('pendentes')">
        ‚è≥ PENDENTES
        <span id="pendentes-badge" class="notification-badge" style="display:none;">0</span>
      </button>
      <button id="btn-tab-analytics" class="tab-btn" onclick="switchTab('analytics')">üìà AN√ÅLISES</button>
      <button id="btn-tab-users" class="tab-btn" style="display:none;" onclick="switchTab('usuarios')">‚öôÔ∏è CONFIGURA√á√ïES</button>
      <button class="tab-btn" onclick="abrirAlterarSenha()">üîë SENHA</button>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <div class="notification-bell" onclick="toggleNotificationCenter()">
        üîî
        <span class="notification-count" id="notification-count" style="display:none;">0</span>
      </div>
      <button class="btn-logout" onclick="confirmarSair()">üö™ SAIR</button>
    </div>
  </div>
  
  <!-- Central de Notifica√ß√µes -->
  <div class="notification-center" id="notification-center">
    <div class="notification-header">
      <span>üîî NOTIFICA√á√ïES</span>
      <span style="cursor:pointer;" onclick="toggleNotificationCenter()">‚úï</span>
    </div>
    <div class="notification-list" id="notification-list">
      <div style="padding:40px 20px; text-align:center; color:#64748b; font-size:12px;">
        üì≠ NENHUMA NOTIFICA√á√ÉO
      </div>
    </div>
  </div>
  
  <!-- Banner PWA -->
  <div class="install-pwa-banner" id="pwa-banner">
    <div>
      <strong style="font-size:14px;">üì± INSTALE NOSSO APP</strong>
      <div style="font-size:11px; opacity:0.9; margin-top:5px;">Acesse offline e receba notifica√ß√µes</div>
    </div>
    <div style="display:flex; gap:10px;">
      <button class="close-banner" onclick="fecharBannerPWA()">‚úï</button>
      <button onclick="instalarPWA()">INSTALAR</button>
    </div>
  </div>
  
  <div id="tab-geral">
    <div id="status-financeiro" class="mini-card">
      <div class="loading"></div> CARREGANDO...
    </div>
    
    <!-- Estat√≠sticas R√°pidas Melhoradas -->
    <div class="stats-grid no-print" id="stats-container"></div>
    
    <!-- Alertas e Notifica√ß√µes -->
    <div id="alertas-container"></div>
    
    <div class="charts-row no-print">
      <div class="card">
        <h3>üí∞ GASTOS POR SECRETARIA</h3>
        <div style="height:280px;"><canvas id="chartSec"></canvas></div>
      </div>
      <div class="card">
        <h3>üöõ TOP 5 VE√çCULOS</h3>
        <div style="height:280px;"><canvas id="chartVec"></canvas></div>
      </div>
    </div>
    
    <!-- Novo Abastecimento -->
    <div class="card no-print">
      <h3>‚õΩ NOVO ABASTECIMENTO</h3>
      
      <!-- Scanner QR Code -->
      <div class="qr-scanner-container" id="qr-scanner-area" style="display:none;">
        <h4>üì∑ ESCANEIE O QR CODE DO VE√çCULO</h4>
        <div id="qr-reader"></div>
        <button class="btn-save" style="background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%); margin-top:15px;" onclick="pararScanner()">‚ùå CANCELAR SCANNER</button>
      </div>
      
      <div style="text-align:center; margin-bottom:15px;">
        <button class="btn-save" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); max-width:300px; margin:0 auto;" onclick="iniciarScanner()">
          üì± ESCANEAR QR CODE
        </button>
      </div>
      
      <div class="grid-form">
        <div>
          <label>PLACA *</label>
          <input type="text" id="f-placa" placeholder="ABC-1234" maxlength="8" oninput="sugerir(this.value)">
        </div>
        <div>
          <label>POSTO *</label>
          <select id="f-posto" onchange="atualizarPrecosPosto()">
            <option value="">SELECIONE O POSTO</option>
          </select>
        </div>
        <div>
          <label>SECRETARIA *</label>
          <select id="f-sec">
            <option value="AVULSOS / GERAL">AVULSOS / GERAL</option>
            <option value="ADMINISTRA√á√ÉO E FINAN√áAS">ADMINISTRA√á√ÉO E FINAN√áAS</option>
            <option value="AGRICULTURA E MEIO AMBIENTE">AGRICULTURA E MEIO AMBIENTE</option>
            <option value="ASSIST√äNCIA SOCIAL">ASSIST√äNCIA SOCIAL</option>
            <option value="COMUNICA√á√ÉO">COMUNICA√á√ÉO</option>
            <option value="CULTURA, ESPORTE E LAZER">CULTURA, ESPORTE E LAZER</option>
            <option value="EDUCA√á√ÉO">EDUCA√á√ÉO</option>
            <option value="GOVERNO">GOVERNO</option>
            <option value="INFRAESTRUTURA E SERVI√áOS">INFRAESTRUTURA E SERVI√áOS</option>
            <option value="PLANEJAMENTO">PLANEJAMENTO</option>
            <option value="SA√öDE">SA√öDE</option>
          </select>
        </div>
        <div>
          <label>MOTORISTA *</label>
          <input type="text" id="f-mot" placeholder="NOME DO MOTORISTA">
        </div>
        <div>
          <label>COMBUST√çVEL *</label>
          <select id="f-tipo" onchange="calc()">
            <option value="GASOLINA">GASOLINA</option>
            <option value="ALCOOL">√ÅLCOOL</option>
            <option value="DIESEL">DIESEL</option>
          </select>
        </div>
        <div>
          <label>DATA *</label>
          <input type="date" id="f-data">
        </div>
        <div>
          <label>KM ATUAL *</label>
          <input type="number" id="f-km" placeholder="0" min="0" oninput="validarKmAtual()">
        </div>
        <div>
          <label>LITROS *</label>
          <input type="number" id="f-lit" placeholder="0.00" step="0.01" min="0" oninput="calc()">
        </div>
        <div>
          <label>VALOR TOTAL (R$)</label>
          <input type="text" id="f-val" readonly style="background:#f1f5f9; font-weight:bold;">
        </div>
      </div>
      
      <!-- Previs√£o de Consumo -->
      <div id="previsao-consumo" style="display:none; margin-top:15px; padding:15px; background:#f8fafc; border-radius:8px;">
        <h4 style="font-size:12px; margin:0 0 10px 0; color:#64748b;">üìä PREVIS√ÉO DE CONSUMO</h4>
        <div id="previsao-content"></div>
      </div>
      
      <button class="btn-save" id="btn-registrar" onclick="processar()">‚úîÔ∏è REGISTRAR ABASTECIMENTO</button>
    </div>
    
    <!-- Filtro de Relat√≥rio -->
    <div class="card no-print">
      <h3>üîç FILTROS DE RELAT√ìRIO</h3>
      <div class="grid-form">
        <div>
          <label>DATA INICIAL</label>
          <input type="date" id="rel-data-inicial">
        </div>
        <div>
          <label>DATA FINAL</label>
          <input type="date" id="rel-data-final">
        </div>
        <div>
          <label>SECRETARIA</label>
          <select id="rel-secretaria">
            <option value="">TODAS</option>
            <option value="AVULSOS / GERAL">AVULSOS / GERAL</option>
            <option value="ADMINISTRA√á√ÉO E FINAN√áAS">ADMINISTRA√á√ÉO E FINAN√áAS</option>
            <option value="AGRICULTURA E MEIO AMBIENTE">AGRICULTURA E MEIO AMBIENTE</option>
            <option value="ASSIST√äNCIA SOCIAL">ASSIST√äNCIA SOCIAL</option>
            <option value="COMUNICA√á√ÉO">COMUNICA√á√ÉO</option>
            <option value="CULTURA, ESPORTE E LAZER">CULTURA, ESPORTE E LAZER</option>
            <option value="EDUCA√á√ÉO">EDUCA√á√ÉO</option>
            <option value="GOVERNO">GOVERNO</option>
            <option value="INFRAESTRUTURA E SERVI√áOS">INFRAESTRUTURA E SERVI√áOS</option>
            <option value="PLANEJAMENTO">PLANEJAMENTO</option>
            <option value="SA√öDE">SA√öDE</option>
          </select>
        </div>
        <div>
          <label>POSTO</label>
          <select id="rel-posto">
            <option value="">TODOS</option>
          </select>
        </div>
        <div>
          <label>COMBUST√çVEL</label>
          <select id="rel-combustivel">
            <option value="">TODOS</option>
            <option value="GASOLINA">GASOLINA</option>
            <option value="ALCOOL">√ÅLCOOL</option>
            <option value="DIESEL">DIESEL</option>
          </select>
        </div>
        <div>
          <label>PLACA</label>
          <input type="text" id="rel-placa" placeholder="ABC-1234">
        </div>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px;">
        <button class="btn-save" onclick="gerarRelatorio()">üìä GERAR</button>
        <button class="btn-save" style="background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);" onclick="limparFiltros()">üîÑ LIMPAR</button>
        <button class="btn-save" style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);" onclick="exportarExcel()">üì• EXPORTAR EXCEL</button>
      </div>
      <button class="btn-save" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%); margin-top:5px;" onclick="window.print()">üñ®Ô∏è IMPRIMIR</button>
    </div>
    
    <!-- Relat√≥rios -->
    <div id="relatorio-container"></div>
  </div>
  
  <div id="tab-pendentes" style="display:none;">
    <div class="card">
      <h3>‚è≥ SOLICITA√á√ïES PENDENTES DE APROVA√á√ÉO</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>DATA</th>
              <th>PLACA</th>
              <th>POSTO</th>
              <th>SECRETARIA</th>
              <th>MOTORISTA</th>
              <th>COMBUST√çVEL</th>
              <th>LITROS</th>
              <th>VALOR</th>
              <th>SOLICITANTE</th>
              <th class="no-print">A√á√ïES</th>
            </tr>
          </thead>
          <tbody id="pendentes-body"></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div id="tab-executivo" style="display:none;">
    <!-- Dashboard Executivo -->
    <div class="executive-card">
      <h2>üëî DASHBOARD EXECUTIVO</h2>
      <div class="executive-metrics" id="executive-metrics"></div>
    </div>
    
    <div class="card">
      <h3>üìä VIS√ÉO GERAL DO M√äS</h3>
      <div class="charts-row">
        <div style="height:300px;"><canvas id="chartExecutivo1"></canvas></div>
        <div style="height:300px;"><canvas id="chartExecutivo2"></canvas></div>
      </div>
    </div>
    
    <div class="card">
      <h3>üéØ PERFORMANCE POR SECRETARIA</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>SECRETARIA</th>
              <th>OR√áADO</th>
              <th>REALIZADO</th>
              <th>DIFEREN√áA</th>
              <th>% EXECU√á√ÉO</th>
              <th>PROJE√á√ÉO M√äS</th>
              <th>STATUS</th>
            </tr>
          </thead>
          <tbody id="performance-body"></tbody>
        </table>
      </div>
    </div>
    
    <div class="charts-row">
      <div class="card">
        <h3>üìà EVOLU√á√ÉO ANUAL</h3>
        <div style="height:300px;"><canvas id="chartAnual"></canvas></div>
      </div>
      <div class="card">
        <h3>üöó FROTA - INDICADORES</h3>
        <div style="height:300px;"><canvas id="chartFrota"></canvas></div>
      </div>
    </div>
    
    <div class="card">
      <h3>‚ö†Ô∏è ALERTAS E RECOMENDA√á√ïES</h3>
      <div id="alertas-executivo"></div>
    </div>
  </div>
  
  <div id="tab-analytics" style="display:none;">
    <div class="card">
      <h3>üìà AN√ÅLISE COMPARATIVA - M√äS ATUAL VS M√äS ANTERIOR</h3>
      <div class="comparison-card" id="comparison-container"></div>
    </div>
    
    <div class="card">
      <h3>üèÜ RANKING DE EFICI√äNCIA DE VE√çCULOS</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>POSI√á√ÉO</th>
              <th>PLACA</th>
              <th>MODELO</th>
              <th>M√âDIA (KM/L)</th>
              <th>TOTAL GASTO</th>
              <th>TOTAL LITROS</th>
              <th>ABASTECIMENTOS</th>
              <th>EFICI√äNCIA</th>
            </tr>
          </thead>
          <tbody id="ranking-body"></tbody>
        </table>
      </div>
    </div>
    
    <div class="card">
      <h3>üìä CONSUMO POR TIPO DE COMBUST√çVEL</h3>
      <div style="height:300px;"><canvas id="chartCombustivel"></canvas></div>
    </div>
    
    <div class="card">
      <h3>üìâ TEND√äNCIA DE GASTOS (√öLTIMOS 6 MESES)</h3>
      <div style="height:300px;"><canvas id="chartTendencia"></canvas></div>
    </div>
  </div>
  
  <div id="tab-users" style="display:none;">
    <div class="card">
      <h3>‚õΩ CADASTRO DE POSTOS</h3>
      <div class="grid-form">
        <div>
          <label>NOME DO POSTO *</label>
          <input type="text" id="posto-nome" placeholder="EX: POSTO MATINA">
        </div>
        <div>
          <label>GASOLINA (R$/L) *</label>
          <input type="number" id="posto-gas" placeholder="0.00" step="0.01" min="0">
        </div>
        <div>
          <label>√ÅLCOOL (R$/L) *</label>
          <input type="number" id="posto-alc" placeholder="0.00" step="0.01" min="0">
        </div>
        <div>
          <label>DIESEL (R$/L) *</label>
          <input type="number" id="posto-die" placeholder="0.00" step="0.01" min="0">
        </div>
      </div>
      <button class="btn-save" onclick="salvarPosto()" style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);">‚ûï SALVAR POSTO</button>
    </div>
    
    <div class="card">
      <h3>‚õΩ POSTOS CADASTRADOS</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>POSTO</th>
              <th>GASOLINA</th>
              <th>√ÅLCOOL</th>
              <th>DIESEL</th>
              <th class="no-print">A√á√ïES</th>
            </tr>
          </thead>
          <tbody id="postos-body"></tbody>
        </table>
      </div>
    </div>
    
    <div class="card">
      <h3>üöó CADASTRO DE VE√çCULOS</h3>
      <div class="grid-form">
        <div>
          <label>PLACA *</label>
          <input type="text" id="vei-placa" placeholder="ABC-1234" maxlength="8">
        </div>
        <div>
          <label>MODELO</label>
          <input type="text" id="vei-modelo" placeholder="EX: GOL, SAVEIRO">
        </div>
        <div>
          <label>SECRETARIA (OPCIONAL)</label>
          <select id="vei-sec">
            <option value="">NENHUMA (COMPARTILHADO)</option>
            <option>ADMINISTRA√á√ÉO E FINAN√áAS</option>
            <option>AGRICULTURA E MEIO AMBIENTE</option>
            <option>ASSIST√äNCIA SOCIAL</option>
            <option>EDUCA√á√ÉO</option>
            <option>SA√öDE</option>
            <option>INFRAESTRUTURA E SERVI√áOS</option>
            <option>AVULSOS / GERAL</option>
          </select>
        </div>
        <div>
          <label>MOTORISTA PADR√ÉO (OPCIONAL)</label>
          <input type="text" id="vei-motorista" placeholder="NOME DO MOTORISTA">
        </div>
        <div>
          <label>TIPO DE COMBUST√çVEL</label>
          <select id="vei-combustivel">
            <option value="GASOLINA">GASOLINA</option>
            <option value="ALCOOL">√ÅLCOOL</option>
            <option value="DIESEL">DIESEL</option>
            <option value="FLEX">FLEX (GASOLINA/√ÅLCOOL)</option>
          </select>
        </div>
        <div>
          <label>ANO</label>
          <input type="number" id="vei-ano" placeholder="2020" min="1980" max="2030">
        </div>
      </div>
      <button class="btn-save" onclick="salvarVeiculo()" style="background: linear-gradient(135deg, var(--success) 0%, #16a34a 100%);">‚ûï SALVAR VE√çCULO</button>
      
      <!-- Gerador de QR Code -->
      <div class="qr-code-display" id="qr-display" style="display:none;">
        <h4>üì± QR CODE GERADO</h4>
        <p style="font-size:12px; color:#64748b;">IMPRIMA E COLE NO VE√çCULO</p>
        <div id="qrcode"></div>
        <p style="margin-top:10px;"><strong>PLACA:</strong> <span id="qr-placa-text"></span></p>
        <button class="btn-save" style="background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);" onclick="baixarQRCode()">üíæ BAIXAR QR CODE</button>
      </div>
    </div>
    
    <div class="card">
      <h3>üë• GEST√ÉO DE USU√ÅRIOS</h3>
      <div class="grid-form">
        <div>
          <label>USU√ÅRIO</label>
          <input type="text" id="new-user" placeholder="LOGIN">
        </div>
        <div>
          <label>SENHA</label>
          <input type="password" id="new-pass" placeholder="SENHA">
        </div>
        <div>
          <label>PERFIL</label>
          <select id="new-role" onchange="toggleUserFields()">
            <option value="admin">ADMIN (TOTAL)</option>
            <option value="secretarios">SECRET√ÅRIO (RESTRITO)</option>
            <option value="frentista">FRENTISTA (SOMENTE LEITURA)</option>
          </select>
        </div>
        <div>
          <label>COMBUST√çVEL PERMITIDO</label>
          <select id="new-combustivel">
            <option value="GASOLINA">GASOLINA</option>
            <option value="ALCOOL">√ÅLCOOL</option>
            <option value="DIESEL">DIESEL</option>
            <option value="todos">TODOS</option>
          </select>
        </div>
        <div id="field-limit">
          <label>LIMITE MENSAL (R$)</label>
          <input type="number" id="new-limit" placeholder="0.00" step="0.01">
        </div>
        <div id="field-sec">
          <label>SECRETARIA VINCULADA</label>
          <select id="new-sec-vinc">
            <option value="">SELECIONE...</option>
            <option>ADMINISTRA√á√ÉO E FINAN√áAS</option>
            <option>AGRICULTURA E MEIO AMBIENTE</option>
            <option>ASSIST√äNCIA SOCIAL</option>
            <option>EDUCA√á√ÉO</option>
            <option>SA√öDE</option>
            <option>INFRAESTRUTURA E SERVI√áOS</option>
            <option>AVULSOS / GERAL</option>
          </select>
        </div>
      </div>
      <button class="btn-save" onclick="addUsuario()" style="background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);">‚ûï SALVAR USU√ÅRIO</button>
    </div>
    
    <div class="card">
      <h3>üìã USU√ÅRIOS CADASTRADOS</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>USU√ÅRIO</th>
              <th>PERFIL</th>
              <th>COMB. PERMITIDO</th>
              <th>V√çNCULO</th>
              <th>LIMITE</th>
              <th class="no-print">A√á√ïES</th>
            </tr>
          </thead>
          <tbody id="user-body"></tbody>
        </table>
      </div>
    </div>
    
    <!-- LISTA DE VE√çCULOS -->
    <div class="card">
      <h3>üöó VE√çCULOS CADASTRADOS</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>PLACA</th>
              <th>MODELO</th>
              <th>SECRETARIA</th>
              <th>MOTORISTA PADR√ÉO</th>
              <th>COMBUST√çVEL</th>
              <th>ANO</th>
              <th class="no-print">A√á√ïES</th>
            </tr>
          </thead>
          <tbody id="veiculos-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal QR Code Global -->
<div id="modal-qr" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="fecharModalQR()">&times;</span>
    <h3>üì± QR CODE DO VE√çCULO</h3>
    <div style="text-align:center;">
      <div id="qrcode-modal"></div>
      <p style="margin-top:15px; font-size:16px;"><strong>PLACA:</strong> <span id="qr-placa-modal"></span></p>
      <button class="btn-save" style="background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);" onclick="baixarQRCodeModal()">üíæ BAIXAR QR CODE</button>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDsEQ8L_hWgacZ8xweY3DR9OYt2t151kZE",
    authDomain: "tabela-gasolina.firebaseapp.com",
    databaseURL: "https://tabela-gasolina-default-rtdb.firebaseio.com", 
    projectId: "tabela-gasolina"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  
  const STATUS = {
    AGUARDANDO: 'AGUARDANDO',
    AUTORIZADO: 'AUTORIZADO',
    REJEITADO: 'REJEITADO'
  };
  
  const LIMITES_KM = {
    GASOLINA: 7,
    DIESEL: 2.5,
    ALCOOL: 5
  };
  
  const LIMITES_EXCELENTE = {
    GASOLINA: 12,
    DIESEL: 8,
    ALCOOL: 9
  };
  
  const PERFIS = {
    MASTER: 'master',
    ADMIN: 'admin',
    SECRETARIO: 'secretarios',
    FRENTISTA: 'frentista'
  };
  
  const PERMISSOES_DISPONIVEIS = {
    'ver_dashboard': { nome: 'Ver Dashboard', descricao: 'Visualizar painel principal', categoria: 'visualizacao' },
    'ver_relatorio_geral': { nome: 'Ver Relat√≥rios Gerais', descricao: 'Acessar todos os relat√≥rios', categoria: 'visualizacao' },
    'ver_relatorio_secretaria': { nome: 'Ver Relat√≥rio Secretaria', descricao: 'Ver apenas sua secretaria', categoria: 'visualizacao' },
    'registrar_abastecimento': { nome: 'Registrar Abastecimento', descricao: 'Criar novos registros', categoria: 'operacoes' },
    'autorizar_abastecimento': { nome: 'Autorizar Abastecimento', descricao: 'Aprovar/rejeitar solicita√ß√µes', categoria: 'operacoes' },
    'deletar_abastecimento': { nome: 'Deletar Abastecimento', descricao: 'Excluir registros', categoria: 'operacoes' },
    'gerenciar_veiculos': { nome: 'Gerenciar Ve√≠culos', descricao: 'Cadastrar ve√≠culos', categoria: 'gestao' },
    'gerenciar_postos': { nome: 'Gerenciar Postos', descricao: 'Cadastrar postos', categoria: 'gestao' },
    'gerenciar_usuarios': { nome: 'Gerenciar Usu√°rios', descricao: 'CRUD de usu√°rios', categoria: 'gestao' },
    'exportar_excel': { nome: 'Exportar Excel', descricao: 'Baixar relat√≥rios', categoria: 'exportacao' }
  };
  
  const PERMISSOES_PADRAO = {
    master: Object.keys(PERMISSOES_DISPONIVEIS),
    admin: ['ver_dashboard', 'ver_relatorio_geral', 'registrar_abastecimento', 'autorizar_abastecimento', 'deletar_abastecimento', 'gerenciar_veiculos', 'gerenciar_postos', 'exportar_excel'],
    secretarios: ['ver_dashboard', 'ver_relatorio_secretaria', 'registrar_abastecimento', 'exportar_excel'],
    frentista: ['ver_relatorio_geral']
  };
  
  // Fun√ß√£o para verificar permiss√µes - CORRIGIDA
  function temPermissao(permissao) {
    if (loginUser === 'master') return true;
    return userPermissions.includes(permissao);
  }
  
  // Fun√ß√£o para verificar se pode ver relat√≥rio de uma secretaria
  function podeVerRelatorio(secretaria) {
    if (temPermissao('ver_relatorio_geral')) return true;
    if (temPermissao('ver_relatorio_secretaria') && secretaria === userSecretaria) return true;
    return false;
  }
  
  let cache = [];
  let veiculos = [];
  let postos = [];
  let userLimit = 0;
  let userRole = "";
  let loginUser = "";
  let userSecretaria = "";
  let usuarioData = {};
  let precos = { GASOLINA: 6, ALCOOL: 4, DIESEL: 6 };
  let chartSec = null;
  let chartVec = null;
  let chartCombustivel = null;
  let chartTendencia = null;
  let chartExecutivo1 = null;
  let chartExecutivo2 = null;
  let chartAnual = null;
  let chartFrota = null;
  let html5QrCode = null;
  let dadosMesAnterior = null;
  let notificacoes = [];
  let deferredPrompt = null;
  let userPermissions = [];
  let usuarioEditandoPermissoes = null;
  
  db.ref('config/precos').on('value', snap => {
    if (snap.val()) {
      precos = snap.val();
    }
  });
  
  db.ref('veiculos').on('value', snap => {
    veiculos = [];
    snap.forEach(item => {
      let v = item.val();
      v.id = item.key;
      veiculos.push(v);
    });
  });
  
  db.ref('postos').on('value', snap => {
    postos = [];
    snap.forEach(item => {
      let p = item.val();
      p.id = item.key;
      postos.push(p);
    });
    atualizarSelectPostos();
  });
  
  function logar() {
    const u = document.getElementById('user').value.toLowerCase().trim();
    const s = document.getElementById('senha').value.trim();
    
    if (!u || !s) {
      mostrarNotificacao("PREENCHA USU√ÅRIO E SENHA!", "error");
      return;
    }
    
    if (u === "master" && s === "1234") {
      return entrar("master", "admin", 0, "", { 
        combustivelLiberado: "todos",
        senha: "1234",
        role: "admin",
        permissoes: Object.keys(PERMISSOES_DISPONIVEIS)
      });
    }
    
    db.ref('usuarios/' + u).once('value', snap => {
      const user = snap.val();
      if (user && user.senha === s) {
        const permissoes = user.permissoes || PERMISSOES_PADRAO[user.role] || [];
        const dadosUsuario = {
          combustivelLiberado: user.combustivelLiberado || "todos",
          senha: user.senha,
          role: user.role,
          limite: user.limite || 0,
          secretariaVinculada: user.secretariaVinculada || "",
          permissoes: permissoes
        };
        entrar(u, user.role, user.limite || 0, user.secretariaVinculada || "", dadosUsuario);
        registrarAuditoria('LOGIN', { usuario: u });
      } else {
        mostrarNotificacao("USU√ÅRIO OU SENHA INCORRETOS!", "error");
      }
    }).catch(error => {
      console.error("Erro ao buscar usu√°rio:", error);
      mostrarNotificacao("ERRO AO CONECTAR AO BANCO DE DADOS!", "error");
    });
  }
  
  function entrar(u, role, limit, sec, dadosExtras) {
    loginUser = u;
    userRole = role;
    userLimit = limit;
    userSecretaria = sec;
    usuarioData = dadosExtras || {};
    userPermissions = dadosExtras.permissoes || PERMISSOES_PADRAO[role] || [];
    
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').classList.remove('blurred');
    
    // Controle de visibilidade das abas baseado em PERMISS√ïES
    document.getElementById('btn-tab-users').style.display = 
      (loginUser === 'master' || temPermissao('gerenciar_usuarios')) ? 'block' : 'none';
    
    document.getElementById('btn-tab-pendentes').style.display = 
      (temPermissao('autorizar_abastecimento')) ? 'block' : 'none';
    
    document.getElementById('btn-tab-executivo').style.display = 
      (temPermissao('ver_dashboard')) ? 'block' : 'none';
    
    document.getElementById('btn-tab-analytics').style.display = 
      (temPermissao('ver_dashboard')) ? 'block' : 'none';
    
    // Esconder se√ß√£o de novo abastecimento se n√£o tiver permiss√£o
    if (!temPermissao('registrar_abastecimento')) {
      const novoAbastCard = document.querySelector('.card.no-print h3');
      if (novoAbastCard && novoAbastCard.textContent.includes('NOVO ABASTECIMENTO')) {
        novoAbastCard.closest('.card').style.display = 'none';
      }
    }
    
    // Controlar visibilidade do card de filtros
    if (!temPermissao('ver_relatorio_geral') && !temPermissao('ver_relatorio_secretaria')) {
      const filtroCard = document.querySelector('.card.no-print h3');
      if (filtroCard && filtroCard.textContent.includes('FILTROS')) {
        filtroCard.closest('.card').style.display = 'none';
      }
    }
    
    if (role === 'secretarios' && sec !== "") {
      document.getElementById('f-sec').value = sec;
      document.getElementById('f-sec').disabled = true;
    }
    
    mostrarNotificacao(`‚úÖ BEM-VINDO, ${u.toUpperCase()}!`, "success");
    
    // Inicializar notifica√ß√µes
    inicializarNotificacoes();
    
    // Verificar PWA
    verificarPWA();
    
    setTimeout(() => {
      renderizar();
      calcularDadosMesAnterior();
    }, 100);
  }
  
  function calc() {
    const postoNome = document.getElementById('f-posto').value;
    const tipo = document.getElementById('f-tipo').value;
    const litros = parseFloat(document.getElementById('f-lit').value) || 0;
    
    if (!postoNome) {
      document.getElementById('f-val').value = "R$ 0.00";
      return;
    }
    
    const postoData = postos.find(p => p.nome === postoNome);
    
    if (!postoData || !postoData.precos) {
      mostrarNotificacao("‚ö†Ô∏è POSTO N√ÉO ENCONTRADO OU SEM PRE√áOS CADASTRADOS!", "warning");
      document.getElementById('f-val').value = "R$ 0.00";
      return;
    }
    
    const precoLitro = postoData.precos[tipo] || 0;
    const valorTotal = litros * precoLitro;
    
    document.getElementById('f-val').value = "R$ " + valorTotal.toFixed(2);
    
    // Atualizar previs√£o de consumo
    atualizarPrevisaoConsumo();
  }
  
  function atualizarPrevisaoConsumo() {
    const placa = document.getElementById('f-placa').value.toUpperCase().trim();
    const tipo = document.getElementById('f-tipo').value;
    const litros = parseFloat(document.getElementById('f-lit').value) || 0;
    const kmAtual = parseFloat(document.getElementById('f-km').value) || 0;
    
    if (!placa || litros === 0 || kmAtual === 0) {
      document.getElementById('previsao-consumo').style.display = 'none';
      return;
    }
    
    const historico = cache
      .filter(v => v.placa === placa && v.tipo === tipo && v.status === STATUS.AUTORIZADO)
      .sort((a, b) => b.timestamp - a.timestamp)
      .slice(0, 5);
    
    if (historico.length === 0) {
      document.getElementById('previsao-consumo').style.display = 'none';
      return;
    }
    
    const ultimoAbast = historico[0];
    const kmRodados = kmAtual - ultimoAbast.km;
    const mediaEsperada = kmRodados / litros;
    
    const mediaHistorica = calcularMediaAvancada(placa, tipo);
    
    const previsaoDiv = document.getElementById('previsao-content');
    const limiteMinimo = LIMITES_KM[tipo] || 0;
    const limiteExcelente = LIMITES_EXCELENTE[tipo] || 15;
    
    let statusConsumo = "";
    let corStatus = "";
    
    if (mediaEsperada >= limiteExcelente) {
      statusConsumo = "EXCELENTE ‚≠ê";
      corStatus = "var(--success)";
    } else if (mediaEsperada >= limiteMinimo) {
      statusConsumo = "NORMAL ‚úÖ";
      corStatus = "#3b82f6";
    } else {
      statusConsumo = "ABAIXO DO ESPERADO ‚ö†Ô∏è";
      corStatus = "var(--danger)";
    }
    
    previsaoDiv.innerHTML = `
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; text-align:center;">
        <div>
          <div style="font-size:11px; color:#64748b;">KM RODADOS</div>
          <div style="font-size:18px; font-weight:bold;">${kmRodados.toFixed(0)} km</div>
        </div>
        <div>
          <div style="font-size:11px; color:#64748b;">M√âDIA PREVISTA</div>
          <div style="font-size:18px; font-weight:bold; color:${corStatus};">${mediaEsperada.toFixed(2)} km/l</div>
        </div>
        <div>
          <div style="font-size:11px; color:#64748b;">STATUS</div>
          <div style="font-size:14px; font-weight:bold; color:${corStatus};">${statusConsumo}</div>
        </div>
      </div>
      ${mediaHistorica > 0 ? `
      <div style="margin-top:10px; font-size:11px; color:#64748b; text-align:center;">
        M√©dia Hist√≥rica: <strong>${mediaHistorica.toFixed(2)} km/l</strong>
        ${mediaEsperada < mediaHistorica * 0.7 ? '<span style="color:var(--danger);"> ‚ö†Ô∏è CONSUMO MUITO ACIMA DO NORMAL!</span>' : ''}
      </div>
      ` : ''}
    `;
    
    document.getElementById('previsao-consumo').style.display = 'block';
  }
  
  function validarKmAtual() {
    const placa = document.getElementById('f-placa').value.toUpperCase().trim();
    const kmAtual = parseFloat(document.getElementById('f-km').value) || 0;
    
    if (!placa || kmAtual === 0) return;
    
    const ultimoAbast = cache
      .filter(x => x.placa === placa && x.status === STATUS.AUTORIZADO)
      .sort((a, b) => b.timestamp - a.timestamp)[0];
    
    if (ultimoAbast && kmAtual < ultimoAbast.km) {
      mostrarNotificacao(`‚ö†Ô∏è ATEN√á√ÉO: KM ATUAL (${kmAtual}) √â MENOR QUE O √öLTIMO REGISTRADO (${ultimoAbast.km})!`, "warning");
    }
    
    atualizarPrevisaoConsumo();
  }
  
  function calcularMediaAvancada(placa, combustivel) {
    const historico = cache
      .filter(v => v.placa === placa && v.tipo === combustivel && v.status === STATUS.AUTORIZADO)
      .sort((a, b) => b.timestamp - a.timestamp)
      .slice(0, 5);
    
    if (historico.length < 2) return 0;
    
    let totalKm = 0, totalLitros = 0;
    for (let i = 0; i < historico.length - 1; i++) {
      const kmDif = historico[i].km - historico[i + 1].km;
      if (kmDif > 0) {
        totalKm += kmDif;
        totalLitros += historico[i].litro;
      }
    }
    
    return totalLitros > 0 ? totalKm / totalLitros : 0;
  }
  
  function atualizarPrecosPosto() {
    calc();
  }
  
  function atualizarSelectPostos() {
    const select = document.getElementById('f-posto');
    const selectRel = document.getElementById('rel-posto');
    
    if (select) {
      select.innerHTML = '<option value="">SELECIONE O POSTO</option>';
      postos.forEach(p => {
        select.innerHTML += `<option value="${p.nome}">${p.nome}</option>`;
      });
    }
    
    if (selectRel) {
      selectRel.innerHTML = '<option value="">TODOS</option>';
      postos.forEach(p => {
        selectRel.innerHTML += `<option value="${p.nome}">${p.nome}</option>`;
      });
    }
  }
  
  function calcularMedia(abastecimento) {
    const historico = cache
      .filter(v => 
        v.placa === abastecimento.placa && 
        v.timestamp < abastecimento.timestamp &&
        v.status === STATUS.AUTORIZADO
      )
      .sort((a, b) => b.timestamp - a.timestamp);
    
    if (historico.length === 0 || abastecimento.litro <= 0) {
      return 0;
    }
    
    const kmAnterior = historico[0].km;
    const kmAtual = abastecimento.km;
    const litros = abastecimento.litro;
    
    return (kmAtual - kmAnterior) / litros;
  }
  
  function validarAbastecimento(dados) {
    const erros = [];
    
    if (!dados.placa || dados.placa.length < 7) {
      erros.push("‚ùå PLACA INV√ÅLIDA");
    }
    if (!dados.posto || dados.posto === "") {
      erros.push("‚ùå SELECIONE O POSTO");
    }
    if (!dados.motorista || dados.motorista.trim() === "") {
      erros.push("‚ùå MOTORISTA OBRIGAT√ìRIO");
    }
    if (!dados.data) {
      erros.push("‚ùå DATA OBRIGAT√ìRIA");
    }
    const hoje = new Date().toISOString().split('T')[0];
    if (dados.data > hoje) {
      erros.push("‚ùå DATA N√ÉO PODE SER FUTURA");
    }
    if (dados.litro <= 0) {
      erros.push("‚ùå LITROS DEVE SER MAIOR QUE ZERO");
    }
    if (dados.km <= 0) {
      erros.push("‚ùå KM DEVE SER MAIOR QUE ZERO");
    }
    
    const ultimoAbast = cache
      .filter(x => x.placa === dados.placa && x.status === STATUS.AUTORIZADO)
      .sort((a, b) => b.timestamp - a.timestamp)[0];
    if (ultimoAbast && dados.km < ultimoAbast.km) {
      erros.push(`‚ùå KM ATUAL (${dados.km}) N√ÉO PODE SER MENOR QUE O √öLTIMO REGISTRADO (${ultimoAbast.km})`);
    }
    return erros;
  }
  
  async function processar() {
    if (!temPermissao('registrar_abastecimento')) {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA REGISTRAR ABASTECIMENTO!", "error");
      return;
    }
  
    const btnRegistrar = document.getElementById('btn-registrar');
    const textoOriginal = btnRegistrar.innerHTML;
  
    btnRegistrar.disabled = true;
    btnRegistrar.innerHTML = '<div class="loading"></div> PROCESSANDO...';
  
    try {
      const dados = {
        placa: document.getElementById('f-placa').value.toUpperCase().trim(),
        posto: document.getElementById('f-posto').value,
        motorista: document.getElementById('f-mot').value.toUpperCase().trim(),
        data: document.getElementById('f-data').value,
        tipo: document.getElementById('f-tipo').value,
        secretaria: document.getElementById('f-sec').value,
        litro: parseFloat(document.getElementById('f-lit').value) || 0,
        km: parseFloat(document.getElementById('f-km').value) || 0
      };
  
      // üîç Valida√ß√£o
      const erros = validarAbastecimento(dados);
      if (erros.length > 0) {
        mostrarNotificacao(erros.join("\n"), "error");
        return;
      }
  
      // üîê Permiss√£o por combust√≠vel
      if (usuarioData.combustivelLiberado !== 'todos' && 
          usuarioData.combustivelLiberado !== dados.tipo) {
        mostrarNotificacao(
          "‚õî VOC√ä N√ÉO TEM PERMISS√ÉO PARA ESTE TIPO DE COMBUST√çVEL!",
          "error"
        );
        return;
      }
  
      // ‚õΩ Buscar pre√ßo do posto
      const postoData = postos.find(p => p.nome === dados.posto);
      if (!postoData || !postoData.precos || postoData.precos[dados.tipo] == null) {
        mostrarNotificacao(
          "‚ùå ERRO: PRE√áO DO COMBUST√çVEL N√ÉO CONFIGURADO NO POSTO!",
          "error"
        );
        return;
      }
  
      dados.precoPorLitro = postoData.precos[dados.tipo];
      dados.valor = dados.litro * dados.precoPorLitro;
  
      // üßæ AVULSOS / GERAL ‚Äî hist√≥rico
      if (dados.secretaria === 'AVULSOS / GERAL') {
        const ultimosAbastecimentos = cache
          .filter(x => x.placa === dados.placa && x.status === STATUS.AUTORIZADO)
          .sort((a, b) => b.timestamp - a.timestamp)
          .slice(0, 5);
  
        if (ultimosAbastecimentos.length > 0) {
          const confirmar = await mostrarModalHistorico(dados.placa, ultimosAbastecimentos);
          if (!confirmar) return;
        }
      }
  
      // üíæ SALVAR ABASTECIMENTO
      const status = (temPermissao('autorizar_abastecimento')) 
        ? STATUS.AUTORIZADO 
        : STATUS.AGUARDANDO;
      
      await db.ref('abastecimentos').push({
        ...dados,
        status: status,
        solicitadoPor: loginUser.toUpperCase(),
        timestamp: Date.now()
      });
  
      mostrarNotificacao(
        status === STATUS.AUTORIZADO
          ? "‚úÖ ABASTECIMENTO REGISTRADO COM SUCESSO!"
          : "üì§ SOLICITA√á√ÉO ENVIADA PARA APROVA√á√ÉO!",
        "success"
      );
      
      registrarAuditoria('ABASTECIMENTO_REGISTRADO', {
        placa: dados.placa,
        valor: dados.valor,
        status: status
      });
      
      limparFormulario();
      
    } catch (erro) {
      console.error(erro);
      mostrarNotificacao("‚ùå Erro ao registrar abastecimento!", "error");
    } finally {
      btnRegistrar.disabled = false;
      btnRegistrar.innerHTML = textoOriginal;
    }
  }
  
  function aprovar(id) {
    if (!temPermissao('autorizar_abastecimento')) {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA APROVAR!", "error");
      return;
    }
    
    if (!confirm("‚úÖ CONFIRMA A APROVA√á√ÉO DESTE ABASTECIMENTO?")) return;
    
    db.ref('abastecimentos/' + id).update({ 
      status: STATUS.AUTORIZADO,
      aprovadoPor: loginUser.toUpperCase(),
      aprovadoEm: Date.now()
    }).then(() => {
      registrarAuditoria('ABASTECIMENTO_APROVADO', { id: id });
      mostrarNotificacao("‚úÖ ABASTECIMENTO APROVADO!", "success");
    });
  }
  
  function rejeitar(id) {
    if (!temPermissao('autorizar_abastecimento')) {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA REJEITAR!", "error");
      return;
    }
    
    if (!confirm("‚ö†Ô∏è TEM CERTEZA QUE DESEJA REJEITAR ESTA SOLICITA√á√ÉO?")) return;
    const motivo = prompt("üìù MOTIVO DA REJEI√á√ÉO (OPCIONAL):");
    db.ref('abastecimentos/' + id).update({
      status: STATUS.REJEITADO,
      rejeitadoPor: loginUser.toUpperCase(),
      rejeitadoEm: Date.now(),
      motivoRejeicao: motivo || "N√ÉO INFORMADO"
    }).then(() => {
      registrarAuditoria('ABASTECIMENTO_REJEITADO', { id: id, motivo: motivo });
      mostrarNotificacao("‚ùå SOLICITA√á√ÉO REJEITADA!", "success");
    });
  }
  
  function deletar(id) {
    if (!temPermissao('deletar_abastecimento')) {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA EXCLUIR!", "error");
      return;
    }
    
    if (!confirm("‚ö†Ô∏è TEM CERTEZA QUE DESEJA EXCLUIR ESTE REGISTRO?\n\n‚õî ESTA A√á√ÉO N√ÉO PODE SER DESFEITA!")) return;
    db.ref('abastecimentos/' + id).remove().then(() => {
      registrarAuditoria('ABASTECIMENTO_DELETADO', { id: id });
      mostrarNotificacao("üóëÔ∏è REGISTRO EXCLU√çDO COM SUCESSO!", "success");
    });
  }
  
  function registrarAuditoria(acao, dados) {
    db.ref('auditoria').push({
      acao: acao,
      usuario: loginUser.toUpperCase(),
      timestamp: Date.now(),
      dados: dados
    });
  }
  
  function renderizar() {
    if (!loginUser) return;
    
    // Verificar se usu√°rio pode ver dashboard
    if (temPermissao('ver_dashboard') || temPermissao('ver_relatorio_geral') || temPermissao('ver_relatorio_secretaria')) {
      atualizarStatusFinanceiro();
      
      // S√≥ mostrar estat√≠sticas se tiver permiss√£o
      if (temPermissao('ver_dashboard')) {
        atualizarEstatisticas();
        atualizarGraficos();
        atualizarAlertas();
      } else {
        document.getElementById('stats-container').style.display = 'none';
        document.getElementById('alertas-container').style.display = 'none';
        const chartsRow = document.querySelector('.charts-row');
        if (chartsRow) chartsRow.style.display = 'none';
      }
    }
    
    atualizarRelatorio();
    
    if (temPermissao('autorizar_abastecimento')) {
      atualizarPendentes();
    }
  }
  
  function atualizarAlertas() {
    const alertasContainer = document.getElementById('alertas-container');
    let alertasHtml = '';
    
    // S√≥ mostrar alertas se tiver permiss√£o para ver dashboard
    if (!temPermissao('ver_dashboard')) {
      alertasContainer.innerHTML = '';
      return;
    }
    
    // Alertas de m√©dia baixa por ve√≠culo
    const veiculosComMedia = {};
    
    cache.filter(x => x.status === STATUS.AUTORIZADO).forEach(abast => {
      if (!veiculosComMedia[abast.placa]) {
        veiculosComMedia[abast.placa] = {
          placa: abast.placa,
          tipo: abast.tipo,
          abastecimentos: []
        };
      }
      veiculosComMedia[abast.placa].abastecimentos.push(abast);
    });
    
    const alertasMediaBaixa = [];
    
    Object.values(veiculosComMedia).forEach(veiculo => {
      const abasts = veiculo.abastecimentos.sort((a, b) => b.timestamp - a.timestamp);
      
      if (abasts.length >= 2) {
        let totalKm = 0, totalLitros = 0;
        
        for (let i = 0; i < Math.min(5, abasts.length - 1); i++) {
          const kmDif = abasts[i].km - abasts[i + 1].km;
          if (kmDif > 0) {
            totalKm += kmDif;
            totalLitros += abasts[i].litro;
          }
        }
        
        const mediaGeral = totalLitros > 0 ? totalKm / totalLitros : 0;
        
        // Limites personalizados por tipo de combust√≠vel
        const limiteAlerta = veiculo.tipo === 'DIESEL' ? 4 : 9;
        
        if (mediaGeral > 0 && mediaGeral < limiteAlerta) {
          alertasMediaBaixa.push({
            placa: veiculo.placa,
            media: mediaGeral,
            tipo: veiculo.tipo,
            limite: limiteAlerta
          });
        }
      }
    });
    
    if (alertasMediaBaixa.length > 0) {
      alertasHtml += '<div class="alert-box danger">';
      alertasHtml += '<h4 style="margin:0 0 10px 0; font-size:14px;">üö® ALERTAS DE EFICI√äNCIA BAIXA</h4>';
      alertasMediaBaixa.forEach(alerta => {
        alertasHtml += `
          <div style="margin-bottom:8px; padding:10px; background:white; border-radius:6px; border-left:4px solid var(--danger);">
            <strong>${alerta.placa}</strong> - M√©dia: <span style="color:var(--danger); font-weight:bold;">${alerta.media.toFixed(2)} km/l</span>
            <span style="font-size:11px; color:#64748b;"> (${alerta.tipo} - Limite m√≠nimo: ${alerta.limite} km/l)</span>
            <button class="btn-action" style="background:var(--accent); color:white; margin-left:10px; font-size:10px;" onclick="analisarVeiculo('${alerta.placa}')">
              üìä VER AN√ÅLISE
            </button>
          </div>
        `;
      });
      alertasHtml += '</div>';
    }
    
    // Alerta de limite de secretaria
    if (userRole === 'secretarios') {
      const gastoComprometido = cache
        .filter(x => 
          (x.status === STATUS.AUTORIZADO || x.status === STATUS.AGUARDANDO) &&
          x.secretaria === userSecretaria
        )
        .reduce((acc, item) => acc + item.valor, 0);
      
      const percentualGasto = (gastoComprometido / userLimit) * 100;
      
      if (percentualGasto >= 80) {
        alertasHtml += `
          <div class="alert-box ${percentualGasto >= 95 ? 'danger' : ''}">
            <h4 style="margin:0 0 10px 0; font-size:14px;">‚ö†Ô∏è ATEN√á√ÉO AO LIMITE OR√áAMENT√ÅRIO</h4>
            <p style="margin:0;">
              Voc√™ j√° utilizou <strong>${percentualGasto.toFixed(1)}%</strong> do limite mensal.
              <br>Saldo restante: <strong>R$ ${(userLimit - gastoComprometido).toFixed(2)}</strong>
            </p>
            <div class="progress-bar" style="margin-top:10px;">
              <div class="progress-fill ${percentualGasto >= 95 ? 'danger' : 'warning'}" style="width:${percentualGasto}%"></div>
            </div>
          </div>
        `;
      }
    }
    
    alertasContainer.innerHTML = alertasHtml;
  }
  
  function analisarVeiculo(placa) {
    if (!temPermissao('ver_dashboard')) {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA VER AN√ÅLISES!", "error");
      return;
    }
    
    const historico = cache
      .filter(x => x.placa === placa && x.status === STATUS.AUTORIZADO)
      .sort((a, b) => b.timestamp - a.timestamp);
    
    if (historico.length < 2) {
      mostrarNotificacao("‚ùå HIST√ìRICO INSUFICIENTE PARA AN√ÅLISE", "error");
      return;
    }
    
    const analiseContent = document.getElementById('analise-content');
    
    let medias = [];
    for (let i = 0; i < historico.length - 1; i++) {
      const kmDif = historico[i].km - historico[i + 1].km;
      const media = kmDif / historico[i].litro;
      medias.push({
        data: historico[i].data,
        media: media,
        km: historico[i].km,
        litros: historico[i].litro,
        valor: historico[i].valor
      });
    }
    
    const mediaGeral = medias.reduce((acc, m) => acc + m.media, 0) / medias.length;
    const totalGasto = historico.reduce((acc, h) => acc + h.valor, 0);
    const totalLitros = historico.reduce((acc, h) => acc + h.litro, 0);
    
    let tabelaHtml = `
      <div style="margin-bottom:20px;">
        <div class="stats-grid" style="grid-template-columns:1fr 1fr 1fr;">
          <div class="stat-card">
            <h4>M√âDIA GERAL</h4>
            <div class="stat-value" style="color:${mediaGeral < 4 ? 'var(--danger)' : 'var(--success)'}">
              ${mediaGeral.toFixed(2)} km/l
            </div>
          </div>
          <div class="stat-card">
            <h4>TOTAL GASTO</h4>
            <div class="stat-value">R$ ${totalGasto.toFixed(2)}</div>
          </div>
          <div class="stat-card">
            <h4>TOTAL LITROS</h4>
            <div class="stat-value">${totalLitros.toFixed(1)} L</div>
          </div>
        </div>
      </div>
      
      <h4 style="margin-top:20px; font-size:13px;">HIST√ìRICO DE CONSUMO</h4>
      <div style="max-height:300px; overflow-y:auto;">
        <table style="width:100%; font-size:11px;">
          <thead>
            <tr style="background:#f8fafc;">
              <th style="padding:8px;">DATA</th>
              <th>KM</th>
              <th>LITROS</th>
              <th>M√âDIA</th>
              <th>VALOR</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    medias.forEach(m => {
      const corMedia = m.media < 4 ? 'var(--danger)' : (m.media > 10 ? 'var(--success)' : '#64748b');
      tabelaHtml += `
        <tr>
          <td style="padding:6px;">${m.data.split('-').reverse().join('/')}</td>
          <td>${m.km.toLocaleString('pt-BR')}</td>
          <td>${m.litros.toFixed(1)}L</td>
          <td style="font-weight:bold; color:${corMedia};">${m.media.toFixed(2)} km/l</td>
          <td>R$ ${m.valor.toFixed(2)}</td>
        </tr>
      `;
    });
    
    tabelaHtml += `
          </tbody>
        </table>
      </div>
      
      <div style="margin-top:20px; padding:15px; background:#f8fafc; border-radius:8px;">
        <h4 style="margin:0 0 10px 0; font-size:12px;">üí° RECOMENDA√á√ïES</h4>
        <ul style="margin:0; padding-left:20px; font-size:11px; line-height:1.8;">
          ${mediaGeral < 4 ? '<li style="color:var(--danger);">‚ö†Ô∏è M√©dia muito abaixo do esperado. Verifique manuten√ß√£o do ve√≠culo.</li>' : ''}
          ${mediaGeral < 7 && mediaGeral >= 4 ? '<li style="color:var(--warning);">‚ö†Ô∏è M√©dia abaixo do ideal. Considere revis√£o preventiva.</li>' : ''}
          ${mediaGeral >= 10 ? '<li style="color:var(--success);">‚úÖ Ve√≠culo com excelente efici√™ncia!</li>' : ''}
          <li>üìã Total de abastecimentos analisados: <strong>${historico.length}</strong></li>
          <li>üìÖ Per√≠odo: ${historico[historico.length - 1].data.split('-').reverse().join('/')} a ${historico[0].data.split('-').reverse().join('/')}</li>
        </ul>
      </div>
    `;
    
    analiseContent.innerHTML = tabelaHtml;
    document.getElementById('modal-analise').style.display = 'flex';
  }
  
  function fecharModalAnalise() {
    document.getElementById('modal-analise').style.display = 'none';
  }
  
  let resolveModalHistorico = null;
  
  function mostrarModalHistorico(placa, ultimosAbastecimentos) {
    return new Promise((resolve) => {
      resolveModalHistorico = resolve;
      
      const modal = document.getElementById('modal-historico-avulso');
      const content = document.getElementById('historico-avulso-content');
      
      let html = `
        <p style="margin:15px 0; font-size:13px; color:#64748b;">
          Ve√≠culo <strong style="color:var(--primary);">${placa}</strong> possui os seguintes abastecimentos registrados:
        </p>
        <div style="background:#f8fafc; border-radius:8px; padding:15px; max-height:400px; overflow-y:auto;">
      `;
      
      ultimosAbastecimentos.forEach((abast, index) => {
        const mediaAbast = index < ultimosAbastecimentos.length - 1 
          ? (abast.km - ultimosAbastecimentos[index + 1].km) / abast.litro 
          : 0;
        
        const corSecretaria = abast.secretaria === 'AVULSOS / GERAL' ? '#94a3b8' : 'var(--accent)';
        
        html += `
          <div style="background:white; padding:12px; border-radius:8px; margin-bottom:10px; border-left:4px solid ${corSecretaria};">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:8px;">
              <div>
                <div style="font-size:10px; color:#64748b; text-transform:uppercase;">Data</div>
                <div style="font-size:13px; font-weight:bold;">${abast.data.split('-').reverse().join('/')}</div>
              </div>
              <div>
                <div style="font-size:10px; color:#64748b; text-transform:uppercase;">KM</div>
                <div style="font-size:13px; font-weight:bold;">${abast.km.toLocaleString('pt-BR')}</div>
              </div>
            </div>
            <div style="font-size:10px; color:#64748b; text-transform:uppercase; margin-bottom:4px;">Secretaria</div>
            <div style="font-size:12px; font-weight:bold; color:${corSecretaria}; margin-bottom:8px;">
              ${abast.secretaria}
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; padding-top:8px; border-top:1px solid #e2e8f0;">
              <div style="text-align:center;">
                <div style="font-size:10px; color:#64748b;">LITROS</div>
                <div style="font-size:13px; font-weight:bold;">${abast.litro.toFixed(1)}L</div>
              </div>
              <div style="text-align:center;">
                <div style="font-size:10px; color:#64748b;">M√âDIA</div>
                <div style="font-size:13px; font-weight:bold; color:${mediaAbast > 0 && mediaAbast < 4 ? 'var(--danger)' : 'var(--success)'};">
                  ${mediaAbast > 0 ? mediaAbast.toFixed(2) + ' km/l' : '---'}
                </div>
              </div>
              <div style="text-align:center;">
                <div style="font-size:10px; color:#64748b;">VALOR</div>
                <div style="font-size:13px; font-weight:bold;">R$ ${abast.valor.toFixed(2)}</div>
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      content.innerHTML = html;
      modal.style.display = 'flex';
    });
  }
  
  function fecharModalHistoricoAvulso(confirmar) {
    const modal = document.getElementById('modal-historico-avulso');
    modal.style.display = 'none';
    if (resolveModalHistorico) {
      resolveModalHistorico(confirmar);
      resolveModalHistorico = null;
    }
  }
  
  function atualizarEstatisticas() {
    const container = document.getElementById('stats-container');
    const dadosAutorizados = cache.filter(x => x.status === STATUS.AUTORIZADO);
    
    const totalGasto = dadosAutorizados.reduce((acc, item) => acc + item.valor, 0);
    const totalLitros = dadosAutorizados.reduce((acc, item) => acc + item.litro, 0);
    const totalAbastecimentos = dadosAutorizados.length;
    const veiculosUnicos = [...new Set(dadosAutorizados.map(x => x.placa))].length;
    
    // Comparar com m√™s anterior
    let trendGasto = '';
    let trendLitros = '';
    
    if (dadosMesAnterior) {
      const diferencaGasto = totalGasto - dadosMesAnterior.totalGasto;
      const percentualGasto = dadosMesAnterior.totalGasto > 0 
        ? (diferencaGasto / dadosMesAnterior.totalGasto * 100) 
        : 0;
      
      const diferencaLitros = totalLitros - dadosMesAnterior.totalLitros;
      const percentualLitros = dadosMesAnterior.totalLitros > 0
        ? (diferencaLitros / dadosMesAnterior.totalLitros * 100)
        : 0;
      
      trendGasto = `
        <div class="stat-trend ${diferencaGasto >= 0 ? 'negative' : 'positive'}">
          ${diferencaGasto >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(percentualGasto).toFixed(1)}% vs m√™s anterior
        </div>
      `;
      
      trendLitros = `
        <div class="stat-trend ${diferencaLitros >= 0 ? 'negative' : 'positive'}">
          ${diferencaLitros >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(percentualLitros).toFixed(1)}% vs m√™s anterior
        </div>
      `;
    }
    
    container.innerHTML = `
      <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <h4>TOTAL GASTO</h4>
        <div class="stat-value">R$ ${totalGasto.toFixed(2)}</div>
        ${trendGasto}
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚õΩ</div>
        <h4>TOTAL LITROS</h4>
        <div class="stat-value">${totalLitros.toFixed(1)} L</div>
        ${trendLitros}
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <h4>ABASTECIMENTOS</h4>
        <div class="stat-value">${totalAbastecimentos}</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üöó</div>
        <h4>VE√çCULOS</h4>
        <div class="stat-value">${veiculosUnicos}</div>
      </div>
    `;
  }
  
  function calcularDadosMesAnterior() {
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    
    let mesAnterior = mesAtual - 1;
    let anoAnterior = anoAtual;
    
    if (mesAnterior < 0) {
      mesAnterior = 11;
      anoAnterior = anoAtual - 1;
    }
    
    const dadosMesPassado = cache.filter(x => {
      if (x.status !== STATUS.AUTORIZADO) return false;
      const dataAbast = new Date(x.data);
      return dataAbast.getMonth() === mesAnterior && dataAbast.getFullYear() === anoAnterior;
    });
    
    dadosMesAnterior = {
      totalGasto: dadosMesPassado.reduce((acc, item) => acc + item.valor, 0),
      totalLitros: dadosMesPassado.reduce((acc, item) => acc + item.litro, 0),
      totalAbastecimentos: dadosMesPassado.length
    };
  }
  
  function atualizarStatusFinanceiro() {
    const statusDiv = document.getElementById('status-financeiro');
    
    // Frentista: mostrar apenas status de visualiza√ß√£o SEM VALORES
    if (userRole === 'frentista') {
      const totalPendente = cache.filter(x => x.status === STATUS.AGUARDANDO).length;
      const totalAutorizado = cache.filter(x => x.status === STATUS.AUTORIZADO).length;
      const totalRejeitado = cache.filter(x => x.status === STATUS.REJEITADO).length;
      
      statusDiv.innerHTML = `
        üë§ OPERADOR: ${loginUser.toUpperCase()} 
        <span class="badge badge-danger">FRENTISTA</span><br>
        üìä VISUALIZA√á√ÉO: ${totalAutorizado} APROVADOS | ‚è≥ ${totalPendente} PENDENTES | ‚ùå ${totalRejeitado} REJEITADOS
      `;
      statusDiv.style.background = 'linear-gradient(135deg, #64748b 0%, #475569 100%)';
      return;
    }
    
    if (userRole === 'secretarios') {
      const gasto = cache.filter(x => 
        (x.status === STATUS.AUTORIZADO || x.status === STATUS.AGUARDANDO) &&
        x.secretaria === userSecretaria
      ).reduce((acc, item) => acc + item.valor, 0);
      
      const saldo = userLimit - gasto;
      const percentual = (gasto / userLimit * 100).toFixed(1);
      statusDiv.innerHTML = `
        üìä ${userSecretaria}<br>
        üí∞ LIMITE: R$ ${userLimit.toFixed(2)} | 
        üìâ GASTO: R$ ${gasto.toFixed(2)} (${percentual}%) | 
        ‚úÖ SALDO: R$ ${saldo.toFixed(2)}
        <div class="progress-bar">
          <div class="progress-fill ${saldo < userLimit * 0.2 ? 'danger' : (saldo < userLimit * 0.5 ? 'warning' : '')}" style="width:${percentual}%"></div>
        </div>
      `;
      if (saldo < userLimit * 0.2) {
        statusDiv.style.background = 'linear-gradient(135deg, var(--danger) 0%, #dc2626 100%)';
      } else if (saldo < userLimit * 0.5) {
        statusDiv.style.background = 'linear-gradient(135deg, var(--warning) 0%, #f97316 100%)';
      } else {
        statusDiv.style.background = 'linear-gradient(135deg, var(--primary) 0%, #1e293b 100%)';
      }
    } else {
      const totalGasto = cache.filter(x => x.status === STATUS.AUTORIZADO)
        .reduce((acc, item) => acc + item.valor, 0);
      const totalPendente = cache.filter(x => x.status === STATUS.AGUARDANDO)
        .reduce((acc, item) => acc + item.valor, 0);
      const pendentesQtd = cache.filter(x => x.status === STATUS.AGUARDANDO).length;
      statusDiv.innerHTML = `
        üë§ OPERADOR: ${loginUser.toUpperCase()} 
        <span class="badge badge-success">${userRole.toUpperCase()}</span><br>
        üí∞ TOTAL APROVADO: R$ ${totalGasto.toFixed(2)} | 
        ‚è≥ PENDENTE: R$ ${totalPendente.toFixed(2)} (${pendentesQtd})
      `;
    }
  }
  
  function atualizarRelatorio() {
    let listaSecs = [...new Set(cache.map(x => x.secretaria))].sort();
    
    // Filtrar secretarias baseado nas permiss√µes
    if (temPermissao('ver_relatorio_secretaria') && !temPermissao('ver_relatorio_geral')) {
      listaSecs = listaSecs.filter(sec => sec === userSecretaria);
