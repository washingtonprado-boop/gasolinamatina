<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Combust√≠vel Matina/BA</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <style>
        :root { 
            --primary: #0f172a; --accent: #3b82f6; --success: #22c55e; 
            --warning: #f59e0b; --danger: #ef4444; --bg: #f1f5f9; 
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; text-transform: uppercase; }
        body { background-color: var(--bg); margin: 0; padding: 10px; color: #1e293b; }
        .container { max-width: 1200px; margin: 0 auto; }
        .blurred { filter: blur(15px); pointer-events: none; }

        #login-screen { 
            position: fixed; inset: 0; background: var(--primary); z-index: 999; 
            display: flex; align-items: center; justify-content: center; flex-direction: column; color: white; 
        }
        .login-box { width: 90%; max-width: 320px; }
        .login-box input { 
            width: 100%; padding: 15px; border-radius: 10px; border: none; 
            margin-bottom: 10px; text-align: center; font-size: 16px; 
        }

        .card { 
            background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; 
        }
        
        .resumo-geral { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .mini-card { background: var(--primary); color: white; padding: 15px; border-radius: 10px; text-align: center; }
        .mini-card span { display: block; font-size: 10px; opacity: 0.8; margin-bottom: 5px; }
        .mini-card b { font-size: 1.2em; }

        .sec-block { margin-top: 25px; border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: white; }
        .sec-header { background: var(--primary); color: white; padding: 12px 15px; font-weight: bold; font-size: 14px; }

        .form-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 768px) { .form-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } }

        .table-scroll { overflow-x: auto; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; font-size: 11px; }
        th { background: #f8fafc; padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; }
        
        .subtotal-row { background: #f8fafc; font-weight: bold; color: var(--primary); }
        .consumo-baixo { background-color: #fee2e2 !important; color: #991b1b; }

        input, select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; }
        label { font-size: 11px; font-weight: bold; color: #64748b; margin-bottom: 5px; display: block; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; }
        .btn-save { background: var(--success); font-size: 16px; }
        .btn-edit { background: var(--warning); padding: 5px 10px; border: none; border-radius: 4px; color: white; cursor: pointer; }
        .btn-del { background: var(--danger); padding: 5px 10px; border: none; border-radius: 4px; color: white; cursor: pointer; }

        @media print { .no-print { display: none !important; } .sec-block { break-inside: avoid; border: 1px solid #ccc; } }
    </style>
</head>
<body>

<div id="login-screen">
    <h2>MATINA/BA ‚õΩ</h2>
    <div class="login-box">
        <input type="password" id="senha" placeholder="DIGITE A SENHA" onkeydown="if(event.key==='Enter') logar()">
        <button class="btn" style="background: var(--accent);" onclick="logar()">ENTRAR</button>
    </div>
</div>

<div class="container blurred" id="app">
    
    <div class="charts-row no-print" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="card">
            <h4>üí∞ GASTOS POR SECRETARIA</h4>
            <div class="chart-container" style="height:250px;"><canvas id="chartSec"></canvas></div>
        </div>
        <div class="card">
            <h4>üöõ TOP 5 VE√çCULOS (R$)</h4>
            <div class="chart-container" style="height:250px;"><canvas id="chartVec"></canvas></div>
        </div>
    </div>

    <div class="card no-print">
        <h3>‚õΩ NOVO LAN√áAMENTO</h3>
        <div class="form-grid">
            <div><label>PLACA</label><input type="text" id="f-placa" placeholder="ABC1234" oninput="sugerir(this.value)"></div>
            <div>
                <label>SECRETARIA</label>
                <select id="f-sec">
                    <option value="AVULSOS">AVULSOS / GERAL</option>
                    <option value="Administra√ß√£o e Finan√ßas">ADM. E FINAN√áAS</option>
                    <option value="Infraestrutura e Servi√ßos">INFRAESTRUTURA</option>
                    <option value="Educa√ß√£o">EDUCA√á√ÉO</option>
                    <option value="Sa√∫de">SA√öDE</option>
                    <option value="Agricultura e Meio Ambiente">AGRICULTURA</option>
                    <option value="Assist√™ncia Social">ASSIST√äNCIA SOCIAL</option>
                </select>
            </div>
            <div><label>MOTORISTA</label><input type="text" id="f-mot"></div>
            <div>
                <label>AUTORIZADO POR</label>
                <select id="f-aut">
                    <option value="N√ÉO INFORMADO">SELECIONE</option>
                    <option value="GILVAR">GILVAR</option>
                    <option value="ENIO">ENIO</option>
                </select>
            </div>
            <div><label>POSTO</label><select id="f-posto" onchange="calc()"><option>POSTO VITOR</option><option>POSTO MATINA</option></select></div>
            <div><label>VALOR LITRO (R$)</label><input type="number" id="f-preco" value="5.89" step="0.01" oninput="calc()"></div>
            <div><label>DATA</label><input type="date" id="f-data"></div>
            <div><label>KM ATUAL</label><input type="number" id="f-km"></div>
            <div><label>LITROS</label><input type="number" id="f-lit" step="0.01" oninput="calc('L')"></div>
            <div><label>TOTAL (R$)</label><input type="number" id="f-val" step="0.01" oninput="calc('V')"></div>
        </div>
        <button id="btn-save" class="btn btn-save" style="margin-top: 20px;" onclick="processar()">‚úîÔ∏è SALVAR REGISTRO</button>
        <button id="btn-cancel" class="btn" style="background: #64748b; margin-top: 10px; display: none;" onclick="cancelarEdicao()">CANCELAR</button>
    </div>

    <div class="card no-print">
        <h3>üìä FILTROS E RELAT√ìRIOS</h3>
        <div class="form-grid">
            <div><label>DE:</label><input type="date" id="rel-ini" onchange="aplicarFiltros()"></div>
            <div><label>AT√â:</label><input type="date" id="rel-fim" onchange="aplicarFiltros()"></div>
            <div><label>SECRETARIA</label><select id="rel-sec" onchange="aplicarFiltros()"><option value="">TODAS</option></select></div>
            <div><label>BUSCA (PLACA/MOTORISTA)</label><input type="text" id="busca" placeholder="DIGITE..." oninput="aplicarFiltros()"></div>
        </div>
        <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button class="btn" style="background: var(--accent); width: auto;" onclick="window.print()">üñ®Ô∏è IMPRIMIR PDF</button>
            <button class="btn" style="background: #10b981; width: auto;" onclick="exportarExcel()">EXCEL</button>
        </div>
    </div>

    <div id="relatorio-container"></div>

</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDsEQ8L_hWgacZ8xweY3DR9OYt2t151kZE",
        authDomain: "tabela-gasolina.firebaseapp.com",
        databaseURL: "https://tabela-gasolina-default-rtdb.firebaseio.com", 
        projectId: "tabela-gasolina",
        storageBucket: "tabela-gasolina.firebasestorage.app",
        messagingSenderId: "77121029722",
        appId: "1:77121029722:web:641b26a6cdf4c287f53a63"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let cache = [], editID = null, chartSec = null, chartVec = null;
    document.getElementById('f-data').valueAsDate = new Date();

    function logar() {
        if(document.getElementById('senha').value.toLowerCase() === "admin") {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app').classList.remove('blurred');
        } else { alert("SENHA INCORRETA"); }
    }

    function calc(origem) {
        const preco = parseFloat(document.getElementById('f-preco').value) || 0;
        const l = document.getElementById('f-lit'), v = document.getElementById('f-val');
        if(origem === 'L') v.value = (l.value * preco).toFixed(2);
        else if(origem === 'V') l.value = (v.value / preco).toFixed(2);
        else v.value = (l.value * preco).toFixed(2);
    }

    function processar() {
        const d = {
            placa: document.getElementById('f-placa').value.toUpperCase(),
            secretaria: document.getElementById('f-sec').value,
            motorista: document.getElementById('f-mot').value.toUpperCase(),
            autorizador: document.getElementById('f-aut').value, // SALVANDO AUTORIZADOR
            posto: document.getElementById('f-posto').value,
            data: document.getElementById('f-data').value,
            km: parseFloat(document.getElementById('f-km').value) || 0,
            litro: parseFloat(document.getElementById('f-lit').value) || 0,
            valor: parseFloat(document.getElementById('f-val').value) || 0
        };
        
        if(!d.placa || !d.valor) return alert("PLACA E VALOR OBRIGAT√ìRIOS!");
        
        if(editID) {
            db.ref('abastecimentos/' + editID).set(d).then(() => cancelarEdicao());
        } else {
            db.ref('abastecimentos').push(d);
            limparForm();
        }
    }

    function sugerir(val) {
        const item = cache.find(x => x.placa === val.toUpperCase());
        if(item) {
            document.getElementById('f-sec').value = item.secretaria;
            document.getElementById('f-mot').value = item.motorista;
        }
    }

    function limparForm() {
        ["f-placa","f-km","f-lit","f-val","f-mot"].forEach(id => document.getElementById(id).value = "");
        document.getElementById('f-aut').value = "N√ÉO INFORMADO";
        editID = null;
    }

    db.ref('abastecimentos').on('value', snap => {
        cache = []; snap.forEach(i => { let v = i.val(); v.id = i.key; cache.push(v); });
        popularFiltroSecretaria();
        aplicarFiltros();
        atualizarGraficos();
    });

    function renderizar(lista) {
        const container = document.getElementById('relatorio-container');
        container.innerHTML = "";

        if(lista.length === 0) return;

        const tR$ = lista.reduce((a, b) => a + b.valor, 0);
        const tL = lista.reduce((a, b) => a + b.litro, 0);
        container.innerHTML = `
            <div class="resumo-geral">
                <div class="mini-card"><span>TOTAL INVESTIDO</span><b>R$ ${tR$.toFixed(2)}</b></div>
                <div class="mini-card" style="background:var(--accent)"><span>TOTAL LITROS</span><b>${tL.toFixed(2)} L</b></div>
                <div class="mini-card" style="background:var(--success)"><span>LAN√áAMENTOS</span><b>${lista.length}</b></div>
            </div>`;

        const secretarias = [...new Set(lista.map(x => x.secretaria))];
        secretarias.forEach(sec => {
            const itens = lista.filter(x => x.secretaria === sec).sort((a,b) => new Date(a.data) - new Date(b.data));
            let sR$ = 0, sL = 0, linhas = "";

            itens.forEach(d => {
                const hist = cache.filter(v => v.placa === d.placa && v.data <= d.data && v.id !== d.id).sort((a,b) => new Date(b.data) - new Date(a.data));
                const kmAnt = hist.length > 0 ? hist[0].km : 0;
                const media = (kmAnt > 0 && d.km > kmAnt) ? (d.km - kmAnt) / d.litro : 0;
                const alerta = (media > 0 && media < 5) ? 'class="consumo-baixo"' : '';
                
                // FALLBACK PARA REGISTROS ANTIGOS SEM AUTORIZADOR
                const aut = d.autorizador || "---";

                sR$ += d.valor; sL += d.litro;
                linhas += `
                    <tr ${alerta}>
                        <td>${d.data.split('-').reverse().join('/')}</td>
                        <td><b>${d.placa}</b></td>
                        <td>${d.motorista}</td>
                        <td>${aut}</td> <td>${d.km} <br><small style="font-size:8px;">${kmAnt > 0 ? 'ANT: '+kmAnt : 'INICIAL'}</small></td>
                        <td>${d.litro.toFixed(2)}L</td>
                        <td>${media > 0 ? media.toFixed(2) : '---'}</td>
                        <td>R$ ${d.valor.toFixed(2)}</td>
                        <td class="no-print">
                            <button class="btn-edit" onclick="editar('${d.id}')">‚úèÔ∏è</button>
                            <button class="btn-del" onclick="remover('${d.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });

            container.innerHTML += `
                <div class="sec-block">
                    <div class="sec-header">üè¢ ${sec}</div>
                    <div class="table-scroll">
                        <table>
                            <thead><tr><th>DATA</th><th>PLACA</th><th>MOTORISTA</th><th>AUTORIZADOR</th><th>KM</th><th>LITROS</th><th>M√âDIA</th><th>TOTAL</th><th class="no-print">A√á√ïES</th></tr></thead>
                            <tbody>${linhas}</tbody>
                            <tfoot><tr class="subtotal-row"><td colspan="5">SUBTOTAL</td><td>${sL.toFixed(2)}L</td><td>-</td><td colspan="2">R$ ${sR$.toFixed(2)}</td></tr></tfoot>
                        </table>
                    </div>
                </div>`;
        });
    }

    function editar(id) {
        const d = cache.find(x => x.id === id);
        editID = id;
        document.getElementById('f-placa').value = d.placa;
        document.getElementById('f-sec').value = d.secretaria;
        document.getElementById('f-mot').value = d.motorista;
        document.getElementById('f-aut').value = d.autorizador || "N√ÉO INFORMADO";
        document.getElementById('f-data').value = d.data;
        document.getElementById('f-km').value = d.km;
        document.getElementById('f-lit').value = d.litro;
        document.getElementById('f-val').value = d.valor;
        document.getElementById('btn-save').innerText = "ATUALIZAR REGISTRO";
        document.getElementById('btn-cancel').style.display = 'block';
        window.scrollTo(0,0);
    }

    function cancelarEdicao() { limparForm(); document.getElementById('btn-save').innerText = "‚úîÔ∏è SALVAR REGISTRO"; document.getElementById('btn-cancel').style.display = 'none'; }
    function remover(id) { if(confirm("EXCLUIR REGISTRO?")) db.ref('abastecimentos').child(id).remove(); }

    function atualizarGraficos() {
        const secMap = {}; cache.forEach(d => secMap[d.secretaria] = (secMap[d.secretaria] || 0) + d.valor);
        if(chartSec) chartSec.destroy();
        chartSec = new Chart(document.getElementById('chartSec'), {
            type: 'doughnut',
            data: { labels: Object.keys(secMap), datasets: [{ data: Object.values(secMap), backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6'] }] },
            options: { responsive: true, maintainAspectRatio: false }
        });

        const vecMap = {}; cache.forEach(d => vecMap[d.placa] = (vecMap[d.placa] || 0) + d.valor);
        const sortedVec = Object.entries(vecMap).sort((a,b) => b[1] - a[1]).slice(0,5);
        if(chartVec) chartVec.destroy();
        chartVec = new Chart(document.getElementById('chartVec'), {
            type: 'bar',
            data: { labels: sortedVec.map(x => x[0]), datasets: [{ label: 'R$', data: sortedVec.map(x => x[1]), backgroundColor: '#0f172a' }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function aplicarFiltros() {
        const ini = document.getElementById('rel-ini').value;
        const fim = document.getElementById('rel-fim').value;
        const sec = document.getElementById('rel-sec').value;
        const busca = document.getElementById('busca').value.toUpperCase();

        const filtrado = cache.filter(d => {
            const dataOk = (!ini || d.data >= ini) && (!fim || d.data <= fim);
            const secOk = !sec || d.secretaria === sec;
            const buscaOk = !busca || d.placa.includes(busca) || d.motorista.includes(busca);
            return dataOk && secOk && buscaOk;
        });
        renderizar(filtrado);
    }

    function popularFiltroSecretaria() {
        const select = document.getElementById('rel-sec');
        const secs = [...new Set(cache.map(x => x.secretaria))];
        select.innerHTML = '<option value="">TODAS</option>' + secs.map(s => `<option value="${s}">${s}</option>`).join('');
    }

    function exportarExcel() {
        let csv = "DATA;PLACA;MOTORISTA;AUTORIZADOR;KM;LITROS;VALOR\n";
        cache.forEach(d => csv += `${d.data};${d.placa};${d.motorista};${d.autorizador || ''};${d.km};${d.litro};${d.valor}\n`);
        const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a'); a.setAttribute('href', url); a.setAttribute('download', 'relatorio_matina.csv'); a.click();
    }
</script>
</body>
</html>
