<!-- Firebase e Chart.js -->
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- PWA Manifest -->
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU2lzdGVtYSBkZSBDb21idXN0w61lbCIsInNob3J0X25hbWUiOiJDb21idXN0w61lbCIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZjFmNWY5IiwidGhlbWVfY29sb3IiOiIjM2I4MmY2IiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vaS5pbWd1ci5jb20vQUtNMjVXMS5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">
<meta name="theme-color" content="#3b82f6">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Combust√≠vel">
<link rel="apple-touch-icon" href="https://i.imgur.com/AKM25W1.png">

<style>
  :root { 
      --primary: #0f172a; 
      --accent: #3b82f6; 
      --success: #22c55e; 
      --warning: #f59e0b; 
      --danger: #ef4444; 
      --bg: #f1f5f9; 
  }
  * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; text-transform: uppercase; }
  body { background-color: var(--bg); margin: 0; padding: 10px; color: #1e293b; }
  .container { max-width: 1400px; margin: 0 auto; }
  .blurred { filter: blur(15px); pointer-events: none; }
  
  #login-screen { 
      position: fixed; 
      inset: 0; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      z-index: 999; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      color: white; 
  }
  .login-container {
      display: flex;
      max-width: 1100px;
      width: 90%;
      background: white;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }
  .login-left {
      flex: 1;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));
      padding: 60px 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      position: relative;
  }
  .login-left::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('https://i.imgur.com/qtUXYi3.png') center/cover;
      opacity: 0.15;
  }
  .login-logo {
      width: 100%;
      max-width: 300px;
      margin-bottom: 30px;
      position: relative;
      z-index: 1;
  }
  .login-left h1 {
      font-size: 32px;
      margin: 0 0 15px 0;
      position: relative;
      z-index: 1;
  }
  .login-left p {
      font-size: 16px;
      opacity: 0.9;
      position: relative;
      z-index: 1;
  }
  .login-box { 
      flex: 1;
      padding: 60px 50px;
      background: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
  }
  @media (max-width: 768px) {
      .login-container {
          flex-direction: column;
          width: 95%;
      }
      .login-left {
          padding: 40px 20px;
      }
      .login-box {
          padding: 40px 30px;
      }
  }
  .login-box h2 { 
      margin-bottom: 10px; 
      font-size: 32px; 
      color: var(--primary);
      text-shadow: none;
      text-align: center;
  }
  .login-box p { 
      color: #64748b; 
      font-size: 14px; 
      margin-bottom: 30px;
      text-align: center;
  }
  .login-box input { 
      width: 100%; 
      padding: 16px; 
      border-radius: 12px; 
      border: 2px solid #e2e8f0; 
      margin-bottom: 15px; 
      text-align: center; 
      font-size: 16px;
      transition: all 0.3s;
  }
  .login-box input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  .login-box .btn-login {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
  }
  .login-box .btn-login:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
  }
  
  .top-bar { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 20px; 
      flex-wrap: wrap; 
      gap: 10px;
      background: white;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .nav-tabs { display: flex; gap: 10px; flex-wrap: wrap; }
  .tab-btn { 
      padding: 12px 20px; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      background: #e2e8f0; 
      font-weight: bold; 
      font-size: 11px; 
      transition: all 0.3s;
      position: relative;
  }
  .tab-btn.active { 
      background: var(--accent); 
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }
  .tab-btn:hover { opacity: 0.8; transform: translateY(-1px); }
  .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      animation: pulse-badge 2s infinite;
  }
  @keyframes pulse-badge {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
  }
  @keyframes slideInRight {
      from {
          transform: translateX(400px);
          opacity: 0;
      }
      to {
          transform: translateX(0);
          opacity: 1;
      }
  }
  @keyframes slideOutRight {
      from {
          transform: translateX(0);
          opacity: 1;
      }
      to {
          transform: translateX(400px);
          opacity: 0;
      }
  }
  @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
  }
  
  .btn-logout { 
      background: var(--danger); 
      color: white; 
      padding: 12px 24px; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: bold;
      transition: all 0.3s;
  }
  .btn-logout:hover {
      background: #dc2626;
      transform: translateY(-1px);
  }
  
  .card { 
      background: white; 
      border-radius: 12px; 
      padding: 24px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
      margin-bottom: 20px;
      transition: all 0.3s;
  }
  .card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  }
  .card h3 { 
      margin-top: 0; 
      color: var(--primary);
      font-size: 18px;
      border-bottom: 3px solid var(--accent);
      padding-bottom: 10px;
      margin-bottom: 20px;
  }
  
  .mini-card { 
      background: linear-gradient(135deg, var(--primary) 0%, #1e293b 100%);
      color: white; 
      padding: 20px; 
      border-radius: 12px; 
      text-align: center; 
      font-weight: bold; 
      margin-bottom: 20px; 
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  
  .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
  }
  .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
      transition: all 0.3s;
  }
  .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  }
  .stat-card h4 {
      font-size: 11px;
      color: #64748b;
      margin: 0 0 10px 0;
  }
  .stat-card .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary);
  }
  .stat-card .stat-icon {
      font-size: 32px;
      margin-bottom: 10px;
  }
  .stat-trend {
      font-size: 12px;
      margin-top: 5px;
      display: flex;
      align-items: center;
  }
  .stat-trend.positive {
      color: var(--success);
  }
  .stat-trend.negative {
      color: var(--danger);
  }
  
  .charts-row { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
      gap: 20px; 
      margin-bottom: 20px; 
  }
  
  .table-wrapper { overflow-x: auto; }
  table { 
      width: 100%; 
      border-collapse: collapse; 
      min-width: 1000px; 
      font-size: 11px; 
  }
  th { 
      background: #f8fafc; 
      padding: 12px; 
      text-align: left; 
      border-bottom: 2px solid #e2e8f0; 
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
  }
  td { padding: 12px; border-bottom: 1px solid #f1f5f9; }
  tr:hover { background: #f8fafc; }
  
  .alerta-media { 
      background-color: #fee2e2 !important; 
      color: #b91c1c !important; 
      font-weight: bold;
      animation: pulse 2s infinite;
  }
  .alerta-km-alto {
      background-color: #fef3c7 !important;
      color: #92400e !important;
  }
  .eficiencia-excelente {
      background-color: #d1fae5 !important;
      color: #065f46 !important;
  }
  
  @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
  }
  
  .btn-save { 
      background: linear-gradient(135deg, var(--success) 0%, #16a34a 100%);
      color: white; 
      border: none; 
      padding: 16px; 
      border-radius: 10px; 
      cursor: pointer; 
      font-weight: bold; 
      width: 100%; 
      margin-top: 10px; 
      transition: all 0.3s;
      font-size: 13px;
  }
  .btn-save:hover { 
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(34, 197, 94, 0.3);
  }
  .btn-save:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
  }
  
  .status-tag { 
      padding: 6px 12px; 
      border-radius: 20px; 
      font-weight: bold; 
      font-size: 9px; 
      display: inline-block;
  }
  .status-aguardando { background: var(--warning); color: #000; }
  .status-autorizado { background: var(--success); color: #fff; }
  .status-rejeitado { background: var(--danger); color: #fff; }
  
  input, select { 
      width: 100%; 
      padding: 12px; 
      border: 2px solid #e2e8f0; 
      border-radius: 8px; 
      margin-bottom: 5px;
      transition: all 0.3s;
  }
  input:focus, select:focus { 
      outline: none; 
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  label { 
      font-size: 10px; 
      font-weight: bold; 
      color: #64748b; 
      display: block; 
      margin-bottom: 5px;
  }
  
  .btn-action { 
      padding: 8px 14px; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      margin: 0 3px; 
      font-size: 13px;
      transition: all 0.3s;
  }
  .btn-action:hover {
      transform: scale(1.05);
  }
  .btn-aprovar { background: var(--success); color: white; }
  .btn-rejeitar { background: var(--danger); color: white; }
  .btn-deletar { background: #64748b; color: white; }
  
  .grid-form { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
      gap: 15px; 
  }
  
  .section-header {
      background: linear-gradient(135deg, var(--primary) 0%, #1e293b 100%);
      color: white; 
      padding: 15px 20px; 
      margin-top: 20px; 
      border-radius: 10px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  
  .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: bold;
      margin-left: 8px;
  }
  .badge-success { background: var(--success); color: white; }
  .badge-danger { background: var(--danger); color: white; }
  .badge-warning { background: var(--warning); color: black; }
  .badge-primary { background: var(--accent); color: white; }
  .badge-info { background: #0891b2; color: white; }
  
  .alert-box {
      background: #fef3c7;
      border-left: 4px solid var(--warning);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
  }
  .alert-box.danger {
      background: #fee2e2;
      border-left-color: var(--danger);
  }
  .alert-box.success {
      background: #d1fae5;
      border-left-color: var(--success);
  }
  
  .progress-bar {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
  }
  .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), var(--accent));
      transition: width 0.3s;
  }
  .progress-fill.warning {
      background: linear-gradient(90deg, var(--warning), #f97316);
  }
  .progress-fill.danger {
      background: linear-gradient(90deg, var(--danger), #dc2626);
  }
  
  @media print { 
      .no-print { display: none !important; } 
      .card { box-shadow: none; page-break-inside: avoid; }
      body { background: white; }
  }
  
  @media (max-width: 768px) {
      .grid-form { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: 1fr; }
      .charts-row { grid-template-columns: 1fr; }
      table { font-size: 9px; }
      th, td { padding: 8px; }
  }
  
  .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s;
  }
  @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
  }
  .modal-content {
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideUp 0.3s;
  }
  @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
  }
  .modal-content h3 {
      color: var(--primary);
      border-bottom: 3px solid var(--accent);
      padding-bottom: 10px;
      margin-bottom: 20px;
  }
  .modal-content label {
      text-transform: none;
      font-weight: normal;
  }
  .modal-close {
      float: right;
      cursor: pointer;
      font-weight: bold;
      font-size: 28px;
      color: #94a3b8;
      transition: all 0.3s;
  }
  .modal-close:hover {
      color: var(--danger);
      transform: rotate(90deg);
  }
  
  .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
  }
  @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
  }
  
  .qr-scanner-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
  }
  .qr-scanner-container video {
      width: 100%;
      max-width: 400px;
      border-radius: 8px;
      border: 3px solid var(--accent);
  }
  #qr-reader {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
  }
  .qr-code-display {
      margin-top: 20px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 8px;
  }
  .qr-code-display canvas {
      margin: 10px auto;
      display: block;
  }
  
  .comparison-card {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 15px;
  }
  .comparison-item {
      text-align: center;
      padding: 15px;
      background: #f8fafc;
      border-radius: 8px;
  }
  .comparison-item h5 {
      font-size: 11px;
      color: #64748b;
      margin: 0 0 10px 0;
  }
  .comparison-value {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary);
  }
  
  .efficiency-meter {
      width: 100%;
      height: 30px;
      background: linear-gradient(90deg, var(--danger) 0%, var(--warning) 50%, var(--success) 100%);
      border-radius: 15px;
      position: relative;
      margin: 10px 0;
  }
  .efficiency-pointer {
      position: absolute;
      top: -5px;
      width: 4px;
      height: 40px;
      background: #000;
      border-radius: 2px;
      transition: left 0.5s;
  }
  
  /* Sistema de Notifica√ß√µes */
  .notification-center {
      position: fixed;
      top: 80px;
      right: 20px;
      width: 350px;
      max-height: 500px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
      overflow: hidden;
  }
  .notification-center.active {
      display: block;
      animation: slideInRight 0.3s;
  }
  @keyframes slideInRight {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
  }
  .notification-header {
      padding: 15px 20px;
      background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);
      color: white;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
  }
  .notification-list {
      max-height: 400px;
      overflow-y: auto;
  }
  .notification-item {
      padding: 15px 20px;
      border-bottom: 1px solid #e2e8f0;
      cursor: pointer;
      transition: all 0.2s;
  }
  .notification-item:hover {
      background: #f8fafc;
  }
  .notification-item.unread {
      background: #eff6ff;
      border-left: 4px solid var(--accent);
  }
  .notification-item .notification-title {
      font-weight: bold;
      font-size: 12px;
      margin-bottom: 5px;
  }
  .notification-item .notification-text {
      font-size: 11px;
      color: #64748b;
      text-transform: none;
  }
  .notification-item .notification-time {
      font-size: 10px;
      color: #94a3b8;
      margin-top: 5px;
  }
  .notification-bell {
      position: relative;
      cursor: pointer;
      font-size: 20px;
      padding: 8px 12px;
      background: white;
      border-radius: 8px;
      transition: all 0.3s;
  }
  .notification-bell:hover {
      background: #f1f5f9;
  }
  .notification-bell .notification-count {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      animation: pulse-badge 2s infinite;
  }
  
  /* Dashboard Executivo */
  .executive-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
  }
  .executive-card h2 {
      margin: 0 0 20px 0;
      font-size: 24px;
  }
  .executive-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
  }
  .executive-metric {
      background: rgba(255,255,255,0.2);
      padding: 20px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
  }
  .executive-metric-label {
      font-size: 11px;
      opacity: 0.9;
      margin-bottom: 8px;
  }
  .executive-metric-value {
      font-size: 28px;
      font-weight: bold;
  }
  .executive-metric-trend {
      font-size: 12px;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 5px;
  }
  
  /* PWA Install Button */
  .install-pwa-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);
      color: white;
      padding: 15px 20px;
      display: none;
      align-items: center;
      justify-content: space-between;
      z-index: 999;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
  }
  .install-pwa-banner.show {
      display: flex;
      animation: slideUp 0.3s;
  }
  .install-pwa-banner button {
      background: white;
      color: var(--accent);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
  }
  .install-pwa-banner button:hover {
      transform: scale(1.05);
  }
  .install-pwa-banner .close-banner {
      background: transparent;
      color: white;
      font-size: 20px;
      padding: 5px 10px;
  }
  
  /* Indicador de Tanque Cheio */
  .tanque-cheio-badge {
      display: inline-block;
      background: linear-gradient(135deg, var(--warning) 0%, #f97316 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 9px;
      font-weight: bold;
      margin-left: 8px;
      animation: pulse 2s infinite;
  }
  
  /* Bot√£o de Tanque Cheio */
  .btn-tanque-cheio {
      background: linear-gradient(135deg, var(--warning) 0%, #f97316 100%);
      color: white;
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 0 3px;
      font-size: 11px;
      font-weight: bold;
      transition: all 0.3s;
  }
  .btn-tanque-cheio:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
  }
</style>

<!-- Modal para Edi√ß√£o de Usu√°rios -->
<div id="modal-edit" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="fecharModal()">&times;</span>
    <h3>‚úèÔ∏è EDITAR USU√ÅRIO</h3>
    <div class="grid-form">
      <div>
        <label>USU√ÅRIO</label>
        <input type="text" id="edit-user" disabled>
      </div>
      <div>
        <label>NOVA SENHA</label>
        <input type="password" id="edit-pass">
      </div>
      <div>
        <label>COMBUST√çVEL PERMITIDO</label>
        <select id="edit-combustivel">
          <option value="GASOLINA">GASOLINA</option>
          <option value="ALCOOL">√ÅLCOOL</option>
          <option value="DIESEL">DIESEL</option>
<option value='GAS'>G√°s</option>
<option value='DIESEL S10'>Diesel S10</option>
<option value='GAS'>G√°s</option>
          <option value="todos">TODOS</option>
        </select>
      </div>
      <div>
        <label>PERFIL</label>
        <select id="edit-role" onchange="toggleEditFields()">
          <option value="admin">ADMIN (TOTAL)</option>
          <option value="secretarios">SECRET√ÅRIO (RESTRITO)</option>
          <option value="frentista">FRENTISTA (SOMENTE LEITURA)</option>
          <option value="autorizador">AUTORIZADOR (RESTRITO)</option>
        </select>
      </div>
      <div id="edit-field-limit">
        <label>LIMITE MENSAL (R$)</label>
        <input type="number" id="edit-limit" placeholder="0.00" step="0.01">
      </div>
      <div id="edit-field-sec">
        <label>SECRETARIA VINCULADA</label>
        <select id="edit-sec-vinc">
          <option value="">SELECIONE...</option>
          <option>ADMINISTRA√á√ÉO E FINAN√áAS</option>
          <option>AGRICULTURA E MEIO AMBIENTE</option>
          <option>ASSIST√äNCIA SOCIAL</option>
          <option>COMUNICA√á√ÉO</option>
          <option>CULTURA</option>
          <option>EDUCA√á√ÉO</option>
          <option>ESPORTES</option>
          <option>GOVERNO</option>
          <option>INFRAESTRUTURA E SERVI√áOS</option>
          <option>PLANEJAMENTO</option>
          <option>SA√öDE</option>
          <option>AVULSOS / GERAL</option>
        </select>
      </div>
      <div id="edit-field-posto-autorizador" style="display:none;">
        <label>POSTO AUTORIZADO</label>
        <select id="edit-posto-vinc" onchange="carregarCombustiveisPostoAutorizadorEdit()">
          <option value="">SELECIONE...</option>
        </select>
      </div>
      <div id="edit-field-combustiveis-autorizador" style="display:none;">
        <label>COMBUST√çVEIS QUE PODE LIBERAR</label>
        <div id="lista-combustiveis-autorizador-edit" style="display: grid; gap: 8px; padding: 10px; background: #f8fafc; border-radius: 8px;">
          <p style="color: #64748b; font-size: 11px; margin: 0;">Selecione um posto primeiro</p>
        </div>
      </div>
    </div>
    <button class="btn-save" style="background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);" onclick="salvarEdicao()">üíæ SALVAR ALTERA√á√ïES</button>
  </div>
</div>

<!-- Modal de Edi√ß√£o de Posto -->
<div id="modal-edit-posto" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="fecharModalEditPosto()">&times;</span>
    <h3>‚úèÔ∏è EDITAR POSTO</h3>
    <input type="hidden" id="edit-posto-id">
    
    <div class="grid-form">
      <div style="grid-column: 1/-1;">
        <label>NOME DO POSTO *</label>
        <input type="text" id="edit-posto-nome" placeholder="EX: POSTO CENTRAL">
      </div>
    </div>
    
    <div style="margin: 20px 0; padding: 15px; background: #f8fafc; border-radius: 8px;">
      <h4 style="margin: 0 0 15px 0; font-size: 14px; color: var(--primary);">COMBUST√çVEIS FORNECIDOS PELO POSTO</h4>
      <p style="font-size: 11px; color: #64748b; margin-bottom: 15px;">Selecione os combust√≠veis que este posto oferece e informe o pre√ßo de cada um:</p>
      
      <div style="display: grid; gap: 15px;">
        <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #e2e8f0;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 0 0 auto;">
            <input type="checkbox" id="edit-posto-tem-gasolina" onchange="toggleCombustivelPostoEdit('gasolina')">
            <span style="font-weight: bold; color: var(--danger);">GASOLINA</span>
          </label>
          <div style="flex: 1; display: flex; align-items: center; gap: 10px;">
            <label style="font-size: 12px; white-space: nowrap;">PRE√áO (R$/L):</label>
            <input type="number" id="edit-posto-gas" placeholder="0.00" step="0.01" min="0" disabled style="flex: 1;">
          </div>
        </div>
        
        <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #e2e8f0;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 0 0 auto;">
            <input type="checkbox" id="edit-posto-tem-alcool" onchange="toggleCombustivelPostoEdit('alcool')">
            <span style="font-weight: bold; color: var(--success);">√ÅLCOOL</span>
          </label>
          <div style="flex: 1; display: flex; align-items: center; gap: 10px;">
            <label style="font-size: 12px; white-space: nowrap;">PRE√áO (R$/L):</label>
            <input type="number" id="edit-posto-alc" placeholder="0.00" step="0.01" min="0" disabled style="flex: 1;">
          </div>
        </div>
        
        <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #e2e8f0;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 0 0 auto;">
            <input type="checkbox" id="edit-posto-tem-diesel" onchange="toggleCombustivelPostoEdit('diesel')">
            <span style="font-weight: bold; color: var(--warning);">DIESEL</span>
          </label>
          <div style="flex: 1; display: flex; align-items: center; gap: 10px;">
            <label style="font-size: 12px; white-space: nowrap;">PRE√áO (R$/L):</label>
            <input type="number" id="edit-posto-die" placeholder="0.00" step="0.01" min="0" disabled style="flex: 1;">
          </div>
        </div>
        
        <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #e2e8f0;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 0 0 auto;">
            <input type="checkbox" id="edit-posto-tem-diesels10" onchange="toggleCombustivelPostoEdit('diesels10')">
            <span style="font-weight: bold; color: #ea580c;">DIESEL S10</span>
          </label>
          <div style="flex: 1; display: flex; align-items: center; gap: 10px;">
            <label style="font-size: 12px; white-space: nowrap;">PRE√áO (R$/L):</label>
            <input type="number" id="edit-posto-diesels10" placeholder="0.00" step="0.01" min="0" disabled style="flex: 1;">
          </div>
        </div>
        
        <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #e2e8f0;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 0 0 auto;">
            <input type="checkbox" id="edit-posto-tem-gas" onchange="toggleCombustivelPostoEdit('gas')">
            <span style="font-weight: bold; color: #0891b2;">G√ÅS</span>
          </label>
          <div style="flex: 1; display: flex; align-items: center; gap: 10px;">
            <label style="font-size: 12px; white-space: nowrap;">PRE√áO (R$/L):</label>
            <input type="number" id="edit-posto-gas-gnv" placeholder="0.00" step="0.01" min="0" disabled style="flex: 1;">
          </div>
        </div>
      </div>
    </div>
    
    <button class="btn-save" style="background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);" onclick="salvarEdicaoPosto()">üíæ SALVAR ALTERA√á√ïES</button>
  </div>
</div>

<!-- Modal de An√°lise de Efici√™ncia -->
<div id="modal-analise" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <span class="modal-close" onclick="fecharModalAnalise()">&times;</span>
    <h3>üìä AN√ÅLISE DE EFICI√äNCIA</h3>
    <div id="analise-content"></div>
  </div>
</div>

<!-- Modal de Hist√≥rico de Abastecimentos (Avulsos) -->
<div id="modal-historico-avulso" class="modal">
  <div class="modal-content" style="max-width: 600px;">
    <span class="modal-close" onclick="fecharModalHistoricoAvulso(false)">&times;</span>
    <h3 style="color:var(--warning);">‚ö†Ô∏è ATEN√á√ÉO: ABASTECIMENTO AVULSO</h3>
    <div id="historico-avulso-content"></div>
    <div style="margin-top:20px; padding:15px; background:#fff3cd; border-radius:8px; border-left:4px solid var(--warning);">
      <p style="margin:0; font-size:12px; color:#856404;">
        <strong>‚ö†Ô∏è IMPORTANTE:</strong> Este ve√≠culo possui hist√≥rico de abastecimentos em outras secretarias.<br>
        Deseja realmente registrar como <strong>AVULSO</strong>?
      </p>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px;">
      <button class="btn-save" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%);" onclick="fecharModalHistoricoAvulso(false)">
        ‚ùå CANCELAR
      </button>
      <button class="btn-save" onclick="fecharModalHistoricoAvulso(true)">
        ‚úÖ CONFIRMAR AVULSO
      </button>
    </div>
  </div>
</div>

<!-- Modal de Permiss√µes de Perfil -->
<div id="modal-permissoes" class="modal">
  <div class="modal-content" style="max-width: 700px;">
    <span class="modal-close" onclick="fecharModalPermissoes()">&times;</span>
    <h3>üîê CONFIGURAR PERMISS√ïES DO PERFIL</h3>
    <p style="font-size:12px; color:#64748b; margin-bottom:20px;">
      Selecione o que cada perfil pode visualizar e fazer no sistema
    </p>
    
    <div style="margin-bottom:20px;">
      <label>SELECIONE O PERFIL PARA CONFIGURAR</label>
      <select id="perfil-config" onchange="carregarPermissoesPerfil()" style="width:100%;">
        <option value="admin">ADMIN (TOTAL)</option>
        <option value="secretarios">SECRET√ÅRIO (RESTRITO)</option>
        <option value="frentista">FRENTISTA (SOMENTE LEITURA)</option>
	<option value="Autorizador">FRENTISTA (REST)</option>
        <option value="custom">PERSONALIZADO</option>
      </select>
    </div>
    
    <div id="permissoes-lista" style="max-height:400px; overflow-y:auto;">
      <!-- As permiss√µes ser√£o carregadas aqui -->
    </div>
    
    <button class="btn-save" style="background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);" onclick="salvarPermissoes()">
      üíæ SALVAR PERMISS√ïES
    </button>
  </div>
</div>

<!-- Modal para Aprovar Tanque Cheio - ATUALIZADO -->
<div id="modal-tanque-cheio" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="fecharModalTanqueCheio()">&times;</span>
    <h3>‚õΩ APROVAR TANQUE CHEIO</h3>
    
    <div id="tanque-cheio-detalhes" style="margin-bottom:20px; padding:15px; background:#f8fafc; border-radius:8px;">
      <!-- Detalhes do abastecimento ser√£o preenchidos aqui -->
    </div>
    
    <!-- NOVA SE√á√ÉO: Limite do Secret√°rio -->
    <div id="tanque-cheio-limite" style="margin-bottom:20px; padding:15px; background:#f1f5f9; border-radius:8px; display:none;">
      <h4 style="margin:0 0 10px 0; font-size:13px; color:var(--primary);">üìä LIMITE DO SECRET√ÅRIO</h4>
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
        <div style="text-align:center;">
          <div style="font-size:11px; color:#64748b;">LIMITE MENSAL</div>
          <div style="font-size:18px; font-weight:bold; color:var(--accent);" id="limite-mensal">R$ 0,00</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:11px; color:#64748b;">GASTO ATUAL</div>
          <div style="font-size:18px; font-weight:bold; color:var(--warning);" id="gasto-atual">R$ 0,00</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:11px; color:#64748b;">SALDO RESTANTE</div>
          <div style="font-size:18px; font-weight:bold; color:var(--success);" id="saldo-restante">R$ 0,00</div>
        </div>
      </div>
      <div class="progress-bar" style="margin-top:10px;">
        <div class="progress-fill" id="progresso-limite" style="width:0%"></div>
      </div>
      <div style="margin-top:10px; font-size:11px; color:#64748b; text-align:center;" id="info-limite">
        <!-- Informa√ß√µes adicionais sobre o limite -->
      </div>
    </div>
    
    <div class="grid-form">
      <div>
        <label>LITROS ABASTECIDOS *</label>
        <input type="number" id="tanque-litros" placeholder="0.00" step="0.01" min="0" oninput="calcularValorTanqueCheio(); verificarLimiteSecretario()">
      </div>
      <div>
        <label>PRE√áO POR LITRO (R$)</label>
        <input type="number" id="tanque-preco" placeholder="0.00" step="0.01" min="0" oninput="calcularValorTanqueCheio(); verificarLimiteSecretario()">
      </div>
      <div>
        <label>VALOR TOTAL (R$)</label>
        <input type="text" id="tanque-valor" readonly style="background:#f1f5f9; font-weight:bold;">
      </div>
      <div>
        <label>OD√îMETRO FINAL (KM)</label>
        <input type="number" id="tanque-km" placeholder="0" min="0">
      </div>
      <div>
        <label>OBSERVA√á√ïES</label>
        <input type="text" id="tanque-obs" placeholder="Observa√ß√µes (opcional)">
      </div>
    </div>
    
    <div style="margin-top:20px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
      <button class="btn-save" style="background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);" onclick="fecharModalTanqueCheio()">
        ‚ùå CANCELAR
      </button>
      <button class="btn-save" id="btn-confirmar-tanque" onclick="confirmarTanqueCheio()">
        ‚úÖ CONFIRMAR ABASTECIMENTO
      </button>
    </div>
  </div>
</div>

<!-- Modal de Edi√ß√£o de VIP -->
<div id="modal-edit-vip" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="fecharModalEditVIP()">&times;</span>
    <h3>‚úèÔ∏è EDITAR PESSOA VIP</h3>
    <input type="hidden" id="edit-vip-id">
    
    <div class="grid-form">
      <div>
        <label>NOME COMPLETO *</label>
        <input type="text" id="edit-vip-nome" placeholder="Ex: Maria da Silva">
      </div>
      <div>
        <label>CARGO *</label>
        <select id="edit-vip-cargo">
          <option value="">SELECIONE...</option>
          <option value="Prefeito(a)">Prefeito(a)</option>
          <option value="Vice-Prefeito(a)">Vice-Prefeito(a)</option>
          <option value="Vereador(a)">Vereador(a)</option>
          <option value="Secret√°rio(a)">Secret√°rio(a)</option>
          <option value="Diretor(a)">Diretor(a)</option>
          <option value="Outro">Outro</option>
        </select>
      </div>
      <div>
        <label>CATEGORIA</label>
        <select id="edit-vip-categoria">
          <option value="executivo">Executivo</option>
          <option value="legislativo">Legislativo</option>
          <option value="administrativo">Administrativo</option>
        </select>
      </div>
      <div>
        <label>LIMITE MENSAL (R$)</label>
        <input type="number" id="edit-vip-limite" placeholder="0.00" step="0.01" min="0">
        <label style="display: flex; align-items: center; gap: 8px; margin-top: 8px; font-size: 13px; cursor: pointer;">
          <input type="checkbox" id="edit-vip-sem-limite" onchange="toggleLimiteVIP('edit')">
          <span>‚≠ê Sem limite (ilimitado)</span>
        </label>
      </div>
    </div>
    
    <button class="btn-save" onclick="salvarEdicaoVIP()" style="margin-top: 20px; background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);">
      üíæ SALVAR ALTERA√á√ïES
    </button>
  </div>
</div>

<!-- Tela de Login -->
<div id="login-screen">
  <div class="login-container">
    <div class="login-left">
      <img src="https://i.imgur.com/AKM25W1.png" alt="Logo" class="login-logo">
      <h1>SISTEMA DE CONTROLE</h1>
      <p>Gest√£o Inteligente de Combust√≠vel v2.0</p>
    </div>
    <div class="login-box">
      <h2>üöó BEM-VINDO</h2>
      <p>Fa√ßa login para continuar</p>
      <input type="text" id="user" placeholder="USU√ÅRIO" autocomplete="username">
      <input type="password" id="senha" placeholder="SENHA" autocomplete="current-password" onkeypress="if(event.key==='Enter') logar()">
      <button class="btn-login" onclick="logar()">üîê ENTRAR</button>
    </div>
  </div>
</div>

<!-- √Årea Principal do App -->
<div class="container blurred" id="app">
  <div class="top-bar no-print">
    <div class="nav-tabs">
      <button id="btn-tab-geral" class="tab-btn active" onclick="switchTab('geral')">üìä DASHBOARD</button>
      <button id="btn-tab-executivo" class="tab-btn" style="display:none;" onclick="switchTab('executivo')">üëî EXECUTIVO</button>
      <button id="btn-tab-vip" class="tab-btn" style="display:none;" onclick="switchTab('vip')">‚≠ê VIP</button>
      <button id="btn-tab-pendentes" class="tab-btn" style="display:none;" onclick="switchTab('pendentes')">
        ‚è≥ PENDENTES
        <span id="pendentes-badge" class="notification-badge" style="display:none;">0</span>
      </button>
      <button id="btn-tab-analytics" class="tab-btn" onclick="switchTab('analytics')">üìà AN√ÅLISES</button>
      <button id="btn-tab-users" class="tab-btn" style="display:none;" onclick="switchTab('usuarios')">‚öôÔ∏è CONFIGURA√á√ïES</button>
      <button class="tab-btn" onclick="abrirAlterarSenha()">üîë SENHA</button>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <button id="btn-toggle-som" class="tab-btn" onclick="toggleSomNotificacao()" 
              style="font-size: 18px; padding: 8px 12px;" 
              title="Ativar/Desativar som de notifica√ß√µes">
        üîä
      </button>
      <div class="notification-bell" onclick="toggleNotificationCenter()">
        üîî
        <span class="notification-count" id="notification-count" style="display:none;">0</span>
      </div>
      <button class="btn-logout" onclick="confirmarSair()">üö™ SAIR</button>
    </div>
  </div>
  
  <!-- Central de Notifica√ß√µes -->
  <div class="notification-center" id="notification-center">
    <div class="notification-header">
      <span>üîî NOTIFICA√á√ïES</span>
      <span style="cursor:pointer;" onclick="toggleNotificationCenter()">‚úï</span>
    </div>
    <div class="notification-list" id="notification-list">
      <div style="padding:40px 20px; text-align:center; color:#64748b; font-size:12px;">
        üì≠ NENHUMA NOTIFICA√á√ÉO
      </div>
    </div>
  </div>
  
  <!-- Banner PWA -->
  <div class="install-pwa-banner" id="pwa-banner">
    <div>
      <strong style="font-size:14px;">üì± INSTALE NOSSO APP</strong>
      <div style="font-size:11px; opacity:0.9; margin-top:5px;">Acesse offline e receba notifica√ß√µes</div>
    </div>
    <div style="display:flex; gap:10px;">
      <button class="close-banner" onclick="fecharBannerPWA()">‚úï</button>
      <button onclick="instalarPWA()">INSTALAR</button>
    </div>
  </div>
  
  <div id="tab-geral">
    <div id="status-financeiro" class="mini-card">
      <div class="loading"></div> CARREGANDO...
    </div>
    
    <!-- Estat√≠sticas R√°pidas Melhoradas -->
    <div class="stats-grid no-print" id="stats-container"></div>
    
    <!-- Alertas e Notifica√ß√µes -->
    <div id="alertas-container"></div>
    
    <div class="charts-row no-print">
      <div class="card">
        <h3>üí∞ GASTOS POR SECRETARIA</h3>
        <div style="height:280px;"><canvas id="chartSec"></canvas></div>
      </div>
      <div class="card">
        <h3>üöõ TOP 5 VE√çCULOS</h3>
        <div style="height:280px;"><canvas id="chartVec"></canvas></div>
      </div>
    </div>
    
    <!-- Novo Abastecimento -->
    <div class="card no-print">
      <h3>‚õΩ NOVO ABASTECIMENTO</h3>
      
      <!-- Scanner QR Code -->
      <div class="qr-scanner-container" id="qr-scanner-area" style="display:none;">
        <h4>üì∑ ESCANEIE O QR CODE DO VE√çCULO</h4>
        <div id="qr-reader"></div>
        <button class="btn-save" style="background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%); margin-top:15px;" onclick="pararScanner()">‚ùå CANCELAR SCANNER</button>
      </div>
      
      <div style="text-align:center; margin-bottom:15px;">
        <button class="btn-save" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); max-width:300px; margin:0 auto;" onclick="iniciarScanner()">
          üì± ESCANEAR QR CODE
        </button>
      </div>
      
      <div class="grid-form">
        <div>
          <label>PLACA *</label>
          <input type="text" id="f-placa" placeholder="ABC-1234" maxlength="8" oninput="sugerir(this.value); verificarMediaEmTempoReal(); verificarLimiteEmTempoReal()">
        </div>
        <div>
          <label>POSTO *</label>
          <select id="f-posto" onchange="atualizarPrecosPosto(); verificarLimiteEmTempoReal()">
            <option value="">SELECIONE O POSTO</option>
          </select>
        </div>
        <div>
          <label>SECRETARIA *</label>
          <select id="f-sec">
            <option value="AVULSOS / GERAL">AVULSOS / GERAL</option>
            <option value="ADMINISTRA√á√ÉO E FINAN√áAS">ADMINISTRA√á√ÉO E FINAN√áAS</option>
            <option value="AGRICULTURA E MEIO AMBIENTE">AGRICULTURA E MEIO AMBIENTE</option>
            <option value="ASSIST√äNCIA SOCIAL">ASSIST√äNCIA SOCIAL</option>
            <option value="COMUNICA√á√ÉO">COMUNICA√á√ÉO</option>
            <option value="CULTURA">CULTURA</option>
            <option value="EDUCA√á√ÉO">EDUCA√á√ÉO</option>
            <option value="ESPORTES">ESPORTES</option>
            <option value="GOVERNO">GOVERNO</option>
            <option value="INFRAESTRUTURA E SERVI√áOS">INFRAESTRUTURA E SERVI√áOS</option>
            <option value="PLANEJAMENTO">PLANEJAMENTO</option>
            <option value="SA√öDE">SA√öDE</option>
          </select>
        </div>
        <div>
          <label>MOTORISTA *</label>
          <input type="text" id="f-mot" placeholder="NOME DO MOTORISTA">
        </div>
        <div>
          <label>COMBUST√çVEL *</label>
          <select id="f-tipo" onchange="calc(); verificarMediaEmTempoReal(); verificarLimiteEmTempoReal()">
      <option value="GASOLINA">GASOLINA</option>
      <option value="ALCOOL">√ÅLCOOL</option>
      <option value="DIESEL">DIESEL</option>
      <option value="DIESEL S10">DIESEL S10</option>
      <option value="GAS">G√ÅS</option>
    </select>
        </div>
        <div>
          <label>DATA *</label>
          <input type="date" id="f-data">
        </div>
        <div>
          <label>KM ATUAL *</label>
          <input type="number" id="f-km" placeholder="0" min="0" oninput="validarKmAtual(); verificarMediaEmTempoReal(); verificarLimiteEmTempoReal()">
        </div>
        <div>
          <label>LITROS *</label>
          <input type="number" id="f-lit" placeholder="0.00" step="0.01" min="0" oninput="calc(); verificarMediaEmTempoReal(); verificarLimiteEmTempoReal()">
        </div>
        <div>
          <label>VALOR TOTAL (R$)</label>
          <input type="text" id="f-val" readonly style="background:#f1f5f9; font-weight:bold;">
        </div>
      </div>
      
      <!-- Op√ß√£o Tanque Cheio -->
      <div style="grid-column: 1/-1; margin-top:15px;">
        <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
          <input type="checkbox" id="f-tanque-cheio" onchange="toggleTanqueCheio(); verificarLimiteEmTempoReal()">
          <span style="color:var(--warning); font-weight:bold;">‚õΩ TANQUE CHEIO (Secret√°rio)</span>
        </label>
        <div id="tanque-cheio-info" style="display:none; margin-top:10px; padding:10px; background:#fff3cd; border-radius:8px; font-size:11px;">
          <p style="margin:0;">
            <strong>‚ö†Ô∏è MODO TANQUE CHEIO:</strong> O administrador preencher√° os litros e valor durante a aprova√ß√£o.
          </p>
        </div>
      </div>
      
      <!-- Previs√£o de Consumo -->
      <div id="previsao-consumo" style="display:none; margin-top:15px; padding:15px; background:#f8fafc; border-radius:8px;">
        <h4 style="font-size:12px; margin:0 0 10px 0; color:#64748b;">üìä PREVIS√ÉO DE CONSUMO</h4>
        <div id="previsao-content"></div>
      </div>
      
      <button class="btn-save" id="btn-registrar" onclick="processar()">‚úîÔ∏è REGISTRAR ABASTECIMENTO</button>
    </div>
    
    <!-- Filtro de Relat√≥rio -->
    <div class="card no-print" id="card-filtros-relatorio">
      <h3>üîç FILTROS DE RELAT√ìRIO</h3>
      <div class="grid-form">
        <div>
          <label>DATA INICIAL</label>
          <input type="date" id="rel-data-inicial">
        </div>
        <div>
          <label>DATA FINAL</label>
          <input type="date" id="rel-data-final">
        </div>
        <div>
          <label>SECRETARIA</label>
          <select id="rel-secretaria">
            <option value="">TODAS</option>
            <option value="AVULSOS / GERAL">AVULSOS / GERAL</option>
            <option value="ADMINISTRA√á√ÉO E FINAN√áAS">ADMINISTRA√á√ÉO E FINAN√áAS</option>
            <option value="AGRICULTURA E MEIO AMBIENTE">AGRICULTURA E MEIO AMBIENTE</option>
            <option value="ASSIST√äNCIA SOCIAL">ASSIST√äNCIA SOCIAL</option>
            <option value="COMUNICA√á√ÉO">COMUNICA√á√ÉO</option>
            <option value="CULTURA">CULTURA</option>
            <option value="EDUCA√á√ÉO">EDUCA√á√ÉO</option>
            <option value="ESPORTES">ESPORTES</option>
            <option value="GOVERNO">GOVERNO</option>
            <option value="INFRAESTRUTURA E SERVI√áOS">INFRAESTRUTURA E SERVI√áOS</option>
            <option value="PLANEJAMENTO">PLANEJAMENTO</option>
            <option value="SA√öDE">SA√öDE</option>
          </select>
        </div>
        <div>
          <label>POSTO</label>
          <select id="rel-posto">
            <option value="">TODOS</option>
          </select>
        </div>
        <div>
          <label>COMBUST√çVEL</label>
          <select id="rel-combustivel">
            <option value="">TODOS</option>
            <option value="GASOLINA">GASOLINA</option>
            <option value="ALCOOL">√ÅLCOOL</option>
            <option value="DIESEL">DIESEL</option>
<option value='GAS'>G√°s</option>
<option value='DIESEL S10'>Diesel S10</option>
<option value='GAS'>G√°s</option>
          </select>
        </div>
        <div>
          <label>PLACA</label>
          <input type="text" id="rel-placa" placeholder="ABC-1234">
        </div>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px;">
        <button class="btn-save" onclick="gerarRelatorio()">üìä GERAR</button>
        <button class="btn-save" style="background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);" onclick="limparFiltros()">üîÑ LIMPAR</button>
        <button class="btn-save" style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);" onclick="exportarExcel()">üì• EXPORTAR EXCEL</button>
      </div>
      <button class="btn-save" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%); margin-top:5px;" onclick="window.print()">üñ®Ô∏è IMPRIMIR</button>
    </div>
    
    <!-- Relat√≥rios -->
    <div id="relatorio-container"></div>
  </div>
  
  <!-- Tab VIP - Prefeita e Vereadores -->
  <div id="tab-vip" style="display:none;">
    <div class="card">
      <h2>‚≠ê ABASTECIMENTOS VIP - PREFEITA E VEREADORES</h2>
      <p style="color: #64748b; font-size: 13px; margin-top: 10px;">
        Lan√ßamento direto de abastecimentos para Prefeita e Vereadores (aprova√ß√£o autom√°tica)
      </p>
    </div>
    
    <!-- Dashboard de Limites VIP -->
    <div class="card" id="dashboard-vip">
      <h3>üí∞ LIMITES MENSAIS - PESSOAS VIP</h3>
      <div id="container-limites-vip" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 20px;">
        <!-- Ser√° preenchido dinamicamente -->
      </div>
    </div>
    
    <!-- Formul√°rio de Abastecimento VIP -->
    <div class="card">
      <h3>‚õΩ NOVO ABASTECIMENTO VIP</h3>
      <div class="grid-form">
        <div>
          <label>PESSOA VIP *</label>
          <select id="vip-pessoa" onchange="atualizarLimiteVIP()">
            <option value="">SELECIONE...</option>
            <option value="PREFEITA">üëë PREFEITA</option>
            <option value="WAGNER">üèõÔ∏è Wagner (Vereador)</option>
            <option value="VALU">üèõÔ∏è Val√∫ (Vereador/a)</option>
            <option value="CASSIA">üèõÔ∏è C√°ssia (Vereadora)</option>
            <option value="VALDECI">üèõÔ∏è Valdeci (Vereador)</option>
            <option value="ANTONIO_GUEDES">üèõÔ∏è Ant√¥nio Guedes (Vereador)</option>
          </select>
        </div>
        
        <div>
          <label>DATA *</label>
          <input type="date" id="vip-data">
        </div>
        
        <div>
          <label>PLACA DO VE√çCULO *</label>
          <input type="text" id="vip-placa" placeholder="ABC-1234" maxlength="8" style="text-transform:uppercase;">
        </div>
        
        <div>
          <label>POSTO *</label>
          <select id="vip-posto" onchange="carregarCombustiveisVIP()">
            <option value="">SELECIONE...</option>
          </select>
        </div>
        
        <div>
          <label>COMBUST√çVEL *</label>
          <select id="vip-combustivel" onchange="calcularValorVIP()">
            <option value="">SELECIONE O POSTO PRIMEIRO</option>
          </select>
        </div>
        
        <div>
          <label>LITROS *</label>
          <input type="number" id="vip-litros" placeholder="0.00" step="0.01" min="0" oninput="calcularValorVIP()">
        </div>
        
        <div>
          <label>PRE√áO/LITRO (R$)</label>
          <input type="number" id="vip-preco" placeholder="0.00" step="0.01" min="0" readonly style="background:#f1f5f9;">
        </div>
        
        <div>
          <label>VALOR TOTAL (R$)</label>
          <input type="text" id="vip-valor" readonly style="background:#f1f5f9; font-weight:bold; font-size:16px; color:var(--primary);">
        </div>
        
        <div>
          <label>OD√îMETRO (KM) *</label>
          <input type="number" id="vip-km" placeholder="0" min="0">
        </div>
        
        <div style="grid-column: 1/-1;">
          <label>OBSERVA√á√ïES</label>
          <textarea id="vip-obs" placeholder="Observa√ß√µes adicionais (opcional)" rows="2"></textarea>
        </div>
      </div>
      
      <!-- Alerta de Limite -->
      <div id="alerta-limite-vip" style="display:none; margin-top:15px; padding:15px; background:#fef3c7; border-left:4px solid var(--warning); border-radius:8px;">
        <div style="display:flex; align-items:center; gap:10px;">
          <div style="font-size:24px;">‚ö†Ô∏è</div>
          <div>
            <strong style="color:#92400e;">ATEN√á√ÉO: LIMITE SER√Å EXCEDIDO!</strong>
            <div id="detalhes-excedente-vip" style="font-size:12px; color:#78350f; margin-top:5px;"></div>
          </div>
        </div>
      </div>
      
      <button class="btn-save" onclick="lancarAbastecimentoVIP()" style="margin-top:20px; background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
        ‚≠ê LAN√áAR ABASTECIMENTO VIP
      </button>
    </div>
    
    <!-- Hist√≥rico de Abastecimentos VIP -->
    <div class="card">
      <h3>üìã HIST√ìRICO DE ABASTECIMENTOS VIP</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>DATA</th>
              <th>PESSOA</th>
              <th>PLACA</th>
              <th>POSTO</th>
              <th>COMBUST√çVEL</th>
              <th>LITROS</th>
              <th>VALOR</th>
              <th>LAN√áADO POR</th>
              <th class="no-print">A√á√ïES</th>
            </tr>
          </thead>
          <tbody id="historico-vip-body">
            <tr>
              <td colspan="9" style="text-align:center; padding:40px;">
                ‚è≥ CARREGANDO HIST√ìRICO...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div id="tab-pendentes" style="display:none;">
    <!-- Dashboard do Autorizador -->
    <div id="dashboard-autorizador" style="display:none;">
      <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 20px;">
        <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
          <h4 style="margin: 0 0 5px 0; font-size: 11px; opacity: 0.9;">AUTORIZA√á√ïES HOJE</h4>
          <div class="stat-value" id="stat-autorizacoes-hoje">0</div>
          <div style="font-size: 10px; opacity: 0.8; margin-top: 5px;" id="stat-tendencia-hoje"></div>
        </div>
        
        <div class="stat-card" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white;">
          <h4 style="margin: 0 0 5px 0; font-size: 11px; opacity: 0.9;">ESTA SEMANA</h4>
          <div class="stat-value" id="stat-autorizacoes-semana">0</div>
          <div style="font-size: 10px; opacity: 0.8; margin-top: 5px;">√öLTIMOS 7 DIAS</div>
        </div>
        
        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
          <h4 style="margin: 0 0 5px 0; font-size: 11px; opacity: 0.9;">ESTE M√äS</h4>
          <div class="stat-value" id="stat-autorizacoes-mes">0</div>
          <div style="font-size: 10px; opacity: 0.8; margin-top: 5px;" id="stat-media-dia"></div>
        </div>
        
        <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white;">
          <h4 style="margin: 0 0 5px 0; font-size: 11px; opacity: 0.9;">TEMPO M√âDIO</h4>
          <div class="stat-value" id="stat-tempo-medio">--</div>
          <div style="font-size: 10px; opacity: 0.8; margin-top: 5px;">DE RESPOSTA</div>
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
        <div class="card">
          <h3 style="font-size: 14px;">üìä COMBUST√çVEIS MAIS AUTORIZADOS</h3>
          <div id="combustiveis-ranking" style="margin-top: 15px;">
            <div style="text-align: center; padding: 20px; color: #64748b;">Carregando...</div>
          </div>
        </div>
        
        <div class="card">
          <h3 style="font-size: 14px;">‚è±Ô∏è HIST√ìRICO DE RESPOSTAS</h3>
          <div style="height: 180px; margin-top: 15px;">
            <canvas id="chart-autorizador-tempo"></canvas>
          </div>
        </div>
      </div>
      
      <div class="card" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-left: 4px solid #3b82f6;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h4 style="margin: 0; font-size: 13px; color: #0f172a;">üéØ SUA PERFORMANCE</h4>
            <p style="margin: 5px 0 0 0; font-size: 11px; color: #64748b;" id="performance-texto">Excelente trabalho!</p>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 32px; font-weight: bold; color: #3b82f6;" id="performance-score">100%</div>
            <div style="font-size: 10px; color: #64748b;">EFICI√äNCIA</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="card">
      <h3>‚è≥ SOLICITA√á√ïES PENDENTES DE APROVA√á√ÉO</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>DATA</th>
              <th>PLACA</th>
              <th>POSTO</th>
              <th>SECRETARIA</th>
              <th>MOTORISTA</th>
              <th>COMBUST√çVEL</th>
              <th>LITROS</th>
              <th>VALOR</th>
              <th>SOLICITANTE</th>
              <th class="no-print">A√á√ïES</th>
            </tr>
          </thead>
          <tbody id="pendentes-body"></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div id="tab-executivo" style="display:none;">
    <!-- Dashboard Executivo -->
    <div class="executive-card">
      <h2>üëî DASHBOARD EXECUTIVO</h2>
      <div class="executive-metrics" id="executive-metrics"></div>
    </div>
    
    <div class="card">
      <h3>üìä VIS√ÉO GERAL DO M√äS</h3>
      <div class="charts-row">
        <div style="height:300px;"><canvas id="chartExecutivo1"></canvas></div>
        <div style="height:300px;"><canvas id="chartExecutivo2"></canvas></div>
      </div>
    </div>
    
    <div class="card">
      <h3>üéØ PERFORMANCE POR SECRETARIA</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>SECRETARIA</th>
              <th>OR√áADO</th>
              <th>REALIZADO</th>
              <th>DIFEREN√áA</th>
              <th>% EXECU√á√ÉO</th>
              <th>PROJE√á√ÉO M√äS</th>
              <th>STATUS</th>
            </tr>
          </thead>
          <tbody id="performance-body"></tbody>
        </table>
      </div>
    </div>
    
    <div class="charts-row">
      <div class="card">
        <h3>üìà EVOLU√á√ÉO ANUAL</h3>
        <div style="height:300px;"><canvas id="chartAnual"></canvas></div>
      </div>
      <div class="card">
        <h3>üöó FROTA - INDICADORES</h3>
        <div style="height:300px;"><canvas id="chartFrota"></canvas></div>
      </div>
    </div>
    
    <div class="card">
      <h3>‚ö†Ô∏è ALERTAS E RECOMENDA√á√ïES</h3>
      <div id="alertas-executivo"></div>
    </div>
  </div>
  
  <div id="tab-analytics" style="display:none;">
    <div class="card">
      <h3>üìà AN√ÅLISE COMPARATIVA - M√äS ATUAL VS M√äS ANTERIOR</h3>
      <div class="comparison-card" id="comparison-container"></div>
    </div>
    
    <div class="card">
      <h3>üèÜ RANKING DE EFICI√äNCIA DE VE√çCULOS</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>POSI√á√ÉO</th>
              <th>PLACA</th>
              <th>MODELO</th>
              <th>M√âDIA (KM/L)</th>
              <th>TOTAL GASTO</th>
              <th>TOTAL LITROS</th>
              <th>ABASTECIMENTOS</th>
              <th>EFICI√äNCIA</th>
            </tr>
          </thead>
          <tbody id="ranking-body"></tbody>
        </table>
      </div>
    </div>
    
    <div class="card">
      <h3>üìä CONSUMO POR TIPO DE COMBUST√çVEL</h3>
      <div style="height:300px;"><canvas id="chartCombustivel"></canvas></div>
    </div>
    
    <div class="card">
      <h3>üìâ TEND√äNCIA DE GASTOS (√öLTIMOS 6 MESES)</h3>
      <div style="height:300px;"><canvas id="chartTendencia"></canvas></div>
    </div>
  </div>
  
  <div id="tab-users" style="display:none;">
    <!-- Gest√£o de Pessoas VIP -->
    <div class="card" id="gestao-vips" style="display:none;">
      <h3>‚≠ê GEST√ÉO DE PESSOAS VIP</h3>
      <p style="color: #64748b; font-size: 13px; margin-top: 10px;">
        Configure as pessoas autorizadas a receber abastecimentos diretos (Prefeita, Vereadores, etc)
      </p>
      
      <!-- Formul√°rio de Novo VIP -->
      <div style="margin-top: 20px; padding: 20px; background: #f8fafc; border-radius: 8px;">
        <h4 style="margin: 0 0 15px 0; font-size: 14px; color: var(--primary);">‚ûï ADICIONAR NOVA PESSOA VIP</h4>
        <div class="grid-form">
          <div>
            <label>NOME COMPLETO *</label>
            <input type="text" id="novo-vip-nome" placeholder="Ex: Maria da Silva">
          </div>
          <div>
            <label>CARGO *</label>
            <select id="novo-vip-cargo">
              <option value="">SELECIONE...</option>
              <option value="Prefeito(a)">Prefeito(a)</option>
              <option value="Vice-Prefeito(a)">Vice-Prefeito(a)</option>
              <option value="Vereador(a)">Vereador(a)</option>
              <option value="Secret√°rio(a)">Secret√°rio(a)</option>
              <option value="Diretor(a)">Diretor(a)</option>
              <option value="Outro">Outro</option>
            </select>
          </div>
          <div>
            <label>CATEGORIA</label>
            <select id="novo-vip-categoria">
              <option value="executivo">Executivo</option>
              <option value="legislativo">Legislativo</option>
              <option value="administrativo">Administrativo</option>
            </select>
          </div>
          <div>
            <label>LIMITE MENSAL (R$)</label>
            <input type="number" id="novo-vip-limite" placeholder="0.00" step="0.01" min="0">
            <label style="display: flex; align-items: center; gap: 8px; margin-top: 8px; font-size: 13px; cursor: pointer;">
              <input type="checkbox" id="novo-vip-sem-limite" onchange="toggleLimiteVIP('novo')">
              <span>‚≠ê Sem limite (ilimitado)</span>
            </label>
          </div>
        </div>
        <button class="btn-save" onclick="adicionarVIP()" style="margin-top: 15px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
          ‚≠ê ADICIONAR PESSOA VIP
        </button>
      </div>
      
      <!-- Lista de VIPs Cadastrados -->
      <div style="margin-top: 25px;">
        <h4 style="margin: 0 0 15px 0; font-size: 14px; color: var(--primary);">üìã PESSOAS VIP CADASTRADAS</h4>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>NOME</th>
                <th>CARGO</th>
                <th>CATEGORIA</th>
                <th>LIMITE MENSAL</th>
                <th>GASTO M√äS ATUAL</th>
                <th>SALDO</th>
                <th class="no-print">A√á√ïES</th>
              </tr>
            </thead>
            <tbody id="vips-body">
              <tr>
                <td colspan="7" style="text-align:center; padding:40px;">
                  ‚è≥ CARREGANDO PESSOAS VIP...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div class="card">
      <h3>‚õΩ CADASTRO DE POSTOS</h3>
      <div class="grid-form">
        <div style="grid-column: 1/-1;">
          <label>NOME DO POSTO *</label>
          <input type="text" id="posto-nome" placeholder="EX: POSTO MATINA">
        </div>
      </div>
      
      <div style="margin: 20px 0; padding: 15px; background: #f8fafc; border-radius: 8px;">
        <h4 style="margin: 0 0 15px 0; font-size: 14px; color: var(--primary);">COMBUST√çVEIS FORNECIDOS PELO POSTO</h4>
        <p style="font-size: 11px; color: #64748b; margin-bottom: 15px;">Selecione os combust√≠veis que este posto oferece e informe o pre√ßo de cada um:</p>
        
        <div style="display: grid; gap: 15px;">
          <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #e2e8f0;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 0 0 auto;">
              <input type="checkbox" id="posto-tem-gasolina" onchange="toggleCombustivelPosto('gasolina')">
              <span style="font-weight: bold; color: var(--danger);">GASOLINA</span>
            </label>
            <div style="flex: 1; display: flex; align-items: center; gap: 10px;">
              <label style="font-size: 12px; white-space: nowrap;">PRE√áO (R$/L):</label>
              <input type="number" id="posto-gas" placeholder="0.00" step="0.01" min="0" disabled style="flex: 1;">
            </div>
          </div>
          
          <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #e2e8f0;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 0 0 auto;">
              <input type="checkbox" id="posto-tem-alcool" onchange="toggleCombustivelPosto('alcool')">
              <span style="font-weight: bold; color: var(--success);">√ÅLCOOL</span>
            </label>
            <div style="flex: 1; display: flex; align-items: center; gap: 10px;">
              <label style="font-size: 12px; white-space: nowrap;">PRE√áO (R$/L):</label>
              <input type="number" id="posto-alc" placeholder="0.00" step="0.01" min="0" disabled style="flex: 1;">
            </div>
          </div>
          
          <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #e2e8f0;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 0 0 auto;">
              <input type="checkbox" id="posto-tem-diesel" onchange="toggleCombustivelPosto('diesel')">
              <span style="font-weight: bold; color: var(--warning);">DIESEL</span>
            </label>
            <div style="flex: 1; display: flex; align-items: center; gap: 10px;">
              <label style="font-size: 12px; white-space: nowrap;">PRE√áO (R$/L):</label>
              <input type="number" id="posto-die" placeholder="0.00" step="0.01" min="0" disabled style="flex: 1;">
            </div>
          </div>
          
          <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #e2e8f0;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 0 0 auto;">
              <input type="checkbox" id="posto-tem-diesels10" onchange="toggleCombustivelPosto('diesels10')">
              <span style="font-weight: bold; color: #ea580c;">DIESEL S10</span>
            </label>
            <div style="flex: 1; display: flex; align-items: center; gap: 10px;">
              <label style="font-size: 12px; white-space: nowrap;">PRE√áO (R$/L):</label>
              <input type="number" id="posto-diesels10" placeholder="0.00" step="0.01" min="0" disabled style="flex: 1;">
            </div>
          </div>
          
          <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #e2e8f0;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 0 0 auto;">
              <input type="checkbox" id="posto-tem-gas" onchange="toggleCombustivelPosto('gas')">
              <span style="font-weight: bold; color: #0891b2;">G√ÅS</span>
            </label>
            <div style="flex: 1; display: flex; align-items: center; gap: 10px;">
              <label style="font-size: 12px; white-space: nowrap;">PRE√áO (R$/L):</label>
              <input type="number" id="posto-gas-gnv" placeholder="0.00" step="0.01" min="0" disabled style="flex: 1;">
            </div>
          </div>
        </div>
      </div>
      
      <button class="btn-save" onclick="salvarPosto()" style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);">‚ûï SALVAR POSTO</button>
    </div>
    
    <div class="card">
      <h3>‚õΩ POSTOS CADASTRADOS</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>POSTO</th>
              <th>COMBUST√çVEIS DISPON√çVEIS</th>
              <th class="no-print">A√á√ïES</th>
            </tr>
          </thead>
          <tbody id="postos-body"></tbody>
        </table>
      </div>
    </div>
    
    <div class="card">
      <h3>üöó CADASTRO DE VE√çCULOS</h3>
      <div class="grid-form">
        <div>
          <label>PLACA *</label>
          <input type="text" id="vei-placa" placeholder="ABC-1234" maxlength="8">
        </div>
        <div>
          <label>MODELO</label>
          <input type="text" id="vei-modelo" placeholder="EX: GOL, SAVEIRO">
        </div>
        <div>
          <label>SECRETARIA (OPCIONAL)</label>
          <select id="vei-sec">
            <option value="">NENHUMA (COMPARTILHADO)</option>
            <option>ADMINISTRA√á√ÉO E FINAN√áAS</option>
            <option>AGRICULTURA E MEIO AMBIENTE</option>
            <option>ASSIST√äNCIA SOCIAL</option>
            <option>EDUCA√á√ÉO</option>
            <option>SA√öDE</option>
            <option>INFRAESTRUTURA E SERVI√áOS</option>
            <option>AVULSOS / GERAL</option>
          </select>
        </div>
        <div>
          <label>MOTORISTA PADR√ÉO (OPCIONAL)</label>
          <input type="text" id="vei-motorista" placeholder="NOME DO MOTORISTA">
        </div>
        <div>
          <label>TIPO DE COMBUST√çVEL</label>
          <select id="vei-combustivel">
            <option value="GASOLINA">GASOLINA</option>
            <option value="ALCOOL">√ÅLCOOL</option>
            <option value="DIESEL">DIESEL</option>
<option value='GAS'>G√°s</option>
<option value='DIESEL S10'>Diesel S10</option>
<option value='GAS'>G√°s</option>
            <option value="FLEX">FLEX (GASOLINA/√ÅLCOOL)</option>
          </select>
        </div>
        <div>
          <label>ANO</label>
          <input type="number" id="vei-ano" placeholder="2020" min="1980" max="2030">
        </div>
      </div>
      <button class="btn-save" onclick="salvarVeiculo()" style="background: linear-gradient(135deg, var(--success) 0%, #16a34a 100%);">‚ûï SALVAR VE√çCULO</button>
      
      <!-- Gerador de QR Code -->
      <div class="qr-code-display" id="qr-display" style="display:none;">
        <h4>üì± QR CODE GERADO</h4>
        <p style="font-size:12px; color:#64748b;">IMPRIMA E COLE NO VE√çCULO</p>
        <div id="qrcode"></div>
        <p style="margin-top:10px;"><strong>PLACA:</strong> <span id="qr-placa-text"></span></p>
        <button class="btn-save" style="background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);" onclick="baixarQRCode()">üíæ BAIXAR QR CODE</button>
      </div>
    </div>
    
    <div class="card">
      <h3>üë• GEST√ÉO DE USU√ÅRIOS</h3>
      <div class="grid-form">
        <div>
          <label>USU√ÅRIO</label>
          <input type="text" id="new-user" placeholder="LOGIN">
        </div>
        <div>
          <label>SENHA</label>
          <input type="password" id="new-pass" placeholder="SENHA">
        </div>
        <div>
          <label>PERFIL</label>
          <select id="new-role" onchange="toggleUserFields()">
            <option value="admin">ADMIN (TOTAL)</option>
            <option value="secretarios">SECRET√ÅRIO (RESTRITO)</option>
            <option value="frentista">FRENTISTA (SOMENTE LEITURA)</option>
	    <option value="autorizador">AUTORIZADOR (RESTRITO)</option>
          </select>
        </div>
        <div>
          <label>COMBUST√çVEL PERMITIDO</label>
          <select id="new-combustivel">
            <option value="GASOLINA">GASOLINA</option>
            <option value="ALCOOL">√ÅLCOOL</option>
            <option value="DIESEL">DIESEL</option>
<option value='GAS'>G√°s</option>
<option value='DIESEL S10'>Diesel S10</option>
<option value='GAS'>G√°s</option>
            <option value="todos">TODOS</option>
          </select>
        </div>
        <div id="field-limit">
          <label>LIMITE MENSAL (R$)</label>
          <input type="number" id="new-limit" placeholder="0.00" step="0.01">
        </div>
        <div id="field-sec">
          <label>SECRETARIA VINCULADA</label>
          <select id="new-sec-vinc">
            <option value="">SELECIONE...</option>
            <option>ADMINISTRA√á√ÉO E FINAN√áAS</option>
            <option>AGRICULTURA E MEIO AMBIENTE</option>
            <option>ASSIST√äNCIA SOCIAL</option>
            <option>COMUNICA√á√ÉO</option>
            <option>CULTURA</option>
            <option>EDUCA√á√ÉO</option>
            <option>ESPORTES</option>
            <option>GOVERNO</option>
            <option>INFRAESTRUTURA E SERVI√áOS</option>
            <option>PLANEJAMENTO</option>
            <option>SA√öDE</option>
            <option>AVULSOS / GERAL</option>
          </select>
        </div>
        <div id="field-posto-autorizador" style="display:none;">
          <label>POSTO AUTORIZADO</label>
          <select id="new-posto-vinc" onchange="carregarCombustiveisPostoAutorizador()">
            <option value="">CARREGANDO...</option>
          </select>
        </div>
        <div id="field-combustiveis-autorizador" style="display:none;">
          <label>COMBUST√çVEIS QUE PODE LIBERAR</label>
          <div id="lista-combustiveis-autorizador" style="display: grid; gap: 8px; padding: 10px; background: #f8fafc; border-radius: 8px;">
            <p style="color: #64748b; font-size: 11px; margin: 0;">Selecione um posto primeiro</p>
          </div>
        </div>
      </div>
      <button class="btn-save" onclick="addUsuario()" style="background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);">‚ûï SALVAR USU√ÅRIO</button>
    </div>
    
    <div class="card">
      <h3>üìã USU√ÅRIOS CADASTRADOS</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>USU√ÅRIO</th>
              <th>PERFIL</th>
              <th>COMB. PERMITIDO</th>
              <th>V√çNCULO</th>
              <th>LIMITE</th>
              <th>POSTO</th>
              <th class="no-print">A√á√ïES</th>
            </tr>
          </thead>
          <tbody id="user-body"></tbody>
        </table>
      </div>
    </div>
    
    <!-- LISTA DE VE√çCULOS -->
    <div class="card">
      <h3>üöó VE√çCULOS CADASTRADOS</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>PLACA</th>
              <th>MODELO</th>
              <th>SECRETARIA</th>
              <th>MOTORISTA PADR√ÉO</th>
              <th>COMBUST√çVEL</th>
              <th>ANO</th>
              <th class="no-print">A√á√ïES</th>
            </tr>
          </thead>
          <tbody id="veiculos-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal QR Code Global -->
<div id="modal-qr" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="fecharModalQR()">&times;</span>
    <h3>üì± QR CODE DO VE√çCULO</h3>
    <div style="text-align:center;">
      <div id="qrcode-modal"></div>
      <p style="margin-top:15px; font-size:16px;"><strong>PLACA:</strong> <span id="qr-placa-modal"></span></p>
      <button class="btn-save" style="background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%);" onclick="baixarQRCodeModal()">üíæ BAIXAR QR CODE</button>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDsEQ8L_hWgacZ8xweY3DR9OYt2t151kZE",
    authDomain: "tabela-gasolina.firebaseapp.com",
    databaseURL: "https://tabela-gasolina-default-rtdb.firebaseio.com", 
    projectId: "tabela-gasolina"
  };
  
  console.log("=== INICIANDO SISTEMA ===");
  console.log("Firebase dispon√≠vel?", typeof firebase !== 'undefined');
  
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  
  console.log("Firebase inicializado");
  console.log("Database:", db);
  console.log("==================");
  
  const STATUS = {
    AGUARDANDO: 'AGUARDANDO',
    AUTORIZADO: 'AUTORIZADO',
    REJEITADO: 'REJEITADO'
  };
  
  // PESSOAS VIP - PREFEITA E VEREADORES
  const PESSOAS_VIP = {
    'PREFEITA': {
      nome: 'PREFEITA',
      cargo: 'Prefeita Municipal',
      limiteDefault: 5000.00,
      categoria: 'executivo'
    },
    'WAGNER': {
      nome: 'Wagner',
      cargo: 'Vereador',
      limiteDefault: 2000.00,
      categoria: 'legislativo'
    },
    'VALU': {
      nome: 'Val√∫',
      cargo: 'Vereador(a)',
      limiteDefault: 2000.00,
      categoria: 'legislativo'
    },
    'CASSIA': {
      nome: 'C√°ssia',
      cargo: 'Vereadora',
      limiteDefault: 2000.00,
      categoria: 'legislativo'
    },
    'VALDECI': {
      nome: 'Valdeci',
      cargo: 'Vereador',
      limiteDefault: 2000.00,
      categoria: 'legislativo'
    },
    'ANTONIO_GUEDES': {
      nome: 'Ant√¥nio Guedes',
      cargo: 'Vereador',
      limiteDefault: 2000.00,
      categoria: 'legislativo'
    }
  };
  
  const LIMITES_KM = {
    GASOLINA: 7,
    DIESEL: 2.5,
    ALCOOL: 5
  };
  
  const LIMITES_EXCELENTE = {
    GASOLINA: 12,
    DIESEL: 8,
    ALCOOL: 9
  };
  
  // NOVO: Adicionar limites de alerta
  const LIMITES_ALERTA = {
    GASOLINA: 9,
    DIESEL: 6,
    ALCOOL: 7
  };
  
  const PERFIS = {
    MASTER: 'master',
    ADMIN: 'admin',
    SECRETARIO: 'secretarios',
    FRENTISTA: 'frentista',
    AUTORIZADOR: 'autorizador'};
  
  const PERMISSOES_DISPONIVEIS = {
    'ver_dashboard': { nome: 'Ver Dashboard', descricao: 'Visualizar painel principal', categoria: 'visualizacao' },
    'ver_relatorio_geral': { nome: 'Ver Relat√≥rios Gerais', descricao: 'Acessar todos os relat√≥rios', categoria: 'visualizacao' },
    'ver_relatorio_secretaria': { nome: 'Ver Relat√≥rio Secretaria', descricao: 'Ver apenas sua secretaria', categoria: 'visualizacao' },
    'usar_filtros_relatorio': { nome: 'Usar Filtros de Relat√≥rio', descricao: 'Aplicar filtros nos relat√≥rios', categoria: 'visualizacao' },
    'registrar_abastecimento': { nome: 'Registrar Abastecimento', descricao: 'Criar novos registros', categoria: 'operacoes' },
    'registrar_abastecimento_vip': { nome: 'Registrar Abastecimento VIP', descricao: 'Lan√ßar para Prefeita/Vereadores', categoria: 'operacoes' },
    'autorizar_abastecimento': { nome: 'Autorizar Abastecimento', descricao: 'Aprovar/rejeitar solicita√ß√µes', categoria: 'operacoes' },
    'deletar_abastecimento': { nome: 'Deletar Abastecimento', descricao: 'Excluir registros', categoria: 'operacoes' },
    'gerenciar_veiculos': { nome: 'Gerenciar Ve√≠culos', descricao: 'Cadastrar ve√≠culos', categoria: 'gestao' },
    'gerenciar_postos': { nome: 'Gerenciar Postos', descricao: 'Cadastrar postos', categoria: 'gestao' },
    'gerenciar_usuarios': { nome: 'Gerenciar Usu√°rios', descricao: 'CRUD de usu√°rios', categoria: 'gestao' },
    'exportar_excel': { nome: 'Exportar Excel', descricao: 'Baixar relat√≥rios', categoria: 'exportacao' }
  };
  
  const PERMISSOES_PADRAO = {
    master: Object.keys(PERMISSOES_DISPONIVEIS),
    admin: ['ver_dashboard', 'ver_relatorio_geral', 'usar_filtros_relatorio', 'registrar_abastecimento', 'registrar_abastecimento_vip', 'autorizar_abastecimento', 'deletar_abastecimento', 'gerenciar_veiculos', 'gerenciar_postos', 'exportar_excel'],
    secretarios: ['ver_dashboard', 'ver_relatorio_secretaria', 'usar_filtros_relatorio', 'registrar_abastecimento', 'exportar_excel'],
    frentista: ['ver_relatorio_geral', 'usar_filtros_relatorio'],
  autorizador: ['autorizar_abastecimento', 'registrar_abastecimento_vip']
};
  
  // Fun√ß√£o para verificar permiss√µes
  function temPermissao(permissao) {
    if (loginUser === 'master') return true;
    return userPermissions.includes(permissao);
  }
  
  // Fun√ß√£o para verificar se pode ver relat√≥rio de uma secretaria
  function podeVerRelatorio(secretaria) {
    if (temPermissao('ver_relatorio_geral')) return true;
    if (temPermissao('ver_relatorio_secretaria') && secretaria === userSecretaria) return true;
    return false;
  }
  
  let cache = [];
  let veiculos = [];
  let postos = [];
  let userLimit = 0;
  let userRole = "";
  let loginUser = "";
  let userSecretaria = "";
  let usuarioData = {};
  let precos = { GASOLINA: 6, ALCOOL: 4, DIESEL: 6 };
  let chartSec = null;
  let chartVec = null;
  let chartCombustivel = null;
  let chartTendencia = null;
  let chartExecutivo1 = null;
  let chartExecutivo2 = null;
  let chartAnual = null;
  let chartFrota = null;
  let html5QrCode = null;
  let dadosMesAnterior = null;
  let notificacoes = [];
  let deferredPrompt = null;
  let userPermissions = [];
  let usuarioEditandoPermissoes = null;
  let abastecimentoTanqueCheioAtual = null;
  let limiteSecretarioAtual = null;
  
  db.ref('config/precos').on('value', snap => {
    if (snap.val()) {
      precos = snap.val();
    }
  });
  
  db.ref('veiculos').on('value', snap => {
    veiculos = [];
    snap.forEach(item => {
      let v = item.val();
      v.id = item.key;
      veiculos.push(v);
    });
  });
  
  db.ref('postos').on('value', snap => {
    postos = [];
    snap.forEach(item => {
      let p = item.val();
      p.id = item.key;
      postos.push(p);
    });
    atualizarSelectPostos();
  });
  
  // Fun√ß√£o para alternar modo tanque cheio
  function toggleTanqueCheio() {
    const isTanqueCheio = document.getElementById('f-tanque-cheio').checked;
    const litrosInput = document.getElementById('f-lit');
    const valorInput = document.getElementById('f-val');
    const infoDiv = document.getElementById('tanque-cheio-info');
    
    if (isTanqueCheio) {
      litrosInput.value = "";
      valorInput.value = "";
      litrosInput.disabled = true;
      infoDiv.style.display = 'block';
    } else {
      litrosInput.disabled = false;
      infoDiv.style.display = 'none';
    }
    calc();
  }
  
  // NOVO: Fun√ß√£o corrigida para calcular m√©dia
  function calcularMedia(abastecimento) {
    // Buscar o √∫ltimo abastecimento APROVADO do mesmo ve√≠culo e combust√≠vel
    const ultimoAbast = cache
      .filter(v => 
        v.placa === abastecimento.placa && 
        v.tipo === abastecimento.tipo &&
        v.status === STATUS.AUTORIZADO &&
        v.timestamp < abastecimento.timestamp
      )
      .sort((a, b) => b.timestamp - a.timestamp)[0];

    if (!ultimoAbast || abastecimento.litro <= 0) {
      return 0;
    }

    const kmRodados = abastecimento.km - ultimoAbast.km;
    
    // Verificar se os km s√£o v√°lidos (n√£o podem ser negativos)
    if (kmRodados <= 0) {
      return 0;
    }

    return kmRodados / abastecimento.litro;
  }
  
  // NOVO: Fun√ß√£o para validar m√©dia do ve√≠culo no momento do registro
  function validarMediaVeiculo(dados) {
    const ultimoAbast = cache
      .filter(x => 
        x.placa === dados.placa && 
        x.tipo === dados.tipo &&
        x.status === STATUS.AUTORIZADO
      )
      .sort((a, b) => b.timestamp - a.timestamp)[0];

    if (!ultimoAbast || dados.litro <= 0) {
      return { valido: true }; // Sem hist√≥rico suficiente
    }

    const kmRodados = dados.km - ultimoAbast.km;
    
    if (kmRodados <= 0) {
      return { valido: true }; // Km inv√°lido, n√£o calcular
    }

    const media = kmRodados / dados.litro;
    const limiteAlerta = LIMITES_ALERTA[dados.tipo];

    return {
      valido: true,
      media: media,
      abaixoDoLimite: media < limiteAlerta,
      limite: limiteAlerta,
      ultimoKm: ultimoAbast.km,
      kmRodados: kmRodados
    };
  }
  
  // NOVO: Fun√ß√£o para verificar m√©dia em tempo real no formul√°rio
  function verificarMediaEmTempoReal() {
    const placa = document.getElementById('f-placa').value.toUpperCase().trim();
    const tipo = document.getElementById('f-tipo').value;
    const litros = parseFloat(document.getElementById('f-lit').value) || 0;
    const kmAtual = parseFloat(document.getElementById('f-km').value) || 0;
    
    if (!placa || litros <= 0 || kmAtual <= 0) {
      // Se n√£o tiver dados suficientes, n√£o mostra o alerta
      return;
    }
    
    const validacao = validarMediaVeiculo({
      placa: placa,
      tipo: tipo,
      litro: litros,
      km: kmAtual
    });
    
    const previsaoDiv = document.getElementById('previsao-content');
    // Remover alertas anteriores
    const alertaAnterior = previsaoDiv.querySelector('.alerta-media-tempo-real');
    if (alertaAnterior) {
      alertaAnterior.remove();
    }
    
    if (validacao.abaixoDoLimite) {
      const limiteAlerta = LIMITES_ALERTA[tipo];
      
      const alertaDiv = document.createElement('div');
      alertaDiv.className = 'alerta-media-tempo-real';
      alertaDiv.style.marginTop = '10px';
      alertaDiv.style.padding = '10px';
      alertaDiv.style.background = '#fee2e2';
      alertaDiv.style.borderRadius = '6px';
      alertaDiv.style.borderLeft = '4px solid var(--danger)';
      
      alertaDiv.innerHTML = `
        <div style="font-size:11px; color:#b91c1c; font-weight:bold;">
          ‚ö†Ô∏è ALERTA: M√©dia abaixo do esperado!
        </div>
        <div style="font-size:10px; color:#b91c1c; margin-top:5px;">
          M√©dia calculada: <strong>${validacao.media.toFixed(2)} km/l</strong><br>
          M√≠nimo esperado para ${tipo}: <strong>${limiteAlerta} km/l</strong>
        </div>
      `;
      
      previsaoDiv.appendChild(alertaDiv);
    }
  }
  
  // NOVA FUN√á√ÉO: Verificar limite em tempo real
  function verificarLimiteEmTempoReal() {
    if (userRole !== 'secretarios' && userRole !== 'autorizador') return;
    
    // Se for tanque cheio, n√£o validar limite agora
    const isTanqueCheio = document.getElementById('f-tanque-cheio').checked;
    if (isTanqueCheio) {
      // Para tanque cheio, remover alertas
      const alerta = document.getElementById('alerta-limite');
      if (alerta) alerta.remove();
      const info = document.getElementById('info-limite');
      if (info) info.remove();
      
      const btnRegistrar = document.getElementById('btn-registrar');
      btnRegistrar.disabled = false;
      btnRegistrar.style.background = '';
      btnRegistrar.innerHTML = '‚úîÔ∏è REGISTRAR ABASTECIMENTO';
      return;
    }
    
    const litros = parseFloat(document.getElementById('f-lit').value) || 0;
    const tipo = document.getElementById('f-tipo').value;
    const posto = document.getElementById('f-posto').value;
    
    if (!posto || litros <= 0) {
      // Se n√£o tiver dados suficientes, n√£o mostra o alerta
      return;
    }
    
    const postoData = postos.find(p => p.nome === posto);
    if (!postoData || !postoData.precos) return;
    
    const precoPorLitro = postoData.precos[tipo] || 0;
    const valorAbastecimento = litros * precoPorLitro;
    
    const gastoAtual = cache
      .filter(x => 
        (x.status === STATUS.AUTORIZADO || x.status === STATUS.AGUARDANDO) &&
        x.secretaria === userSecretaria
      )
      .reduce((acc, item) => acc + (item.valor || 0), 0);
    
    const gastoProjetado = gastoAtual + valorAbastecimento;
    const saldoRestante = Math.max(0, userLimit - gastoAtual);
    
    // Atualizar interface para mostrar situa√ß√£o
    const valorInput = document.getElementById('f-val');
    const btnRegistrar = document.getElementById('btn-registrar');
    
    if (gastoProjetado > userLimit) {
      // Excedeu o limite
      btnRegistrar.disabled = true;
      btnRegistrar.style.background = 'linear-gradient(135deg, var(--danger) 0%, #dc2626 100%)';
      btnRegistrar.innerHTML = '‚õî LIMITE EXCEDIDO';
      
      // Mostrar alerta visual
      valorInput.style.borderColor = 'var(--danger)';
      valorInput.style.backgroundColor = '#fee2e2';
      valorInput.style.color = 'var(--danger)';
      
      // Adicionar tooltip/informa√ß√£o
      if (!document.getElementById('alerta-limite')) {
        const alerta = document.createElement('div');
        alerta.id = 'alerta-limite';
        alerta.style.marginTop = '10px';
        alerta.style.padding = '10px';
        alerta.style.background = '#fee2e2';
        alerta.style.borderRadius = '6px';
        alerta.style.borderLeft = '4px solid var(--danger)';
        alerta.style.fontSize = '11px';
        alerta.innerHTML = `
          <strong>‚ö†Ô∏è LIMITE EXCEDIDO!</strong><br>
          Limite: R$ ${userLimit.toFixed(2)}<br>
          Gasto atual: R$ ${gastoAtual.toFixed(2)}<br>
          Valor deste abastecimento: R$ ${valorAbastecimento.toFixed(2)}<br>
          <strong>Reduza os litros para continuar.</strong>
        `;
        
        const form = document.querySelector('.grid-form');
        if (form) {
          form.appendChild(alerta);
        }
      }
    } else {
      // Dentro do limite
      btnRegistrar.disabled = false;
      btnRegistrar.style.background = '';
      btnRegistrar.innerHTML = '‚úîÔ∏è REGISTRAR ABASTECIMENTO';
      
      valorInput.style.borderColor = '#e2e8f0';
      valorInput.style.backgroundColor = '#f1f5f9';
      valorInput.style.color = '#1e293b';
      
      // Remover alerta se existir
      const alerta = document.getElementById('alerta-limite');
      if (alerta) {
        alerta.remove();
      }
      
      // Mostrar informa√ß√£o de saldo se estiver pr√≥ximo do limite
      if (saldoRestante < userLimit * 0.3 && saldoRestante > 0) {
        if (!document.getElementById('info-limite')) {
          const info = document.createElement('div');
          info.id = 'info-limite';
          info.style.marginTop = '10px';
          info.style.padding = '8px';
          info.style.background = '#fff3cd';
          info.style.borderRadius = '6px';
          info.style.borderLeft = '4px solid var(--warning)';
          info.style.fontSize = '10px';
          info.innerHTML = `
            <strong>‚ö†Ô∏è ATEN√á√ÉO AO LIMITE</strong><br>
            Saldo restante: <strong>R$ ${saldoRestante.toFixed(2)}</strong>
          `;
          
          const form = document.querySelector('.grid-form');
          if (form) {
            form.appendChild(info);
          }
        }
      } else {
        const info = document.getElementById('info-limite');
        if (info) {
          info.remove();
        }
      }
    }
  }
  
  function logar() {
    console.log("=== INICIANDO LOGIN ===");
    const u = document.getElementById('user').value.toLowerCase().trim();
    const s = document.getElementById('senha').value.trim();
    
    console.log("Usu√°rio digitado:", u);
    console.log("Senha digitada:", s ? "***" : "(vazia)");
    
    if (!u || !s) {
      console.log("Campos vazios");
      mostrarNotificacao("PREENCHA USU√ÅRIO E SENHA!", "error");
      return;
    }
    
    if (u === "master" && s === "1234") {
      console.log("Login como MASTER");
      return entrar("master", "admin", 0, "", { 
        combustivelLiberado: "todos",
        senha: "1234",
        role: "admin",
        permissoes: Object.keys(PERMISSOES_DISPONIVEIS) // Master tem todas as permiss√µes
      });
    }
    
    console.log("Buscando no Firebase:", 'usuarios/' + u);
    console.log("Firebase DB:", db);
    
    db.ref('usuarios/' + u).once('value', snap => {
      console.log("Resposta Firebase recebida");
      console.log("Usu√°rio existe?", snap.exists());
      
      const user = snap.val();
      console.log("Dados do usu√°rio:", user);
      
      if (user && user.senha === s) {
        console.log("‚úÖ Senha correta! Fazendo login...");
        const permissoes = user.permissoes || PERMISSOES_PADRAO[user.role] || [];
        const dadosUsuario = {
          combustivelLiberado: user.combustivelLiberado || "todos",
          senha: user.senha,
          role: user.role,
          limite: user.limite || 0,
          secretariaVinculada: user.secretariaVinculada || "",
          permissoes: permissoes
        };
        entrar(u, user.role, user.limite || 0, user.secretariaVinculada || "", dadosUsuario);
        registrarAuditoria('LOGIN', { usuario: u });
      } else {
        console.log("‚ùå Falha no login");
        console.log("Usu√°rio existe:", !!user);
        console.log("Senha bate:", user ? user.senha === s : false);
        mostrarNotificacao("USU√ÅRIO OU SENHA INCORRETOS!", "error");
      }
    }).catch(error => {
      console.error("‚ùå ERRO AO BUSCAR USU√ÅRIO:", error);
      console.error("Detalhes:", error.message);
      console.error("Stack:", error.stack);
      mostrarNotificacao("ERRO AO CONECTAR AO BANCO DE DADOS!", "error");
    });
  }
  
  function entrar(u, role, limit, sec, dadosExtras) {
    loginUser = u;
    userRole = role;
    userLimit = limit;
    userSecretaria = sec;
    usuarioData = dadosExtras || {};
    userPermissions = dadosExtras.permissoes || PERMISSOES_PADRAO[role] || [];
    
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').classList.remove('blurred');
    
    // Controle de visibilidade das abas baseado em PERMISS√ïES
    document.getElementById('btn-tab-users').style.display = 
      (loginUser === 'master' || temPermissao('gerenciar_usuarios')) ? 'block' : 'none';
    
    document.getElementById('btn-tab-pendentes').style.display = 
      (temPermissao('autorizar_abastecimento')) ? 'block' : 'none';
    
    document.getElementById('btn-tab-vip').style.display = 
      (temPermissao('registrar_abastecimento_vip')) ? 'block' : 'none';
    
    document.getElementById('btn-tab-executivo').style.display = 
      (temPermissao('ver_dashboard')) ? 'block' : 'none';
    
    document.getElementById('btn-tab-analytics').style.display = 
      (temPermissao('ver_dashboard')) ? 'block' : 'none';
    
    // Esconder se√ß√£o de novo abastecimento se n√£o tiver permiss√£o
    if (!temPermissao('registrar_abastecimento')) {
      const novoAbastCard = document.querySelector('.card.no-print h3');
      if (novoAbastCard && novoAbastCard.textContent.includes('NOVO ABASTECIMENTO')) {
        novoAbastCard.closest('.card').style.display = 'none';
      }
    }
    
    // Controlar visibilidade dos filtros de relat√≥rio
    const cardFiltros = document.getElementById('card-filtros-relatorio');
    if (cardFiltros) {
      if (temPermissao('usar_filtros_relatorio')) {
        cardFiltros.style.display = 'block';
      } else {
        cardFiltros.style.display = 'none';
      }
    }
    
    if (role === 'secretarios' && sec !== "") {
      document.getElementById('f-sec').value = sec;
      document.getElementById('f-sec').disabled = true;
    }
    
    mostrarNotificacao(`‚úÖ BEM-VINDO, ${u.toUpperCase()}!`, "success");
    
    // Inicializar notifica√ß√µes
    inicializarNotificacoes();
    
    // Verificar PWA
    verificarPWA();
    
    setTimeout(() => {
      renderizar();
      calcularDadosMesAnterior();
    }, 100);
  }
  
  function calc() {
    const postoNome = document.getElementById('f-posto').value;
    const tipo = document.getElementById('f-tipo').value;
    const litros = parseFloat(document.getElementById('f-lit').value) || 0;
    
    if (!postoNome) {
      document.getElementById('f-val').value = "R$ 0.00";
      return;
    }
    
    const postoData = postos.find(p => p.nome === postoNome);
    
    if (!postoData || !postoData.precos) {
      mostrarNotificacao("‚ö†Ô∏è POSTO N√ÉO ENCONTRADO OU SEM PRE√áOS CADASTRADOS!", "warning");
      document.getElementById('f-val').value = "R$ 0.00";
      return;
    }
    
    const precoLitro = postoData.precos[tipo] || 0;
    const valorTotal = litros * precoLitro;
    
    document.getElementById('f-val').value = "R$ " + valorTotal.toFixed(2);
    
    // Atualizar previs√£o de consumo
    atualizarPrevisaoConsumo();
    
    // Verificar limite em tempo real para secret√°rios
    if (userRole === 'secretarios') {
      verificarLimiteEmTempoReal();
    }
  }
  
  function atualizarPrevisaoConsumo() {
    const placa = document.getElementById('f-placa').value.toUpperCase().trim();
    const tipo = document.getElementById('f-tipo').value;
    const litros = parseFloat(document.getElementById('f-lit').value) || 0;
    const kmAtual = parseFloat(document.getElementById('f-km').value) || 0;
    
    if (!placa || litros === 0 || kmAtual === 0) {
      document.getElementById('previsao-consumo').style.display = 'none';
      return;
    }
    
    const historico = cache
      .filter(v => v.placa === placa && v.tipo === tipo && v.status === STATUS.AUTORIZADO)
      .sort((a, b) => b.timestamp - a.timestamp)
      .slice(0, 5);
    
    if (historico.length === 0) {
      document.getElementById('previsao-consumo').style.display = 'none';
      return;
    }
    
    const ultimoAbast = historico[0];
    const kmRodados = kmAtual - ultimoAbast.km;
    const mediaEsperada = kmRodados / litros;
    
    const mediaHistorica = calcularMediaAvancada(placa, tipo);
    
    const previsaoDiv = document.getElementById('previsao-content');
    const limiteMinimo = LIMITES_KM[tipo] || 0;
    const limiteExcelente = LIMITES_EXCELENTE[tipo] || 15;
    
    let statusConsumo = "";
    let corStatus = "";
    
    if (mediaEsperada >= limiteExcelente) {
      statusConsumo = "EXCELENTE ‚≠ê";
      corStatus = "var(--success)";
    } else if (mediaEsperada >= limiteMinimo) {
      statusConsumo = "NORMAL ‚úÖ";
      corStatus = "#3b82f6";
    } else {
      statusConsumo = "ABAIXO DO ESPERADO ‚ö†Ô∏è";
      corStatus = "var(--danger)";
    }
    
    previsaoDiv.innerHTML = `
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; text-align:center;">
        <div>
          <div style="font-size:11px; color:#64748b;">KM RODADOS</div>
          <div style="font-size:18px; font-weight:bold;">${kmRodados.toFixed(0)} km</div>
        </div>
        <div>
          <div style="font-size:11px; color:#64748b;">M√âDIA PREVISTA</div>
          <div style="font-size:18px; font-weight:bold; color:${corStatus};">${mediaEsperada.toFixed(2)} km/l</div>
        </div>
        <div>
          <div style="font-size:11px; color:#64748b;">STATUS</div>
          <div style="font-size:14px; font-weight:bold; color:${corStatus};">${statusConsumo}</div>
        </div>
      </div>
      ${mediaHistorica > 0 ? `
      <div style="margin-top:10px; font-size:11px; color:#64748b; text-align:center;">
        M√©dia Hist√≥rica: <strong>${mediaHistorica.toFixed(2)} km/l</strong>
        ${mediaEsperada < mediaHistorica * 0.7 ? '<span style="color:var(--danger);"> ‚ö†Ô∏è CONSUMO MUITO ACIMA DO NORMAL!</span>' : ''}
      </div>
      ` : ''}
    `;
    
    document.getElementById('previsao-consumo').style.display = 'block';
    
    // Adicionar verifica√ß√£o de m√©dia em tempo real
    verificarMediaEmTempoReal();
  }
  
  function validarKmAtual() {
    const placa = document.getElementById('f-placa').value.toUpperCase().trim();
    const kmAtual = parseFloat(document.getElementById('f-km').value) || 0;
    
    if (!placa || kmAtual === 0) return;
    
    const ultimoAbast = cache
      .filter(x => x.placa === placa && x.status === STATUS.AUTORIZADO)
      .sort((a, b) => b.timestamp - a.timestamp)[0];
    
    if (ultimoAbast && kmAtual < ultimoAbast.km) {
      mostrarNotificacao(`‚ö†Ô∏è ATEN√á√ÉO: KM ATUAL (${kmAtual}) √â MENOR QUE O √öLTIMO REGISTRADO (${ultimoAbast.km})!`, "warning");
    }
    
    atualizarPrevisaoConsumo();
  }
  
  function calcularMediaAvancada(placa, combustivel) {
    const historico = cache
      .filter(v => v.placa === placa && v.tipo === combustivel && v.status === STATUS.AUTORIZADO)
      .sort((a, b) => b.timestamp - a.timestamp)
      .slice(0, 5);
    
    if (historico.length < 2) return 0;
    
    let totalKm = 0, totalLitros = 0;
    for (let i = 0; i < historico.length - 1; i++) {
      const kmDif = historico[i].km - historico[i + 1].km;
      if (kmDif > 0) {
        totalKm += kmDif;
        totalLitros += historico[i].litro;
      }
    }
    
    return totalLitros > 0 ? totalKm / totalLitros : 0;
  }
  
  function atualizarPrecosPosto() {
    calc();
  }
  
  function atualizarSelectPostos() {
    const select = document.getElementById('f-posto');
    const selectRel = document.getElementById('rel-posto');
    
    if (select) {
      select.innerHTML = '<option value="">SELECIONE O POSTO</option>';
      postos.forEach(p => {
        select.innerHTML += `<option value="${p.nome}">${p.nome}</option>`;
      });
    }
    
    if (selectRel) {
      selectRel.innerHTML = '<option value="">TODOS</option>';
      postos.forEach(p => {
        selectRel.innerHTML += `<option value="${p.nome}">${p.nome}</option>`;
      });
    }
  }
  
  function validarAbastecimento(dados) {
    const erros = [];
    
    if (!dados.placa || dados.placa.length < 7) {
      erros.push("‚ùå PLACA INV√ÅLIDA");
    }
    if (!dados.posto || dados.posto === "") {
      erros.push("‚ùå SELECIONE O POSTO");
    }
    if (!dados.motorista || dados.motorista.trim() === "") {
      erros.push("‚ùå MOTORISTA OBRIGAT√ìRIO");
    }
    if (!dados.data) {
      erros.push("‚ùå DATA OBRIGAT√ìRIA");
    }
    const hoje = new Date().toISOString().split('T')[0];
    if (dados.data > hoje) {
      erros.push("‚ùå DATA N√ÉO PODE SER FUTURA");
    }
    
    // Se for tanque cheio, n√£o validar litros
    if (!dados.tanqueCheio && dados.litro <= 0) {
      erros.push("‚ùå LITROS DEVE SER MAIOR QUE ZERO");
    }
    
    if (dados.km <= 0) {
      erros.push("‚ùå KM DEVE SER MAIOR QUE ZERO");
    }
    
    const ultimoAbast = cache
      .filter(x => x.placa === dados.placa && x.status === STATUS.AUTORIZADO)
      .sort((a, b) => b.timestamp - a.timestamp)[0];
    if (ultimoAbast && dados.km < ultimoAbast.km) {
      erros.push(`‚ùå KM ATUAL (${dados.km}) N√ÉO PODE SER MENOR QUE O √öLTIMO REGISTRADO (${ultimoAbast.km})`);
    }
    return erros;
  }
  
  async function processar() {
    if (!temPermissao('registrar_abastecimento')) {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA REGISTRAR ABASTECIMENTO!", "error");
      return;
    }
  
    const btnRegistrar = document.getElementById('btn-registrar');
    const textoOriginal = btnRegistrar.innerHTML;
  
    btnRegistrar.disabled = true;
    btnRegistrar.innerHTML = '<div class="loading"></div> PROCESSANDO...';
  
    try {
      const dados = {
        placa: document.getElementById('f-placa').value.toUpperCase().trim(),
        posto: document.getElementById('f-posto').value,
        motorista: document.getElementById('f-mot').value.toUpperCase().trim(),
        data: document.getElementById('f-data').value,
        tipo: document.getElementById('f-tipo').value,
        secretaria: document.getElementById('f-sec').value,
        litro: parseFloat(document.getElementById('f-lit').value) || 0,
        km: parseFloat(document.getElementById('f-km').value) || 0,
        tanqueCheio: document.getElementById('f-tanque-cheio').checked
      };
  
      // üîç Valida√ß√£o
      const erros = validarAbastecimento(dados);
      if (erros.length > 0) {
        mostrarNotificacao(erros.join("\n"), "error");
        btnRegistrar.disabled = false;
        btnRegistrar.innerHTML = textoOriginal;
        return;
      }
  
      // üîê Permiss√£o por combust√≠vel
      if (usuarioData.combustivelLiberado !== 'todos' && 
          usuarioData.combustivelLiberado !== dados.tipo) {
        mostrarNotificacao(
          "‚õî VOC√ä N√ÉO TEM PERMISS√ÉO PARA ESTE TIPO DE COMBUST√çVEL!",
          "error"
        );
        btnRegistrar.disabled = false;
        btnRegistrar.innerHTML = textoOriginal;
        return;
      }
  
      // ‚õΩ Buscar pre√ßo do posto
      const postoData = postos.find(p => p.nome === dados.posto);
      if (!postoData || !postoData.precos || postoData.precos[dados.tipo] == null) {
        mostrarNotificacao(
          "‚ùå ERRO: PRE√áO DO COMBUST√çVEL N√ÉO CONFIGURADO NO POSTO!",
          "error"
        );
        btnRegistrar.disabled = false;
        btnRegistrar.innerHTML = textoOriginal;
        return;
      }
  
      // Se for tanque cheio, n√£o calcula o valor
      if (dados.tanqueCheio) {
        dados.precoPorLitro = 0;
        dados.valor = 0;
      } else {
        dados.precoPorLitro = postoData.precos[dados.tipo];
        dados.valor = dados.litro * dados.precoPorLitro;
      }

      // üî¥ NOVA VALIDA√á√ÉO: Verificar limite do secret√°rio
      if (userRole === 'secretarios' && !dados.tanqueCheio) {
        const gastoAtual = cache
          .filter(x => 
            (x.status === STATUS.AUTORIZADO || x.status === STATUS.AGUARDANDO) &&
            x.secretaria === userSecretaria
          )
          .reduce((acc, item) => acc + (item.valor || 0), 0);
        
        const gastoProjetado = gastoAtual + dados.valor;
        
        if (gastoProjetado > userLimit) {
          const saldoRestante = Math.max(0, userLimit - gastoAtual);
          mostrarNotificacao(
            `‚ùå LIMITE OR√áAMENT√ÅRIO EXCEDIDO!\n\n` +
            `Limite mensal: R$ ${userLimit.toFixed(2)}\n` +
            `Gasto atual: R$ ${gastoAtual.toFixed(2)}\n` +
            `Valor deste abastecimento: R$ ${dados.valor.toFixed(2)}\n` +
            `Gasto projetado: R$ ${gastoProjetado.toFixed(2)}\n` +
            `Saldo restante: R$ ${saldoRestante.toFixed(2)}\n\n` +
            `Voc√™ precisa reduzir os litros ou cancelar o registro.`,
            "error"
          );
          btnRegistrar.disabled = false;
          btnRegistrar.innerHTML = textoOriginal;
          return;
        }
      }
  
      // NOVO: üîç Validar m√©dia do ve√≠culo antes de registrar
      if (!dados.tanqueCheio) { // Tanque cheio n√£o calcula m√©dia agora
        const validacaoMedia = validarMediaVeiculo(dados);
        
        if (validacaoMedia.media > 0 && validacaoMedia.abaixoDoLimite) {
          const confirmar = confirm(
            `‚ö†Ô∏è ALERTA: M√âDIA DE CONSUMO BAIXA!\n\n` +
            `Ve√≠culo: ${dados.placa}\n` +
            `Tipo: ${dados.tipo}\n` +
            `KM rodados: ${validacaoMedia.kmRodados.toFixed(0)} km\n` +
            `Litros: ${dados.litro.toFixed(2)} L\n` +
            `M√©dia calculada: ${validacaoMedia.media.toFixed(2)} km/l\n` +
            `M√≠nimo esperado: ${validacaoMedia.limite} km/l\n\n` +
            `Deseja continuar com o registro?`
          );
          
          if (!confirmar) {
            btnRegistrar.disabled = false;
            btnRegistrar.innerHTML = textoOriginal;
            return;
          }
        }
      }
  
      // üßæ AVULSOS / GERAL ‚Äî hist√≥rico
      if (dados.secretaria === 'AVULSOS / GERAL') {
        const ultimosAbastecimentos = cache
          .filter(x => x.placa === dados.placa && x.status === STATUS.AUTORIZADO)
          .sort((a, b) => b.timestamp - a.timestamp)
          .slice(0, 5);
  
        if (ultimosAbastecimentos.length > 0) {
          const confirmar = await mostrarModalHistorico(dados.placa, ultimosAbastecimentos);
          if (!confirmar) {
            btnRegistrar.disabled = false;
            btnRegistrar.innerHTML = textoOriginal;
            return;
          }
        }
      }
  
      // üíæ SALVAR ABASTECIMENTO
      const status = (temPermissao('autorizar_abastecimento')) 
        ? STATUS.AUTORIZADO 
        : STATUS.AGUARDANDO;
      
      await db.ref('abastecimentos').push({
        ...dados,
        status: status,
        solicitadoPor: loginUser.toUpperCase(),
        timestamp: Date.now()
      });
  
      mostrarNotificacao(
        status === STATUS.AUTORIZADO
          ? "‚úÖ ABASTECIMENTO REGISTRADO COM SUCESSO!"
          : "üì§ SOLICITA√á√ÉO ENVIADA PARA APROVA√á√ÉO!",
        "success"
      );
      
      registrarAuditoria('ABASTECIMENTO_REGISTRADO', {
        placa: dados.placa,
        valor: dados.valor,
        status: status,
        tanqueCheio: dados.tanqueCheio
      });
      
      limparFormulario();
      
    } catch (erro) {
      console.error(erro);
      mostrarNotificacao("‚ùå Erro ao registrar abastecimento!", "error");
    } finally {
      btnRegistrar.disabled = false;
      btnRegistrar.innerHTML = textoOriginal;
    }
  }
  
  // NOVA FUN√á√ÉO: Carregar informa√ß√µes do limite do secret√°rio
  async function carregarLimiteSecretario(abastecimento) {
    const limiteDiv = document.getElementById('tanque-cheio-limite');
    const secretaria = abastecimento.secretaria;
    
    // Buscar todos os usu√°rios para encontrar o secret√°rio respons√°vel
    const usuariosSnapshot = await db.ref('usuarios').once('value');
    const usuarios = [];
    let secretarioEncontrado = null;
    
    usuariosSnapshot.forEach(snap => {
      const usuario = snap.val();
      usuario.id = snap.key;
      usuarios.push(usuario);
      
      // Procurar usu√°rio do tipo secretarios vinculado √† secretaria do abastecimento
      if (usuario.role === 'secretarios' && 
          usuario.secretariaVinculada === secretaria) {
        secretarioEncontrado = usuario;
      }
    });
    
    if (!secretarioEncontrado) {
      limiteDiv.style.display = 'none';
      limiteSecretarioAtual = null;
      return;
    }
    
    // Calcular gasto atual da secretaria no m√™s atual
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    
    const gastoAtual = cache
      .filter(x => 
        x.status === STATUS.AUTORIZADO &&
        x.secretaria === secretaria &&
        !x.tanqueCheio // Excluir tanques cheios pendentes
      )
      .reduce((acc, item) => acc + (item.valor || 0), 0);
    
    const limiteMensal = secretarioEncontrado.limite || 0;
    const saldoRestante = Math.max(0, limiteMensal - gastoAtual);
    const percentualGasto = limiteMensal > 0 ? (gastoAtual / limiteMensal * 100) : 0;
    
    // Atualizar exibi√ß√£o
    document.getElementById('limite-mensal').textContent = 
      `R$ ${limiteMensal.toFixed(2)}`;
    document.getElementById('gasto-atual').textContent = 
      `R$ ${gastoAtual.toFixed(2)}`;
    document.getElementById('saldo-restante').textContent = 
      `R$ ${saldoRestante.toFixed(2)}`;
    
    // Atualizar barra de progresso
    const progresso = document.getElementById('progresso-limite');
    progresso.style.width = `${Math.min(100, percentualGasto)}%`;
    
    // Definir cor baseada no percentual
    if (percentualGasto >= 90) {
      progresso.className = 'progress-fill danger';
    } else if (percentualGasto >= 70) {
      progresso.className = 'progress-fill warning';
    } else {
      progresso.className = 'progress-fill';
    }
    
    // Informa√ß√µes adicionais
    const infoDiv = document.getElementById('info-limite');
    infoDiv.innerHTML = `
      Secret√°rio: <strong>${secretarioEncontrado.id.toUpperCase()}</strong> | 
      Secretaria: <strong>${secretaria}</strong>
    `;
    
    limiteDiv.style.display = 'block';
    limiteSecretarioAtual = { limiteMensal, gastoAtual, saldoRestante };
    return { limiteMensal, gastoAtual, saldoRestante };
  }
  
  // NOVA FUN√á√ÉO: Verificar limite do secret√°rio em tempo real
  function verificarLimiteSecretario() {
    const valorInput = document.getElementById('tanque-valor');
    if (!valorInput) return;
    
    const valorTotal = parseFloat(valorInput.value.replace('R$ ', '').replace(',', '.')) || 0;
    
    const saldoElement = document.getElementById('saldo-restante');
    if (!saldoElement) return;
    
    const saldoRestante = parseFloat(saldoElement.textContent.replace('R$ ', '').replace(',', '.')) || 0;
    
    const btnConfirmar = document.getElementById('btn-confirmar-tanque');
    const infoDiv = document.getElementById('info-limite');
    
    if (valorTotal > saldoRestante && saldoRestante > 0) {
      // Valor excede o saldo restante
      const excedente = valorTotal - saldoRestante;
      
      // Atualizar bot√£o com aviso
      btnConfirmar.style.background = 'linear-gradient(135deg, var(--warning) 0%, #d97706 100%)';
      btnConfirmar.innerHTML = '‚ö†Ô∏è APROVAR (EXCEDE LIMITE)';
      
      // Mostrar alerta destacado
      const alertaExistente = document.getElementById('alerta-excedente');
      if (alertaExistente) {
        alertaExistente.remove();
      }
      
      const alertaDiv = document.createElement('div');
      alertaDiv.id = 'alerta-excedente';
      alertaDiv.style.cssText = `
        margin-top: 15px;
        padding: 15px;
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border-left: 4px solid var(--warning);
        border-radius: 8px;
        animation: pulse 1.5s infinite;
      `;
      alertaDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
          <div style="font-size: 24px;">‚ö†Ô∏è</div>
          <div>
            <strong style="color: #92400e; font-size: 13px;">ATEN√á√ÉO: VALOR EXCEDE O LIMITE!</strong>
          </div>
        </div>
        <div style="font-size: 11px; color: #78350f; line-height: 1.6;">
          <p style="margin: 5px 0;"><strong>Valor do abastecimento:</strong> R$ ${valorTotal.toFixed(2)}</p>
          <p style="margin: 5px 0;"><strong>Saldo dispon√≠vel:</strong> R$ ${saldoRestante.toFixed(2)}</p>
          <p style="margin: 5px 0;"><strong>Excedente:</strong> <span style="color: var(--danger); font-weight: bold;">R$ ${excedente.toFixed(2)}</span></p>
          <p style="margin: 10px 0 0 0; padding-top: 10px; border-top: 1px solid #fbbf24;">
            <em>Voc√™ pode aprovar, mas o secret√°rio ser√° notificado do estouro de or√ßamento.</em>
          </p>
        </div>
      `;
      
      // Inserir ap√≥s a div de limite
      const limiteDiv = document.getElementById('tanque-cheio-limite');
      limiteDiv.parentNode.insertBefore(alertaDiv, limiteDiv.nextSibling);
      
    } else {
      // Valor dentro do limite
      btnConfirmar.style.background = '';
      btnConfirmar.innerHTML = '‚úÖ CONFIRMAR ABASTECIMENTO';
      
      // Remover alerta se existir
      const alertaExistente = document.getElementById('alerta-excedente');
      if (alertaExistente) {
        alertaExistente.remove();
      }
    }
  }
  
  // Modal para aprovar tanque cheio
  function abrirModalTanqueCheio(abast) {
    abastecimentoTanqueCheioAtual = abast;
    
    // Preencher detalhes
    document.getElementById('tanque-cheio-detalhes').innerHTML = `
      <p><strong>Ve√≠culo:</strong> ${abast.placa}</p>
      <p><strong>Posto:</strong> ${abast.posto}</p>
      <p><strong>Combust√≠vel:</strong> ${abast.tipo}</p>
      <p><strong>Motorista:</strong> ${abast.motorista}</p>
      <p><strong>Solicitante:</strong> ${abast.solicitadoPor}</p>
      <p><strong>Secretaria:</strong> ${abast.secretaria}</p>
    `;
    
    // Preencher pre√ßo padr√£o
    const precoPadrao = precos[abast.tipo] || 0;
    document.getElementById('tanque-preco').value = precoPadrao;
    
    // Preencher KM atual
    document.getElementById('tanque-km').value = abast.km;
    
    // Limpar litros e valor
    document.getElementById('tanque-litros').value = '';
    document.getElementById('tanque-valor').value = '';
    
    // Carregar informa√ß√µes do limite do secret√°rio
    if (userRole === 'admin' || userRole === 'autorizador' || loginUser === 'master') {
      carregarLimiteSecretario(abast);
    } else {
      document.getElementById('tanque-cheio-limite').style.display = 'none';
    }
    
    // Resetar bot√£o de confirma√ß√£o
    const btnConfirmar = document.getElementById('btn-confirmar-tanque');
    btnConfirmar.disabled = false;
    btnConfirmar.innerHTML = '‚úÖ CONFIRMAR ABASTECIMENTO';
    btnConfirmar.style.background = '';
    
    // Abrir modal
    document.getElementById('modal-tanque-cheio').style.display = 'flex';
  }
  
  function calcularValorTanqueCheio() {
    const litros = parseFloat(document.getElementById('tanque-litros').value) || 0;
    const preco = parseFloat(document.getElementById('tanque-preco').value) || 0;
    const valorTotal = litros * preco;
    document.getElementById('tanque-valor').value = "R$ " + valorTotal.toFixed(2);
    
    // Verificar limite em tempo real
    verificarLimiteSecretario();
  }
  
  function confirmarTanqueCheio() {
    if (!abastecimentoTanqueCheioAtual) return;
    
    const litros = parseFloat(document.getElementById('tanque-litros').value) || 0;
    const preco = parseFloat(document.getElementById('tanque-preco').value) || 0;
    const valor = litros * preco;
    const kmFinal = document.getElementById('tanque-km').value;
    const obs = document.getElementById('tanque-obs').value;
    
    if (!litros || litros <= 0) {
      mostrarNotificacao("‚ùå INFORME OS LITROS ABASTECIDOS!", "error");
      return;
    }
    
    if (!kmFinal || kmFinal <= 0) {
      mostrarNotificacao("‚ùå INFORME O OD√îMETRO FINAL!", "error");
      return;
    }
    
    // Verificar limite uma √∫ltima vez
    const saldoElement = document.getElementById('saldo-restante');
    const saldoRestante = parseFloat(saldoElement.textContent.replace('R$ ', '').replace(',', '.')) || 0;
    
    let excedeLimite = false;
    if (valor > saldoRestante && saldoRestante > 0) {
      excedeLimite = true;
      const confirmarExcedente = confirm(
        `‚ö†Ô∏è ATEN√á√ÉO: VALOR EXCEDE O LIMITE DISPON√çVEL!\n\n` +
        `Secretaria: ${abastecimentoTanqueCheioAtual.secretaria}\n` +
        `Valor do abastecimento: R$ ${valor.toFixed(2)}\n` +
        `Saldo dispon√≠vel: R$ ${saldoRestante.toFixed(2)}\n` +
        `Excedente: R$ ${(valor - saldoRestante).toFixed(2)}\n\n` +
        `O secret√°rio ser√° notificado do estouro de or√ßamento.\n\n` +
        `Deseja aprovar mesmo assim?`
      );
      
      if (!confirmarExcedente) return;
    }
    
    if (!confirm(`Confirmar abastecimento de ${litros}L por R$ ${valor.toFixed(2)}?`)) return;
    
    const dadosAtualizados = {
      litro: litros,
      precoPorLitro: preco,
      valor: valor,
      km: parseInt(kmFinal),
      status: STATUS.AUTORIZADO,
      aprovadoPor: loginUser.toUpperCase(),
      aprovadoEm: Date.now(),
      observacoes: obs || "",
      tanqueCheio: true,
      excedeLimite: excedeLimite // Flag para indicar que excedeu o limite
    };
    
    db.ref('abastecimentos/' + abastecimentoTanqueCheioAtual.id).update(dadosAtualizados)
      .then(() => {
        registrarAuditoria('ABASTECIMENTO_TANQUE_CHEIO_APROVADO', { 
          id: abastecimentoTanqueCheioAtual.id, 
          litros: litros, 
          valor: valor,
          secretaria: abastecimentoTanqueCheioAtual.secretaria,
          excedeLimite: excedeLimite,
          excedente: excedeLimite ? (valor - saldoRestante) : 0
        });
        
        if (excedeLimite) {
          mostrarNotificacao("‚ö†Ô∏è TANQUE CHEIO APROVADO COM ALERTA DE LIMITE EXCEDIDO!", "warning");
        } else {
          mostrarNotificacao("‚úÖ TANQUE CHEIO APROVADO COM SUCESSO!", "success");
        }
        
        fecharModalTanqueCheio();
      })
      .catch(error => {
        mostrarNotificacao("‚ùå ERRO: " + error.message, "error");
      });
  }
  
  function fecharModalTanqueCheio() {
    document.getElementById('modal-tanque-cheio').style.display = 'none';
    abastecimentoTanqueCheioAtual = null;
    limiteSecretarioAtual = null;
  }
  
  function aprovar(id) {
    if (!temPermissao('autorizar_abastecimento')) {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA APROVAR!", "error");
      return;
    }
    
    const abastecimento = cache.find(x => x.id === id);
    
    // Se for tanque cheio, abrir modal especial
    if (abastecimento && abastecimento.tanqueCheio) {
      abrirModalTanqueCheio(abastecimento);
      return;
    }
    
    // Caso contr√°rio, aprova√ß√£o normal
    if (!confirm("‚úÖ CONFIRMA A APROVA√á√ÉO DESTE ABASTECIMENTO?")) return;
    
    db.ref('abastecimentos/' + id).update({ 
      status: STATUS.AUTORIZADO,
      aprovadoPor: loginUser.toUpperCase(),
      aprovadoEm: Date.now()
    }).then(() => {
      registrarAuditoria('ABASTECIMENTO_APROVADO', { id: id });
      mostrarNotificacao("‚úÖ ABASTECIMENTO APROVADO!", "success");
    });
  }
  
  function rejeitar(id) {
    if (!temPermissao('autorizar_abastecimento')) {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA REJEITAR!", "error");
      return;
    }
    
    if (!confirm("‚ö†Ô∏è TEM CERTEZA QUE DESEJA REJEITAR ESTA SOLICITA√á√ÉO?")) return;
    const motivo = prompt("üìù MOTIVO DA REJEI√á√ÉO (OPCIONAL):");
    db.ref('abastecimentos/' + id).update({
      status: STATUS.REJEITADO,
      rejeitadoPor: loginUser.toUpperCase(),
      rejeitadoEm: Date.now(),
      motivoRejeicao: motivo || "N√ÉO INFORMADO"
    }).then(() => {
      registrarAuditoria('ABASTECIMENTO_REJEITADO', { id: id, motivo: motivo });
      mostrarNotificacao("‚ùå SOLICITA√á√ÉO REJEITADA!", "success");
    });
  }
  
  function deletar(id) {
    if (!temPermissao('deletar_abastecimento')) {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA EXCLUIR!", "error");
      return;
    }
    
    if (!confirm("‚ö†Ô∏è TEM CERTEZA QUE DESEJA EXCLUIR ESTE REGISTRO?\n\n‚õî ESTA A√á√ÉO N√ÉO PODE SER DESFEITA!")) return;
    db.ref('abastecimentos/' + id).remove().then(() => {
      registrarAuditoria('ABASTECIMENTO_DELETADO', { id: id });
      mostrarNotificacao("üóëÔ∏è REGISTRO EXCLU√çDO COM SUCESSO!", "success");
    });
  }
  
  function registrarAuditoria(acao, dados) {
    db.ref('auditoria').push({
      acao: acao,
      usuario: loginUser.toUpperCase(),
      timestamp: Date.now(),
      dados: dados
    });
  }
  
  function renderizar() {
    if (!loginUser) return;
    
    // Verificar se usu√°rio pode ver dashboard
    if (temPermissao('ver_dashboard') || temPermissao('ver_relatorio_geral') || temPermissao('ver_relatorio_secretaria')) {
      atualizarStatusFinanceiro();
      
      // S√≥ mostrar estat√≠sticas se tiver permiss√£o
      if (temPermissao('ver_dashboard')) {
        atualizarEstatisticas();
        atualizarGraficos();
        atualizarAlertas();
      } else {
        document.getElementById('stats-container').style.display = 'none';
        document.getElementById('alertas-container').style.display = 'none';
        const chartsRow = document.querySelector('.charts-row');
        if (chartsRow) chartsRow.style.display = 'none';
      }
    }
    
    atualizarRelatorio();
    
    if (temPermissao('autorizar_abastecimento')) {
      atualizarPendentes();
    }
  }
  
  function atualizarAlertas() {
    const alertasContainer = document.getElementById('alertas-container');
    let alertasHtml = '';
    
    // S√≥ mostrar alertas se tiver permiss√£o para ver dashboard
    if (!temPermissao('ver_dashboard')) {
      alertasContainer.innerHTML = '';
      return;
    }
    
    // Alertas de m√©dia baixa por ve√≠culo
    const veiculosComMedia = {};
    
    cache.filter(x => x.status === STATUS.AUTORIZADO).forEach(abast => {
      if (!veiculosComMedia[abast.placa]) {
        veiculosComMedia[abast.placa] = {
          placa: abast.placa,
          tipo: abast.tipo,
          abastecimentos: []
        };
      }
      veiculosComMedia[abast.placa].abastecimentos.push(abast);
    });
    
    const alertasMediaBaixa = [];
    
    Object.values(veiculosComMedia).forEach(veiculo => {
      const abasts = veiculo.abastecimentos.sort((a, b) => b.timestamp - a.timestamp);
      
      if (abasts.length >= 2) {
        let totalKm = 0, totalLitros = 0;
        
        for (let i = 0; i < Math.min(5, abasts.length - 1); i++) {
          const kmDif = abasts[i].km - abasts[i + 1].km;
          if (kmDif > 0) {
            totalKm += kmDif;
            totalLitros += abasts[i].litro;
          }
        }
        
        const mediaGeral = totalLitros > 0 ? totalKm / totalLitros : 0;
        
        // NOVO: Usar os limites de alerta espec√≠ficos
        const limiteAlerta = LIMITES_ALERTA[veiculo.tipo] || 9;
        
        if (mediaGeral > 0 && mediaGeral < limiteAlerta) {
          alertasMediaBaixa.push({
            placa: veiculo.placa,
            media: mediaGeral,
            tipo: veiculo.tipo,
            limite: limiteAlerta
          });
        }
      }
    });
    
    if (alertasMediaBaixa.length > 0) {
      alertasHtml += '<div class="alert-box danger">';
      alertasHtml += '<h4 style="margin:0 0 10px 0; font-size:14px;">üö® ALERTAS DE EFICI√äNCIA BAIXA</h4>';
      alertasMediaBaixa.forEach(alerta => {
        alertasHtml += `
          <div style="margin-bottom:8px; padding:10px; background:white; border-radius:6px; border-left:4px solid var(--danger);">
            <strong>${alerta.placa}</strong> - M√©dia: <span style="color:var(--danger); font-weight:bold;">${alerta.media.toFixed(2)} km/l</span>
            <span style="font-size:11px; color:#64748b;"> (${alerta.tipo} - Limite m√≠nimo: ${alerta.limite} km/l)</span>
            <button class="btn-action" style="background:var(--accent); color:white; margin-left:10px; font-size:10px;" onclick="analisarVeiculo('${alerta.placa}')">
              üìä VER AN√ÅLISE
            </button>
          </div>
        `;
      });
      alertasHtml += '</div>';
    }
    
    // Alerta de limite de secretaria
    if (userRole === 'secretarios') {
      const gastoComprometido = cache
        .filter(x => 
          (x.status === STATUS.AUTORIZADO || x.status === STATUS.AGUARDANDO) &&
          x.secretaria === userSecretaria
        )
        .reduce((acc, item) => acc + item.valor, 0);
      
      const percentualGasto = (gastoComprometido / userLimit) * 100;
      
      if (percentualGasto >= 80) {
        alertasHtml += `
          <div class="alert-box ${percentualGasto >= 95 ? 'danger' : ''}">
            <h4 style="margin:0 0 10px 0; font-size:14px;">‚ö†Ô∏è ATEN√á√ÉO AO LIMITE OR√áAMENT√ÅRIO</h4>
            <p style="margin:0;">
              Voc√™ j√° utilizou <strong>${percentualGasto.toFixed(1)}%</strong> do limite mensal.
              <br>Saldo restante: <strong>R$ ${(userLimit - gastoComprometido).toFixed(2)}</strong>
            </p>
            <div class="progress-bar" style="margin-top:10px;">
              <div class="progress-fill ${percentualGasto >= 95 ? 'danger' : 'warning'}" style="width:${percentualGasto}%"></div>
            </div>
          </div>
        `;
      }
    }
    
    alertasContainer.innerHTML = alertasHtml;
  }
  
  function analisarVeiculo(placa) {
    if (!temPermissao('ver_dashboard')) {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA VER AN√ÅLISES!", "error");
      return;
    }
    
    const historico = cache
      .filter(x => x.placa === placa && x.status === STATUS.AUTORIZADO)
      .sort((a, b) => b.timestamp - a.timestamp);
    
    if (historico.length < 2) {
      mostrarNotificacao("‚ùå HIST√ìRICO INSUFICIENTE PARA AN√ÅLISE", "error");
      return;
    }
    
    const analiseContent = document.getElementById('analise-content');
    
    let medias = [];
    for (let i = 0; i < historico.length - 1; i++) {
      const kmDif = historico[i].km - historico[i + 1].km;
      const media = kmDif / historico[i].litro;
      medias.push({
        data: historico[i].data,
        media: media,
        km: historico[i].km,
        litros: historico[i].litro,
        valor: historico[i].valor
      });
    }
    
    const mediaGeral = medias.reduce((acc, m) => acc + m.media, 0) / medias.length;
    const totalGasto = historico.reduce((acc, h) => acc + h.valor, 0);
    const totalLitros = historico.reduce((acc, h) => acc + h.litro, 0);
    
    let tabelaHtml = `
      <div style="margin-bottom:20px;">
        <div class="stats-grid" style="grid-template-columns:1fr 1fr 1fr;">
          <div class="stat-card">
            <h4>M√âDIA GERAL</h4>
            <div class="stat-value" style="color:${mediaGeral < 4 ? 'var(--danger)' : 'var(--success)'}">
              ${mediaGeral.toFixed(2)} km/l
            </div>
          </div>
          <div class="stat-card">
            <h4>TOTAL GASTO</h4>
            <div class="stat-value">R$ ${totalGasto.toFixed(2)}</div>
          </div>
          <div class="stat-card">
            <h4>TOTAL LITROS</h4>
            <div class="stat-value">${totalLitros.toFixed(1)} L</div>
          </div>
        </div>
      </div>
      
      <h4 style="margin-top:20px; font-size:13px;">HIST√ìRICO DE CONSUMO</h4>
      <div style="max-height:300px; overflow-y:auto;">
        <table style="width:100%; font-size:11px;">
          <thead>
            <tr style="background:#f8fafc;">
              <th style="padding:8px;">DATA</th>
              <th>KM</th>
              <th>LITROS</th>
              <th>M√âDIA</th>
              <th>VALOR</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    medias.forEach(m => {
      const corMedia = m.media < 4 ? 'var(--danger)' : (m.media > 10 ? 'var(--success)' : '#64748b');
      tabelaHtml += `
        <tr>
          <td style="padding:6px;">${m.data.split('-').reverse().join('/')}</td>
          <td>${m.km.toLocaleString('pt-BR')}</td>
          <td>${m.litros.toFixed(1)}L</td>
          <td style="font-weight:bold; color:${corMedia};">${m.media.toFixed(2)} km/l</td>
          <td>R$ ${m.valor.toFixed(2)}</td>
        </tr>
      `;
    });
    
    tabelaHtml += `
          </tbody>
        </table>
      </div>
      
      <div style="margin-top:20px; padding:15px; background:#f8fafc; border-radius:8px;">
        <h4 style="margin:0 0 10px 0; font-size:12px;">üí° RECOMENDA√á√ïES</h4>
        <ul style="margin:0; padding-left:20px; font-size:11px; line-height:1.8;">
          ${mediaGeral < 4 ? '<li style="color:var(--danger);">‚ö†Ô∏è M√©dia muito abaixo do esperado. Verifique manuten√ß√£o do ve√≠culo.</li>' : ''}
          ${mediaGeral < 7 && mediaGeral >= 4 ? '<li style="color:var(--warning);">‚ö†Ô∏è M√©dia abaixo do ideal. Considere revis√£o preventiva.</li>' : ''}
          ${mediaGeral >= 10 ? '<li style="color:var(--success);">‚úÖ Ve√≠culo com excelente efici√™ncia!</li>' : ''}
          <li>üìã Total de abastecimentos analisados: <strong>${historico.length}</strong></li>
          <li>üìÖ Per√≠odo: ${historico[historico.length - 1].data.split('-').reverse().join('/')} a ${historico[0].data.split('-').reverse().join('/')}</li>
        </ul>
      </div>
    `;
    
    analiseContent.innerHTML = tabelaHtml;
    document.getElementById('modal-analise').style.display = 'flex';
  }
  
  function fecharModalAnalise() {
    document.getElementById('modal-analise').style.display = 'none';
  }
  
  let resolveModalHistorico = null;
  
  function mostrarModalHistorico(placa, ultimosAbastecimentos) {
    return new Promise((resolve) => {
      resolveModalHistorico = resolve;
      
      const modal = document.getElementById('modal-historico-avulso');
      const content = document.getElementById('historico-avulso-content');
      
      let html = `
        <p style="margin:15px 0; font-size:13px; color:#64748b;">
          Ve√≠culo <strong style="color:var(--primary);">${placa}</strong> possui os seguintes abastecimentos registrados:
        </p>
        <div style="background:#f8fafc; border-radius:8px; padding:15px; max-height:400px; overflow-y:auto;">
      `;
      
      ultimosAbastecimentos.forEach((abast, index) => {
        const mediaAbast = calcularMedia(abast);
        
        const corSecretaria = abast.secretaria === 'AVULSOS / GERAL' ? '#94a3b8' : 'var(--accent)';
        
        // NOVO: Verificar se a m√©dia est√° abaixo do limite de alerta
        const limiteAlerta = LIMITES_ALERTA[abast.tipo] || 9;
        const temAlertaMedia = mediaAbast > 0 && mediaAbast < limiteAlerta;
        
        html += `
          <div style="background:white; padding:12px; border-radius:8px; margin-bottom:10px; border-left:4px solid ${temAlertaMedia ? 'var(--danger)' : corSecretaria};">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:8px;">
              <div>
                <div style="font-size:10px; color:#64748b; text-transform:uppercase;">Data</div>
                <div style="font-size:13px; font-weight:bold;">${abast.data.split('-').reverse().join('/')}</div>
              </div>
              <div>
                <div style="font-size:10px; color:#64748b; text-transform:uppercase;">KM</div>
                <div style="font-size:13px; font-weight:bold;">${abast.km.toLocaleString('pt-BR')}</div>
              </div>
            </div>
            <div style="font-size:10px; color:#64748b; text-transform:uppercase; margin-bottom:4px;">Secretaria</div>
            <div style="font-size:12px; font-weight:bold; color:${corSecretaria}; margin-bottom:8px;">
              ${abast.secretaria}
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; padding-top:8px; border-top:1px solid #e2e8f0;">
              <div style="text-align:center;">
                <div style="font-size:10px; color:#64748b;">LITROS</div>
                <div style="font-size:13px; font-weight:bold;">${abast.litro.toFixed(1)}L</div>
              </div>
              <div style="text-align:center;">
                <div style="font-size:10px; color:#64748b;">M√âDIA</div>
                <div style="font-size:13px; font-weight:bold; color:${temAlertaMedia ? 'var(--danger)' : (mediaAbast > 0 && mediaAbast >= limiteAlerta ? 'var(--success)' : '#64748b')};">
                  ${mediaAbast > 0 ? mediaAbast.toFixed(2) + ' km/l' : '---'}
                  ${temAlertaMedia ? ' ‚ö†Ô∏è' : ''}
                </div>
              </div>
              <div style="text-align:center;">
                <div style="font-size:10px; color:#64748b;">VALOR</div>
                <div style="font-size:13px; font-weight:bold;">R$ ${abast.valor.toFixed(2)}</div>
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      content.innerHTML = html;
      modal.style.display = 'flex';
    });
  }
  
  function fecharModalHistoricoAvulso(confirmar) {
    const modal = document.getElementById('modal-historico-avulso');
    modal.style.display = 'none';
    if (resolveModalHistorico) {
      resolveModalHistorico(confirmar);
      resolveModalHistorico = null;
    }
  }
  
  function atualizarEstatisticas() {
    const container = document.getElementById('stats-container');
    const dadosAutorizados = cache.filter(x => x.status === STATUS.AUTORIZADO);
    
    const totalGasto = dadosAutorizados.reduce((acc, item) => acc + item.valor, 0);
    const totalLitros = dadosAutorizados.reduce((acc, item) => acc + item.litro, 0);
    const totalAbastecimentos = dadosAutorizados.length;
    const veiculosUnicos = [...new Set(dadosAutorizados.map(x => x.placa))].length;
    
    // Comparar com m√™s anterior
    let trendGasto = '';
    let trendLitros = '';
    
    if (dadosMesAnterior) {
      const diferencaGasto = totalGasto - dadosMesAnterior.totalGasto;
      const percentualGasto = dadosMesAnterior.totalGasto > 0 
        ? (diferencaGasto / dadosMesAnterior.totalGasto * 100) 
        : 0;
      
      const diferencaLitros = totalLitros - dadosMesAnterior.totalLitros;
      const percentualLitros = dadosMesAnterior.totalLitros > 0
        ? (diferencaLitros / dadosMesAnterior.totalLitros * 100)
        : 0;
      
      trendGasto = `
        <div class="stat-trend ${diferencaGasto >= 0 ? 'negative' : 'positive'}">
          ${diferencaGasto >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(percentualGasto).toFixed(1)}% vs m√™s anterior
        </div>
      `;
      
      trendLitros = `
        <div class="stat-trend ${diferencaLitros >= 0 ? 'negative' : 'positive'}">
          ${diferencaLitros >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(percentualLitros).toFixed(1)}% vs m√™s anterior
        </div>
      `;
    }
    
    container.innerHTML = `
      <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <h4>TOTAL GASTO</h4>
        <div class="stat-value">R$ ${totalGasto.toFixed(2)}</div>
        ${trendGasto}
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚õΩ</div>
        <h4>TOTAL LITROS</h4>
        <div class="stat-value">${totalLitros.toFixed(1)} L</div>
        ${trendLitros}
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <h4>ABASTECIMENTOS</h4>
        <div class="stat-value">${totalAbastecimentos}</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üöó</div>
        <h4>VE√çCULOS</h4>
        <div class="stat-value">${veiculosUnicos}</div>
      </div>
    `;
  }
  
  function calcularDadosMesAnterior() {
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    
    let mesAnterior = mesAtual - 1;
    let anoAnterior = anoAtual;
    
    if (mesAnterior < 0) {
      mesAnterior = 11;
      anoAnterior = anoAtual - 1;
    }
    
    const dadosMesPassado = cache.filter(x => {
      if (x.status !== STATUS.AUTORIZADO) return false;
      const dataAbast = new Date(x.data);
      return dataAbast.getMonth() === mesAnterior && dataAbast.getFullYear() === anoAnterior;
    });
    
    dadosMesAnterior = {
      totalGasto: dadosMesPassado.reduce((acc, item) => acc + item.valor, 0),
      totalLitros: dadosMesPassado.reduce((acc, item) => acc + item.litro, 0),
      totalAbastecimentos: dadosMesPassado.length
    };
  }
  
  function atualizarStatusFinanceiro() {
    const statusDiv = document.getElementById('status-financeiro');
    
    // Frentista: mostrar apenas status de visualiza√ß√£o SEM VALORES
    if (userRole === 'frentista') {
      const totalPendente = cache.filter(x => x.status === STATUS.AGUARDANDO).length;
      const totalAutorizado = cache.filter(x => x.status === STATUS.AUTORIZADO).length;
      const totalRejeitado = cache.filter(x => x.status === STATUS.REJEITADO).length;
      
      statusDiv.innerHTML = `
        üë§ OPERADOR: ${loginUser.toUpperCase()} 
        <span class="badge badge-danger">FRENTISTA</span><br>
        üìä VISUALIZA√á√ÉO: ${totalAutorizado} APROVADOS | ‚è≥ ${totalPendente} PENDENTES | ‚ùå ${totalRejeitado} REJEITADOS
      `;
      statusDiv.style.background = 'linear-gradient(135deg, #64748b 0%, #475569 100%)';
      return;
    }
    
    if (userRole === 'secretarios') {
      const gasto = cache.filter(x => 
        (x.status === STATUS.AUTORIZADO || x.status === STATUS.AGUARDANDO) &&
        x.secretaria === userSecretaria
      ).reduce((acc, item) => acc + item.valor, 0);
      
      const saldo = userLimit - gasto;
      const percentual = (gasto / userLimit * 100).toFixed(1);
      statusDiv.innerHTML = `
        üìä ${userSecretaria}<br>
        üí∞ LIMITE: R$ ${userLimit.toFixed(2)} | 
        üìâ GASTO: R$ ${gasto.toFixed(2)} (${percentual}%) | 
        ‚úÖ SALDO: R$ ${saldo.toFixed(2)}
        <div class="progress-bar">
          <div class="progress-fill ${saldo < userLimit * 0.2 ? 'danger' : (saldo < userLimit * 0.5 ? 'warning' : '')}" style="width:${percentual}%"></div>
        </div>
      `;
      if (saldo < userLimit * 0.2) {
        statusDiv.style.background = 'linear-gradient(135deg, var(--danger) 0%, #dc2626 100%)';
      } else if (saldo < userLimit * 0.5) {
        statusDiv.style.background = 'linear-gradient(135deg, var(--warning) 0%, #f97316 100%)';
      } else {
        statusDiv.style.background = 'linear-gradient(135deg, var(--primary) 0%, #1e293b 100%)';
      }
    } else {
      const totalGasto = cache.filter(x => x.status === STATUS.AUTORIZADO)
        .reduce((acc, item) => acc + item.valor, 0);
      const totalPendente = cache.filter(x => x.status === STATUS.AGUARDANDO)
        .reduce((acc, item) => acc + item.valor, 0);
      const pendentesQtd = cache.filter(x => x.status === STATUS.AGUARDANDO).length;
      statusDiv.innerHTML = `
        üë§ OPERADOR: ${loginUser.toUpperCase()} 
        <span class="badge badge-success">${userRole.toUpperCase()}</span><br>
        üí∞ TOTAL APROVADO: R$ ${totalGasto.toFixed(2)} | 
        ‚è≥ PENDENTE: R$ ${totalPendente.toFixed(2)} (${pendentesQtd})
      `;
    }
  }
  
  function atualizarRelatorio() {
    let listaSecs = [...new Set(cache.map(x => x.secretaria))].sort();
    
    // Filtrar secretarias baseado nas permiss√µes
    if (temPermissao('ver_relatorio_secretaria') && !temPermissao('ver_relatorio_geral')) {
      listaSecs = listaSecs.filter(sec => sec === userSecretaria);
    }
    
    const container = document.getElementById('relatorio-container');
    container.innerHTML = "";
    
    const isFrentista = (userRole === 'frentista');
    
    listaSecs.forEach(sec => {
      if (!podeVerRelatorio(sec)) return;
      
      const itens = cache.filter(x => x.secretaria === sec && x.status !== STATUS.REJEITADO)
        .sort((a, b) => b.timestamp - a.timestamp);
      if (itens.length === 0) return;
      let linhas = "";
      itens.forEach(d => {
        const media = calcularMedia(d);
        // NOVO: Usar os limites de alerta espec√≠ficos
        const limiteAlerta = LIMITES_ALERTA[d.tipo];
        const classeAlerta = (media > 0 && media < limiteAlerta) ? "alerta-media" : "";
        
        linhas += `<tr class="${classeAlerta}">
          <td>${d.data.split('-').reverse().join('/')}</td>
          <td><b>${d.placa}</b> ${d.tanqueCheio ? '<span class="tanque-cheio-badge">‚õΩ TANQUE CHEIO</span>' : ''}</td>
          <td>${d.posto || '---'}</td>
          <td>${d.motorista}</td>
          <td>${d.tipo}</td>
          <td><span class="status-tag status-${d.status.toLowerCase()}">${d.status}</span></td>
          <td>${d.km.toLocaleString('pt-BR')}</td>
          <td>${d.litro.toFixed(2)} L</td>
          ${!isFrentista ? `
          <td ${classeAlerta ? `style="font-weight:bold;"` : ''}>
            ${media > 0 ? media.toFixed(2) + ' km/l' + (classeAlerta ? ' üö®' : '') : '---'}
          </td>
          <td>R$ ${d.valor.toFixed(2)}</td>
          ` : ''}
          <td class="no-print">
            ${(d.status === STATUS.AGUARDANDO && temPermissao('autorizar_abastecimento'))
              ? `<button class="btn-action btn-aprovar" onclick="aprovar('${d.id}')">‚úÖ</button>
                 <button class="btn-action btn-rejeitar" onclick="rejeitar('${d.id}')">‚ùå</button>` 
              : ''}
            ${(temPermissao('deletar_abastecimento'))
              ? `<button class="btn-action btn-deletar" onclick="deletar('${d.id}')">üóëÔ∏è</button>` 
              : ''}
          </td>
        </tr>`;
      });
      
      const totalSec = itens.reduce((acc, item) => acc + item.valor, 0);
      const totalLitros = itens.reduce((acc, item) => acc + item.litro, 0);
      
      // Frentista n√£o v√™ valores financeiros
      const headerInfo = isFrentista 
        ? `${sec} | ‚õΩ ${totalLitros.toFixed(2)} L | üìä ${itens.length} abastecimentos`
        : `${sec} | üí∞ R$ ${totalSec.toFixed(2)} | ‚õΩ ${totalLitros.toFixed(2)} L | üìä ${itens.length} abastecimentos`;
      
      container.innerHTML += `
        <div class="section-header">
          ${headerInfo}
        </div>
        <div class="card">
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>DATA</th>
                  <th>PLACA</th>
                  <th>POSTO</th>
                  <th>MOTORISTA</th>
                  <th>COMBUST√çVEL</th>
                  <th>STATUS</th>
                  <th>KM</th>
                  <th>LITROS</th>
                  ${!isFrentista ? '<th>M√âDIA</th><th>VALOR</th>' : ''}
                  <th class="no-print">A√á√ïES</th>
                </tr>
              </thead>
              <tbody>${linhas}</tbody>
            </table>
          </div>
        </div>
      `;
    });
  }
  
  let chartAutorizadorTempo = null;
  
  function atualizarDashboardAutorizador() {
    // Mostrar dashboard apenas para autorizadores
    const dashboard = document.getElementById('dashboard-autorizador');
    if (!dashboard) return;
    
    dashboard.style.display = 'block';
    
    // Buscar autoriza√ß√µes feitas por este usu√°rio
    db.ref('auditoria').orderByChild('usuario').equalTo(loginUser).once('value', snapshot => {
      const autorizacoes = [];
      snapshot.forEach(child => {
        const acao = child.val();
        if (acao.acao === 'APROVACAO' || acao.acao === 'REJEICAO') {
          autorizacoes.push({
            timestamp: acao.timestamp,
            acao: acao.acao,
            dados: acao.dados
          });
        }
      });
      
      // Estat√≠sticas
      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0);
      
      const inicioSemana = new Date();
      inicioSemana.setDate(inicioSemana.getDate() - 7);
      
      const inicioMes = new Date();
      inicioMes.setDate(1);
      inicioMes.setHours(0, 0, 0, 0);
      
      const autorizacoesHoje = autorizacoes.filter(a => a.timestamp >= hoje.getTime());
      const autorizacoesSemana = autorizacoes.filter(a => a.timestamp >= inicioSemana.getTime());
      const autorizacoesMes = autorizacoes.filter(a => a.timestamp >= inicioMes.getTime());
      
      // Atualizar cards
      document.getElementById('stat-autorizacoes-hoje').textContent = autorizacoesHoje.length;
      document.getElementById('stat-autorizacoes-semana').textContent = autorizacoesSemana.length;
      document.getElementById('stat-autorizacoes-mes').textContent = autorizacoesMes.length;
      
      // Tend√™ncia de hoje
      const ontem = new Date(hoje);
      ontem.setDate(ontem.getDate() - 1);
      const autorizacoesOntem = autorizacoes.filter(a => 
        a.timestamp >= ontem.getTime() && a.timestamp < hoje.getTime()
      );
      
      const tendencia = autorizacoesHoje.length - autorizacoesOntem.length;
      const tendenciaTexto = tendencia > 0 ? `‚ñ≤ +${tendencia} vs ontem` : 
                             tendencia < 0 ? `‚ñº ${tendencia} vs ontem` : 
                             `= mesmo que ontem`;
      document.getElementById('stat-tendencia-hoje').textContent = tendenciaTexto;
      
      // M√©dia por dia no m√™s
      const diasNoMes = new Date().getDate();
      const mediaDia = (autorizacoesMes.length / diasNoMes).toFixed(1);
      document.getElementById('stat-media-dia').textContent = `M√©dia: ${mediaDia}/dia`;
      
      // Tempo m√©dio de resposta (simulado - em produ√ß√£o, calcular tempo entre solicita√ß√£o e aprova√ß√£o)
      const tempoMedio = autorizacoesMes.length > 0 ? 
        Math.floor(Math.random() * 15 + 5) : 0; // Entre 5 e 20 min (simulado)
      document.getElementById('stat-tempo-medio').textContent = tempoMedio > 0 ? 
        `${tempoMedio} min` : '--';
      
      // Ranking de combust√≠veis
      const combustiveisMap = {};
      autorizacoesMes.forEach(a => {
        if (a.acao === 'APROVACAO' && a.dados && a.dados.combustivel) {
          const comb = a.dados.combustivel;
          combustiveisMap[comb] = (combustiveisMap[comb] || 0) + 1;
        }
      });
      
      const combustiveisOrdenados = Object.entries(combustiveisMap)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
      
      let rankingHtml = '';
      if (combustiveisOrdenados.length === 0) {
        rankingHtml = '<div style="text-align: center; padding: 20px; color: #64748b; font-size: 12px;">Nenhuma autoriza√ß√£o este m√™s</div>';
      } else {
        const total = Object.values(combustiveisMap).reduce((a, b) => a + b, 0);
        combustiveisOrdenados.forEach(([comb, qtd], index) => {
          const percentual = ((qtd / total) * 100).toFixed(1);
          const cores = {
            'GASOLINA': '#ef4444',
            'DIESEL': '#f59e0b',
            'ALCOOL': '#22c55e',
            'DIESEL S10': '#ea580c',
            'GAS': '#0891b2'
          };
          const cor = cores[comb] || '#64748b';
          
          rankingHtml += `
            <div style="margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 11px;">
                <strong>${index + 1}. ${comb}</strong>
                <span>${qtd} (${percentual}%)</span>
              </div>
              <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
                <div style="background: ${cor}; height: 100%; width: ${percentual}%; transition: width 0.3s;"></div>
              </div>
            </div>
          `;
        });
      }
      document.getElementById('combustiveis-ranking').innerHTML = rankingHtml;
      
      // Gr√°fico de hist√≥rico de tempo (√∫ltimos 7 dias)
      const ultimosDias = [];
      const autorizacoesPorDia = [];
      
      for (let i = 6; i >= 0; i--) {
        const dia = new Date();
        dia.setDate(dia.getDate() - i);
        dia.setHours(0, 0, 0, 0);
        
        const proximoDia = new Date(dia);
        proximoDia.setDate(proximoDia.getDate() + 1);
        
        const qtd = autorizacoes.filter(a => 
          a.timestamp >= dia.getTime() && a.timestamp < proximoDia.getTime()
        ).length;
        
        ultimosDias.push(dia.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
        autorizacoesPorDia.push(qtd);
      }
      
      if (chartAutorizadorTempo) chartAutorizadorTempo.destroy();
      const ctx = document.getElementById('chart-autorizador-tempo');
      if (ctx) {
        chartAutorizadorTempo = new Chart(ctx, {
          type: 'line',
          data: {
            labels: ultimosDias,
            datasets: [{
              label: 'Autoriza√ß√µes',
              data: autorizacoesPorDia,
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.4,
              fill: true,
              pointRadius: 4,
              pointHoverRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.parsed.y + ' autoriza√ß√µes';
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                  font: { size: 10 }
                }
              },
              x: {
                ticks: {
                  font: { size: 10 }
                }
              }
            }
          }
        });
      }
      
      // Performance (% de aprova√ß√µes vs rejei√ß√µes)
      const aprovacoes = autorizacoesMes.filter(a => a.acao === 'APROVACAO').length;
      const rejeicoes = autorizacoesMes.filter(a => a.acao === 'REJEICAO').length;
      const totalAcoes = aprovacoes + rejeicoes;
      
      if (totalAcoes > 0) {
        const percAprovacao = ((aprovacoes / totalAcoes) * 100).toFixed(0);
        document.getElementById('performance-score').textContent = percAprovacao + '%';
        
        let textoPerformance = '';
        if (percAprovacao >= 90) {
          textoPerformance = 'üåü Excelente! Alta taxa de aprova√ß√£o';
        } else if (percAprovacao >= 70) {
          textoPerformance = 'üëç Bom trabalho! Continue assim';
        } else {
          textoPerformance = '‚ö†Ô∏è Muitas rejei√ß√µes - verificar crit√©rios';
        }
        document.getElementById('performance-texto').textContent = textoPerformance;
      } else {
        document.getElementById('performance-score').textContent = '--';
        document.getElementById('performance-texto').textContent = 'Aguardando primeiras autoriza√ß√µes';
      }
    });
  }
  
  function toggleSomNotificacao() {
    notificacaoSomHabilitado = !notificacaoSomHabilitado;
    const btn = document.getElementById('btn-toggle-som');
    
    if (notificacaoSomHabilitado) {
      btn.textContent = 'üîä';
      btn.title = 'Som ativado - Clique para desativar';
      mostrarNotificacao("üîä SOM DE NOTIFICA√á√ïES ATIVADO", "success");
      // Tocar som de teste
      tocarSomNotificacao();
    } else {
      btn.textContent = 'üîá';
      btn.title = 'Som desativado - Clique para ativar';
      mostrarNotificacao("üîá SOM DE NOTIFICA√á√ïES DESATIVADO", "info");
    }
    
    // Salvar prefer√™ncia no localStorage
    localStorage.setItem('somNotificacao', notificacaoSomHabilitado);
  }
  
  // Carregar prefer√™ncia de som ao iniciar
  window.addEventListener('DOMContentLoaded', () => {
    const somSalvo = localStorage.getItem('somNotificacao');
    if (somSalvo !== null) {
      notificacaoSomHabilitado = somSalvo === 'true';
      const btn = document.getElementById('btn-toggle-som');
      if (btn) {
        btn.textContent = notificacaoSomHabilitado ? 'üîä' : 'üîá';
        btn.title = notificacaoSomHabilitado ? 'Som ativado' : 'Som desativado';
      }
    }
  });
  
  let ultimoTotalPendentes = 0;
  let notificacaoSomHabilitado = true;
  
  function tocarSomNotificacao() {
    if (!notificacaoSomHabilitado) return;
    
    // Criar som de notifica√ß√£o usando Web Audio API
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 800;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.5);
  }
  
  function mostrarNotificacaoVisual(quantidade) {
    // Criar notifica√ß√£o visual no topo da tela
    const notif = document.createElement('div');
    notif.style.cssText = `
      position: fixed;
      top: 80px;
      right: 20px;
      background: linear-gradient(135deg, #3b82f6 0%, #667eea 100%);
      color: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
      z-index: 10000;
      animation: slideInRight 0.5s, pulse 1.5s infinite;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
    `;
    notif.innerHTML = `
      <div style="display: flex; align-items: center; gap: 15px;">
        <div style="font-size: 32px;">üîî</div>
        <div>
          <div style="font-size: 16px; margin-bottom: 5px;">NOVA SOLICITA√á√ÉO!</div>
          <div style="font-size: 12px; opacity: 0.9;">${quantidade} ${quantidade === 1 ? 'pend√™ncia' : 'pend√™ncias'} aguardando</div>
        </div>
      </div>
    `;
    
    notif.onclick = () => {
      switchTab('tab-pendentes');
      notif.remove();
    };
    
    document.body.appendChild(notif);
    
    // Remover automaticamente ap√≥s 5 segundos
    setTimeout(() => {
      notif.style.animation = 'slideOutRight 0.5s';
      setTimeout(() => notif.remove(), 500);
    }, 5000);
  }
  
  function atualizarPendentes() {
    const pendentes = cache.filter(x => x.status === STATUS.AGUARDANDO);
    const tbody = document.getElementById('pendentes-body');
    const badge = document.getElementById('pendentes-badge');
    
    // Atualizar dashboard do autorizador se for autorizador
    if (userRole === 'autorizador') {
      atualizarDashboardAutorizador();
    }
    
    // Detectar novas pend√™ncias e notificar
    if (pendentes.length > ultimoTotalPendentes && ultimoTotalPendentes > 0) {
      const novasPendencias = pendentes.length - ultimoTotalPendentes;
      tocarSomNotificacao();
      mostrarNotificacaoVisual(novasPendencias);
    }
    ultimoTotalPendentes = pendentes.length;
    
    if (pendentes.length > 0 && badge) {
      badge.style.display = 'flex';
      badge.textContent = pendentes.length;
      
      // Fazer o badge piscar se houver pend√™ncias
      badge.style.animation = 'pulse-badge 2s infinite';
    } else if (badge) {
      badge.style.display = 'none';
    }
    
    if (pendentes.length === 0) {
      tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:40px;">‚úÖ NENHUMA SOLICITA√á√ÉO PENDENTE</td></tr>';
      return;
    }
    tbody.innerHTML = pendentes.map(d => `
      <tr>
        <td>${d.data.split('-').reverse().join('/')}</td>
        <td><b>${d.placa}</b> ${d.tanqueCheio ? '<span class="tanque-cheio-badge">‚õΩ TANQUE CHEIO</span>' : ''}</td>
        <td>${d.posto || '---'}</td>
        <td>${d.secretaria}</td>
        <td>${d.motorista}</td>
        <td>${d.tipo}</td>
        <td>${d.tanqueCheio ? '<em>Pendente</em>' : (d.litro.toFixed(2) + ' L')}</td>
        <td>${d.tanqueCheio ? '<em>Pendente</em>' : ('R$ ' + d.valor.toFixed(2))}</td>
        <td>${d.solicitadoPor}</td>
        <td class="no-print">
          <button class="btn-action btn-aprovar" onclick="aprovar('${d.id}')">
            ${d.tanqueCheio ? '‚õΩ APROVAR' : '‚úÖ APROVAR'}
          </button>
          <button class="btn-action btn-rejeitar" onclick="rejeitar('${d.id}')">‚ùå REJEITAR</button>
        </td>
      </tr>
    `).join('');
  }
  
  function atualizarGraficos() {
    const dadosGrafico = cache.filter(x => {
      if (userRole === 'secretarios') {
        return x.status === STATUS.AUTORIZADO && x.secretaria === userSecretaria;
      }
      return x.status === STATUS.AUTORIZADO;
    });
    if (dadosGrafico.length === 0) return;
    
    // Gr√°fico de Secretarias
    const secMap = {};
    dadosGrafico.forEach(d => {
      secMap[d.secretaria] = (secMap[d.secretaria] || 0) + d.valor;
    });
    if (chartSec) chartSec.destroy();
    chartSec = new Chart(document.getElementById('chartSec'), {
      type: 'doughnut',
      data: {
        labels: Object.keys(secMap),
        datasets: [{
          data: Object.values(secMap),
          backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#64748b', '#14b8a6', '#f97316']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { position: 'bottom', labels: { font: { size: 10 } } },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.label + ': R$ ' + context.parsed.toFixed(2);
              }
            }
          }
        }
      }
    });
    
    // Gr√°fico de Top 5 Ve√≠culos
    const vecMap = {};
    dadosGrafico.forEach(d => {
      vecMap[d.placa] = (vecMap[d.placa] || 0) + d.valor;
    });
    const sortedVec = Object.entries(vecMap)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);
    if (chartVec) chartVec.destroy();
    chartVec = new Chart(document.getElementById('chartVec'), {
      type: 'bar',
      data: {
        labels: sortedVec.map(x => x[0]),
        datasets: [{
          label: 'GASTO (R$)',
          data: sortedVec.map(x => x[1]),
          backgroundColor: '#3b82f6',
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                return 'R$ ' + context.parsed.y.toFixed(2);
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return 'R$ ' + value.toFixed(0);
              }
            }
          }
        }
      }
    });
    
    // Atualizar Analytics se estiver na aba
    if (document.getElementById('tab-analytics').style.display !== 'none') {
      atualizarAnalytics();
    }
  }
  
  function atualizarAnalytics() {
    // Compara√ß√£o Mensal
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    
    let mesAnterior = mesAtual - 1;
    let anoAnterior = anoAtual;
    if (mesAnterior < 0) {
      mesAnterior = 11;
      anoAnterior = anoAtual - 1;
    }
    
    const dadosMesAtual = cache.filter(x => {
      if (x.status !== STATUS.AUTORIZADO) return false;
      const dataAbast = new Date(x.data);
      return dataAbast.getMonth() === mesAtual && dataAbast.getFullYear() === anoAtual;
    });
    
    const dadosMesPassado = cache.filter(x => {
      if (x.status !== STATUS.AUTORIZADO) return false;
      const dataAbast = new Date(x.data);
      return dataAbast.getMonth() === mesAnterior && dataAbast.getFullYear() === anoAnterior;
    });
    
    const totalAtual = dadosMesAtual.reduce((acc, item) => acc + item.valor, 0);
    const totalAnterior = dadosMesPassado.reduce((acc, item) => acc + item.valor, 0);
    const litrosAtual = dadosMesAtual.reduce((acc, item) => acc + item.litro, 0);
    const litrosAnterior = dadosMesPassado.reduce((acc, item) => acc + item.litro, 0);
    
    const diferencaValor = totalAtual - totalAnterior;
    const percentualValor = totalAnterior > 0 ? (diferencaValor / totalAnterior * 100) : 0;
    
    const comparisonContainer = document.getElementById('comparison-container');
    comparisonContainer.innerHTML = `
      <div class="comparison-item">
        <h5>M√äS ANTERIOR</h5>
        <div class="comparison-value">R$ ${totalAnterior.toFixed(2)}</div>
        <div style="font-size:12px; color:#64748b; margin-top:5px;">${litrosAnterior.toFixed(1)}L</div>
      </div>
      <div class="comparison-item">
        <h5>M√äS ATUAL</h5>
        <div class="comparison-value">R$ ${totalAtual.toFixed(2)}</div>
        <div style="font-size:12px; color:#64748b; margin-top:5px;">${litrosAtual.toFixed(1)}L</div>
      </div>
      <div class="comparison-item" style="grid-column:1/-1;">
        <h5>VARIA√á√ÉO</h5>
        <div class="comparison-value" style="color:${diferencaValor >= 0 ? 'var(--danger)' : 'var(--success)'}">
          ${diferencaValor >= 0 ? '‚ñ≤' : '‚ñº'} R$ ${Math.abs(diferencaValor).toFixed(2)}
        </div>
        <div style="font-size:14px; margin-top:5px; font-weight:bold; color:${diferencaValor >= 0 ? 'var(--danger)' : 'var(--success)'}">
          ${percentualValor >= 0 ? '+' : ''}${percentualValor.toFixed(1)}%
        </div>
      </div>
    `;
    
    // Ranking de Efici√™ncia
    atualizarRankingEficiencia();
    
    // Gr√°fico de Combust√≠vel
    atualizarGraficoCombustivel();
    
    // Gr√°fico de Tend√™ncia
    atualizarGraficoTendencia();
  }
  
  function atualizarRankingEficiencia() {
    const veiculosComMedia = {};
    
    cache.filter(x => x.status === STATUS.AUTORIZADO).forEach(abast => {
      if (!veiculosComMedia[abast.placa]) {
        const veiculo = veiculos.find(v => v.placa === abast.placa);
        veiculosComMedia[abast.placa] = {
          placa: abast.placa,
          modelo: veiculo ? veiculo.modelo : '---',
          abastecimentos: [],
          totalGasto: 0,
          totalLitros: 0
        };
      }
      veiculosComMedia[abast.placa].abastecimentos.push(abast);
      veiculosComMedia[abast.placa].totalGasto += abast.valor;
      veiculosComMedia[abast.placa].totalLitros += abast.litro;
    });
    
    const ranking = [];
    Object.values(veiculosComMedia).forEach(veiculo => {
      const abasts = veiculo.abastecimentos.sort((a, b) => b.timestamp - a.timestamp);
      
      if (abasts.length >= 2) {
        let totalKm = 0, totalLitros = 0;
        
        for (let i = 0; i < abasts.length - 1; i++) {
          const kmDif = abasts[i].km - abasts[i + 1].km;
          if (kmDif > 0) {
            totalKm += kmDif;
            totalLitros += abasts[i].litro;
          }
        }
        
        const mediaGeral = totalLitros > 0 ? totalKm / totalLitros : 0;
        
        if (mediaGeral > 0) {
          ranking.push({
            placa: veiculo.placa,
            modelo: veiculo.modelo,
            media: mediaGeral,
            totalGasto: veiculo.totalGasto,
            totalLitros: veiculo.totalLitros,
            abastecimentos: abasts.length
          });
        }
      }
    });
    
    ranking.sort((a, b) => b.media - a.media);
    
    const tbody = document.getElementById('ranking-body');
    if (ranking.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:40px;">üì≠ DADOS INSUFICIENTES PARA RANKING</td></tr>';
      return;
    }
    
    tbody.innerHTML = ranking.map((item, index) => {
      let eficienciaClass = '';
      let eficienciaTexto = '';
      
      // NOVO: Usar limites de alerta espec√≠ficos para determinar a classifica√ß√£o
      const limiteAlerta = item.media ? LIMITES_ALERTA[cache.find(x => x.placa === item.placa)?.tipo] || 9 : 9;
      
      if (item.media >= (limiteAlerta + 3)) {
        eficienciaClass = 'eficiencia-excelente';
        eficienciaTexto = '‚≠ê EXCELENTE';
      } else if (item.media >= limiteAlerta) {
        eficienciaClass = '';
        eficienciaTexto = '‚úÖ BOA';
      } else if (item.media >= (limiteAlerta - 2)) {
        eficienciaClass = 'alerta-km-alto';
        eficienciaTexto = '‚ö†Ô∏è REGULAR';
      } else {
        eficienciaClass = 'alerta-media';
        eficienciaTexto = 'üö® CR√çTICA';
      }
      
      return `
        <tr class="${eficienciaClass}">
          <td><strong>${index + 1}¬∫</strong></td>
          <td><b>${item.placa}</b></td>
          <td>${item.modelo}</td>
          <td style="font-weight:bold; font-size:13px;">${item.media.toFixed(2)} km/l</td>
          <td>R$ ${item.totalGasto.toFixed(2)}</td>
          <td>${item.totalLitros.toFixed(1)}L</td>
          <td>${item.abastecimentos}</td>
          <td><strong>${eficienciaTexto}</strong></td>
        </tr>
      `;
    }).join('');
  }
  
  function atualizarGraficoCombustivel() {
    const dadosAutorizados = cache.filter(x => x.status === STATUS.AUTORIZADO);
    
    const combustivelMap = {};
    dadosAutorizados.forEach(d => {
      combustivelMap[d.tipo] = (combustivelMap[d.tipo] || 0) + d.valor;
    });
    
    if (chartCombustivel) chartCombustivel.destroy();
    chartCombustivel = new Chart(document.getElementById('chartCombustivel'), {
      type: 'pie',
      data: {
        labels: Object.keys(combustivelMap),
        datasets: [{
          data: Object.values(combustivelMap),
          backgroundColor: ['#ef4444', '#22c55e', '#f59e0b']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: function(context) {
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentual = (context.parsed / total * 100).toFixed(1);
                return context.label + ': R$ ' + context.parsed.toFixed(2) + ' (' + percentual + '%)';
              }
            }
          }
        }
      }
    });
  }
  
  function atualizarGraficoTendencia() {
    const hoje = new Date();
    const meses = [];
    const valores = [];
    
    for (let i = 5; i >= 0; i--) {
      let mes = hoje.getMonth() - i;
      let ano = hoje.getFullYear();
      
      while (mes < 0) {
        mes += 12;
        ano -= 1;
      }
      
      const dadosMes = cache.filter(x => {
        if (x.status !== STATUS.AUTORIZADO) return false;
        const dataAbast = new Date(x.data);
        return dataAbast.getMonth() === mes && dataAbast.getFullYear() === ano;
      });
      
      const totalMes = dadosMes.reduce((acc, item) => acc + item.valor, 0);
      
      const nomeMes = new Date(ano, mes, 1).toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
      meses.push(nomeMes.toUpperCase());
      valores.push(totalMes);
    }
    
    if (chartTendencia) chartTendencia.destroy();
    chartTendencia = new Chart(document.getElementById('chartTendencia'), {
      type: 'line',
      data: {
        labels: meses,
        datasets: [{
          label: 'GASTO MENSAL (R$)',
          data: valores,
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          tension: 0.4,
          fill: true,
          pointRadius: 5,
          pointHoverRadius: 7
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'top' },
          tooltip: {
            callbacks: {
              label: function(context) {
                return 'R$ ' + context.parsed.y.toFixed(2);
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return 'R$ ' + value.toFixed(0);
              }
            }
          }
        }
      }
    });
  }
  
  function exportarExcel() {
    if (!temPermissao('exportar_excel')) {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA EXPORTAR!", "error");
      return;
    }
    
    const dataInicial = document.getElementById('rel-data-inicial').value;
    const dataFinal = document.getElementById('rel-data-final').value;
    const secretaria = document.getElementById('rel-secretaria').value;
    const posto = document.getElementById('rel-posto').value;
    const combustivel = document.getElementById('rel-combustivel').value;
    const placa = document.getElementById('rel-placa').value.toUpperCase().trim();
    
    let registros = cache.filter(x => x.status === STATUS.AUTORIZADO);
    
    if (dataInicial) registros = registros.filter(r => r.data >= dataInicial);
    if (dataFinal) registros = registros.filter(r => r.data <= dataFinal);
    if (secretaria) registros = registros.filter(r => r.secretaria === secretaria);
    if (posto) registros = registros.filter(r => r.posto === posto);
    if (combustivel) registros = registros.filter(r => r.tipo === combustivel);
    if (placa) registros = registros.filter(r => r.placa.includes(placa));
    
    if (registros.length === 0) {
      mostrarNotificacao("‚ùå NENHUM REGISTRO PARA EXPORTAR!", "error");
      return;
    }
    
    // Preparar dados para Excel
    const dadosExcel = registros.map(r => {
      const media = calcularMedia(r);
      const limiteAlerta = LIMITES_ALERTA[r.tipo];
      const alerta = (media > 0 && media < limiteAlerta) ? 'SIM' : 'N√ÉO';
      
      return {
        'DATA': r.data.split('-').reverse().join('/'),
        'PLACA': r.placa,
        'POSTO': r.posto || '---',
        'SECRETARIA': r.secretaria,
        'MOTORISTA': r.motorista,
        'COMBUST√çVEL': r.tipo,
        'KM': r.km,
        'LITROS': r.litro.toFixed(2),
        'M√âDIA (KM/L)': media > 0 ? media.toFixed(2) : '---',
        'LIMITE ALERTA': limiteAlerta,
        'ALERTA BAIXA M√âDIA': alerta,
        'VALOR (R$)': r.valor.toFixed(2),
        'STATUS': r.status,
        'TANQUE CHEIO': r.tanqueCheio ? 'Sim' : 'N√£o'
      };
    });
    
    // Criar planilha
    const ws = XLSX.utils.json_to_sheet(dadosExcel);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Relat√≥rio");
    
    // Gerar arquivo
    const nomeArquivo = `Relatorio_Combustivel_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, nomeArquivo);
    
    mostrarNotificacao("‚úÖ RELAT√ìRIO EXPORTADO COM SUCESSO!", "success");
    
    // Log de auditoria
    registrarAuditoria('EXPORTACAO_EXCEL', {
      registros: registros.length,
      filtros: { dataInicial, dataFinal, secretaria, posto, combustivel, placa }
    });
  }
  
  function toggleCombustivelPostoEdit(tipo) {
    const checkbox = document.getElementById(`edit-posto-tem-${tipo}`);
    let inputId;
    
    switch(tipo) {
      case 'gasolina':
        inputId = 'edit-posto-gas';
        break;
      case 'alcool':
        inputId = 'edit-posto-alc';
        break;
      case 'diesel':
        inputId = 'edit-posto-die';
        break;
      case 'diesels10':
        inputId = 'edit-posto-diesels10';
        break;
      case 'gas':
        inputId = 'edit-posto-gas-gnv';
        break;
    }
    
    const input = document.getElementById(inputId);
    if (checkbox.checked) {
      input.disabled = false;
      input.focus();
    } else {
      input.disabled = true;
      input.value = '';
    }
  }
  
  function editarPosto(postoId) {
    if (!temPermissao('gerenciar_postos')) {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA EDITAR POSTOS!", "error");
      return;
    }
    
    db.ref('postos/' + postoId).once('value', snap => {
      if (!snap.exists()) {
        mostrarNotificacao("‚ùå POSTO N√ÉO ENCONTRADO!", "error");
        return;
      }
      
      const posto = snap.val();
      
      // Armazenar ID do posto
      document.getElementById('edit-posto-id').value = postoId;
      
      // Preencher nome
      document.getElementById('edit-posto-nome').value = posto.nome;
      
      // Limpar todos os checkboxes e campos
      document.getElementById('edit-posto-tem-gasolina').checked = false;
      document.getElementById('edit-posto-tem-alcool').checked = false;
      document.getElementById('edit-posto-tem-diesel').checked = false;
      document.getElementById('edit-posto-tem-diesels10').checked = false;
      document.getElementById('edit-posto-tem-gas').checked = false;
      
      document.getElementById('edit-posto-gas').value = '';
      document.getElementById('edit-posto-gas').disabled = true;
      document.getElementById('edit-posto-alc').value = '';
      document.getElementById('edit-posto-alc').disabled = true;
      document.getElementById('edit-posto-die').value = '';
      document.getElementById('edit-posto-die').disabled = true;
      document.getElementById('edit-posto-diesels10').value = '';
      document.getElementById('edit-posto-diesels10').disabled = true;
      document.getElementById('edit-posto-gas-gnv').value = '';
      document.getElementById('edit-posto-gas-gnv').disabled = true;
      
      // Marcar checkboxes e preencher pre√ßos dos combust√≠veis existentes
      if (posto.precos) {
        Object.keys(posto.precos).forEach(combustivel => {
          const preco = posto.precos[combustivel];
          
          switch(combustivel) {
            case 'GASOLINA':
              document.getElementById('edit-posto-tem-gasolina').checked = true;
              document.getElementById('edit-posto-gas').disabled = false;
              document.getElementById('edit-posto-gas').value = preco;
              break;
            case 'ALCOOL':
              document.getElementById('edit-posto-tem-alcool').checked = true;
              document.getElementById('edit-posto-alc').disabled = false;
              document.getElementById('edit-posto-alc').value = preco;
              break;
            case 'DIESEL':
              document.getElementById('edit-posto-tem-diesel').checked = true;
              document.getElementById('edit-posto-die').disabled = false;
              document.getElementById('edit-posto-die').value = preco;
              break;
            case 'DIESEL S10':
              document.getElementById('edit-posto-tem-diesels10').checked = true;
              document.getElementById('edit-posto-diesels10').disabled = false;
              document.getElementById('edit-posto-diesels10').value = preco;
              break;
            case 'GAS':
              document.getElementById('edit-posto-tem-gas').checked = true;
              document.getElementById('edit-posto-gas-gnv').disabled = false;
              document.getElementById('edit-posto-gas-gnv').value = preco;
              break;
          }
        });
      }
      
      // Abrir modal
      document.getElementById('modal-edit-posto').style.display = 'flex';
    });
  }
  
  function fecharModalEditPosto() {
    document.getElementById('modal-edit-posto').style.display = 'none';
  }
  
  function salvarEdicaoPosto() {
    if (!temPermissao('gerenciar_postos')) {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA EDITAR POSTOS!", "error");
      return;
    }
    
    const postoId = document.getElementById('edit-posto-id').value;
    const nome = document.getElementById('edit-posto-nome').value.toUpperCase().trim();
    
    if (!nome) {
      mostrarNotificacao("‚ùå PREENCHA O NOME DO POSTO!", "error");
      return;
    }
    
    // Verificar quais combust√≠veis foram selecionados
    const combustiveis = {};
    let algumSelecionado = false;
    
    if (document.getElementById('edit-posto-tem-gasolina').checked) {
      const preco = parseFloat(document.getElementById('edit-posto-gas').value);
      if (!preco || preco <= 0) {
        mostrarNotificacao("‚ùå PREENCHA O PRE√áO DA GASOLINA!", "error");
        return;
      }
      combustiveis['GASOLINA'] = preco;
      algumSelecionado = true;
    }
    
    if (document.getElementById('edit-posto-tem-alcool').checked) {
      const preco = parseFloat(document.getElementById('edit-posto-alc').value);
      if (!preco || preco <= 0) {
        mostrarNotificacao("‚ùå PREENCHA O PRE√áO DO √ÅLCOOL!", "error");
        return;
      }
      combustiveis['ALCOOL'] = preco;
      algumSelecionado = true;
    }
    
    if (document.getElementById('edit-posto-tem-diesel').checked) {
      const preco = parseFloat(document.getElementById('edit-posto-die').value);
      if (!preco || preco <= 0) {
        mostrarNotificacao("‚ùå PREENCHA O PRE√áO DO DIESEL!", "error");
        return;
      }
      combustiveis['DIESEL'] = preco;
      algumSelecionado = true;
    }
    
    if (document.getElementById('edit-posto-tem-diesels10').checked) {
      const preco = parseFloat(document.getElementById('edit-posto-diesels10').value);
      if (!preco || preco <= 0) {
        mostrarNotificacao("‚ùå PREENCHA O PRE√áO DO DIESEL S10!", "error");
        return;
      }
      combustiveis['DIESEL S10'] = preco;
      algumSelecionado = true;
    }
    
    if (document.getElementById('edit-posto-tem-gas').checked) {
      const preco = parseFloat(document.getElementById('edit-posto-gas-gnv').value);
      if (!preco || preco <= 0) {
        mostrarNotificacao("‚ùå PREENCHA O PRE√áO DO G√ÅS!", "error");
        return;
      }
      combustiveis['GAS'] = preco;
      algumSelecionado = true;
    }
    
    if (!algumSelecionado) {
      mostrarNotificacao("‚ùå SELECIONE PELO MENOS UM TIPO DE COMBUST√çVEL!", "error");
      return;
    }
    
    // Atualizar posto no Firebase
    db.ref('postos/' + postoId).update({
      nome: nome,
      precos: combustiveis,
      atualizadoEm: Date.now()
    }).then(() => {
      registrarAuditoria('POSTO_EDITADO', { 
        postoId: postoId,
        nome: nome, 
        combustiveis: Object.keys(combustiveis) 
      });
      mostrarNotificacao("‚úÖ POSTO ATUALIZADO COM SUCESSO!", "success");
      fecharModalEditPosto();
      listPostos();
      
      // Atualizar tamb√©m o select de postos no formul√°rio de abastecimento
      carregarPostos();
    }).catch(error => {
      mostrarNotificacao("‚ùå ERRO AO ATUALIZAR: " + error.message, "error");
    });
  }
  
  function toggleCombustivelPosto(tipo) {
    const checkbox = document.getElementById(`posto-tem-${tipo}`);
    let inputId;
    
    switch(tipo) {
      case 'gasolina':
        inputId = 'posto-gas';
        break;
      case 'alcool':
        inputId = 'posto-alc';
        break;
      case 'diesel':
        inputId = 'posto-die';
        break;
      case 'diesels10':
        inputId = 'posto-diesels10';
        break;
      case 'gas':
        inputId = 'posto-gas-gnv';
        break;
    }
    
    const input = document.getElementById(inputId);
    if (checkbox.checked) {
      input.disabled = false;
      input.focus();
    } else {
      input.disabled = true;
      input.value = '';
    }
  }
  
  function toggleUserFields() {
    const role = document.getElementById('new-role').value;
    const isFrentista = (role === 'frentista');
    const isSecretario = (role === 'secretarios');
    const isAutorizador = (role === 'autorizador');
    
    document.getElementById('field-limit').style.display = isSecretario ? 'block' : 'none';
    document.getElementById('field-sec').style.display = isSecretario ? 'block' : 'none';
    document.getElementById('field-posto-autorizador').style.display = isAutorizador ? 'block' : 'none';
    document.getElementById('field-combustiveis-autorizador').style.display = isAutorizador ? 'block' : 'none';
    
    // Frentista n√£o precisa de combust√≠vel permitido
    const combField = document.getElementById('new-combustivel').closest('div');
    if (combField) {
      combField.style.display = (isFrentista || isAutorizador) ? 'none' : 'block';
    }
    
    // Carregar postos quando selecionar autorizador
    if (isAutorizador) {
      carregarPostosParaAutorizador();
    } else {
      // Limpar campos de autorizador quando mudar para outro perfil
      const postoSelect = document.getElementById('new-posto-vinc');
      if (postoSelect) postoSelect.value = '';
      const containerComb = document.getElementById('lista-combustiveis-autorizador');
      if (containerComb) containerComb.innerHTML = '<p style="color: #64748b; font-size: 11px; margin: 0;">Selecione um posto primeiro</p>';
    }
  }
  
  function carregarCombustiveisPostoAutorizador() {
    console.log("=== carregarCombustiveisPostoAutorizador chamada ===");
    const postoId = document.getElementById('new-posto-vinc').value;
    const container = document.getElementById('lista-combustiveis-autorizador');
    
    console.log("Posto ID selecionado:", postoId);
    console.log("Container encontrado:", !!container);
    
    // Limpar container primeiro
    container.innerHTML = '';
    
    if (!postoId) {
      console.log("Nenhum posto selecionado");
      container.innerHTML = '<p style="color: #64748b; font-size: 11px; margin: 0;">‚¨ÜÔ∏è Selecione um posto acima para ver os combust√≠veis dispon√≠veis</p>';
      return;
    }
    
    // Mostrar loading
    container.innerHTML = '<p style="color: #64748b; font-size: 11px; margin: 0;">‚è≥ Carregando combust√≠veis do posto...</p>';
    
    console.log("Buscando posto no Firebase:", 'postos/' + postoId);
    
    // Buscar combust√≠veis do posto
    db.ref('postos/' + postoId).once('value', snap => {
      console.log("Resposta do Firebase recebida");
      console.log("Posto existe?", snap.exists());
      
      // Limpar novamente antes de popular
      container.innerHTML = '';
      
      if (!snap.exists()) {
        console.log("‚ùå Posto n√£o encontrado");
        container.innerHTML = '<p style="color: #ef4444; font-size: 11px; margin: 0;">‚ùå Posto n√£o encontrado</p>';
        return;
      }
      
      const posto = snap.val();
      console.log("Dados do posto:", posto);
      console.log("posto.precos:", posto.precos);
      
      const combustiveis = Object.keys(posto.precos);
      console.log("Combust√≠veis extra√≠dos:", combustiveis);
      console.log("Quantidade de combust√≠veis:", combustiveis.length);
      
      if (combustiveis.length === 0) {
        console.log("‚ùå Posto sem combust√≠veis");
        container.innerHTML = '<p style="color: #ef4444; font-size: 11px; margin: 0;">‚ùå Este posto n√£o tem combust√≠veis cadastrados</p>';
        return;
      }
      
      // Gerar checkboxes APENAS para os combust√≠veis dispon√≠veis no posto
      let html = '<p style="color: #22c55e; font-size: 11px; margin: 0 0 10px 0;">‚úÖ Combust√≠veis dispon√≠veis neste posto:</p>';
      combustiveis.forEach(comb => {
        console.log("Adicionando checkbox para:", comb);
        html += `
          <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; cursor: pointer;">
            <input type="checkbox" class="comb-autorizador-novo" value="${comb}"> 
            <strong>${comb}</strong>
          </label>
        `;
      });
      
      console.log("HTML gerado (length):", html.length);
      console.log("Inserindo no container...");
      container.innerHTML = html;
      console.log("‚úÖ Container atualizado");
      console.log("Total de checkboxes criados:", document.querySelectorAll('.comb-autorizador-novo').length);
    }).catch(error => {
      console.error("‚ùå Erro ao buscar posto:", error);
      container.innerHTML = '<p style="color: #ef4444; font-size: 11px; margin: 0;">‚ùå Erro ao carregar combust√≠veis</p>';
    });
  }
  
  function carregarPostosParaAutorizador() {
    const select = document.getElementById('new-posto-vinc');
    select.innerHTML = '<option value="">SELECIONE...</option>';
    
    db.ref('postos').once('value', snap => {
      if (snap.exists()) {
        snap.forEach(c => {
          const p = c.val();
          select.innerHTML += `<option value="${c.key}">${p.nome}</option>`;
        });
      } else {
        select.innerHTML = '<option value="">NENHUM POSTO CADASTRADO</option>';
      }
    });
  }
  
  function carregarCombustiveisPostoAutorizadorEdit() {
    console.log("=== carregarCombustiveisPostoAutorizadorEdit chamada ===");
    const postoId = document.getElementById('edit-posto-vinc').value;
    const container = document.getElementById('lista-combustiveis-autorizador-edit');
    
    console.log("Posto ID (edit):", postoId);
    
    // Limpar container primeiro
    container.innerHTML = '';
    
    if (!postoId) {
      console.log("Nenhum posto selecionado (edit)");
      container.innerHTML = '<p style="color: #64748b; font-size: 11px; margin: 0;">‚¨ÜÔ∏è Selecione um posto acima para ver os combust√≠veis dispon√≠veis</p>';
      return;
    }
    
    // Mostrar loading
    container.innerHTML = '<p style="color: #64748b; font-size: 11px; margin: 0;">‚è≥ Carregando combust√≠veis do posto...</p>';
    
    console.log("Buscando posto (edit):", 'postos/' + postoId);
    
    // Buscar combust√≠veis do posto
    db.ref('postos/' + postoId).once('value', snap => {
      console.log("Resposta Firebase (edit) recebida");
      
      // Limpar novamente antes de popular
      container.innerHTML = '';
      
      if (!snap.exists()) {
        console.log("‚ùå Posto n√£o encontrado (edit)");
        container.innerHTML = '<p style="color: #ef4444; font-size: 11px; margin: 0;">‚ùå Posto n√£o encontrado</p>';
        return;
      }
      
      const posto = snap.val();
      console.log("Dados do posto (edit):", posto);
      const combustiveis = Object.keys(posto.precos);
      console.log("Combust√≠veis (edit):", combustiveis);
      
      if (combustiveis.length === 0) {
        console.log("‚ùå Posto sem combust√≠veis (edit)");
        container.innerHTML = '<p style="color: #ef4444; font-size: 11px; margin: 0;">‚ùå Este posto n√£o tem combust√≠veis cadastrados</p>';
        return;
      }
      
      // Gerar checkboxes APENAS para os combust√≠veis dispon√≠veis no posto
      let html = '<p style="color: #22c55e; font-size: 11px; margin: 0 0 10px 0;">‚úÖ Combust√≠veis dispon√≠veis neste posto:</p>';
      combustiveis.forEach(comb => {
        console.log("Adicionando checkbox (edit) para:", comb);
        html += `
          <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; cursor: pointer;">
            <input type="checkbox" class="comb-autorizador-edit" value="${comb}"> 
            <strong>${comb}</strong>
          </label>
        `;
      });
      
      console.log("‚úÖ Container (edit) atualizado");
      container.innerHTML = html;
    }).catch(error => {
      console.error("‚ùå Erro ao buscar posto (edit):", error);
      container.innerHTML = '<p style="color: #ef4444; font-size: 11px; margin: 0;">‚ùå Erro ao carregar combust√≠veis</p>';
    });
  }
  
  function toggleEditFields() {
    const role = document.getElementById('edit-role').value;
    const isFrentista = (role === 'frentista');
    const isSecretario = (role === 'secretarios');
    const isAutorizador = (role === 'autorizador');
    
    document.getElementById('edit-field-limit').style.display = isSecretario ? 'block' : 'none';
    document.getElementById('edit-field-sec').style.display = isSecretario ? 'block' : 'none';
    document.getElementById('edit-field-posto-autorizador').style.display = isAutorizador ? 'block' : 'none';
    document.getElementById('edit-field-combustiveis-autorizador').style.display = isAutorizador ? 'block' : 'none';
    
    // Frentista e autorizador n√£o precisam de combust√≠vel permitido
    const combField = document.getElementById('edit-combustivel').closest('div');
    if (combField) {
      combField.style.display = (isFrentista || isAutorizador) ? 'none' : 'block';
    }
    
    // Carregar postos quando selecionar autorizador
    if (isAutorizador) {
      const select = document.getElementById('edit-posto-vinc');
      select.innerHTML = '<option value="">CARREGANDO...</option>';
      
      db.ref('postos').once('value', snap => {
        select.innerHTML = '<option value="">SELECIONE...</option>';
        if (snap.exists()) {
          snap.forEach(c => {
            const p = c.val();
            select.innerHTML += `<option value="${c.key}">${p.nome}</option>`;
          });
        } else {
          select.innerHTML = '<option value="">NENHUM POSTO CADASTRADO</option>';
        }
      });
    } else {
      // Limpar campos de autorizador quando mudar para outro perfil
      const postoSelect = document.getElementById('edit-posto-vinc');
      if (postoSelect) postoSelect.value = '';
      const containerComb = document.getElementById('lista-combustiveis-autorizador-edit');
      if (containerComb) containerComb.innerHTML = '<p style="color: #64748b; font-size: 11px; margin: 0;">Selecione um posto primeiro</p>';
    }
  }
  
  function addUsuario() {
    if (!temPermissao('gerenciar_usuarios') && loginUser !== 'master') {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA CRIAR USU√ÅRIOS!", "error");
      return;
    }
    
    const usuario = document.getElementById('new-user').value.toLowerCase().trim();
    const senha = document.getElementById('new-pass').value.trim();
    const role = document.getElementById('new-role').value;
    const combustivel = document.getElementById('new-combustivel').value;
    const limite = parseFloat(document.getElementById('new-limit').value) || 0;
    const secretaria = document.getElementById('new-sec-vinc').value;
    
    if (!usuario || !senha) {
      mostrarNotificacao("‚ùå PREENCHA USU√ÅRIO E SENHA!", "error");
      return;
    }
    
    if (usuario.length < 3) {
      mostrarNotificacao("‚ùå USU√ÅRIO DEVE TER NO M√çNIMO 3 CARACTERES!", "error");
      return;
    }
    
    if (senha.length < 4) {
      mostrarNotificacao("‚ùå SENHA DEVE TER NO M√çNIMO 4 CARACTERES!", "error");
      return;
    }
    
    if (role === 'secretarios' && (!limite || !secretaria)) {
      mostrarNotificacao("‚ùå PREENCHA LIMITE E SECRETARIA PARA SECRET√ÅRIOS!", "error");
      return;
    }
    
    const dadosUsuario = {
      senha: senha,
      role: role,
      combustivelLiberado: combustivel,
      limite: limite,
      secretariaVinculada: secretaria,
      permissoes: PERMISSOES_PADRAO[role] || []
    };
    
    // Se for autorizador, incluir posto e combust√≠veis autorizados
    if (role === 'autorizador') {
      const postoVinculado = document.getElementById('new-posto-vinc').value;
      if (!postoVinculado) {
        mostrarNotificacao("‚ùå SELECIONE UM POSTO PARA O AUTORIZADOR!", "error");
        return;
      }
      
      // Pegar combust√≠veis selecionados
      const combustiveisAutorizados = [];
      document.querySelectorAll('.comb-autorizador-novo:checked').forEach(cb => {
        combustiveisAutorizados.push(cb.value);
      });
      
      if (combustiveisAutorizados.length === 0) {
        mostrarNotificacao("‚ùå SELECIONE PELO MENOS UM COMBUST√çVEL QUE O AUTORIZADOR PODE LIBERAR!", "error");
        return;
      }
      
      dadosUsuario.postoVinculado = postoVinculado;
      dadosUsuario.combustiveisAutorizados = combustiveisAutorizados;
    }
    
    db.ref('usuarios/' + usuario).set(dadosUsuario).then(() => {
      registrarAuditoria('USUARIO_CRIADO', { usuario: usuario, role: role });
      mostrarNotificacao("‚úÖ USU√ÅRIO SALVO COM SUCESSO!", "success");
      document.getElementById('new-user').value = '';
      document.getElementById('new-pass').value = '';
      document.getElementById('new-limit').value = '';
      document.getElementById('new-sec-vinc').value = '';
      document.getElementById('new-posto-vinc').value = '';
      document.querySelectorAll('.comb-autorizador-novo').forEach(cb => cb.checked = false);
      listUsuarios();
    });
  }
  
  function listUsuarios() {
    db.ref('usuarios').once('value', snap => {
      const tbody = document.getElementById('user-body');
      tbody.innerHTML = "";
      
      // Carregar nomes dos postos primeiro
      db.ref('postos').once('value', postosSnap => {
        const postosMap = {};
        postosSnap.forEach(p => {
          postosMap[p.key] = p.val().nome;
        });
        
        snap.forEach(c => {
          const u = c.val();
          
          let badgeClass = 'badge-success';
          let perfilTexto = 'ADMIN';
          
          if (u.role === 'secretarios') {
            badgeClass = 'badge-warning';
            perfilTexto = 'SECRET√ÅRIO';
          } else if (u.role === 'frentista') {
            badgeClass = 'badge-danger';
            perfilTexto = 'FRENTISTA';
          } else if (u.role === 'autorizador') {
            badgeClass = 'badge badge-primary';
            perfilTexto = 'AUTORIZADOR';
          }
          
          // Preparar info de combust√≠veis para autorizador
          let combustiveisInfo = u.combustivelLiberado || 'TODOS';
          if (u.role === 'autorizador' && u.combustiveisAutorizados) {
            combustiveisInfo = u.combustiveisAutorizados.join(', ');
          }
          
          // Preparar info de posto
          let postoInfo = '---';
          if (u.role === 'autorizador' && u.postoVinculado) {
            postoInfo = postosMap[u.postoVinculado] || 'Posto n√£o encontrado';
          }
          
          tbody.innerHTML += `
            <tr>
              <td><b>${c.key.toUpperCase()}</b></td>
              <td><span class="badge ${badgeClass}">${perfilTexto}</span></td>
              <td style="font-size:11px;">${combustiveisInfo}</td>
              <td>${u.secretariaVinculada || 'TODAS'}</td>
              <td><b>R$ ${(u.limite || 0).toFixed(2)}</b></td>
              <td style="font-size:11px;">${postoInfo}</td>
              <td class="no-print">
                ${temPermissao('gerenciar_usuarios') || loginUser === 'master' ? `
                  <button class="btn-action" style="background:#8b5cf6;color:white;" onclick="abrirPermissoes('${c.key}')">
                    üîê PERMISS√ïES
                  </button>
                  <button class="btn-action" style="background:var(--accent);color:white;" onclick="editarUsuario('${c.key}')">
                    ‚úèÔ∏è EDITAR
                  </button>
                  <button class="btn-action btn-deletar" onclick="if(confirm('‚ö†Ô∏è EXCLUIR USU√ÅRIO ${c.key.toUpperCase()}?\\n\\n‚õî ESTA A√á√ÉO N√ÉO PODE SER DESFEITA!')) { db.ref('usuarios/${c.key}').remove().then(() => { registrarAuditoria('USUARIO_DELETADO', {usuario: '${c.key}'}); mostrarNotificacao('‚úÖ USU√ÅRIO EXCLU√çDO!', 'success'); listUsuarios(); }); }">
                    üóëÔ∏è EXCLUIR
                  </button>
                ` : ''}
              </td>
            </tr>
          `;
        });
      });
    });
  }
  
  function editarUsuario(id) {
    if (!temPermissao('gerenciar_usuarios') && loginUser !== 'master') {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA EDITAR USU√ÅRIOS!", "error");
      return;
    }
    
    db.ref('usuarios/' + id).once('value', snap => {
      const u = snap.val();
      document.getElementById('edit-user').value = id.toUpperCase();
      document.getElementById('edit-pass').value = u.senha;
      document.getElementById('edit-combustivel').value = u.combustivelLiberado || 'todos';
      document.getElementById('edit-role').value = u.role;
      document.getElementById('edit-limit').value = u.limite || "";
      document.getElementById('edit-sec-vinc').value = u.secretariaVinculada || "";
      
      // Carregar dados de autorizador se aplic√°vel
      if (u.role === 'autorizador') {
        document.getElementById('edit-posto-vinc').value = u.postoVinculado || "";
        
        // Carregar combust√≠veis do posto e marcar os selecionados
        if (u.postoVinculado) {
          db.ref('postos/' + u.postoVinculado).once('value', postoSnap => {
            if (postoSnap.exists()) {
              const posto = postoSnap.val();
              const combustiveis = Object.keys(posto.precos);
              const container = document.getElementById('lista-combustiveis-autorizador-edit');
              
              let html = '';
              combustiveis.forEach(comb => {
                const checked = u.combustiveisAutorizados && u.combustiveisAutorizados.includes(comb) ? 'checked' : '';
                html += `
                  <label style="display: flex; align-items: center; gap: 8px; font-size: 12px;">
                    <input type="checkbox" class="comb-autorizador-edit" value="${comb}" ${checked}> ${comb}
                  </label>
                `;
              });
              
              container.innerHTML = html;
            }
          });
        }
      }
      
      toggleEditFields();
      document.getElementById('modal-edit').style.display = 'flex';
    });
  }
  
  function fecharModal() {
    document.getElementById('modal-edit').style.display = 'none';
  }
  
  function salvarEdicao() {
    if (!temPermissao('gerenciar_usuarios') && loginUser !== 'master') {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA EDITAR USU√ÅRIOS!", "error");
      return;
    }
    
    const id = document.getElementById('edit-user').value.toLowerCase();
    const novaPass = document.getElementById('edit-pass').value;
    const combus = document.getElementById('edit-combustivel').value;
    const role = document.getElementById('edit-role').value;
    const limite = parseFloat(document.getElementById('edit-limit').value) || 0;
    const secretaria = document.getElementById('edit-sec-vinc').value;
    
    if (novaPass.length < 4) {
      mostrarNotificacao("‚ùå SENHA DEVE TER NO M√çNIMO 4 CARACTERES!", "error");
      return;
    }
    
    const dadosAtualizados = { senha: novaPass, combustivelLiberado: combus, role: role };
    
    if (role === 'secretarios') {
      if (!limite || !secretaria) {
        mostrarNotificacao("‚ùå PREENCHA LIMITE E SECRETARIA PARA SECRET√ÅRIOS!", "error");
        return;
      }
      dadosAtualizados.limite = limite;
      dadosAtualizados.secretariaVinculada = secretaria;
      // Limpar dados de autorizador se houver
      dadosAtualizados.postoVinculado = "";
      dadosAtualizados.combustiveisAutorizados = [];
    } else if (role === 'autorizador') {
      const postoVinculado = document.getElementById('edit-posto-vinc').value;
      if (!postoVinculado) {
        mostrarNotificacao("‚ùå SELECIONE UM POSTO PARA O AUTORIZADOR!", "error");
        return;
      }
      
      // Pegar combust√≠veis selecionados
      const combustiveisAutorizados = [];
      document.querySelectorAll('.comb-autorizador-edit:checked').forEach(cb => {
        combustiveisAutorizados.push(cb.value);
      });
      
      if (combustiveisAutorizados.length === 0) {
        mostrarNotificacao("‚ùå SELECIONE PELO MENOS UM COMBUST√çVEL QUE O AUTORIZADOR PODE LIBERAR!", "error");
        return;
      }
      
      dadosAtualizados.postoVinculado = postoVinculado;
      dadosAtualizados.combustiveisAutorizados = combustiveisAutorizados;
      dadosAtualizados.limite = 0;
      dadosAtualizados.secretariaVinculada = "";
    } else {
      dadosAtualizados.limite = 0;
      dadosAtualizados.secretariaVinculada = "";
      dadosAtualizados.postoVinculado = "";
      dadosAtualizados.combustiveisAutorizados = [];
    }
    
    db.ref('usuarios/' + id).update(dadosAtualizados).then(() => {
      registrarAuditoria('USUARIO_EDITADO', { usuario: id });
      mostrarNotificacao("‚úÖ USU√ÅRIO ATUALIZADO COM SUCESSO!", "success");
      fecharModal();
      listUsuarios();
    });
  }
  
  function abrirPermissoes(usuario) {
    if (!temPermissao('gerenciar_usuarios') && loginUser !== 'master') {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA EDITAR PERMISS√ïES!", "error");
      return;
    }
    
    usuarioEditandoPermissoes = usuario;
    
    // Carregar permiss√µes atuais do usu√°rio
    db.ref('usuarios/' + usuario).once('value', snap => {
      const userData = snap.val();
      const permissoesAtuais = userData.permissoes || PERMISSOES_PADRAO[userData.role] || [];
      
      const container = document.getElementById('permissoes-lista');
      container.innerHTML = '';
      
      // Agrupar permiss√µes por categoria
      const categorias = {};
      Object.keys(PERMISSOES_DISPONIVEIS).forEach(key => {
        const permissao = PERMISSOES_DISPONIVEIS[key];
        if (!categorias[permissao.categoria]) {
          categorias[permissao.categoria] = [];
        }
        categorias[permissao.categoria].push({ key, ...permissao });
      });
      
      Object.keys(categorias).forEach(categoria => {
        container.innerHTML += `
          <div style="margin-bottom:20px;">
            <h4 style="margin:0 0 10px 0; font-size:14px; color:var(--primary);">${categoria.toUpperCase()}</h4>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        `;
        
        categorias[categoria].forEach(perm => {
          const checked = permissoesAtuais.includes(perm.key) ? 'checked' : '';
          container.innerHTML += `
            <div style="display:flex; align-items:center; gap:10px; padding:10px; background:#f8fafc; border-radius:8px;">
              <input type="checkbox" id="perm_${perm.key}" ${checked}>
              <label for="perm_${perm.key}" style="text-transform:none; font-weight:normal; font-size:12px;">
                <strong>${perm.nome}</strong><br>
                <span style="color:#64748b; font-size:11px;">${perm.descricao}</span>
              </label>
            </div>
          `;
        });
        
        container.innerHTML += `</div></div>`;
      });
      
      document.getElementById('modal-permissoes').style.display = 'flex';
    });
  }
  
  function salvarPermissoes() {
    if (!usuarioEditandoPermissoes) return;
    
    const checkboxes = document.querySelectorAll('#permissoes-lista input[type="checkbox"]');
    const permissoesSelecionadas = [];
    
    checkboxes.forEach(cb => {
      if (cb.checked) {
        const id = cb.id.replace('perm_', '');
        permissoesSelecionadas.push(id);
      }
    });
    
    db.ref('usuarios/' + usuarioEditandoPermissoes).update({
      permissoes: permissoesSelecionadas
    }).then(() => {
      mostrarNotificacao("‚úÖ PERMISS√ïES ATUALIZADAS!", "success");
      fecharModalPermissoes();
      listUsuarios();
    });
  }
  
  function fecharModalPermissoes() {
    document.getElementById('modal-permissoes').style.display = 'none';
    usuarioEditandoPermissoes = null;
  }
  
  function carregarPermissoesPerfil() {
    const perfil = document.getElementById('perfil-config').value;
    
    if (perfil === 'custom') {
      document.getElementById('permissoes-lista').innerHTML = `
        <div style="padding:40px 20px; text-align:center; color:#64748b;">
          Selecione um usu√°rio espec√≠fico para editar permiss√µes personalizadas.
        </div>
      `;
      return;
    }
    
    const permissoesPadrao = PERMISSOES_PADRAO[perfil] || [];
    
    const container = document.getElementById('permissoes-lista');
    container.innerHTML = '';
    
    // Agrupar permiss√µes por categoria
    const categorias = {};
    Object.keys(PERMISSOES_DISPONIVEIS).forEach(key => {
      const permissao = PERMISSOES_DISPONIVEIS[key];
      if (!categorias[permissao.categoria]) {
        categorias[permissao.categoria] = [];
      }
      categorias[permissao.categoria].push({ key, ...permissao });
    });
    
    Object.keys(categorias).forEach(categoria => {
      container.innerHTML += `
        <div style="margin-bottom:20px;">
          <h4 style="margin:0 0 10px 0; font-size:14px; color:var(--primary);">${categoria.toUpperCase()}</h4>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
      `;
      
      categorias[categoria].forEach(perm => {
        const checked = permissoesPadrao.includes(perm.key) ? 'checked' : '';
        container.innerHTML += `
          <div style="display:flex; align-items:center; gap:10px; padding:10px; background:#f8fafc; border-radius:8px;">
            <input type="checkbox" id="perm_${perm.key}" ${checked} disabled>
            <label for="perm_${perm.key}" style="text-transform:none; font-weight:normal; font-size:12px;">
              <strong>${perm.nome}</strong><br>
              <span style="color:#64748b; font-size:11px;">${perm.descricao}</span>
            </label>
          </div>
        `;
      });
      
      container.innerHTML += `</div></div>`;
    });
  }
  
  function abrirAlterarSenha() {
    const nova = prompt("üîê Digite sua nova senha:");
    if (!nova) return;
    if (nova.length < 4) {
      mostrarNotificacao("‚ùå SENHA DEVE TER NO M√çNIMO 4 CARACTERES!", "error");
      return;
    }
    
    if (loginUser === 'master') {
      db.ref('config/masterPassword').set(nova).then(() => {
        mostrarNotificacao("‚úÖ SENHA DO MASTER ALTERADA COM SUCESSO!", "success");
      });
    } else {
      db.ref('usuarios/' + loginUser).update({ senha: nova }).then(() => {
        registrarAuditoria('SENHA_ALTERADA', {});
        mostrarNotificacao("‚úÖ SENHA ALTERADA COM SUCESSO!", "success");
      }).catch(err => {
        mostrarNotificacao("‚ùå ERRO: " + err.message, "error");
      });
    }
  }
  
  function limparFormulario() {
    ['f-placa', 'f-mot', 'f-km', 'f-lit', 'f-val'].forEach(id => {
      document.getElementById(id).value = "";
    });
    document.getElementById('f-posto').value = "";
    document.getElementById('f-data').valueAsDate = new Date();
    document.getElementById('f-tanque-cheio').checked = false;
    document.getElementById('tanque-cheio-info').style.display = 'none';
    document.getElementById('previsao-consumo').style.display = 'none';
    document.getElementById('f-lit').disabled = false;
    
    // Remover alertas de limite
    const alerta = document.getElementById('alerta-limite');
    if (alerta) alerta.remove();
    const info = document.getElementById('info-limite');
    if (info) info.remove();
    
    // Resetar bot√£o de registrar
    const btnRegistrar = document.getElementById('btn-registrar');
    btnRegistrar.disabled = false;
    btnRegistrar.style.background = '';
    btnRegistrar.innerHTML = '‚úîÔ∏è REGISTRAR ABASTECIMENTO';
  }
  
  function limparFiltros() {
    document.getElementById('rel-data-inicial').value = '';
    document.getElementById('rel-data-final').value = '';
    document.getElementById('rel-secretaria').value = '';
    document.getElementById('rel-posto').value = '';
    document.getElementById('rel-combustivel').value = '';
    document.getElementById('rel-placa').value = '';
    atualizarRelatorio();
    mostrarNotificacao("üîÑ FILTROS LIMPOS!", "info");
  }
  
  function sugerir(valor) {
    const placa = valor.toUpperCase().trim();
    
    const veiculo = veiculos.find(v => v.placa === placa);
    if (veiculo) {
      document.getElementById('f-mot').value = veiculo.motorista || '';
      if (veiculo.secretaria && veiculo.secretaria !== '') {
        document.getElementById('f-sec').value = veiculo.secretaria;
      }
      document.getElementById('f-tipo').value = veiculo.combustivel === 'FLEX' ? 'GASOLINA' : veiculo.combustivel;
      calc();
      return;
    }
    
    const ultimoAbast = cache.filter(x => x.placa === placa && x.status === STATUS.AUTORIZADO)
      .sort((a, b) => b.timestamp - a.timestamp)[0];
    if (ultimoAbast) {
      document.getElementById('f-mot').value = ultimoAbast.motorista;
      document.getElementById('f-sec').value = ultimoAbast.secretaria;
      document.getElementById('f-tipo').value = ultimoAbast.tipo;
      calc();
    }
  }
  
  function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('tab-geral').style.display = 'none';
    document.getElementById('tab-pendentes').style.display = 'none';
    document.getElementById('tab-vip').style.display = 'none';
    document.getElementById('tab-executivo').style.display = 'none';
    document.getElementById('tab-analytics').style.display = 'none';
    document.getElementById('tab-users').style.display = 'none';
    
    if (tab === 'geral') {
      document.getElementById('tab-geral').style.display = 'block';
      document.getElementById('btn-tab-geral').classList.add('active');
    } else if (tab === 'pendentes') {
      document.getElementById('tab-pendentes').style.display = 'block';
      document.getElementById('btn-tab-pendentes').classList.add('active');
      atualizarPendentes();
    } else if (tab === 'vip') {
      document.getElementById('tab-vip').style.display = 'block';
      document.getElementById('btn-tab-vip').classList.add('active');
      inicializarTabVIP();
    } else if (tab === 'executivo') {
      document.getElementById('tab-executivo').style.display = 'block';
      document.getElementById('btn-tab-executivo').classList.add('active');
      atualizarDashboardExecutivo();
    } else if (tab === 'analytics') {
      document.getElementById('tab-analytics').style.display = 'block';
      document.getElementById('btn-tab-analytics').classList.add('active');
      atualizarAnalytics();
    } else if (tab === 'usuarios') {
      document.getElementById('tab-users').style.display = 'block';
      document.getElementById('btn-tab-users').classList.add('active');
      mostrarGestaoVIPs();
      listUsuarios();
      listVeiculos();
      listPostos();
    }
  }
  
  function gerarRelatorio() {
    const dataInicial = document.getElementById('rel-data-inicial').value;
    const dataFinal = document.getElementById('rel-data-final').value;
    const secretaria = document.getElementById('rel-secretaria').value;
    const posto = document.getElementById('rel-posto').value;
    const combustivel = document.getElementById('rel-combustivel').value;
    const placa = document.getElementById('rel-placa').value.toUpperCase().trim();
    
    let registros = cache.filter(x => x.status === STATUS.AUTORIZADO);
    
    if (dataInicial) {
      registros = registros.filter(r => r.data >= dataInicial);
    }
    if (dataFinal) {
      registros = registros.filter(r => r.data <= dataFinal);
    }
    if (secretaria) {
      registros = registros.filter(r => r.secretaria === secretaria);
    }
    if (posto) {
      registros = registros.filter(r => r.posto === posto);
    }
    if (combustivel) {
      registros = registros.filter(r => r.tipo === combustivel);
    }
    if (placa) {
      registros = registros.filter(r => r.placa.includes(placa));
    }
    
    exibirRelatorioFiltrado(registros);
  }
  
  function exibirRelatorioFiltrado(registros) {
    const container = document.getElementById('relatorio-container');
    const isFrentista = (userRole === 'frentista');
    
    if (registros.length === 0) {
      container.innerHTML = `
        <div class="card" style="text-align:center; padding:60px 20px;">
          <div style="font-size:64px; margin-bottom:20px;">üì≠</div>
          <h3>NENHUM REGISTRO ENCONTRADO</h3>
          <p style="color:#64748b;">Ajuste os filtros e tente novamente</p>
        </div>
      `;
      return;
    }
    
    const totalGeral = registros.reduce((acc, r) => acc + r.valor, 0);
    const totalLitros = registros.reduce((acc, r) => acc + r.litro, 0);
    
    let html = `
      <div class="card">
        <h3>üìä RESUMO DO RELAT√ìRIO FILTRADO</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">üìã</div>
            <h4>TOTAL DE REGISTROS</h4>
            <div class="stat-value">${registros.length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚õΩ</div>
            <h4>TOTAL EM LITROS</h4>
            <div class="stat-value">${totalLitros.toFixed(2)} L</div>
          </div>
          ${!isFrentista ? `
          <div class="stat-card">
            <div class="stat-icon">üí∞</div>
            <h4>TOTAL EM VALOR</h4>
            <div class="stat-value">R$ ${totalGeral.toFixed(2)}</div>
          </div>
          ` : ''}
          <div class="stat-card">
            <div class="stat-icon">üöó</div>
            <h4>VE√çCULOS</h4>
            <div class="stat-value">${[...new Set(registros.map(r => r.placa))].length}</div>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>üìÑ DETALHAMENTO</h3>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>DATA</th>
                <th>PLACA</th>
                <th>POSTO</th>
                <th>SECRETARIA</th>
                <th>MOTORISTA</th>
                <th>COMBUST√çVEL</th>
                <th>KM</th>
                <th>LITROS</th>
                ${!isFrentista ? '<th>M√âDIA</th><th>VALOR</th>' : ''}
              </tr>
            </thead>
            <tbody>`;
    
    registros.sort((a, b) => b.timestamp - a.timestamp).forEach(r => {
      const media = calcularMedia(r);
      // NOVO: Usar limites de alerta espec√≠ficos
      const limiteAlerta = LIMITES_ALERTA[r.tipo];
      const classeAlerta = (media > 0 && media < limiteAlerta) ? 'alerta-media' : '';
      
      html += `<tr class="${classeAlerta}">
        <td>${r.data.split('-').reverse().join('/')}</td>
        <td><b>${r.placa}</b> ${r.tanqueCheio ? '<span class="tanque-cheio-badge">‚õΩ TANQUE CHEIO</span>' : ''}</td>
        <td>${r.posto || '---'}</td>
        <td>${r.secretaria}</td>
        <td>${r.motorista}</td>
        <td><span class="badge ${r.tipo === 'GASOLINA' ? 'badge-danger' : r.tipo === 'DIESEL' ? 'badge-warning' : 'badge-success'}">${r.tipo}</span></td>
        <td>${r.km.toLocaleString('pt-BR')}</td>
        <td>${r.litro.toFixed(2)} L</td>
        ${!isFrentista ? `
        <td ${classeAlerta ? 'style="font-weight:bold;"' : ''}>${media > 0 ? media.toFixed(2) + ' km/l' + (classeAlerta ? ' üö®' : '') : '---'}</td>
        <td><b>R$ ${r.valor.toFixed(2)}</b></td>
        ` : ''}
      </tr>`;
    });
    
    html += `</tbody></table></div></div>`;
    container.innerHTML = html;
  }
  
  function confirmarSair() {
    if (confirm("üö™ DESEJA REALMENTE SAIR DO SISTEMA?")) {
      registrarAuditoria('LOGOUT', {});
      location.reload();
    }
  }
  
  function mostrarNotificacao(texto, tipo) {
    const cores = {
      success: "#22c55e",
      error: "#ef4444",
      warning: "#f59e0b",
      info: "#3b82f6"
    };
    Toastify({
      text: texto,
      duration: 3000,
      gravity: "top",
      position: "right",
      backgroundColor: cores[tipo] || cores.info,
      stopOnFocus: true,
      style: {
        borderRadius: "10px",
        fontWeight: "bold",
        fontSize: "12px"
      }
    }).showToast();
  }
  
  db.ref('abastecimentos').on('value', snap => {
    cache = [];
    snap.forEach(item => {
      let v = item.val();
      v.id = item.key;
      cache.push(v);
    });
    renderizar();
  });
  
  function salvarVeiculo() {
    if (!temPermissao('gerenciar_veiculos')) {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA CADASTRAR VE√çCULOS!", "error");
      return;
    }
    
    const placa = document.getElementById('vei-placa').value.toUpperCase().trim();
    const modelo = document.getElementById('vei-modelo').value.toUpperCase().trim();
    const secretaria = document.getElementById('vei-sec').value;
    const motorista = document.getElementById('vei-motorista').value.toUpperCase().trim();
    const combustivel = document.getElementById('vei-combustivel').value;
    const ano = document.getElementById('vei-ano').value;
    
    if (!placa || placa.length < 7) {
      mostrarNotificacao("‚ùå PLACA INV√ÅLIDA!", "error");
      return;
    }
    
    const veiculoRef = db.ref('veiculos').push();
    
    veiculoRef.set({
      placa: placa,
      modelo: modelo,
      secretaria: secretaria,
      motorista: motorista,
      combustivel: combustivel,
      ano: ano,
      cadastradoEm: Date.now()
    }).then(() => {
      registrarAuditoria('VEICULO_CADASTRADO', { placa: placa });
      mostrarNotificacao("‚úÖ VE√çCULO SALVO COM SUCESSO!", "success");
      
      gerarQRCode(placa);
      
      document.getElementById('vei-placa').value = '';
      document.getElementById('vei-modelo').value = '';
      document.getElementById('vei-sec').value = '';
      document.getElementById('vei-motorista').value = '';
      document.getElementById('vei-combustivel').value = 'GASOLINA';
      document.getElementById('vei-ano').value = '';
      listVeiculos();
    }).catch(error => {
      mostrarNotificacao("‚ùå ERRO AO SALVAR: " + error.message, "error");
    });
  }
  
  function gerarQRCode(placa) {
    const qrDisplay = document.getElementById('qr-display');
    const qrcodeDiv = document.getElementById('qrcode');
    qrcodeDiv.innerHTML = '';
    
    try {
      new QRCode(qrcodeDiv, {
        text: placa,
        width: 256,
        height: 256,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
      
      document.getElementById('qr-placa-text').textContent = placa;
      qrDisplay.style.display = 'block';
      
      setTimeout(() => {
        qrDisplay.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 300);
    } catch (error) {
      console.error("Erro ao gerar QR Code:", error);
      mostrarNotificacao("‚ùå ERRO AO GERAR QR CODE!", "error");
    }
  }
  
  function gerarQRCodeModal(placa) {
    const modal = document.getElementById('modal-qr');
    const qrcodeDiv = document.getElementById('qrcode-modal');
    qrcodeDiv.innerHTML = '';
    
    try {
      new QRCode(qrcodeDiv, {
        text: placa,
        width: 256,
        height: 256,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
      
      document.getElementById('qr-placa-modal').textContent = placa;
      modal.style.display = 'flex';
    } catch (error) {
      console.error("Erro ao gerar QR Code:", error);
      mostrarNotificacao("‚ùå ERRO AO GERAR QR CODE!", "error");
    }
  }
  
  function fecharModalQR() {
    document.getElementById('modal-qr').style.display = 'none';
  }
  
  function baixarQRCode() {
    const canvas = document.querySelector('#qrcode canvas');
    const placa = document.getElementById('qr-placa-text').textContent;
    
    if (canvas) {
      const link = document.createElement('a');
      link.download = `QRCode_${placa}.png`;
      link.href = canvas.toDataURL();
      link.click();
      mostrarNotificacao("‚úÖ QR CODE BAIXADO!", "success");
    }
  }
  
  function baixarQRCodeModal() {
    const canvas = document.querySelector('#qrcode-modal canvas');
    const placa = document.getElementById('qr-placa-modal').textContent;
    
    if (canvas) {
      const link = document.createElement('a');
      link.download = `QRCode_${placa}.png`;
      link.href = canvas.toDataURL();
      link.click();
      mostrarNotificacao("‚úÖ QR CODE BAIXADO!", "success");
    }
  }
  
  function salvarPosto() {
    if (!temPermissao('gerenciar_postos')) {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA CADASTRAR POSTOS!", "error");
      return;
    }
    
    const nome = document.getElementById('posto-nome').value.toUpperCase().trim();
    
    if (!nome) {
      mostrarNotificacao("‚ùå PREENCHA O NOME DO POSTO!", "error");
      return;
    }
    
    // Verificar quais combust√≠veis foram selecionados
    const combustiveis = {};
    let algumSelecionado = false;
    
    if (document.getElementById('posto-tem-gasolina').checked) {
      const preco = parseFloat(document.getElementById('posto-gas').value);
      if (!preco || preco <= 0) {
        mostrarNotificacao("‚ùå PREENCHA O PRE√áO DA GASOLINA!", "error");
        return;
      }
      combustiveis['GASOLINA'] = preco;
      algumSelecionado = true;
    }
    
    if (document.getElementById('posto-tem-alcool').checked) {
      const preco = parseFloat(document.getElementById('posto-alc').value);
      if (!preco || preco <= 0) {
        mostrarNotificacao("‚ùå PREENCHA O PRE√áO DO √ÅLCOOL!", "error");
        return;
      }
      combustiveis['ALCOOL'] = preco;
      algumSelecionado = true;
    }
    
    if (document.getElementById('posto-tem-diesel').checked) {
      const preco = parseFloat(document.getElementById('posto-die').value);
      if (!preco || preco <= 0) {
        mostrarNotificacao("‚ùå PREENCHA O PRE√áO DO DIESEL!", "error");
        return;
      }
      combustiveis['DIESEL'] = preco;
      algumSelecionado = true;
    }
    
    if (document.getElementById('posto-tem-diesels10').checked) {
      const preco = parseFloat(document.getElementById('posto-diesels10').value);
      if (!preco || preco <= 0) {
        mostrarNotificacao("‚ùå PREENCHA O PRE√áO DO DIESEL S10!", "error");
        return;
      }
      combustiveis['DIESEL S10'] = preco;
      algumSelecionado = true;
    }
    
    if (document.getElementById('posto-tem-gas').checked) {
      const preco = parseFloat(document.getElementById('posto-gas-gnv').value);
      if (!preco || preco <= 0) {
        mostrarNotificacao("‚ùå PREENCHA O PRE√áO DO G√ÅS!", "error");
        return;
      }
      combustiveis['GAS'] = preco;
      algumSelecionado = true;
    }
    
    if (!algumSelecionado) {
      mostrarNotificacao("‚ùå SELECIONE PELO MENOS UM TIPO DE COMBUST√çVEL!", "error");
      return;
    }
    
    const postoRef = db.ref('postos').push();
    
    postoRef.set({
      nome: nome,
      precos: combustiveis,
      cadastradoEm: Date.now()
    }).then(() => {
      registrarAuditoria('POSTO_CADASTRADO', { nome: nome, combustiveis: Object.keys(combustiveis) });
      mostrarNotificacao("‚úÖ POSTO SALVO COM SUCESSO!", "success");
      
      // Limpar formul√°rio
      document.getElementById('posto-nome').value = '';
      document.getElementById('posto-tem-gasolina').checked = false;
      document.getElementById('posto-tem-alcool').checked = false;
      document.getElementById('posto-tem-diesel').checked = false;
      document.getElementById('posto-tem-diesels10').checked = false;
      document.getElementById('posto-tem-gas').checked = false;
      document.getElementById('posto-gas').value = '';
      document.getElementById('posto-gas').disabled = true;
      document.getElementById('posto-alc').value = '';
      document.getElementById('posto-alc').disabled = true;
      document.getElementById('posto-die').value = '';
      document.getElementById('posto-die').disabled = true;
      document.getElementById('posto-diesels10').value = '';
      document.getElementById('posto-diesels10').disabled = true;
      document.getElementById('posto-gas-gnv').value = '';
      document.getElementById('posto-gas-gnv').disabled = true;
      
      listPostos();
    }).catch(error => {
      mostrarNotificacao("‚ùå ERRO AO SALVAR: " + error.message, "error");
    });
  }
  
  function listPostos() {
    db.ref('postos').once('value', snap => {
      const tbody = document.getElementById('postos-body');
      tbody.innerHTML = "";
      if (!snap.exists()) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:40px;">‚õΩ NENHUM POSTO CADASTRADO</td></tr>';
        return;
      }
      snap.forEach(c => {
        const p = c.val();
        
        // Gerar badges de combust√≠veis
        let badgesCombustiveis = '';
        const coresCombustiveis = {
          'GASOLINA': 'badge-danger',
          'ALCOOL': 'badge-success',
          'DIESEL': 'badge-warning',
          'DIESEL S10': 'badge badge-primary',
          'GAS': 'badge badge-info'
        };
        
        Object.keys(p.precos).forEach(combustivel => {
          const corBadge = coresCombustiveis[combustivel] || 'badge';
          const preco = p.precos[combustivel];
          badgesCombustiveis += `
            <span class="badge ${corBadge}" style="margin: 2px; display: inline-block;">
              ${combustivel}: R$ ${preco.toFixed(2)}
            </span>
          `;
        });
        
        tbody.innerHTML += `
          <tr>
            <td><b>${p.nome}</b></td>
            <td>${badgesCombustiveis}</td>
            <td class="no-print">
              ${temPermissao('gerenciar_postos') ? `
                <button class="btn-action" style="background:var(--accent);color:white;" onclick="editarPosto('${c.key}')">
                  ‚úèÔ∏è EDITAR
                </button>
                <button class="btn-action btn-deletar" onclick="if(confirm('‚ö†Ô∏è EXCLUIR POSTO ${p.nome}?')) { db.ref('postos/${c.key}').remove().then(() => { registrarAuditoria('POSTO_DELETADO', {nome: '${p.nome}'}); mostrarNotificacao('‚úÖ POSTO EXCLU√çDO!', 'success'); listPostos(); }); }">
                  üóëÔ∏è
                </button>
              ` : ''}
            </td>
          </tr>
        `;
      });
    });
  }
  
  function iniciarScanner() {
    const scannerArea = document.getElementById('qr-scanner-area');
    scannerArea.style.display = 'block';
    
    html5QrCode = new Html5Qrcode("qr-reader");
    
    html5QrCode.start(
      { facingMode: "environment" },
      {
        fps: 10,
        qrbox: { width: 250, height: 250 }
      },
      (decodedText) => {
        document.getElementById('f-placa').value = decodedText;
        sugerir(decodedText);
        pararScanner();
        mostrarNotificacao("‚úÖ QR CODE LIDO: " + decodedText, "success");
      },
      (errorMessage) => {
        // Ignora erros de leitura cont√≠nua
      }
    ).catch(err => {
      console.error("Erro ao iniciar scanner:", err);
      mostrarNotificacao("‚ùå ERRO AO ACESSAR C√ÇMERA!", "error");
      scannerArea.style.display = 'none';
    });
  }
  
  function pararScanner() {
    if (html5QrCode) {
      html5QrCode.stop().then(() => {
        document.getElementById('qr-scanner-area').style.display = 'none';
        html5QrCode = null;
      }).catch(err => {
        console.error("Erro ao parar scanner:", err);
      });
    }
  }
  
  function listVeiculos() {
    db.ref('veiculos').once('value', snap => {
      const tbody = document.getElementById('veiculos-body');
      tbody.innerHTML = "";
      if (!snap.exists()) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px;">üì≠ NENHUM VE√çCULO CADASTRADO</td></tr>';
        return;
      }
      snap.forEach(c => {
        const v = c.val();
        tbody.innerHTML += `
          <tr>
            <td><b>${v.placa}</b></td>
            <td>${v.modelo || '---'}</td>
            <td>${v.secretaria || 'COMPARTILHADO'}</td>
            <td>${v.motorista || 'V√ÅRIOS'}</td>
            <td><span class="badge ${v.combustivel === 'GASOLINA' ? 'badge-danger' : v.combustivel === 'DIESEL' ? 'badge-warning' : 'badge-success'}">${v.combustivel || '---'}</span></td>
            <td>${v.ano || '---'}</td>
            <td class="no-print">
              <button class="btn-action" style="background:#8b5cf6;color:white;" onclick="gerarQRCodeModal('${v.placa}')">üì± QR CODE</button>
              ${temPermissao('gerenciar_veiculos') ? `
                <button class="btn-action btn-deletar" onclick="if(confirm('‚ö†Ô∏è EXCLUIR VE√çCULO ${v.placa}?')) { db.ref('veiculos/${c.key}').remove().then(() => { registrarAuditoria('VEICULO_DELETADO', {placa: '${v.placa}'}); mostrarNotificacao('‚úÖ VE√çCULO EXCLU√çDO!', 'success'); listVeiculos(); }); }">
                  üóëÔ∏è
                </button>
              ` : ''}
            </td>
          </tr>
        `;
      });
    });
  }
  
  // Inicializa√ß√£o
  document.getElementById('f-data').valueAsDate = new Date();
  toggleUserFields();
  
  // ==================== PWA ====================
  function verificarPWA() {
    // Detectar se j√° est√° instalado
    if (window.matchMedia('(display-mode: standalone)').matches) {
      console.log('App j√° instalado');
      return;
    }
    
    // Listener para o evento beforeinstallprompt
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // Mostrar banner depois de 3 segundos
      setTimeout(() => {
        document.getElementById('pwa-banner').classList.add('show');
      }, 3000);
    });
    
    // Detectar quando foi instalado
    window.addEventListener('appinstalled', () => {
      console.log('PWA instalado com sucesso!');
      deferredPrompt = null;
      document.getElementById('pwa-banner').classList.remove('show');
      mostrarNotificacao('‚úÖ APP INSTALADO COM SUCESSO!', 'success');
    });
  }
  
  function instalarPWA() {
    if (!deferredPrompt) {
      mostrarNotificacao('‚ö†Ô∏è INSTALA√á√ÉO N√ÉO DISPON√çVEL NESTE NAVEGADOR', 'warning');
      return;
    }
    
    deferredPrompt.prompt();
    
    deferredPrompt.userChoice.then((choiceResult) => {
      if (choiceResult.outcome === 'accepted') {
        console.log('Usu√°rio aceitou instalar o app');
      } else {
        console.log('Usu√°rio recusou instalar o app');
      }
      deferredPrompt = null;
    });
  }
  
  function fecharBannerPWA() {
    document.getElementById('pwa-banner').classList.remove('show');
  }
  
  // ==================== NOTIFICA√á√ïES ====================
  function inicializarNotificacoes() {
    // Carregar notifica√ß√µes do Firebase
    db.ref('notificacoes/' + loginUser).on('value', snap => {
      notificacoes = [];
      snap.forEach(item => {
        let notif = item.val();
        notif.id = item.key;
        notificacoes.push(notif);
      });
      
      notificacoes.sort((a, b) => b.timestamp - a.timestamp);
      atualizarNotificationCenter();
    });
    
    // Monitorar mudan√ßas em abastecimentos para criar notifica√ß√µes
    db.ref('abastecimentos').on('child_changed', (snap) => {
      const abast = snap.val();
      
      // Notificar quando status mudar
      if (abast.status === STATUS.AUTORIZADO && abast.solicitadoPor.toLowerCase() === loginUser) {
        criarNotificacao({
          titulo: '‚úÖ Abastecimento Aprovado',
          texto: `Ve√≠culo ${abast.placa} - R$ ${abast.valor.toFixed(2)}${abast.tanqueCheio ? ' (Tanque Cheio)' : ''}`,
          tipo: 'success',
          destinatario: loginUser
        });
      }
      
      if (abast.status === STATUS.REJEITADO && abast.solicitadoPor.toLowerCase() === loginUser) {
        criarNotificacao({
          titulo: '‚ùå Abastecimento Rejeitado',
          texto: `Ve√≠culo ${abast.placa} - Motivo: ${abast.motivoRejeicao || 'N√£o informado'}`,
          tipo: 'error',
          destinatario: loginUser
        });
      }
    });
    
    db.ref('abastecimentos').on('child_added', (snap) => {
      const abast = snap.val();
      
      // Notificar admins de novas solicita√ß√µes
      if (abast.status === STATUS.AGUARDANDO && temPermissao('autorizar_abastecimento')) {
        criarNotificacao({
          titulo: '‚è≥ Nova Solicita√ß√£o',
          texto: `${abast.solicitadoPor} solicitou abastecimento - ${abast.placa}${abast.tanqueCheio ? ' (Tanque Cheio)' : ''}`,
          tipo: 'info',
          destinatario: loginUser
        });
      }
    });
    
    // Solicitar permiss√£o para notifica√ß√µes
    if ('Notification' in window && Notification.permission === 'default') {
      setTimeout(() => {
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            mostrarNotificacao('üîî NOTIFICA√á√ïES ATIVADAS!', 'success');
          }
        });
      }, 5000);
    }
  }
  
  function criarNotificacao(dados) {
    const notifRef = db.ref('notificacoes/' + dados.destinatario).push();
    notifRef.set({
      titulo: dados.titulo,
      texto: dados.texto,
      tipo: dados.tipo,
      timestamp: Date.now(),
      lida: false
    });
    
    // Mostrar notifica√ß√£o do navegador
    if ('Notification' in window && Notification.permission === 'granted') {
      new Notification(dados.titulo, {
        body: dados.texto,
        icon: 'https://i.imgur.com/AKM25W1.png',
        badge: 'https://i.imgur.com/AKM25W1.png'
      });
    }
  }
  
  function toggleNotificationCenter() {
    const center = document.getElementById('notification-center');
    center.classList.toggle('active');
  }
  
  function atualizarNotificationCenter() {
    const list = document.getElementById('notification-list');
    const count = document.getElementById('notification-count');
    
    const naoLidas = notificacoes.filter(n => !n.lida).length;
    
    if (naoLidas > 0) {
      count.textContent = naoLidas;
      count.style.display = 'flex';
    } else {
      count.style.display = 'none';
    }
    
    if (notificacoes.length === 0) {
      list.innerHTML = '<div style="padding:40px 20px; text-align:center; color:#64748b; font-size:12px;">üì≠ NENHUMA NOTIFICA√á√ÉO</div>';
      return;
    }
    
    list.innerHTML = notificacoes.map(notif => {
      const tempo = calcularTempoDecorrido(notif.timestamp);
      const icone = notif.tipo === 'success' ? '‚úÖ' : notif.tipo === 'error' ? '‚ùå' : '‚è≥';
      
      return `
        <div class="notification-item ${!notif.lida ? 'unread' : ''}" onclick="marcarComoLida('${notif.id}')">
          <div class="notification-title">${icone} ${notif.titulo}</div>
          <div class="notification-text">${notif.texto}</div>
          <div class="notification-time">${tempo}</div>
        </div>
      `;
    }).join('');
  }
  
  function marcarComoLida(id) {
    db.ref('notificacoes/' + loginUser + '/' + id).update({ lida: true });
  }
  
  function calcularTempoDecorrido(timestamp) {
    const agora = Date.now();
    const diff = agora - timestamp;
    
    const segundos = Math.floor(diff / 1000);
    const minutos = Math.floor(segundos / 60);
    const horas = Math.floor(minutos / 60);
    const dias = Math.floor(horas / 24);
    
    if (dias > 0) return `h√° ${dias} dia${dias > 1 ? 's' : ''}`;
    if (horas > 0) return `h√° ${horas} hora${horas > 1 ? 's' : ''}`;
    if (minutos > 0) return `h√° ${minutos} minuto${minutos > 1 ? 's' : ''}`;
    return 'agora';
  }
  
  // ==================== DASHBOARD EXECUTIVO ====================
  function atualizarDashboardExecutivo() {
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    
    // Dados do m√™s atual
    const dadosMes = cache.filter(x => {
      if (x.status !== STATUS.AUTORIZADO) return false;
      const dataAbast = new Date(x.data);
      return dataAbast.getMonth() === mesAtual && dataAbast.getFullYear() === anoAtual;
    });
    
    // Calcular m√©tricas executivas
    const totalGastoMes = dadosMes.reduce((acc, item) => acc + item.valor, 0);
    const totalLitrosMes = dadosMes.reduce((acc, item) => acc + item.litro, 0);
    const totalAbastecimentos = dadosMes.length;
    const ticketMedio = totalAbastecimentos > 0 ? totalGastoMes / totalAbastecimentos : 0;
    
    // Dados do m√™s anterior
    const mesAnterior = mesAtual - 1 < 0 ? 11 : mesAtual - 1;
    const anoAnterior = mesAtual - 1 < 0 ? anoAtual - 1 : anoAtual;
    
    const dadosMesAnterior = cache.filter(x => {
      if (x.status !== STATUS.AUTORIZADO) return false;
      const dataAbast = new Date(x.data);
      return dataAbast.getMonth() === mesAnterior && dataAbast.getFullYear() === anoAnterior;
    });
    
    const totalMesAnterior = dadosMesAnterior.reduce((acc, item) => acc + item.valor, 0);
    const variacaoPercentual = totalMesAnterior > 0 
      ? ((totalGastoMes - totalMesAnterior) / totalMesAnterior * 100) 
      : 0;
    
    // Proje√ß√£o para o final do m√™s
    const diasDecorridos = hoje.getDate();
    const diasNoMes = new Date(anoAtual, mesAtual + 1, 0).getDate();
    const projecaoMes = (totalGastoMes / diasDecorridos) * diasNoMes;
    
    // Economia estimada
    const mediaLitro = totalLitrosMes > 0 ? totalGastoMes / totalLitrosMes : 0;
    const economiaEstimada = dadosMes.filter(d => {
      const media = calcularMedia(d);
      const limiteExcelente = d.tipo === 'DIESEL' ? 8 : 12;
      return media >= limiteExcelente;
    }).length * 50; // R$ 50 de economia por abastecimento eficiente
    
    // Atualizar cards executivos
    const metricsContainer = document.getElementById('executive-metrics');
    metricsContainer.innerHTML = `
      <div class="executive-metric">
        <div class="executive-metric-label">GASTO MENSAL</div>
        <div class="executive-metric-value">R$ ${totalGastoMes.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
        <div class="executive-metric-trend">
          ${variacaoPercentual >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(variacaoPercentual).toFixed(1)}% vs m√™s anterior
        </div>
      </div>
      <div class="executive-metric">
        <div class="executive-metric-label">PROJE√á√ÉO DO M√äS</div>
        <div class="executive-metric-value">R$ ${projecaoMes.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
        <div class="executive-metric-trend">
          Baseado em ${diasDecorridos} de ${diasNoMes} dias
        </div>
      </div>
      <div class="executive-metric">
        <div class="executive-metric-label">TICKET M√âDIO</div>
        <div class="executive-metric-value">R$ ${ticketMedio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
        <div class="executive-metric-trend">
          ${totalAbastecimentos} abastecimentos
        </div>
      </div>
      <div class="executive-metric">
        <div class="executive-metric-label">ECONOMIA ESTIMADA</div>
        <div class="executive-metric-value">R$ ${economiaEstimada.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
        <div class="executive-metric-trend">
          Por efici√™ncia da frota
        </div>
      </div>
    `;
    
    // Gr√°ficos executivos
    atualizarGraficosExecutivos(dadosMes);
    atualizarPerformanceSecretarias();
    atualizarAlertasExecutivos();
    atualizarGraficoAnual();
    atualizarGraficoFrota();
  }
  
  function atualizarGraficosExecutivos(dadosMes) {
    // Gr√°fico 1: Gastos por Tipo de Combust√≠vel
    const gastosPorTipo = {};
    dadosMes.forEach(d => {
      gastosPorTipo[d.tipo] = (gastosPorTipo[d.tipo] || 0) + d.valor;
    });
    
    if (chartExecutivo1) chartExecutivo1.destroy();
    chartExecutivo1 = new Chart(document.getElementById('chartExecutivo1'), {
      type: 'doughnut',
      data: {
        labels: Object.keys(gastosPorTipo),
        datasets: [{
          data: Object.values(gastosPorTipo),
          backgroundColor: ['#ef4444', '#22c55e', '#f59e0b']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: { display: true, text: 'DISTRIBUI√á√ÉO POR COMBUST√çVEL' },
          legend: { position: 'bottom' }
        }
      }
    });
    
    // Gr√°fico 2: Evolu√ß√£o Di√°ria do M√™s
    const gastosPorDia = {};
    dadosMes.forEach(d => {
      const dia = new Date(d.data).getDate();
      gastosPorDia[dia] = (gastosPorDia[dia] || 0) + d.valor;
    });
    
    const diasOrdenados = Object.keys(gastosPorDia).sort((a, b) => a - b);
    
    if (chartExecutivo2) chartExecutivo2.destroy();
    chartExecutivo2 = new Chart(document.getElementById('chartExecutivo2'), {
      type: 'line',
      data: {
        labels: diasOrdenados.map(d => `Dia ${d}`),
        datasets: [{
          label: 'GASTO DI√ÅRIO (R$)',
          data: diasOrdenados.map(d => gastosPorDia[d]),
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: { display: true, text: 'EVOLU√á√ÉO DI√ÅRIA' }
        }
      }
    });
  }
  
  function atualizarPerformanceSecretarias() {
    // Simula√ß√£o de or√ßamento (em produ√ß√£o viria do banco)
    const orcamentos = {
      'SA√öDE': 15000,
      'EDUCA√á√ÉO': 12000,
      'INFRAESTRUTURA E SERVI√áOS': 10000,
      'ASSIST√äNCIA SOCIAL': 8000,
      'ADMINISTRA√á√ÉO E FINAN√áAS': 7000
    };
    
    const tbody = document.getElementById('performance-body');
    let html = '';
    
    Object.keys(orcamentos).forEach(sec => {
      const realizado = cache
        .filter(x => x.secretaria === sec && x.status === STATUS.AUTORIZADO)
        .reduce((acc, item) => acc + item.valor, 0);
      
      const orcado = orcamentos[sec];
      const diferenca = orcado - realizado;
      const percentual = (realizado / orcado * 100).toFixed(1);
      
      // Proje√ß√£o
      const hoje = new Date();
      const diasDecorridos = hoje.getDate();
      const diasNoMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).getDate();
      const projecao = (realizado / diasDecorridos) * diasNoMes;
      
      const status = projecao <= orcado ? '‚úÖ NO OR√áAMENTO' : '‚ö†Ô∏è ACIMA';
      const corStatus = projecao <= orcado ? 'var(--success)' : 'var(--warning)';
      
      html += `
        <tr>
          <td><strong>${sec}</strong></td>
          <td>R$ ${orcado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
          <td>R$ ${realizado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
          <td style="color:${diferenca >= 0 ? 'var(--success)' : 'var(--danger)'}">
            R$ ${Math.abs(diferenca).toLocaleString('pt-BR', {minimumFractionDigits: 2})}
          </td>
          <td>
            <div style="background:#e2e8f0; border-radius:4px; height:20px; overflow:hidden;">
              <div style="background:${percentual > 100 ? 'var(--danger)' : 'var(--accent)'}; height:100%; width:${Math.min(percentual, 100)}%;"></div>
            </div>
            ${percentual}%
          </td>
          <td>R$ ${projecao.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
          <td style="color:${corStatus}; font-weight:bold;">${status}</td>
        </tr>
      `;
    });
    
    tbody.innerHTML = html;
  }
  
  function atualizarAlertasExecutivos() {
    const container = document.getElementById('alertas-executivo');
    let alertas = [];
    
    // Verificar ve√≠culos com efici√™ncia cr√≠tica usando os novos limites
    const veiculosCriticos = [];
    
    cache.filter(x => x.status === STATUS.AUTORIZADO).forEach(abast => {
      const media = calcularMedia(abast);
      const limiteAlerta = LIMITES_ALERTA[abast.tipo];
      if (media > 0 && media < limiteAlerta) {
        if (!veiculosCriticos.includes(abast.placa)) {
          veiculosCriticos.push(abast.placa);
        }
      }
    });
    
    if (veiculosCriticos.length > 0) {
      alertas.push(`
        <div class="alert-box danger">
          <strong>üö® ${veiculosCriticos.length} VE√çCULO(S) COM EFICI√äNCIA CR√çTICA</strong><br>
          <span style="font-size:11px;">Recomenda-se revis√£o preventiva urgente</span>
          <div style="margin-top:10px; font-size:11px;">
            Ve√≠culos: ${veiculosCriticos.join(', ')}
          </div>
        </div>
      `);
    }
    
    // Alerta de proje√ß√£o
    const hoje = new Date();
    const diasRestantes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).getDate() - hoje.getDate();
    
    if (diasRestantes < 10) {
      alertas.push(`
        <div class="alert-box" style="background:#fff3cd; border-left-color:var(--warning);">
          <strong>üìÖ FINAL DO M√äS SE APROXIMANDO</strong><br>
          <span style="font-size:11px;">Restam apenas ${diasRestantes} dias - Revisar or√ßamentos</span>
        </div>
      `);
    }
    
    container.innerHTML = alertas.length > 0 
      ? alertas.join('') 
      : '<div style="text-align:center; padding:40px; color:#64748b;">‚úÖ NENHUM ALERTA NO MOMENTO</div>';
  }
  
  // Gr√°fico Anual (√∫ltimos 12 meses)
  function atualizarGraficoAnual() {
    const hoje = new Date();
    const meses = [];
    const valores = [];
    
    for (let i = 11; i >= 0; i--) {
      let mes = hoje.getMonth() - i;
      let ano = hoje.getFullYear();
      
      while (mes < 0) {
        mes += 12;
        ano -= 1;
      }
      
      const dadosMes = cache.filter(x => {
        if (x.status !== STATUS.AUTORIZADO) return false;
        const dataAbast = new Date(x.data);
        return dataAbast.getMonth() === mes && dataAbast.getFullYear() === ano;
      });
      
      const totalMes = dadosMes.reduce((acc, item) => acc + item.valor, 0);
      
      const nomeMes = new Date(ano, mes, 1).toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
      meses.push(nomeMes.toUpperCase());
      valores.push(totalMes);
    }
    
    if (chartAnual) chartAnual.destroy();
    chartAnual = new Chart(document.getElementById('chartAnual'), {
      type: 'bar',
      data: {
        labels: meses,
        datasets: [{
          label: 'GASTO MENSAL (R$)',
          data: valores,
          backgroundColor: '#3b82f6',
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return 'R$ ' + value.toLocaleString('pt-BR');
              }
            }
          }
        }
      }
    });
  }
  
  // Gr√°fico da Frota
  function atualizarGraficoFrota() {
    const veiculosAtivos = [...new Set(cache.filter(x => x.status === STATUS.AUTORIZADO).map(x => x.placa))].length;
    const totalVeiculos = veiculos.length;
    const veiculosInativos = totalVeiculos - veiculosAtivos;
    
    if (chartFrota) chartFrota.destroy();
    chartFrota = new Chart(document.getElementById('chartFrota'), {
      type: 'doughnut',
      data: {
        labels: ['ATIVOS', 'INATIVOS'],
        datasets: [{
          data: [veiculosAtivos, veiculosInativos],
          backgroundColor: ['#22c55e', '#94a3b8']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' },
          title: { display: true, text: `TOTAL: ${totalVeiculos} VE√çCULOS` }
        }
      }
    });
  }
  
  // Fechar modais clicando fora
  window.onclick = function(event) {
    const modalEdit = document.getElementById('modal-edit');
    const modalQr = document.getElementById('modal-qr');
    const modalAnalise = document.getElementById('modal-analise');
    const modalHistorico = document.getElementById('modal-historico-avulso');
    const modalPermissoes = document.getElementById('modal-permissoes');
    const modalTanqueCheio = document.getElementById('modal-tanque-cheio');
    const modalEditPosto = document.getElementById('modal-edit-posto');
    const modalEditVIP = document.getElementById('modal-edit-vip');
    
    if (event.target === modalEdit) {
      fecharModal();
    }
    if (event.target === modalQr) {
      fecharModalQR();
    }
    if (event.target === modalAnalise) {
      fecharModalAnalise();
    }
    if (event.target === modalHistorico) {
      fecharModalHistoricoAvulso(false);
    }
    if (event.target === modalPermissoes) {
      fecharModalPermissoes();
    }
    if (event.target === modalTanqueCheio) {
      fecharModalTanqueCheio();
    }
    if (event.target === modalEditPosto) {
      fecharModalEditPosto();
    }
    if (event.target === modalEditVIP) {
      fecharModalEditVIP();
    }
  };
  
  // ============================================
  // FUN√á√ïES VIP - PREFEITA E VEREADORES
  // ============================================
  
  let limitesVIPCache = {};
  let gastosVIPCache = {};
  
  // Carregar postos no select VIP
  function carregarPostosVIP() {
    const select = document.getElementById('vip-posto');
    if (!select) return;
    
    select.innerHTML = '<option value="">SELECIONE...</option>';
    
    db.ref('postos').once('value', snap => {
      if (snap.exists()) {
        snap.forEach(c => {
          const p = c.val();
          select.innerHTML += `<option value="${c.key}">${p.nome}</option>`;
        });
      }
    });
  }
  
  // Carregar combust√≠veis do posto selecionado
  function carregarCombustiveisVIP() {
    const postoId = document.getElementById('vip-posto').value;
    const selectComb = document.getElementById('vip-combustivel');
    
    selectComb.innerHTML = '<option value="">SELECIONE...</option>';
    document.getElementById('vip-preco').value = '';
    document.getElementById('vip-valor').value = '';
    
    if (!postoId) {
      selectComb.innerHTML = '<option value="">SELECIONE O POSTO PRIMEIRO</option>';
      return;
    }
    
    db.ref('postos/' + postoId).once('value', snap => {
      if (snap.exists()) {
        const posto = snap.val();
        Object.keys(posto.precos).forEach(comb => {
          selectComb.innerHTML += `<option value="${comb}" data-preco="${posto.precos[comb]}">${comb}</option>`;
        });
      }
    });
  }
  
  // Calcular valor do abastecimento VIP
  function calcularValorVIP() {
    const selectComb = document.getElementById('vip-combustivel');
    const litros = parseFloat(document.getElementById('vip-litros').value) || 0;
    
    if (selectComb.selectedIndex > 0) {
      const preco = parseFloat(selectComb.options[selectComb.selectedIndex].getAttribute('data-preco')) || 0;
      document.getElementById('vip-preco').value = preco.toFixed(2);
      
      const valorTotal = litros * preco;
      document.getElementById('vip-valor').value = 'R$ ' + valorTotal.toFixed(2);
      
      // Verificar limite
      verificarLimiteVIP(valorTotal);
    }
  }
  
  // Verificar se o abastecimento excede o limite
  async function verificarLimiteVIP(valorTotal) {
    const pessoaId = document.getElementById('vip-pessoa').value;
    if (!pessoaId) return;
    
    const alerta = document.getElementById('alerta-limite-vip');
    const detalhes = document.getElementById('detalhes-excedente-vip');
    
    // Buscar dados da pessoa VIP
    const vipSnapshot = await db.ref('pessoas_vip/' + pessoaId).once('value');
    if (!vipSnapshot.exists()) {
      console.error("VIP n√£o encontrado:", pessoaId);
      return;
    }
    
    const vipData = vipSnapshot.val();
    
    // Se sem limite, n√£o mostrar alerta
    if (vipData.semLimite) {
      alerta.style.display = 'none';
      return;
    }
    
    const limite = vipData.limite;
    
    // Calcular gasto atual do m√™s
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    
    const gastosSnapshot = await db.ref('abastecimentos').orderByChild('pessoaVIP').equalTo(pessoaId).once('value');
    let gastoMes = 0;
    
    if (gastosSnapshot.exists()) {
      gastosSnapshot.forEach(snap => {
        const abast = snap.val();
        const dataAbast = new Date(abast.data);
        if (dataAbast.getMonth() === mesAtual && dataAbast.getFullYear() === anoAtual && abast.status === STATUS.AUTORIZADO) {
          gastoMes += abast.valor;
        }
      });
    }
    
    const saldoRestante = limite - gastoMes;
    
    if (valorTotal > saldoRestante) {
      const excedente = valorTotal - saldoRestante;
      alerta.style.display = 'block';
      detalhes.innerHTML = `
        Limite: <strong>R$ ${limite.toFixed(2)}</strong><br>
        Gasto no m√™s: <strong>R$ ${gastoMes.toFixed(2)}</strong><br>
        Saldo restante: <strong>R$ ${saldoRestante.toFixed(2)}</strong><br>
        Este abastecimento: <strong>R$ ${valorTotal.toFixed(2)}</strong><br>
        <span style="color:var(--danger); font-weight:bold;">Excedente: R$ ${excedente.toFixed(2)}</span>
      `;
    } else {
      alerta.style.display = 'none';
    }
  }
  
  // Atualizar informa√ß√µes de limite ao selecionar pessoa
  async function atualizarLimiteVIP() {
    await atualizarDashboardVIP();
  }
  
  // Atualizar dashboard de limites VIP
  async function atualizarDashboardVIP() {
    const container = document.getElementById('container-limites-vip');
    if (!container) return;
    
    container.innerHTML = '<p style="text-align:center; color:#64748b;">‚è≥ Carregando limites...</p>';
    
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    
    // Buscar VIPs do Firebase
    const snapshotVIPs = await db.ref('pessoas_vip').once('value');
    
    if (!snapshotVIPs.exists()) {
      container.innerHTML = '<p style="text-align:center; color:#64748b;">‚≠ê Nenhuma pessoa VIP cadastrada. <br>Configure em CONFIGURA√á√ïES ‚Üí Gest√£o de Pessoas VIP</p>';
      return;
    }
    
    // Agrupar por categoria
    const vipsPorCategoria = {
      executivo: [],
      legislativo: [],
      administrativo: []
    };
    
    for (const snap of Object.values(snapshotVIPs.val())) {
      const pessoa = snap;
      const key = pessoa.id;
      const limite = pessoa.limite;
      const semLimite = pessoa.semLimite || false;
      
      // Calcular gasto do m√™s
      const gastosSnapshot = await db.ref('abastecimentos').orderByChild('pessoaVIP').equalTo(key).once('value');
      let gastoMes = 0;
      let qtdAbastecimentos = 0;
      
      if (gastosSnapshot.exists()) {
        gastosSnapshot.forEach(abastSnap => {
          const abast = abastSnap.val();
          const dataAbast = new Date(abast.data);
          if (dataAbast.getMonth() === mesAtual && dataAbast.getFullYear() === anoAtual && abast.status === STATUS.AUTORIZADO) {
            gastoMes += abast.valor;
            qtdAbastecimentos++;
          }
        });
      }
      
      const saldoRestante = semLimite ? Infinity : (limite - gastoMes);
      const percentual = semLimite ? 0 : ((gastoMes / limite) * 100);
      
      let corBarra = 'var(--success)';
      if (!semLimite) {
        if (percentual >= 90) corBarra = 'var(--danger)';
        else if (percentual >= 70) corBarra = 'var(--warning)';
      }
      
      const icone = pessoa.categoria === 'executivo' ? 'üëë' : (pessoa.categoria === 'legislativo' ? 'üèõÔ∏è' : 'üë§');
      
      const limiteTexto = semLimite ? 'ILIMITADO ‚≠ê' : `R$ ${limite.toFixed(0)}`;
      const saldoTexto = semLimite ? 'ILIMITADO ‚≠ê' : `R$ ${saldoRestante.toFixed(0)}`;
      const percentualTexto = semLimite ? '0%' : `${percentual.toFixed(1)}%`;
      
      const cardHTML = `
        <div style="padding: 15px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; border: 2px solid #e2e8f0;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <div style="font-size: 24px;">${icone}</div>
            <div style="flex: 1;">
              <div style="font-weight: bold; font-size: 14px; color: var(--primary);">${pessoa.nome}</div>
              <div style="font-size: 11px; color: #64748b;">${pessoa.cargo}</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px;">
            <div style="text-align: center;">
              <div style="font-size: 10px; color: #64748b;">LIMITE</div>
              <div style="font-size: ${semLimite ? '12px' : '14px'}; font-weight: bold; color: ${semLimite ? '#f59e0b' : 'var(--accent)'};">${limiteTexto}</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 10px; color: #64748b;">GASTO</div>
              <div style="font-size: 14px; font-weight: bold; color: ${corBarra};">R$ ${gastoMes.toFixed(0)}</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 10px; color: #64748b;">SALDO</div>
              <div style="font-size: ${semLimite ? '12px' : '14px'}; font-weight: bold; color: ${semLimite ? '#22c55e' : 'var(--success)'};">${saldoTexto}</div>
            </div>
          </div>
          
          ${!semLimite ? `
          <div class="progress-bar" style="height: 8px;">
            <div class="progress-fill" style="width: ${Math.min(100, percentual)}%; background: ${corBarra};"></div>
          </div>
          ` : ''}
          
          <div style="margin-top: 8px; font-size: 11px; color: #64748b; text-align: center;">
            ${qtdAbastecimentos} abastecimento${qtdAbastecimentos !== 1 ? 's' : ''} no m√™s${!semLimite ? ` | ${percentualTexto} usado` : ''}
          </div>
        </div>
      `;
      
      vipsPorCategoria[pessoa.categoria].push(cardHTML);
    }
    
    // Montar HTML com separa√ß√£o por categorias
    let html = '';
    
    if (vipsPorCategoria.executivo.length > 0) {
      html += `
        <div style="grid-column: 1/-1;">
          <h4 style="margin: 0 0 15px 0; font-size: 14px; color: var(--primary); display: flex; align-items: center; gap: 8px;">
            <span>üëë</span> EXECUTIVO
          </h4>
        </div>
        ${vipsPorCategoria.executivo.join('')}
      `;
    }
    
    if (vipsPorCategoria.legislativo.length > 0) {
      html += `
        <div style="grid-column: 1/-1; margin-top: ${vipsPorCategoria.executivo.length > 0 ? '20px' : '0'};">
          <h4 style="margin: 0 0 15px 0; font-size: 14px; color: var(--primary); display: flex; align-items: center; gap: 8px;">
            <span>üèõÔ∏è</span> LEGISLATIVO
          </h4>
        </div>
        ${vipsPorCategoria.legislativo.join('')}
      `;
    }
    
    if (vipsPorCategoria.administrativo.length > 0) {
      html += `
        <div style="grid-column: 1/-1; margin-top: ${(vipsPorCategoria.executivo.length > 0 || vipsPorCategoria.legislativo.length > 0) ? '20px' : '0'};">
          <h4 style="margin: 0 0 15px 0; font-size: 14px; color: var(--primary); display: flex; align-items: center; gap: 8px;">
            <span>üë§</span> ADMINISTRATIVO
          </h4>
        </div>
        ${vipsPorCategoria.administrativo.join('')}
      `;
    }
    
    container.innerHTML = html;
  }
  
  // Lan√ßar abastecimento VIP
  async function lancarAbastecimentoVIP() {
    if (!temPermissao('registrar_abastecimento_vip')) {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA LAN√áAR ABASTECIMENTOS VIP!", "error");
      return;
    }
    
    const pessoaId = document.getElementById('vip-pessoa').value;
    const data = document.getElementById('vip-data').value;
    const placa = document.getElementById('vip-placa').value.toUpperCase().trim();
    const postoId = document.getElementById('vip-posto').value;
    const combustivel = document.getElementById('vip-combustivel').value;
    const litros = parseFloat(document.getElementById('vip-litros').value);
    const preco = parseFloat(document.getElementById('vip-preco').value);
    const km = parseInt(document.getElementById('vip-km').value);
    const obs = document.getElementById('vip-obs').value.trim();
    
    // Valida√ß√µes
    if (!pessoaId) {
      mostrarNotificacao("‚ùå SELECIONE A PESSOA VIP!", "error");
      return;
    }
    if (!data) {
      mostrarNotificacao("‚ùå INFORME A DATA!", "error");
      return;
    }
    if (!placa || placa.length < 7) {
      mostrarNotificacao("‚ùå INFORME UMA PLACA V√ÅLIDA!", "error");
      return;
    }
    if (!postoId) {
      mostrarNotificacao("‚ùå SELECIONE O POSTO!", "error");
      return;
    }
    if (!combustivel) {
      mostrarNotificacao("‚ùå SELECIONE O COMBUST√çVEL!", "error");
      return;
    }
    if (!litros || litros <= 0) {
      mostrarNotificacao("‚ùå INFORME OS LITROS!", "error");
      return;
    }
    if (!km || km <= 0) {
      mostrarNotificacao("‚ùå INFORME O OD√îMETRO!", "error");
      return;
    }
    
    const valor = litros * preco;
    
    // Buscar dados da pessoa VIP
    const vipSnapshot = await db.ref('pessoas_vip/' + pessoaId).once('value');
    if (!vipSnapshot.exists()) {
      mostrarNotificacao("‚ùå PESSOA VIP N√ÉO ENCONTRADA!", "error");
      return;
    }
    
    const pessoa = vipSnapshot.val();
    
    // Buscar nome do posto
    const postoSnapshot = await db.ref('postos/' + postoId).once('value');
    const nomePosto = postoSnapshot.exists() ? postoSnapshot.val().nome : 'POSTO N√ÉO ENCONTRADO';
    
    if (!confirm(`‚≠ê CONFIRMAR ABASTECIMENTO VIP?\n\nPessoa: ${pessoa.nome}\nPlaca: ${placa}\nPosto: ${nomePosto}\nCombust√≠vel: ${combustivel}\nLitros: ${litros}L\nValor: R$ ${valor.toFixed(2)}`)) {
      return;
    }
    
    const abastecimento = {
      pessoaVIP: pessoaId,
      nomePessoaVIP: pessoa.nome,
      cargoPessoaVIP: pessoa.cargo,
      data: data,
      placa: placa,
      posto: nomePosto,
      tipo: combustivel,
      litro: litros,
      precoPorLitro: preco,
      valor: valor,
      km: km,
      motorista: pessoa.nome,
      secretaria: 'VIP - ' + pessoa.cargo,
      observacoes: obs,
      status: STATUS.AUTORIZADO,  // Aprova√ß√£o autom√°tica
      aprovadoPor: loginUser.toUpperCase(),
      aprovadoEm: Date.now(),
      solicitadoPor: loginUser.toUpperCase(),
      timestamp: Date.now(),
      tipoAbastecimento: 'VIP'
    };
    
    db.ref('abastecimentos').push(abastecimento)
      .then(() => {
        registrarAuditoria('ABASTECIMENTO_VIP_LANCADO', {
          pessoaVIP: pessoa.nome,
          placa: placa,
          valor: valor
        });
        
        mostrarNotificacao("‚úÖ ABASTECIMENTO VIP LAN√áADO COM SUCESSO!", "success");
        
        // Limpar formul√°rio
        document.getElementById('vip-pessoa').value = '';
        document.getElementById('vip-data').value = new Date().toISOString().split('T')[0];
        document.getElementById('vip-placa').value = '';
        document.getElementById('vip-posto').value = '';
        document.getElementById('vip-combustivel').innerHTML = '<option value="">SELECIONE O POSTO PRIMEIRO</option>';
        document.getElementById('vip-litros').value = '';
        document.getElementById('vip-preco').value = '';
        document.getElementById('vip-valor').value = '';
        document.getElementById('vip-km').value = '';
        document.getElementById('vip-obs').value = '';
        document.getElementById('alerta-limite-vip').style.display = 'none';
        
        // Atualizar dashboard e hist√≥rico
        atualizarDashboardVIP();
        atualizarHistoricoVIP();
      })
      .catch(error => {
        mostrarNotificacao("‚ùå ERRO AO LAN√áAR: " + error.message, "error");
      });
  }
  
  // Atualizar hist√≥rico VIP
  function atualizarHistoricoVIP() {
    const tbody = document.getElementById('historico-vip-body');
    if (!tbody) return;
    
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:20px;">‚è≥ CARREGANDO...</td></tr>';
    
    db.ref('abastecimentos').orderByChild('tipoAbastecimento').equalTo('VIP').once('value', snap => {
      tbody.innerHTML = '';
      
      if (!snap.exists()) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:40px;">üì≠ NENHUM ABASTECIMENTO VIP REGISTRADO</td></tr>';
        return;
      }
      
      const registros = [];
      snap.forEach(c => {
        const abast = c.val();
        abast.id = c.key;
        registros.push(abast);
      });
      
      // Ordenar por data decrescente
      registros.sort((a, b) => b.timestamp - a.timestamp);
      
      registros.forEach(abast => {
        const dataFormatada = new Date(abast.data).toLocaleDateString('pt-BR');
        
        tbody.innerHTML += `
          <tr>
            <td>${dataFormatada}</td>
            <td><strong>${abast.nomePessoaVIP}</strong><br><small>${abast.cargoPessoaVIP}</small></td>
            <td>${abast.placa}</td>
            <td>${abast.posto}</td>
            <td>${abast.tipo}</td>
            <td>${abast.litro.toFixed(2)}L</td>
            <td><strong>R$ ${abast.valor.toFixed(2)}</strong></td>
            <td>${abast.aprovadoPor}</td>
            <td class="no-print">
              ${temPermissao('deletar_abastecimento') ? `
                <button class="btn-action btn-deletar" onclick="if(confirm('‚ö†Ô∏è EXCLUIR ESTE ABASTECIMENTO VIP?')) { db.ref('abastecimentos/${abast.id}').remove().then(() => { mostrarNotificacao('üóëÔ∏è EXCLU√çDO!', 'success'); atualizarHistoricoVIP(); atualizarDashboardVIP(); }); }">
                  üóëÔ∏è
                </button>
              ` : '-'}
            </td>
          </tr>
        `;
      });
    });
  }
  
  // Inicializar tab VIP quando acessada
  function inicializarTabVIP() {
    const hoje = new Date().toISOString().split('T')[0];
    document.getElementById('vip-data').value = hoje;
    
    carregarPostosVIP();
    atualizarDropdownsVIP();
    atualizarDashboardVIP();
    atualizarHistoricoVIP();
  }
  
  // ============================================
  // GEST√ÉO DE PESSOAS VIP (CRUD)
  // ============================================
  
  // Toggle de limite ilimitado
  function toggleLimiteVIP(tipo) {
    const checkbox = document.getElementById(tipo + '-vip-sem-limite');
    const inputLimite = document.getElementById(tipo + '-vip-limite');
    
    if (checkbox.checked) {
      inputLimite.value = '';
      inputLimite.disabled = true;
      inputLimite.placeholder = 'ILIMITADO';
      inputLimite.style.background = '#fef3c7';
      inputLimite.style.fontWeight = 'bold';
      inputLimite.style.color = '#92400e';
    } else {
      inputLimite.disabled = false;
      inputLimite.placeholder = '0.00';
      inputLimite.style.background = '';
      inputLimite.style.fontWeight = '';
      inputLimite.style.color = '';
    }
  }
  
  // Mostrar/esconder se√ß√£o de gest√£o de VIPs
  function mostrarGestaoVIPs() {
    const gestaoVIPs = document.getElementById('gestao-vips');
    if (gestaoVIPs && (loginUser === 'master' || temPermissao('gerenciar_usuarios'))) {
      gestaoVIPs.style.display = 'block';
      listarVIPs();
    }
  }
  
  // Listar todas as pessoas VIP
  async function listarVIPs() {
    const tbody = document.getElementById('vips-body');
    if (!tbody) return;
    
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">‚è≥ CARREGANDO...</td></tr>';
    
    const snapshot = await db.ref('pessoas_vip').once('value');
    
    if (!snapshot.exists()) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px;">‚≠ê NENHUMA PESSOA VIP CADASTRADA</td></tr>';
      return;
    }
    
    tbody.innerHTML = '';
    
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    
    for (const snap of Object.values(snapshot.val())) {
      const vip = snap;
      const vipId = vip.id;
      
      // Calcular gasto do m√™s
      const gastosSnapshot = await db.ref('abastecimentos').orderByChild('pessoaVIP').equalTo(vipId).once('value');
      let gastoMes = 0;
      
      if (gastosSnapshot.exists()) {
        gastosSnapshot.forEach(abastSnap => {
          const abast = abastSnap.val();
          const dataAbast = new Date(abast.data);
          if (dataAbast.getMonth() === mesAtual && dataAbast.getFullYear() === anoAtual && abast.status === STATUS.AUTORIZADO) {
            gastoMes += abast.valor;
          }
        });
      }
      
      const saldoRestante = vip.semLimite ? Infinity : (vip.limite - gastoMes);
      const percentual = vip.semLimite ? 0 : ((gastoMes / vip.limite) * 100);
      
      let corSaldo = 'var(--success)';
      if (!vip.semLimite) {
        if (percentual >= 90) corSaldo = 'var(--danger)';
        else if (percentual >= 70) corSaldo = 'var(--warning)';
      }
      
      const icone = vip.categoria === 'executivo' ? 'üëë' : (vip.categoria === 'legislativo' ? 'üèõÔ∏è' : 'üë§');
      
      const limiteTexto = vip.semLimite ? '<span style="color:#f59e0b; font-weight:bold;">ILIMITADO ‚≠ê</span>' : `R$ ${vip.limite.toFixed(2)}`;
      const saldoTexto = vip.semLimite ? '<span style="color:#22c55e; font-weight:bold;">ILIMITADO ‚≠ê</span>' : `R$ ${saldoRestante.toFixed(2)}`;
      
      tbody.innerHTML += `
        <tr>
          <td><strong>${icone} ${vip.nome}</strong></td>
          <td>${vip.cargo}</td>
          <td><span class="badge">${vip.categoria}</span></td>
          <td><strong style="color:var(--accent);">${limiteTexto}</strong></td>
          <td><strong style="color:${corSaldo};">R$ ${gastoMes.toFixed(2)}</strong></td>
          <td><strong style="color:var(--success);">${saldoTexto}</strong></td>
          <td class="no-print">
            <button class="btn-action" style="background:var(--accent);color:white;" onclick="editarVIP('${vipId}')">
              ‚úèÔ∏è
            </button>
            <button class="btn-action btn-deletar" onclick="deletarVIP('${vipId}', '${vip.nome}')">
              üóëÔ∏è
            </button>
          </td>
        </tr>
      `;
    }
  }
  
  // Adicionar nova pessoa VIP
  function adicionarVIP() {
    if (!temPermissao('gerenciar_usuarios') && loginUser !== 'master') {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA GERENCIAR VIPs!", "error");
      return;
    }
    
    const nome = document.getElementById('novo-vip-nome').value.trim().toUpperCase();
    const cargo = document.getElementById('novo-vip-cargo').value;
    const categoria = document.getElementById('novo-vip-categoria').value;
    const semLimite = document.getElementById('novo-vip-sem-limite').checked;
    const limite = semLimite ? null : parseFloat(document.getElementById('novo-vip-limite').value);
    
    if (!nome) {
      mostrarNotificacao("‚ùå INFORME O NOME!", "error");
      return;
    }
    if (!cargo) {
      mostrarNotificacao("‚ùå SELECIONE O CARGO!", "error");
      return;
    }
    if (!semLimite && (!limite || limite <= 0)) {
      mostrarNotificacao("‚ùå INFORME UM LIMITE V√ÅLIDO OU MARQUE 'SEM LIMITE'!", "error");
      return;
    }
    
    // Gerar ID √∫nico (slug do nome)
    const vipId = nome.replace(/\s+/g, '_').replace(/[^A-Z0-9_]/g, '');
    
    const novaVIP = {
      id: vipId,
      nome: nome,
      cargo: cargo,
      categoria: categoria,
      limite: limite,
      semLimite: semLimite,
      criadoEm: Date.now(),
      criadoPor: loginUser.toUpperCase()
    };
    
    db.ref('pessoas_vip/' + vipId).set(novaVIP)
      .then(() => {
        registrarAuditoria('VIP_ADICIONADO', { nome: nome, limite: semLimite ? 'ILIMITADO' : limite });
        mostrarNotificacao("‚úÖ PESSOA VIP CADASTRADA COM SUCESSO!", "success");
        
        // Limpar formul√°rio
        document.getElementById('novo-vip-nome').value = '';
        document.getElementById('novo-vip-cargo').value = '';
        document.getElementById('novo-vip-categoria').value = 'executivo';
        document.getElementById('novo-vip-limite').value = '';
        document.getElementById('novo-vip-sem-limite').checked = false;
        toggleLimiteVIP('novo'); // Reset do campo
        
        // Atualizar lista
        listarVIPs();
        
        // Atualizar dropdowns VIP
        atualizarDropdownsVIP();
      })
      .catch(error => {
        mostrarNotificacao("‚ùå ERRO AO CADASTRAR: " + error.message, "error");
      });
  }
  
  // Editar pessoa VIP
  function editarVIP(vipId) {
    if (!temPermissao('gerenciar_usuarios') && loginUser !== 'master') {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA EDITAR VIPs!", "error");
      return;
    }
    
    db.ref('pessoas_vip/' + vipId).once('value', snap => {
      if (!snap.exists()) {
        mostrarNotificacao("‚ùå VIP N√ÉO ENCONTRADO!", "error");
        return;
      }
      
      const vip = snap.val();
      
      document.getElementById('edit-vip-id').value = vipId;
      document.getElementById('edit-vip-nome').value = vip.nome;
      document.getElementById('edit-vip-cargo').value = vip.cargo;
      document.getElementById('edit-vip-categoria').value = vip.categoria;
      document.getElementById('edit-vip-limite').value = vip.limite || '';
      document.getElementById('edit-vip-sem-limite').checked = vip.semLimite || false;
      
      // Aplicar estado do checkbox
      toggleLimiteVIP('edit');
      
      document.getElementById('modal-edit-vip').style.display = 'flex';
    });
  }
  
  // Salvar edi√ß√£o de VIP
  function salvarEdicaoVIP() {
    if (!temPermissao('gerenciar_usuarios') && loginUser !== 'master') {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA EDITAR VIPs!", "error");
      return;
    }
    
    const vipId = document.getElementById('edit-vip-id').value;
    const nome = document.getElementById('edit-vip-nome').value.trim().toUpperCase();
    const cargo = document.getElementById('edit-vip-cargo').value;
    const categoria = document.getElementById('edit-vip-categoria').value;
    const semLimite = document.getElementById('edit-vip-sem-limite').checked;
    const limite = semLimite ? null : parseFloat(document.getElementById('edit-vip-limite').value);
    
    if (!nome) {
      mostrarNotificacao("‚ùå INFORME O NOME!", "error");
      return;
    }
    if (!cargo) {
      mostrarNotificacao("‚ùå SELECIONE O CARGO!", "error");
      return;
    }
    if (!semLimite && (!limite || limite <= 0)) {
      mostrarNotificacao("‚ùå INFORME UM LIMITE V√ÅLIDO OU MARQUE 'SEM LIMITE'!", "error");
      return;
    }
    
    db.ref('pessoas_vip/' + vipId).update({
      nome: nome,
      cargo: cargo,
      categoria: categoria,
      limite: limite,
      semLimite: semLimite,
      atualizadoEm: Date.now(),
      atualizadoPor: loginUser.toUpperCase()
    })
      .then(() => {
        registrarAuditoria('VIP_EDITADO', { id: vipId, nome: nome, limite: semLimite ? 'ILIMITADO' : limite });
        mostrarNotificacao("‚úÖ PESSOA VIP ATUALIZADA!", "success");
        fecharModalEditVIP();
        listarVIPs();
        atualizarDropdownsVIP();
      })
      .catch(error => {
        mostrarNotificacao("‚ùå ERRO AO ATUALIZAR: " + error.message, "error");
      });
  }
  
  // Deletar pessoa VIP
  function deletarVIP(vipId, nome) {
    if (!temPermissao('gerenciar_usuarios') && loginUser !== 'master') {
      mostrarNotificacao("‚ùå SEM PERMISS√ÉO PARA DELETAR VIPs!", "error");
      return;
    }
    
    if (!confirm(`‚ö†Ô∏è TEM CERTEZA QUE DESEJA EXCLUIR?\n\n${nome}\n\n‚õî Esta a√ß√£o n√£o pode ser desfeita!\n\n‚úÖ Os abastecimentos hist√≥ricos ser√£o mantidos.`)) {
      return;
    }
    
    db.ref('pessoas_vip/' + vipId).remove()
      .then(() => {
        registrarAuditoria('VIP_DELETADO', { id: vipId, nome: nome });
        mostrarNotificacao("üóëÔ∏è PESSOA VIP EXCLU√çDA!", "success");
        listarVIPs();
        atualizarDropdownsVIP();
      })
      .catch(error => {
        mostrarNotificacao("‚ùå ERRO AO EXCLUIR: " + error.message, "error");
      });
  }
  
  // Fechar modal de edi√ß√£o de VIP
  function fecharModalEditVIP() {
    document.getElementById('modal-edit-vip').style.display = 'none';
  }
  
  // Atualizar dropdowns de VIP em todo o sistema
  async function atualizarDropdownsVIP() {
    const selectVIP = document.getElementById('vip-pessoa');
    if (!selectVIP) return;
    
    selectVIP.innerHTML = '<option value="">SELECIONE...</option>';
    
    const snapshot = await db.ref('pessoas_vip').once('value');
    
    if (snapshot.exists()) {
      snapshot.forEach(snap => {
        const vip = snap.val();
        const icone = vip.categoria === 'executivo' ? 'üëë' : (vip.categoria === 'legislativo' ? 'üèõÔ∏è' : 'üë§');
        selectVIP.innerHTML += `<option value="${vip.id}">${icone} ${vip.nome} (${vip.cargo})</option>`;
      });
    }
  }
  

</script>

